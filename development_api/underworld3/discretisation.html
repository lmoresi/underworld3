<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>underworld3.discretisation API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
    }
</style><style>
    .pdoc .mermaid-pre {
        border: none;
        background: none;
    }
</style>
<script type="module" defer>
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";

    /* Re-invoke Mermaid when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => mermaid.run()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../underworld3.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;underworld3</a>

            <img src="https://github.com/underworldcode/underworld3/blob/main/Jupyterbook/Figures/MansoursNightmare.png?raw=true" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Mesh">Mesh</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Mesh.__init__">Mesh</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.mesh_instances">mesh_instances</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.instance">instance</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.filename">filename</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.boundaries">boundaries</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.boundary_normals">boundary_normals</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.refinement_callback">refinement_callback</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.return_coords_to_bounds">return_coords_to_bounds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.dm0">dm0</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.sf1">sf1</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.petsc_fe">petsc_fe</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.degree">degree</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.qdegree">qdegree</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.dim">dim</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.cdim">cdim</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.view">view</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.clone_dm_hierarchy">clone_dm_hierarchy</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.nuke_coords_and_rebuild">nuke_coords_and_rebuild</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.update_lvec">update_lvec</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.lvec">lvec</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.deform_mesh">deform_mesh</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.access">access</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.N">N</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.Gamma_N">Gamma_N</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.Gamma">Gamma</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.X">X</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.CoordinateSystem">CoordinateSystem</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.r">r</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.rvec">rvec</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.data">data</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.write_timestep">write_timestep</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.petsc_save_checkpoint">petsc_save_checkpoint</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.write_checkpoint">write_checkpoint</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.write">write</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.vtk">vtk</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.generate_xdmf">generate_xdmf</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.vars">vars</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mesh.block_vars">block_vars</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.get_closest_cells">get_closest_cells</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.get_closest_local_cells">get_closest_local_cells</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.get_min_radius_old">get_min_radius_old</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.get_min_radius">get_min_radius</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.stats">stats</a>
                        </li>
                        <li>
                                <a class="function" href="#Mesh.meshVariable_mask_from_label">meshVariable_mask_from_label</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#MeshVariable">MeshVariable</a>
            </li>
            <li>
                    <a class="function" href="#checkpoint_xdmf">checkpoint_xdmf</a>
            </li>
            <li>
                    <a class="function" href="#meshVariable_lookup_by_symbol">meshVariable_lookup_by_symbol</a>
            </li>
            <li>
                    <a class="function" href="#petsc_dm_find_labeled_points_local">petsc_dm_find_labeled_points_local</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../underworld3.html">underworld3</a><wbr>.discretisation    </h1>

                
                        <input id="mod-discretisation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-discretisation-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">numpy</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span> <span class="nn">sympy</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span> <span class="nn">sympy.vector</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">underworld3</span> <span class="k">as</span> <span class="nn">uw</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span> <span class="nn">underworld3.utilities._api_tools</span> <span class="kn">import</span> <span class="n">Stateful</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span> <span class="nn">underworld3.utilities._api_tools</span> <span class="kn">import</span> <span class="n">uw_object</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span> <span class="nn">underworld3.coordinates</span> <span class="kn">import</span> <span class="n">CoordinateSystem</span><span class="p">,</span> <span class="n">CoordinateSystemType</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span> <span class="nn">underworld3.cython</span> <span class="kn">import</span> <span class="n">petsc_discretisation</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">import</span> <span class="nn">underworld3.timing</span> <span class="k">as</span> <span class="nn">timing</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="c1">## Introduce these two specific types of coordinate tracking vector objects</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span> <span class="nn">sympy.vector</span> <span class="kn">import</span> <span class="n">CoordSys3D</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="c1"># class MeshBasisVec(CoordSys3D):</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="c1">#     def __init__(self, *args, **kwargs):</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="c1">#         super().__init__(*args, **kwargs)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="c1">#         return</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="c1"># class MeshSurfaceNormalVec(CoordSys3D):</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="c1">#     def __init__(self, *args, **kwargs):</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="c1">#         super().__init__(*args, **kwargs)</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="c1">#         return</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="k">def</span> <span class="nf">_from_gmsh</span><span class="p">(</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>    <span class="n">filename</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">markVertices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useRegions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useMultipleTags</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="p">):</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a Gmsh .msh file from `filename`.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">    :kwarg comm: Optional communicator to build the mesh on (defaults to</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">        COMM_WORLD).</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="c1">## NOTE: - this should be smart enough to serialise the msh conversion</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="c1">## and then read back in parallel via h5.  This is currently done</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    <span class="c1">## by every gmesh mesh</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    <span class="n">comm</span> <span class="o">=</span> <span class="n">comm</span> <span class="ow">or</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>    <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="c1"># This option allows objects to be in multiple physical groups</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>    <span class="c1"># Rather than just the first one found.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>    <span class="k">if</span> <span class="n">useMultipleTags</span><span class="p">:</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;dm_plex_gmsh_multiple_tags&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;dm_plex_gmsh_multiple_tags&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>    <span class="c1"># This is usually True because dmplex then contains</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>    <span class="c1"># Labels for physical groups</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>    <span class="k">if</span> <span class="n">useRegions</span><span class="p">:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;dm_plex_gmsh_use_regions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">delValue</span><span class="p">(</span><span class="s2">&quot;dm_plex_gmsh_use_regions&quot;</span><span class="p">)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>    <span class="c1"># Marking the vertices may be necessary to constrain isolated points</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>    <span class="c1"># but it means that the labels will have a mix of points, and edges / faces</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>    <span class="k">if</span> <span class="n">markVertices</span><span class="p">:</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;dm_plex_gmsh_mark_vertices&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">delValue</span><span class="p">(</span><span class="s2">&quot;dm_plex_gmsh_mark_vertices&quot;</span><span class="p">)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>    <span class="c1"># this process is more efficient done on the root process and then distributed</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>    <span class="c1"># we do this by saving the mesh as h5 which is more flexible to re-use later</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>    <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="n">plex_0</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">DMPlex</span><span class="p">()</span><span class="o">.</span><span class="n">createFromFile</span><span class="p">(</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>            <span class="n">filename</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_SELF</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="n">plex_0</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_mesh&quot;</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="n">plex_0</span><span class="o">.</span><span class="n">markBoundaryFaces</span><span class="p">(</span><span class="s2">&quot;All_Boundaries&quot;</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="n">plex_0</span><span class="p">)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>    <span class="c1"># Now we have an h5 file and we can hand this to _from_plexh5</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>    <span class="k">return</span> <span class="n">_from_plexh5</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.h5&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">return_sf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="k">def</span> <span class="nf">_from_plexh5</span><span class="p">(</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>    <span class="n">filename</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>    <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>    <span class="n">return_sf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="p">):</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a dmplex .h5 file from `filename` provided.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">    comm: Optional communicator to build the mesh on (defaults to</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">    COMM_WORLD).</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>    <span class="k">if</span> <span class="n">comm</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>        <span class="n">comm</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>    <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>    <span class="c1"># h5plex = PETSc.DMPlex().createFromFile(filename, comm=comm)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>    <span class="n">h5plex</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">DMPlex</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>    <span class="n">sf0</span> <span class="o">=</span> <span class="n">h5plex</span><span class="o">.</span><span class="n">topologyLoad</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>    <span class="n">h5plex</span><span class="o">.</span><span class="n">coordinatesLoad</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">sf0</span><span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>    <span class="n">h5plex</span><span class="o">.</span><span class="n">labelsLoad</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">sf0</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>    <span class="c1"># Do this as well</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>    <span class="n">h5plex</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_mesh&quot;</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>    <span class="n">h5plex</span><span class="o">.</span><span class="n">markBoundaryFaces</span><span class="p">(</span><span class="s2">&quot;All_Boundaries&quot;</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_sf</span><span class="p">:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="k">return</span> <span class="n">h5plex</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        <span class="k">return</span> <span class="n">sf0</span><span class="p">,</span> <span class="n">h5plex</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="k">class</span> <span class="nc">Mesh</span><span class="p">(</span><span class="n">Stateful</span><span class="p">,</span> <span class="n">uw_object</span><span class="p">):</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">    Mesh class for uw - documentation needed</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>    <span class="n">mesh_instances</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="n">plex_or_meshfile</span><span class="p">,</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>        <span class="n">simplex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="n">coordinate_system_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="n">qdegree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        <span class="n">markVertices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>        <span class="n">useRegions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>        <span class="n">useMultipleTags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>        <span class="n">refinement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="n">refinement_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>        <span class="n">return_coords_to_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>        <span class="n">boundaries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="n">boundary_normals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>    <span class="p">):</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">mesh_instances</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="n">Mesh</span><span class="o">.</span><span class="n">mesh_instances</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="n">comm</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plex_or_meshfile</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">DMPlex</span><span class="p">):</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;plexmesh&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">plex_or_meshfile</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Should we build one ?</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>            <span class="n">comm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comm&quot;</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">plex_or_meshfile</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="n">basename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">plex_or_meshfile</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>            <span class="c1"># Note: should be able to handle a .geo as well on this pathway</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.msh&quot;</span><span class="p">:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">_from_gmsh</span><span class="p">(</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>                    <span class="n">plex_or_meshfile</span><span class="p">,</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>                    <span class="n">comm</span><span class="p">,</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>                    <span class="n">markVertices</span><span class="o">=</span><span class="n">markVertices</span><span class="p">,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>                    <span class="n">useRegions</span><span class="o">=</span><span class="n">useRegions</span><span class="p">,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>                    <span class="n">useMultipleTags</span><span class="o">=</span><span class="n">useMultipleTags</span><span class="p">,</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>                <span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>            <span class="k">elif</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.h5&quot;</span><span class="p">:</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">_from_plexh5</span><span class="p">(</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>                    <span class="n">plex_or_meshfile</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">return_sf</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>                <span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>                    <span class="s2">&quot;Mesh file </span><span class="si">%s</span><span class="s2"> has unknown format &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>                    <span class="o">%</span> <span class="p">(</span><span class="n">plex_or_meshfile</span><span class="p">,</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>                <span class="p">)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>        <span class="c1"># Use grid hashing for point location</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;dm_plex_hash_location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setFromOptions</span><span class="p">()</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span> <span class="o">=</span> <span class="n">boundaries</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_normals</span> <span class="o">=</span> <span class="n">boundary_normals</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="n">uw</span><span class="o">.</span><span class="n">adaptivity</span><span class="o">.</span><span class="n">_dm_stack_bcs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">,</span> <span class="s2">&quot;UW_Boundaries&quot;</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">refinement_callback</span> <span class="o">=</span> <span class="n">refinement_callback</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">return_coords_to_bounds</span> <span class="o">=</span> <span class="n">return_coords_to_bounds</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sf1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="c1">## This is where we can refine the dm if required, and rebuild / redistribute</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">refinement</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setRefinementUniform</span><span class="p">()</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">distribute</span><span class="p">()</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>            <span class="c1"># self.dm_hierarchy = self.dm.refineHierarchy(refinement)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="c1"># This is preferable to the refineHierarchy call</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>            <span class="c1"># because we can repair the refined mesh at each</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="c1"># step along the way</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">]</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">refinement</span><span class="p">):</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>                <span class="n">dm_refined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">refine</span><span class="p">()</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                <span class="n">dm_refined</span><span class="o">.</span><span class="n">setCoarseDM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refinement_callback</span><span class="p">):</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>                    <span class="n">refinement_callback</span><span class="p">(</span><span class="n">dm_refined</span><span class="p">)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm_refined</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>            <span class="c1"># self.dm_hierarchy = [self.dm] + self.dm_hierarchy</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_hierarchical_dm&quot;</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refinement_callback</span><span class="p">):</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>                <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>                    <span class="n">refinement_callback</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>            <span class="c1"># Single level equivalent dm</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">distribute</span><span class="p">()</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">]</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="c1"># This will be done anyway - the mesh maybe in a</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="c1"># partially adapted state</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sf1</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span>  <span class="c1"># could be None !</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;mesh&quot;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_mesh&quot;</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;uw_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        <span class="c1"># Set sympy constructs. First a generic, symbolic, Cartesian coordinate system</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="c1"># A unique set of vectors / names for each mesh instance</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="kn">from</span> <span class="nn">sympy.vector</span> <span class="kn">import</span> <span class="n">CoordSys3D</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">CoordSys3D</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="c1"># Tidy some of this printing without changing the</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="c1"># underlying vector names (as these are part of the code generation system)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathrm{\xi_0}&quot;</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathrm{\xi_1}&quot;</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathrm{\xi_2}&quot;</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathbf{\hat{\mathbf</span><span class="si">{e}</span><span class="s2">}_0}&quot;</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">j</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathbf{\hat{\mathbf</span><span class="si">{e}</span><span class="s2">}_1}&quot;</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathbf{\hat{\mathbf</span><span class="si">{e}</span><span class="s2">}_2}&quot;</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span> <span class="o">=</span> <span class="n">CoordSys3D</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\Gamma&quot;</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\Gamma_x&quot;</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\Gamma_y&quot;</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\Gamma_z&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        <span class="c1"># Now add the appropriate coordinate system for the mesh&#39;s natural geometry</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="c1"># This step will usually over-write the defaults we just defined</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_CoordinateSystem</span> <span class="o">=</span> <span class="n">CoordinateSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate_system_type</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="c1"># This was in the _jit extension but ... if</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="c1"># not here then the tests fail sometimes (caching ?)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_x[0]&quot;</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_x[1]&quot;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_x[2]&quot;</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="c1"># Surface integrals also have normal vector information as petsc_n</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_n[0]&quot;</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_n[1]&quot;</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_n[2]&quot;</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">()</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span> <span class="o">=</span> <span class="n">simplex</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_block_vars</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="c1"># a list of equation systems that will</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="c1"># need to be rebuilt if the mesh coordinates change</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_equation_systems_register</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_hash</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_interpolated_results</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_quadrature</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">qdegree</span> <span class="o">=</span> <span class="n">qdegree</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nuke_coords_and_rebuild</span><span class="p">()</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="c1">## Coordinate System</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">CYLINDRICAL2D_NATIVE</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">CYLINDRICAL3D_NATIVE</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="p">):</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus_cylindrical</span><span class="p">(</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="k">elif</span> <span class="p">(</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">SPHERICAL_NATIVE</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        <span class="p">):</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus_spherical</span><span class="p">(</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>            <span class="p">)</span>  <span class="c1">## Not yet complete or tested</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="k">elif</span> <span class="p">(</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">SPHERE_SURFACE_NATIVE</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="p">):</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus_spherical_surface2D_lonlat</span><span class="p">(</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>                <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>            <span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>    <span class="nd">@property</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>    <span class="k">def</span> <span class="nf">dim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">        The mesh dimensionality.</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>    <span class="nd">@property</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>    <span class="k">def</span> <span class="nf">cdim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">        The mesh dimensionality.</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinateDim</span><span class="p">()</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh # </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| Variable Name       | component | degree |     type        |&quot;</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ---------------------------------------------------------- |&quot;</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                        <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">clean_name</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">num_components</span><span class="si">:</span><span class="s2">^10</span><span class="si">}</span><span class="s2"> |</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">degree</span><span class="si">:</span><span class="s2">^7</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">vtype</span><span class="o">.</span><span class="n">name</span><span class="si">:</span><span class="s2">^15</span><span class="si">}</span><span class="s2"> |&quot;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                    <span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ---------------------------------------------------------- |&quot;</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No variables are defined on the mesh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="c1">## Boundary information</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| Boundary Name            | ID    | Min Size | Max Size |&quot;</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ------------------------------------------------------ |&quot;</span><span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No boundary labels are defined on the mesh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>        <span class="k">for</span> <span class="n">bd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>            <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">getStratumSize</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>            <span class="n">ii</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">gather_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>            <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>                    <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2">     | </span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">&lt;5</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">ii</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">ii</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> |&quot;</span><span class="p">,</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>                <span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ------------------------------------------------------ |&quot;</span><span class="p">)</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>        <span class="c1">## Information on the mesh DM</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>    <span class="k">def</span> <span class="nf">clone_dm_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">        Clone the dm hierarchy on the mesh</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="n">dm_hierarchy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="n">new_dm_hierarchy</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">dm_hierarchy</span><span class="p">:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="n">new_dm_hierarchy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_dm_hierarchy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">new_dm_hierarchy</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setCoarseDM</span><span class="p">(</span><span class="n">new_dm_hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="k">return</span> <span class="n">new_dm_hierarchy</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>    <span class="k">def</span> <span class="nf">nuke_coords_and_rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>        <span class="c1"># This is a reversion to the old version (3.15 compatible which seems to work in 3.16 too)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="c1"># let&#39;s go ahead and do an initial projection from linear (the default)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>        <span class="c1"># to linear. this really is a nothing operation, but a</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="c1"># side effect of this operation is that coordinate DM DMField is</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="c1"># converted to the required `PetscFE` type. this may become necessary</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>        <span class="c1"># later where we call the interpolation routines to project from the linear</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>        <span class="c1"># mesh coordinates to other mesh coordinates.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="s2">&quot;meshproj_</span><span class="si">{}</span><span class="s2">_petscspace_degree&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_instances</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>        <span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">FE</span><span class="p">()</span><span class="o">.</span><span class="n">createDefault</span><span class="p">(</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">,</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">qdegree</span><span class="p">,</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>            <span class="s2">&quot;meshproj_</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_instances</span><span class="p">),</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">Sys</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>            <span class="ow">and</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Sys</span><span class="o">.</span><span class="n">getVersionInfo</span><span class="p">()[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="p">):</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">projectCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setCoordinateDisc</span><span class="p">(</span><span class="n">disc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="c1">## LM ToDo: check if this is still a valid issue under 3.18.x / 3.19.x</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="c1"># if self.degree == 1:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="c1">#     # We have to be careful as a projection onto an equivalent PETScFE can cause problematic</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="c1">#     # issues with petsc that we see in parallel - in which case there is a fallback, pass no</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>        <span class="c1">#     # PETScFE and let PETSc decide. Note that the petsc4py wrapped version does not allow this</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="c1">#     # (but it should !)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="c1">#     self.dm.projectCoordinates(self.petsc_fe)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>        <span class="c1"># else:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>        <span class="c1">#     uw.cython.petsc_discretisation.petsc_dm_project_coordinates(self.dm)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>        <span class="c1"># now set copy of this array into dictionary</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinatesLocal</span><span class="p">()</span><span class="o">.</span><span class="n">array</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>            <span class="kc">True</span><span class="p">,</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="p">)</span>  <span class="c1"># True here assumes continuous basis for coordinates ...</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="c1"># invalidate the cell-search k-d tree and the mesh centroid data / rebuild</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_kd_tree_index</span><span class="p">()</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>        <span class="p">(</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_min_size</span><span class="p">,</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="p">,</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">,</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_search_lengths</span><span class="p">,</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mesh_sizes</span><span class="p">()</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="k">return</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>    <span class="k">def</span> <span class="nf">update_lvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="sd">        This method creates and/or updates the mesh variable local vector.</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">        If the local vector is already up to date, this method will do nothing.</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span><span class="p">:</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clearDS</span><span class="p">()</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>                <span class="c1"># create the local vector (memory chunk) and attach to original dm</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createLocalVec</span><span class="p">()</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>            <span class="c1"># push avar arrays into the parent dm array</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>            <span class="n">a_global</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>            <span class="c1"># The field decomposition seems to fail if coarse DMs are present</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="n">names</span><span class="p">,</span> <span class="n">isets</span><span class="p">,</span> <span class="n">dms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createFieldDecomposition</span><span class="p">()</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">():</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>                <span class="c1"># traverse subdms, taking user generated data in the subdm</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>                <span class="c1"># local vec, pushing it into a global sub vec</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">subiset</span><span class="p">,</span> <span class="n">subdm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">isets</span><span class="p">,</span> <span class="n">dms</span><span class="p">):</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>                    <span class="n">lvec</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">vec</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>                    <span class="n">subvec</span> <span class="o">=</span> <span class="n">a_global</span><span class="o">.</span><span class="n">getSubVector</span><span class="p">(</span><span class="n">subiset</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                    <span class="n">subdm</span><span class="o">.</span><span class="n">localToGlobal</span><span class="p">(</span><span class="n">lvec</span><span class="p">,</span> <span class="n">subvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>                    <span class="n">a_global</span><span class="o">.</span><span class="n">restoreSubVector</span><span class="p">(</span><span class="n">subiset</span><span class="p">,</span> <span class="n">subvec</span><span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">a_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">a_global</span><span class="p">)</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>    <span class="nd">@property</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>    <span class="k">def</span> <span class="nf">lvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Vec</span><span class="p">:</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">        Returns a local Petsc vector containing the flattened array</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a><span class="sd">        of all the mesh variables.</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="s2">&quot;Mesh `lvec` needs to be updated using the update_lvec()` method.&quot;</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>            <span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lvec&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>    <span class="k">def</span> <span class="nf">deform_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a><span class="sd">        This method will update the mesh coordinates and reset any cached coordinates in</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="sd">        the mesh and in equation systems that are registered on the mesh.</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">        The coord array that is passed in should match the shape of self.data</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>        <span class="n">coord_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinatesLocal</span><span class="p">()</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">coord_vec</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>        <span class="n">coords</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coords</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setCoordinatesLocal</span><span class="p">(</span><span class="n">coord_vec</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nuke_coords_and_rebuild</span><span class="p">()</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>        <span class="k">for</span> <span class="n">eq_system</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equation_systems_register</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>            <span class="n">eq_system</span><span class="o">.</span><span class="n">_rebuild_after_mesh_update</span><span class="p">()</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="k">return</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>    <span class="k">def</span> <span class="nf">access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">writeable_vars</span><span class="p">:</span> <span class="s2">&quot;MeshVariable&quot;</span><span class="p">):</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">        This context manager makes the underlying mesh variables data available to</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">        the user. The data should be accessed via the variables `data` handle.</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">        As default, all data is read-only. To enable writeable data, the user should</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">        specify which variable they wish to modify.</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">        Parameters</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">        ----------</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">        writeable_vars</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">            The variables for which data write access is required.</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">        Example</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">        -------</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">        &gt;&gt;&gt; import underworld3 as uw</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">        &gt;&gt;&gt; someMesh = uw.discretisation.FeMesh_Cartesian()</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">        &gt;&gt;&gt; with someMesh.deform_mesh():</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">        ...     someMesh.data[0] = [0.1,0.1]</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        &gt;&gt;&gt; someMesh.data[0]</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">        array([ 0.1,  0.1])</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="kn">import</span> <span class="nn">time</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>        <span class="n">timing</span><span class="o">.</span><span class="n">_incrementDepth</span><span class="p">()</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="n">deaccess_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="c1"># if already accessed within higher level context manager, continue.</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>                <span class="k">continue</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>            <span class="c1"># set flag so variable status can be known elsewhere</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>            <span class="n">var</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>            <span class="c1"># add to de-access list to rewind this later</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>            <span class="n">deaccess_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>            <span class="c1"># create &amp; set vec</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>            <span class="n">var</span><span class="o">.</span><span class="n">_set_vec</span><span class="p">(</span><span class="n">available</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            <span class="c1"># grab numpy object, setting read only if necessary</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="n">var</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">vec</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">writeable_vars</span><span class="p">:</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">_old_data_flag</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                <span class="c1"># increment variable state</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">_increment</span><span class="p">()</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>            <span class="c1"># make view for each var component</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>                    <span class="c1"># var._data_ij[i, j] = var.data[:, var._data_layout(i, j)]</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                        <span class="n">data</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">var</span><span class="o">.</span><span class="n">_data_layout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)],</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                    <span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>        <span class="k">class</span> <span class="nc">exit_manager</span><span class="p">:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>                <span class="k">pass</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>                    <span class="c1"># only de-access variables we have set access for.</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deaccess_list</span><span class="p">:</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                        <span class="k">continue</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>                    <span class="c1"># set this back, although possibly not required.</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">writeable_vars</span><span class="p">:</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>                        <span class="n">var</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_old_data_flag</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>                    <span class="c1"># perform sync for any modified vars.</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">writeable_vars</span><span class="p">:</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>                        <span class="n">indexset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>                        <span class="c1"># sync ghost values</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>                        <span class="n">subdm</span><span class="o">.</span><span class="n">localToGlobal</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">vec</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>                        <span class="n">subdm</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">vec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>                        <span class="c1"># subdm.destroy()</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">_stale_lvec</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_set_vec</span><span class="p">(</span><span class="n">available</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>                            <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>                                <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                            <span class="p">]</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                                <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MeshVariable[...].data is only available within mesh.access() context&quot;</span><span class="p">,</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                            <span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>                <span class="n">timing</span><span class="o">.</span><span class="n">_decrementDepth</span><span class="p">()</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                <span class="n">timing</span><span class="o">.</span><span class="n">log_result</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">stime</span><span class="p">,</span> <span class="s2">&quot;Mesh.access&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>        <span class="k">return</span> <span class="n">exit_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>    <span class="nd">@property</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>    <span class="k">def</span> <span class="nf">N</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">CoordSys3D</span><span class="p">:</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">        The mesh coordinate system.</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>    <span class="nd">@property</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>    <span class="k">def</span> <span class="nf">Gamma_N</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">CoordSys3D</span><span class="p">:</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">        The mesh coordinate system.</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>    <span class="nd">@property</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>    <span class="k">def</span> <span class="nf">Gamma</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">CoordSys3D</span><span class="p">:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">        The mesh coordinate system.</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="k">return</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">base_scalars</span><span class="p">()[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>    <span class="nd">@property</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>    <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CoordinateSystem</span><span class="o">.</span><span class="n">X</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>    <span class="nd">@property</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>    <span class="k">def</span> <span class="nf">CoordinateSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CoordinateSystem</span><span class="p">:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CoordinateSystem</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>    <span class="nd">@property</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>    <span class="k">def</span> <span class="nf">r</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">BaseScalar</span><span class="p">]:</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">        The tuple of base scalar objects (N.x,N.y,N.z) for the mesh.</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">base_scalars</span><span class="p">()[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">]</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>    <span class="nd">@property</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>    <span class="k">def</span> <span class="nf">rvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">Vector</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">        The r vector, `r = N.x*N.i + N.y*N.j [+ N.z*N.k]`.</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>        <span class="n">r_vec</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">zero</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="n">N_s</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">base_scalars</span><span class="p">()</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>        <span class="n">N_v</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">base_vectors</span><span class="p">()</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">):</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>            <span class="n">r_vec</span> <span class="o">+=</span> <span class="n">N_s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">N_v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        <span class="k">return</span> <span class="n">r_vec</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>    <span class="nd">@property</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">        The array of mesh element vertex coordinates.</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="c1"># get flat array</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinatesLocal</span><span class="p">()</span><span class="o">.</span><span class="n">array</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>    <span class="k">def</span> <span class="nf">write_timestep</span><span class="p">(</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>        <span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>        <span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>    <span class="p">):</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">        Write the selected mesh, variables and swarm variables (as proxies) for later visualisation.</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">        An xdmf file is generated and the overall package can then be read by paraview or pyvista.</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">        Vertex values (on the mesh points) are stored for all variables regardless of their interpolation order</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;viewer_hdf5_sp_output&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;viewer_hdf5_collective&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>        <span class="n">output_base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="c1"># Checkpoint the mesh file itself if required</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">meshUpdates</span><span class="p">:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="n">mesh_file</span> <span class="o">=</span> <span class="n">output_base_name</span> <span class="o">+</span> <span class="s2">&quot;.mesh.00000.h5&quot;</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span><span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                <span class="n">save_location</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                    <span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                <span class="p">)</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="k">if</span> <span class="n">swarmVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>            <span class="k">for</span> <span class="n">svar</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                <span class="n">save_location</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                    <span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.proxy.</span><span class="si">{</span><span class="n">svar</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>                <span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>                <span class="n">svar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="n">checkpoint_xdmf</span><span class="p">(</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                <span class="n">output_base_name</span><span class="p">,</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                <span class="n">meshUpdates</span><span class="p">,</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>                <span class="n">meshVars</span><span class="p">,</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                <span class="n">swarmVars</span><span class="p">,</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                <span class="n">index</span><span class="p">,</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            <span class="p">)</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>        <span class="k">return</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>    <span class="k">def</span> <span class="nf">petsc_save_checkpoint</span><span class="p">(</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>    <span class="p">):</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">        Use PETSc to save the mesh and mesh vars in a h5 and xdmf file.</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">        Parameters</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">        ----------</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        meshVars:</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">            List of UW mesh variables to save. If left empty then just the mesh is saved.</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">        index :</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a><span class="sd">            An index which might correspond to the timestep or output number (for example).</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">        outputPath :</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="sd">            Path to save the data. If left empty it will save the data in the current working directory.</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meshVars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;`meshVars` does not appear to be a list.&quot;</span><span class="p">)</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="kn">from</span> <span class="nn">underworld3.utilities</span> <span class="kn">import</span> <span class="n">generateXdmf</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="c1">### save mesh vars</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">outputPath</span><span class="si">}{</span><span class="s1">&#39;_step_&#39;</span><span class="si">}{</span><span class="n">index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="n">xfname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">outputPath</span><span class="si">}{</span><span class="s1">&#39;_step_&#39;</span><span class="si">}{</span><span class="n">index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.xdmf&quot;</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="c1">#### create petsc viewer</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">createHDF5</span><span class="p">(</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>            <span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>        <span class="p">)</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="c1">### Empty meshVars will save just the mesh</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                <span class="n">viewer</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>            <span class="n">generateXdmf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">xfname</span><span class="p">)</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>    <span class="k">def</span> <span class="nf">write_checkpoint</span><span class="p">(</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>        <span class="n">unique_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>    <span class="p">):</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Write data in a format that can be restored for restarting the simulation</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="sd">        The difference between this and the visualisation is 1) the parallel section needs</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">        to be stored to reload the data correctly, and 2) the visualisation information (vertex form of fields)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">        is not stored. This routines uses dmplex *VectorView and *VectorLoad functionality</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="c1"># The mesh checkpoint is the same as the one required for visualisation</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">meshUpdates</span><span class="p">:</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>            <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>            <span class="n">mesh_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.mesh.0.h5&quot;</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span><span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="c1"># Checkpoint file</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="k">if</span> <span class="n">unique_id</span><span class="p">:</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>            <span class="n">checkpoint_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">unique</span><span class="si">}</span><span class="s2">.checkpoint.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>            <span class="n">checkpoint_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.checkpoint.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_mesh&quot;</span><span class="p">)</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="c1"># Store the parallel-mesh section information for restoring the checkpoint.</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">sectionView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                <span class="n">iset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                <span class="n">subdm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="p">)</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">globalVectorView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">sectionView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">)</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                <span class="c1"># v._gvec.view(viewer) # would add viz information plus a duplicate of the data</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="k">if</span> <span class="n">swarmVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>            <span class="k">for</span> <span class="n">svar</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                <span class="n">var</span> <span class="o">=</span> <span class="n">svar</span><span class="o">.</span><span class="n">_meshVar</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                <span class="n">iset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>                <span class="n">subdm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="p">)</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">globalVectorView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">sectionView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">)</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>  <span class="c1"># should not be required</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a><span class="sd">        Save mesh data to the specified hdf5 file.</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a><span class="sd">        Parameters</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a><span class="sd">        ----------</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">        filename :</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">            The filename for the mesh checkpoint file.</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="sd">        index :</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">            Not yet implemented. An optional index which might</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">            correspond to the timestep (for example).</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Recording `index` not currently supported&quot;</span><span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>            <span class="c1">## JM:To enable timestep recording, the following needs to be called.</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>            <span class="c1">## I&#39;m unsure if the corresponding xdmf functionality is enabled via</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>            <span class="c1">## the PETSc xdmf script.</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="c1"># viewer.pushTimestepping(viewer)</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="c1"># viewer.setTimestep(index)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="c1"># Not sure if the files are correctly written if we do not explicitly destroy the viewer</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>    <span class="k">def</span> <span class="nf">vtk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        Save mesh to the specified file</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span><span class="o">.</span><span class="n">createVTK</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>    <span class="k">def</span> <span class="nf">generate_xdmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">        This method generates an xdmf schema for the specified file.</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">        The filename of the generated file will be the same as the hdf5 file</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">        but with the `xmf` extension.</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">        Parameters</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">        ----------</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">        filename :</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">            File name of the checkpointed hdf5 file for which the</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">            xdmf schema will be written.</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="kn">from</span> <span class="nn">underworld3.utilities</span> <span class="kn">import</span> <span class="n">generateXdmf</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>            <span class="n">generateXdmf</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="k">return</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>    <span class="c1"># ToDo: rename this so it does not clash with the vars built in</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>    <span class="nd">@property</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="k">def</span> <span class="nf">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">        A list of variables recorded on the mesh.</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>        <span class="c1"># ToDo: rename this so it does not clash with the vars built in</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>    <span class="nd">@property</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>    <span class="k">def</span> <span class="nf">block_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">        A list of variables recorded on the mesh.</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_vars</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>    <span class="k">def</span> <span class="nf">_get_coords_for_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a><span class="sd">        This function returns the vertex array for the</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">        provided variable. If the array does not already exist,</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">        it is first created and then returned.</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">continuous</span><span class="p">)</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="c1"># if array already created, return.</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">:</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords_for_basis</span><span class="p">(</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">continuous</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>            <span class="p">)</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>    <span class="k">def</span> <span class="nf">_get_coords_for_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">continuous</span><span class="p">):</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">        This function returns the vertex array for the</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">        provided variable. If the array does not already exist,</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="sd">        it is first created and then returned.</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="n">dmold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinateDM</span><span class="p">()</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="n">dmold</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>        <span class="n">dmnew</span> <span class="o">=</span> <span class="n">dmold</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;coordinterp_petscspace_degree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">degree</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;coordinterp_petscdualspace_lagrange_continuity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">continuous</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;coordinterp_petscdualspace_lagrange_node_endpoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="n">dmfe</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">FE</span><span class="p">()</span><span class="o">.</span><span class="n">createDefault</span><span class="p">(</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">,</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">qdegree</span><span class="p">,</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            <span class="s2">&quot;coordinterp_&quot;</span><span class="p">,</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>        <span class="p">)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">setField</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dmfe</span><span class="p">)</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>        <span class="n">matInterp</span><span class="p">,</span> <span class="n">vecScale</span> <span class="o">=</span> <span class="n">dmold</span><span class="o">.</span><span class="n">createInterpolation</span><span class="p">(</span><span class="n">dmnew</span><span class="p">)</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>        <span class="n">coordsOld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinates</span><span class="p">()</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>        <span class="n">coordsNewL</span> <span class="o">=</span> <span class="n">dmnew</span><span class="o">.</span><span class="n">getLocalVec</span><span class="p">()</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="n">coordsNewG</span> <span class="o">=</span> <span class="n">dmnew</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="n">matInterp</span><span class="o">.</span><span class="n">mult</span><span class="p">(</span><span class="n">coordsOld</span><span class="p">,</span> <span class="n">coordsNewG</span><span class="p">)</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">coordsNewG</span><span class="p">,</span> <span class="n">coordsNewL</span><span class="p">)</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">coordsNewL</span><span class="o">.</span><span class="n">array</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="n">arrcopy</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">coordsNewG</span><span class="p">)</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">restoreLocalVec</span><span class="p">(</span><span class="n">coordsNewL</span><span class="p">)</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="n">dmfe</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>        <span class="k">return</span> <span class="n">arrcopy</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>    <span class="k">def</span> <span class="nf">_build_kd_tree_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>            <span class="k">return</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>        <span class="c1">## Bootstrapping - the kd-tree is needed to build the index but</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="c1">## the index is also used in the kd-tree.</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>        <span class="kn">from</span> <span class="nn">underworld3.swarm</span> <span class="kn">import</span> <span class="n">Swarm</span><span class="p">,</span> <span class="n">SwarmPICLayout</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="c1"># Create a temp swarm which we&#39;ll use to populate particles</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="c1"># at gauss points. These will then be used as basis for</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="c1"># kd-tree indexing back to owning cells.</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        <span class="n">tempSwarm</span> <span class="o">=</span> <span class="n">Swarm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="c1"># 4^dim pop is used. This number may need to be considered</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="c1"># more carefully, or possibly should be coded to be set dynamically.</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="c1"># We can&#39;t use our own populate function since this needs THIS kd_tree to exist</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>        <span class="c1"># We will need to use a standard layout instead</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="n">tempSwarm</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">finalizeFieldRegister</span><span class="p">()</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="n">tempSwarm</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">insertPointUsingCellDM</span><span class="p">(</span><span class="n">SwarmPICLayout</span><span class="o">.</span><span class="n">GAUSS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>        <span class="k">with</span> <span class="n">tempSwarm</span><span class="o">.</span><span class="n">access</span><span class="p">():</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>            <span class="c1"># Build index on particle coords</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_indexCoords</span> <span class="o">=</span> <span class="n">tempSwarm</span><span class="o">.</span><span class="n">particle_coordinates</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">kdtree</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_indexCoords</span><span class="p">)</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">build_index</span><span class="p">()</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>            <span class="c1"># Grab mapping back to cell_ids.</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>            <span class="c1"># Note that this is the numpy array that we eventually return from this</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>            <span class="c1"># method. As such, we take measures to ensure that we use `numpy.int64` here</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>            <span class="c1"># because we cast from this type in  `_function.evaluate` to construct</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>            <span class="c1"># the PETSc cell-sf datasets, and if instead a `numpy.int32` is used it</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>            <span class="c1"># will cause bugs that are difficult to find.</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_indexMap</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>                <span class="n">tempSwarm</span><span class="o">.</span><span class="n">particle_cellid</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>            <span class="p">)</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="c1"># Use the &quot;OK&quot; version above to find these lengths</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="p">(</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_min_size</span><span class="p">,</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="p">,</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">,</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_search_lengths</span><span class="p">,</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mesh_sizes</span><span class="p">()</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>        <span class="c1">## Now, we can use this information to rebuild the index more carefully</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a><span class="sd">        tempSwarm2 = Swarm(self)</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a><span class="sd">        tempSwarm2.populate(fill_param=4)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a><span class="sd">        with tempSwarm2.access():</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a><span class="sd">            # Build index on particle coords</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a><span class="sd">            self._indexCoords = tempSwarm2.particle_coordinates.data.copy()</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a><span class="sd">            self._index = uw.kdtree.KDTree(self._indexCoords)</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="sd">            self._index.build_index()</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="sd">            # Grab mapping back to cell_ids.</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">            # Note that this is the numpy array that we eventually return from this</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">            # method. As such, we take measures to ensure that we use `numpy.int64` here</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">            # because we cast from this type in  `_function.evaluate` to construct</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">            # the PETSc cell-sf datasets, and if instead a `numpy.int32` is used it</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="sd">            # will cause bugs that are difficult to find.</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">            self._indexMap = numpy.array(</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="sd">                tempSwarm2.particle_cellid.data[:, 0], dtype=numpy.int64</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">            )</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">        # update these</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">        self._min_sizes, self._radii, self._centroids, self._search_lengths = self._get_mesh_sizes()</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>        <span class="k">return</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>    <span class="k">def</span> <span class="nf">get_closest_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">        This method uses a kd-tree algorithm to find the closest</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">        cells to the provided coords. For a regular mesh, this should</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">        be exactly the owning cell, but if the mesh is deformed, this</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">        is not guaranteed. Note, the nearest point does may not be all</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="sd">        that close by - use get_closest_local_cells to filter out points</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">        that are (probably) not within any local cell.</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">        -----------</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">        coords:</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">            An array of the coordinates for which we wish to determine the</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">            closest cells. This should be a 2-dimensional array of</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="sd">            shape (n_coords,dim).</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">        Returns:</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a><span class="sd">        --------</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="sd">        closest_cells:</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">            An array of indices representing the cells closest to the provided</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">            coordinates. This will be a 1-dimensional array of</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">            shape (n_coords).</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_kd_tree_index</span><span class="p">()</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>            <span class="n">closest_points</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>            <span class="c1">### returns an empty array if no coords are on a proc</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>            <span class="n">closest_points</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>        <span class="k">if</span> <span class="n">found</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>                    <span class="s2">&quot;An error was encountered attempting to find the closest cells to the provided coordinates.&quot;</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>                <span class="p">)</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexMap</span><span class="p">[</span><span class="n">closest_points</span><span class="p">]</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>    <span class="k">def</span> <span class="nf">get_closest_local_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">        This method uses a kd-tree algorithm to find the closest</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">        cells to the provided coords. For a regular mesh, this should</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">        be exactly the owning cell, but if the mesh is deformed, this</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">        is not guaranteed. Also compares the distance from the cell to the</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="sd">        point - if this is larger than the &quot;cell size&quot; then returns -1</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">        -----------</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a><span class="sd">        coords:</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a><span class="sd">            An array of the coordinates for which we wish to determine the</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="sd">            closest cells. This should be a 2-dimensional array of</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="sd">            shape (n_coords,dim).</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">        Returns:</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">        --------</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">        closest_cells:</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">            An array of indices representing the cells closest to the provided</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a><span class="sd">            coordinates. This will be a 1-dimensional array of</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">            shape (n_coords).</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="c1"># Create index if required</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_kd_tree_index</span><span class="p">()</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>            <span class="n">closest_points</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="c1"># This is tuned a little bit so that points on a single CPU are never lost</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexMap</span><span class="p">[</span><span class="n">closest_points</span><span class="p">]</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>        <span class="n">invalid</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>            <span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># 2.5 * self._search_lengths[cells]</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>        <span class="p">)</span>  <span class="c1"># 0.25 * self._radii[cells] ** 2</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="n">cells</span><span class="p">[</span><span class="n">invalid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="k">return</span> <span class="n">cells</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>    <span class="k">def</span> <span class="nf">_get_mesh_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a><span class="sd">        Obtain the (local) mesh radii and centroids using</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a><span class="sd">        This routine is called when the mesh is built / rebuilt</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="n">centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords_for_basis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="n">centroids_kd_tree</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">kdtree</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>        <span class="n">cStart</span><span class="p">,</span> <span class="n">cEnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getHeightStratum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>        <span class="n">pStart</span><span class="p">,</span> <span class="n">pEnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getDepthStratum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        <span class="n">cell_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="n">cell_min_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="n">cell_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cEnd</span> <span class="o">-</span> <span class="n">cStart</span><span class="p">):</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="n">cell_num_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getConeSize</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="n">cell_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getTransitiveClosure</span><span class="p">(</span><span class="n">cell</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="n">cell_num_points</span><span class="p">:]</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>            <span class="n">cell_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cell_points</span> <span class="o">-</span> <span class="n">pStart</span><span class="p">]</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">distsq</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">centroids_kd_tree</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">cell_coords</span><span class="p">)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="n">cell_length</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distsq</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="n">cell_r</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distsq</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>            <span class="n">cell_min_r</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distsq</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>        <span class="k">return</span> <span class="n">cell_min_r</span><span class="p">,</span> <span class="n">cell_r</span><span class="p">,</span> <span class="n">centroids</span><span class="p">,</span> <span class="n">cell_length</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>    <span class="c1"># ==========</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>    <span class="c1"># Deprecated in favour of _get_mesh_sizes (above)</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>    <span class="k">def</span> <span class="nf">_get_mesh_centroids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">        Obtain and cache the (local) mesh centroids using underworld swarm technology.</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">        This routine is called when the mesh is built / rebuilt</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">        The global cell number corresponding to a centroid is (supposed to be)</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">        self.dm.getCellNumbering().array.min() + index</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="c1"># (</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>        <span class="c1">#     sizes,</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>        <span class="c1">#     centroids,</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="c1"># ) = petsc_discretisation.petsc_fvm_get_local_cell_sizes(self)</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>        <span class="n">centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords_for_basis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>        <span class="k">return</span> <span class="n">centroids</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>    <span class="k">def</span> <span class="nf">get_min_radius_old</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a><span class="sd">        This method returns the global minimum distance from any cell centroid to a face.</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a><span class="sd">        It wraps to the PETSc `DMPlexGetMinRadius` routine. The petsc4py equivalent always</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="sd">        returns zero.</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>        <span class="c1">## Note: The petsc4py version of DMPlexComputeGeometryFVM does not compute all cells and</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>        <span class="c1">## does not obtain the minimum radius for the mesh.</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>        <span class="kn">from</span> <span class="nn">underworld3.cython.petsc_discretisation</span> <span class="kn">import</span> <span class="n">petsc_fvm_get_min_radius</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_min_radius&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_radius</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_min_radius</span> <span class="o">=</span> <span class="n">petsc_fvm_get_min_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_radius</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>    <span class="k">def</span> <span class="nf">get_min_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a><span class="sd">        This method returns the global minimum distance from any cell centroid to a face.</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="sd">        It wraps to the PETSc `DMPlexGetMinRadius` routine. The petsc4py equivalent always</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a><span class="sd">        returns zero.</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>        <span class="c1">## Note: The petsc4py version of DMPlexComputeGeometryFVM does not compute all cells and</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>        <span class="c1">## does not obtain the minimum radius for the mesh.</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>        <span class="n">all_min_radii</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">gather_data</span><span class="p">(</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="o">.</span><span class="n">min</span><span class="p">(),)),</span> <span class="n">bcast</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>        <span class="p">)</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>        <span class="k">return</span> <span class="n">all_min_radii</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>    <span class="c1"># def get_boundary_subdm(self) -&gt; PETSc.DM:</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>    <span class="c1">#     &quot;&quot;&quot;</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>    <span class="c1">#     This method returns the boundary subdm that wraps DMPlexCreateSubmesh</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>    <span class="c1">#     &quot;&quot;&quot;</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>    <span class="c1">#     from underworld3.petsc_discretisation import petsc_create_surface_submesh</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>    <span class="c1">#     return petsc_create_surface_submesh(self, &quot;Boundary&quot;, 666, )</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>    <span class="c1"># This should be deprecated in favour of using integrals</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uw_function</span><span class="p">,</span> <span class="n">uw_meshVariable</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="sd">        Returns various norms on the mesh for the provided function.</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="sd">          - size</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a><span class="sd">          - mean</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a><span class="sd">          - min</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a><span class="sd">          - max</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a><span class="sd">          - sum</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a><span class="sd">          - L2 norm</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a><span class="sd">          - rms</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a><span class="sd">          NOTE: this currently assumes scalar variables !</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>        <span class="c1">#       This uses a private work MeshVariable and the various norms defined there but</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>        <span class="c1">#       could either be simplified to just use petsc vectors, or extended to</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>        <span class="c1">#       compute integrals over the elements which is in line with uw1 and uw2</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>        <span class="kn">from</span> <span class="nn">petsc4py.PETSc</span> <span class="kn">import</span> <span class="n">NormType</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">uw_meshVariable</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>            <span class="n">tmp</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>                <span class="n">uw_function</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">basis</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>        <span class="n">vsize</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>        <span class="n">vmean</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>        <span class="n">vmax</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>        <span class="n">vmin</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>        <span class="n">vsum</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>        <span class="n">vnorm2</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">NormType</span><span class="o">.</span><span class="n">NORM_2</span><span class="p">)</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>        <span class="n">vrms</span> <span class="o">=</span> <span class="n">vnorm2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vsize</span><span class="p">)</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="k">return</span> <span class="n">vsize</span><span class="p">,</span> <span class="n">vmean</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">vsum</span><span class="p">,</span> <span class="n">vnorm2</span><span class="p">,</span> <span class="n">vrms</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>    <span class="k">def</span> <span class="nf">meshVariable_mask_from_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_name</span><span class="p">,</span> <span class="n">label_value</span><span class="p">):</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract single label value and make a point mask&quot;&quot;&quot;</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>        <span class="n">meshVar</span> <span class="o">=</span> <span class="n">MeshVariable</span><span class="p">(</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>            <span class="sa">f</span><span class="s2">&quot;Mask_</span><span class="si">{</span><span class="n">label_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">label_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>            <span class="n">vtype</span><span class="o">=</span><span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SCALAR</span><span class="p">,</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>            <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>            <span class="n">continuous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>            <span class="n">varsymbol</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;\cal</span><span class="se">{{</span><span class="s2">M</span><span class="se">}}</span><span class="s2">^</span><span class="se">{{</span><span class="s2">[</span><span class="si">{</span><span class="n">label_name</span><span class="si">:</span><span class="s2">.4</span><span class="si">}</span><span class="s2">]</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>        <span class="p">)</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="n">point_indices</span> <span class="o">=</span> <span class="n">petsc_dm_find_labeled_points_local</span><span class="p">(</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>            <span class="n">label_name</span><span class="p">,</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>            <span class="n">label_value</span><span class="p">,</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>            <span class="n">sectionIndex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>        <span class="p">)</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">meshVar</span><span class="p">):</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>            <span class="n">meshVar</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>            <span class="k">if</span> <span class="n">point_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>                <span class="n">meshVar</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">point_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>        <span class="k">return</span> <span class="n">meshVar</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a><span class="c1">## Here we check the existence of the meshVariable and so on before defining a new one</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a><span class="c1">## (and potentially losing the handle to the old one)</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a><span class="k">def</span> <span class="nf">MeshVariable</span><span class="p">(</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>    <span class="n">varname</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>    <span class="n">mesh</span><span class="p">:</span> <span class="s2">&quot;Mesh&quot;</span><span class="p">,</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>    <span class="n">num_components</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>    <span class="n">vtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;uw.VarType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>    <span class="n">degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>    <span class="n">continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>    <span class="n">varsymbol</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a><span class="p">):</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a><span class="sd">    The MeshVariable class generates a variable supported by a finite element mesh and the</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a><span class="sd">    underlying sympy representation that makes it possible to construct expressions that</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a><span class="sd">    depend on the values of the MeshVariable.</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a><span class="sd">    To set / read nodal values, use the numpy interface via the &#39;data&#39; property.</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a><span class="sd">    Parameters</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a><span class="sd">    ----------</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a><span class="sd">    varname :</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a><span class="sd">        A textual name for this variable.</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a><span class="sd">    mesh :</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a><span class="sd">        The supporting underworld mesh.</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a><span class="sd">    num_components :</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a><span class="sd">        The number of components this variable has.</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a><span class="sd">        For example, scalars will have `num_components=1`,</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="sd">        while a 2d vector would have `num_components=2`.</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a><span class="sd">    vtype :</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">        Optional. The underworld variable type for this variable.</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a><span class="sd">        If not defined it will be inferred from `num_components`</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="sd">        if possible.</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a><span class="sd">    degree :</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a><span class="sd">        The polynomial degree for this variable.</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">    varsymbol:</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a><span class="sd">        A symbolic form for printing etc (sympy / latex)</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">varname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="sa">R</span><span class="s2">&quot;+ \dots&quot;</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">varname</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>    <span class="c1">## Smash if already defined (we should check this BEFORE the old meshVariable object is destroyed)</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>    <span class="kn">import</span> <span class="nn">re</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>    <span class="n">clean_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9_]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>    <span class="k">if</span> <span class="n">clean_name</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable with name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> already exists on the mesh - Skipping.&quot;</span><span class="p">)</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>        <span class="k">return</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">clean_name</span><span class="p">]</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">_accessed</span><span class="p">:</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>        <span class="c1">## Before adding a new variable, we first snapshot the data from the mesh.dm</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="c1">## (if not accessed, then this will not be necessary and may break)</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">update_lvec</span><span class="p">()</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="n">old_gvec</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">localToGlobal</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">_lvec</span><span class="p">,</span> <span class="n">old_gvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>    <span class="n">new_meshVariable</span> <span class="o">=</span> <span class="n">_MeshVariable</span><span class="p">(</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>        <span class="n">varname</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">num_components</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">varsymbol</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>    <span class="p">)</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">_accessed</span><span class="p">:</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>        <span class="c1">## Recreate the mesh variable dm and restore the data</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>        <span class="n">dm0</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>        <span class="n">dm1</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>        <span class="n">dm0</span><span class="o">.</span><span class="n">copyFields</span><span class="p">(</span><span class="n">dm1</span><span class="p">)</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>        <span class="n">dm1</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>        <span class="c1"># print(f&quot;{uw.mpi.rank}: Here 1&quot;, flush=True)</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>        <span class="n">mdm_is</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="n">dm1</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dm1</span><span class="o">.</span><span class="n">getNumFields</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">_lvec</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="n">dm1</span><span class="o">.</span><span class="n">createLocalVec</span><span class="p">()</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>        <span class="n">new_gvec</span> <span class="o">=</span> <span class="n">dm1</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>        <span class="n">new_gvec_sub</span> <span class="o">=</span> <span class="n">new_gvec</span><span class="o">.</span><span class="n">getSubVector</span><span class="p">(</span><span class="n">mdm_is</span><span class="p">)</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>        <span class="c1"># Copy the array data and push to gvec</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>        <span class="n">new_gvec_sub</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_gvec</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="n">new_gvec</span><span class="o">.</span><span class="n">restoreSubVector</span><span class="p">(</span><span class="n">mdm_is</span><span class="p">,</span> <span class="n">new_gvec_sub</span><span class="p">)</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>        <span class="c1"># print(f&quot;{uw.mpi.rank}: Here 2&quot;, flush=True)</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>        <span class="c1"># Copy the data to mesh._lvec and delete gvec</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>        <span class="n">dm1</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">new_gvec</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">_lvec</span><span class="p">)</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>        <span class="n">dm1</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">new_gvec</span><span class="p">)</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="n">dm0</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">old_gvec</span><span class="p">)</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>        <span class="c1"># destroy old dm</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>        <span class="n">dm0</span><span class="o">.</span><span class="n">destroy</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>        <span class="c1"># Set new dm on mesh</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">dm1</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>    <span class="k">return</span> <span class="n">new_meshVariable</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a><span class="k">class</span> <span class="nc">_MeshVariable</span><span class="p">(</span><span class="n">Stateful</span><span class="p">,</span> <span class="n">uw_object</span><span class="p">):</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a><span class="sd">    The MeshVariable class generates a variable supported by a finite element mesh and the</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a><span class="sd">    underlying sympy representation that makes it possible to construct expressions that</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a><span class="sd">    depend on the values of the MeshVariable.</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a><span class="sd">    To set / read nodal values, use the numpy interface via the &#39;data&#39; property.</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a><span class="sd">    Parameters</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a><span class="sd">    ----------</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a><span class="sd">    varname :</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a><span class="sd">        A textual name for this variable.</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a><span class="sd">    mesh :</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a><span class="sd">        The supporting underworld mesh.</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a><span class="sd">    num_components :</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a><span class="sd">        The number of components this variable has.</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a><span class="sd">        For example, scalars will have `num_components=1`,</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a><span class="sd">        while a 2d vector would have `num_components=2`.</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a><span class="sd">    vtype :</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a><span class="sd">        Optional. The underworld variable type for this variable.</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a><span class="sd">        If not defined it will be inferred from `num_components`</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a><span class="sd">        if possible.</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a><span class="sd">    degree :</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a><span class="sd">        The polynomial degree for this variable.</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a><span class="sd">    varsymbol:</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a><span class="sd">        A symbolic form for printing etc (sympy / latex)</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>        <span class="n">varname</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>        <span class="n">mesh</span><span class="p">:</span> <span class="s2">&quot;underworld.mesh.Mesh&quot;</span><span class="p">,</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>        <span class="n">size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>        <span class="n">vtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;underworld.VarType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>        <span class="n">degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>        <span class="n">continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>        <span class="n">varsymbol</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>    <span class="p">):</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a><span class="sd">        The MeshVariable class generates a variable supported by a finite element mesh and the</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a><span class="sd">        underlying sympy representation that makes it possible to construct expressions that</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a><span class="sd">        depend on the values of the MeshVariable.</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a><span class="sd">        To set / read nodal values, use the numpy interface via the &#39;data&#39; property.</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a><span class="sd">        Parameters</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a><span class="sd">        ----------</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a><span class="sd">        varname :</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a><span class="sd">            A textual name for this variable.</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a><span class="sd">        mesh :</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a><span class="sd">            The supporting underworld mesh.</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a><span class="sd">        num_components :</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a><span class="sd">            The number of components this variable has.</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a><span class="sd">            For example, scalars will have `num_components=1`,</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a><span class="sd">            while a 2d vector would have `num_components=2`.</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a><span class="sd">        vtype :</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a><span class="sd">            Optional. The underworld variable type for this variable.</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a><span class="sd">            If not defined it will be inferred from `num_components`</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a><span class="sd">            if possible.</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a><span class="sd">        degree :</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a><span class="sd">            The polynomial degree for this variable.</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a><span class="sd">        continuous:</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a><span class="sd">            True for continuous element discretisation across element boundaries.</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a><span class="sd">            False for discontinuous values across element boundaries.</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a><span class="sd">        varsymbol :</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a><span class="sd">            A symbolic form for printing etc (sympy / latex)</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>        <span class="kn">import</span> <span class="nn">re</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>        <span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>        <span class="k">if</span> <span class="n">varsymbol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>            <span class="n">varsymbol</span> <span class="o">=</span> <span class="n">varname</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">varname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="sa">R</span><span class="s2">&quot; ... &quot;</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>            <span class="n">symbol</span> <span class="o">=</span> <span class="n">varsymbol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="sa">R</span><span class="s2">&quot;\cdots&quot;</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">varname</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>            <span class="n">symbol</span> <span class="o">=</span> <span class="n">varsymbol</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_available</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clean_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9_]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>        <span class="c1"># ToDo: Suggest we deprecate this and require it to be set explicitly</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>        <span class="c1"># The tensor types are hard to infer correctly</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>        <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>                <span class="n">vtype</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SCALAR</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">==</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>                <span class="n">vtype</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">VECTOR</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>                <span class="k">if</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="ow">and</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">TENSOR</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">MATRIX</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>                    <span class="s2">&quot;Unable to infer variable type from `num_components`. Please explicitly set the `vtype` parameter.&quot;</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>                <span class="p">)</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vtype</span><span class="p">,</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="p">):</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>                <span class="s2">&quot;&#39;vtype&#39; must be an instance of &#39;Variable_Type&#39;, for example `underworld.VarType.SCALAR`.&quot;</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>            <span class="p">)</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vtype</span> <span class="o">=</span> <span class="n">vtype</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">continuous</span> <span class="o">=</span> <span class="n">continuous</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>        <span class="c1"># First create the petsc FE object of the</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>        <span class="c1"># correct size / dimension to represent the</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>        <span class="c1"># unknowns when used in computations (for tensors)</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>        <span class="c1"># we will need to pack them correctly as well</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>        <span class="c1"># (e.g. T.sym.reshape(1,len(T.sym))))</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>        <span class="c1"># Symmetric tensors ... a bit more work again</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>        <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SCALAR</span><span class="p">:</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">VECTOR</span><span class="p">:</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">TENSOR</span><span class="p">:</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SYM_TENSOR</span><span class="p">:</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">MATRIX</span><span class="p">:</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data_container</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>        <span class="c1"># create associated sympy function</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>        <span class="kn">from</span> <span class="nn">underworld3.function</span> <span class="kn">import</span> <span class="n">UnderworldFunction</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>        <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SCALAR</span><span class="p">:</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">UnderworldFunction</span><span class="p">(</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>                <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>                <span class="n">vtype</span><span class="p">,</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>                <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>                <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>            <span class="p">)(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ijk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">VECTOR</span><span class="p">:</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">):</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">UnderworldFunction</span><span class="p">(</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>                    <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>                    <span class="n">vtype</span><span class="p">,</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>                    <span class="n">comp</span><span class="p">,</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>                    <span class="n">comp</span><span class="p">,</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>                <span class="p">)(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ijk</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">matrix_to_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">TENSOR</span><span class="p">:</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>            <span class="c1"># Matrix form (any number of components)</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">):</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">):</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">UnderworldFunction</span><span class="p">(</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>                        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>                        <span class="n">vtype</span><span class="p">,</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>                        <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_layout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>                    <span class="p">)(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SYM_TENSOR</span><span class="p">:</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>            <span class="c1"># Matrix form (any number of components)</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">):</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">):</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>                    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">:</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">UnderworldFunction</span><span class="p">(</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>                            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>                            <span class="n">vtype</span><span class="p">,</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>                            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">_data_layout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>                        <span class="p">)(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">MATRIX</span><span class="p">:</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>            <span class="c1"># Matrix form (any number of components)</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">UnderworldFunction</span><span class="p">(</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>                        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>                        <span class="n">vtype</span><span class="p">,</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>                        <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_layout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>                    <span class="p">)(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>        <span class="c1"># This allows us to define a __getitem__ method</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>        <span class="c1"># to return a view for a given component when</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>        <span class="c1"># the access manager is active</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>        <span class="n">MeshVariable_ij</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;MeshVariable_ij&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;sym&quot;</span><span class="p">])</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">MeshVariable_ij</span><span class="p">(</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>                    <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MeshVariable[...].data is only available within mesh.access() context&quot;</span><span class="p">,</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>                    <span class="n">sym</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>                <span class="p">)</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_ds</span><span class="p">()</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>        <span class="k">return</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">varsymbol</span><span class="p">):</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>        <span class="n">newMeshVariable</span> <span class="o">=</span> <span class="n">MeshVariable</span><span class="p">(</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>            <span class="n">varname</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>            <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>            <span class="n">num_components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>            <span class="n">vtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vtype</span><span class="p">,</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>            <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>            <span class="n">continuous</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">continuous</span><span class="p">,</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>            <span class="n">varsymbol</span><span class="o">=</span><span class="n">varsymbol</span><span class="p">,</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>        <span class="p">)</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>        <span class="k">return</span> <span class="n">newMeshVariable</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">indices</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>                    <span class="s2">&quot;MeshVariable[i,j] access requires one or two indices &quot;</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>                <span class="p">)</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">indices</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>    <span class="c1"># We should be careful - this is an INTERPOLATION</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>    <span class="c1"># that is stable when used for EXTRAPOLATION but</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>    <span class="c1"># not accurate.</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>    <span class="k">def</span> <span class="nf">rbf_interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_coords</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nnn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>        <span class="c1"># An inverse-distance mapping is quite robust here ... as long</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>        <span class="c1"># as long we take care of the case where some nodes coincide (likely if used mesh2mesh)</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>        <span class="k">if</span> <span class="n">nnn</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>                <span class="n">nnn</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>                <span class="n">nnn</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>            <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building K-D tree&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>        <span class="n">mesh_kdt</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">kdtree</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>        <span class="n">mesh_kdt</span><span class="o">.</span><span class="n">build_index</span><span class="p">()</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">mesh_kdt</span><span class="o">.</span><span class="n">rbf_interpolator_local</span><span class="p">(</span><span class="n">new_coords</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">nnn</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>        <span class="k">del</span> <span class="n">mesh_kdt</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>        <span class="k">return</span> <span class="n">values</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>    <span class="p">):</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a><span class="sd">        Append variable data to the specified mesh hdf5</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a><span class="sd">        data file. The file must already exist.</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a><span class="sd">        Parameters</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a><span class="sd">        ----------</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a><span class="sd">        filename :</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a><span class="sd">            The filename of the mesh checkpoint file. It</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a><span class="sd">            must already exist.</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a><span class="sd">        name :</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a><span class="sd">            Textual name for dataset. In particular, this</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a><span class="sd">            will be used for XDMF generation. If not</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a><span class="sd">            provided, the variable name will be used.</span>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a><span class="sd">        index :</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a><span class="sd">            Not currently supported. An optional index which</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a><span class="sd">            might correspond to the timestep (for example).</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_vec</span><span class="p">(</span><span class="n">available</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Recording `index` not currently supported&quot;</span><span class="p">)</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>            <span class="c1">## JM:To enable timestep recording, the following needs to be called.</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>            <span class="c1">## I&#39;m unsure if the corresponding xdmf functionality is enabled via</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>            <span class="c1">## the PETSc xdmf script.</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>            <span class="c1"># PetscViewerHDF5PushTimestepping(cviewer)</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>            <span class="c1"># viewer.setTimestep(index)</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>            <span class="n">oldname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>        <span class="n">lvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinates</span><span class="p">()</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>    <span class="c1"># ToDo: rename to vertex_checkpoint (or similar)</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>    <span class="p">):</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a><span class="sd">        Write variable data to the specified mesh hdf5</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a><span class="sd">        data file. The file will be over-written.</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a><span class="sd">        Parameters</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a><span class="sd">        ----------</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a><span class="sd">        filename :</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a><span class="sd">            The filename of the mesh checkpoint file</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_vec</span><span class="p">(</span><span class="n">available</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>        <span class="c1"># Variable coordinates - let&#39;s put those in the file to</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>        <span class="c1"># make it a standalone &quot;swarm&quot;</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>        <span class="n">dmold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinateDM</span><span class="p">()</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>        <span class="n">dmold</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>        <span class="n">dmnew</span> <span class="o">=</span> <span class="n">dmold</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;coordinterp_petscspace_degree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;coordinterp_petscdualspace_lagrange_continuity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;coordinterp_petscdualspace_lagrange_node_endpoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>        <span class="n">dmfe</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">FE</span><span class="p">()</span><span class="o">.</span><span class="n">createDefault</span><span class="p">(</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">cdim</span><span class="p">,</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">qdegree</span><span class="p">,</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>            <span class="s2">&quot;coordinterp_&quot;</span><span class="p">,</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>        <span class="p">)</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">setField</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dmfe</span><span class="p">)</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>        <span class="n">lvec</span> <span class="o">=</span> <span class="n">dmnew</span><span class="o">.</span><span class="n">getLocalVec</span><span class="p">()</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>        <span class="n">gvec</span> <span class="o">=</span> <span class="n">dmnew</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>        <span class="n">lvec</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">]</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">localToGlobal</span><span class="p">(</span><span class="n">lvec</span><span class="p">,</span> <span class="n">gvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>        <span class="n">gvec</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;coordinates&quot;</span><span class="p">)</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>        <span class="c1"># Check that this is also synchronised</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>        <span class="c1"># self.mesh.dm.localToGlobal(self._lvec, self._gvec, addv=False)</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="n">gvec</span><span class="p">)</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">gvec</span><span class="p">)</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">restoreLocalVec</span><span class="p">(</span><span class="n">lvec</span><span class="p">)</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>        <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>        <span class="n">dmfe</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>        <span class="k">return</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>    <span class="k">def</span> <span class="nf">read_timestep</span><span class="p">(</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>        <span class="n">data_filename</span><span class="p">,</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>        <span class="n">data_name</span><span class="p">,</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a>        <span class="n">index</span><span class="p">,</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a>        <span class="n">outputPath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>    <span class="p">):</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a><span class="sd">        Read a mesh variable from an arbitrary vertex-based checkpoint file</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a><span class="sd">        and reconstruct/interpolate the data field accordingly. The data sizes / meshes can be</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a><span class="sd">        different and will be matched using a kd-tree / inverse-distance weighting</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a><span class="sd">        to the new mesh.</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>        <span class="c1"># Fix this to match the write_timestep function</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>        <span class="c1"># mesh.write_timestep( &quot;test&quot;, meshUpdates=False, meshVars=[X], outputPath=&quot;&quot;, index=0)</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>        <span class="c1"># swarm.write_timestep(&quot;test&quot;, &quot;swarm&quot;, swarmVars=[var], outputPath=&quot;&quot;, index=0)</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>        <span class="n">output_base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="n">data_filename</span><span class="p">)</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>        <span class="n">data_file</span> <span class="o">=</span> <span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a>        <span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_vec</span><span class="p">(</span><span class="n">available</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>        <span class="c1">## Sub functions that are used to read / interpolate the mesh.</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>        <span class="k">def</span> <span class="nf">field_from_checkpoint</span><span class="p">(</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a>            <span class="n">data_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a>            <span class="n">data_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>        <span class="p">):</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Read the mesh data as a swarm-like value&quot;&quot;&quot;</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading data file </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>            <span class="n">h5f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>            <span class="n">D</span> <span class="o">=</span> <span class="n">h5f</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">][</span><span class="n">data_name</span><span class="p">][()]</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">h5f</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">][()]</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>            <span class="n">h5f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>                <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>            <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a>        <span class="k">def</span> <span class="nf">map_to_vertex_values</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">nnn</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a>            <span class="c1"># Map from &quot;swarm&quot; of points to nodal points</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a>            <span class="c1"># This is a permutation if we building on the checkpointed</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>            <span class="c1"># mesh file</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>            <span class="n">mesh_kdt</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">kdtree</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>            <span class="n">mesh_kdt</span><span class="o">.</span><span class="n">build_index</span><span class="p">()</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>            <span class="k">return</span> <span class="n">mesh_kdt</span><span class="o">.</span><span class="n">rbf_interpolator_local</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">nnn</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a>        <span class="k">def</span> <span class="nf">values_to_mesh_var</span><span class="p">(</span><span class="n">mesh_variable</span><span class="p">,</span> <span class="n">Values</span><span class="p">):</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>            <span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh_variable</span><span class="o">.</span><span class="n">mesh</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>            <span class="c1"># This should be trivial but there may be problems if</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a>            <span class="c1"># the kdtree does not have enough neighbours to allocate</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>            <span class="c1"># values for every point. We handle that here.</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>            <span class="k">with</span> <span class="n">mesh</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">mesh_variable</span><span class="p">):</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a>                <span class="n">mesh_variable</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">Values</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a>            <span class="k">return</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">field_from_checkpoint</span><span class="p">(</span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>            <span class="n">data_file</span><span class="p">,</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a>            <span class="n">data_name</span><span class="p">,</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a>        <span class="p">)</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>        <span class="n">remapped_D</span> <span class="o">=</span> <span class="n">map_to_vertex_values</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a>        <span class="c1"># This is empty at the moment</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a>        <span class="n">values_to_mesh_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remapped_D</span><span class="p">)</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>        <span class="k">return</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>    <span class="k">def</span> <span class="nf">load_from_h5_plex_vector</span><span class="p">(</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>        <span class="n">data_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>    <span class="p">):</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>        <span class="k">if</span> <span class="n">data_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>            <span class="n">data_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_name</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a>            <span class="n">indexset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>            <span class="n">old_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a>            <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">data_name</span><span class="p">)</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>            <span class="n">subdm</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>            <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a>        <span class="k">return</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>    <span class="nd">@property</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a>    <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Basic</span><span class="p">:</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a><span class="sd">        The handle to the (i,j,k) spatial view of this variable if it exists (deprecated)</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ijk</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>    <span class="nd">@property</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>    <span class="k">def</span> <span class="nf">ijk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Basic</span><span class="p">:</span>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a><span class="sd">        The handle to the (i,j,k) spatial view of this variable if it exists</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ijk</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>    <span class="nd">@property</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>    <span class="k">def</span> <span class="nf">sym</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Basic</span><span class="p">:</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a><span class="sd">        The handle to the sympy.Matrix view of this variable</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>    <span class="nd">@property</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>    <span class="k">def</span> <span class="nf">sym_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Basic</span><span class="p">:</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a><span class="sd">        The handle to a flattened version of the sympy.Matrix view of this variable.</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a><span class="sd">        Assume components are stored in the same order that sympy iterates entries in</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a><span class="sd">        a matrix except for the symmetric tensor case where we store in a Voigt form</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtype</span> <span class="o">!=</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SYM_TENSOR</span><span class="p">:</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">))</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>                <span class="k">return</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>                    <span class="p">[</span>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>                    <span class="p">]</span>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>                <span class="k">return</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>                    <span class="p">[</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sym</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>                    <span class="p">]</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>    <span class="k">def</span> <span class="nf">_data_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>        <span class="c1"># mapping</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SCALAR</span><span class="p">:</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">VECTOR</span><span class="p">:</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a>            <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a>                <span class="k">return</span> <span class="n">i</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>                <span class="k">return</span> <span class="n">j</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>                    <span class="sa">f</span><span class="s2">&quot;Vectors have shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>                <span class="p">)</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">TENSOR</span><span class="p">:</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>                <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a>                <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">))[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SYM_TENSOR</span><span class="p">:</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a>                <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a>                <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtype</span> <span class="o">==</span> <span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">MATRIX</span><span class="p">:</span>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a>            <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>    <span class="k">def</span> <span class="nf">_setup_ds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>        <span class="n">name0</span> <span class="o">=</span> <span class="s2">&quot;VAR&quot;</span>  <span class="c1"># self.clean_name ## Filling up the options database</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name0</span><span class="si">}</span><span class="s2">_petscspace_degree&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name0</span><span class="si">}</span><span class="s2">_petscdualspace_lagrange_continuity&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous</span><span class="p">)</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name0</span><span class="si">}</span><span class="s2">_petscdualspace_lagrange_node_endpoints&quot;</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a>        <span class="p">)</span>  <span class="c1"># only active if discontinuous</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a>        <span class="n">petsc_fe</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">FE</span><span class="p">()</span><span class="o">.</span><span class="n">createDefault</span><span class="p">(</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a>            <span class="n">dim</span><span class="p">,</span>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span><span class="p">,</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">qdegree</span><span class="p">,</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>            <span class="n">name0</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a>        <span class="p">)</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getNumFields</span><span class="p">()</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">addField</span><span class="p">(</span><span class="n">petsc_fe</span><span class="p">)</span>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>        <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getField</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a>        <span class="n">field</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_name</span><span class="p">)</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>        <span class="k">return</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>    <span class="k">def</span> <span class="nf">_set_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">available</span><span class="p">):</span>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>            <span class="n">indexset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="n">subdm</span><span class="o">.</span><span class="n">createLocalVector</span><span class="p">()</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="o">.</span><span class="n">zeroEntries</span><span class="p">()</span>  <span class="c1"># not sure if required, but to be sure.</span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span> <span class="o">=</span> <span class="n">subdm</span><span class="o">.</span><span class="n">createGlobalVector</span><span class="p">()</span>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_name</span><span class="p">)</span>  <span class="c1"># This is set for checkpointing.</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">zeroEntries</span><span class="p">()</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_available</span> <span class="o">=</span> <span class="n">available</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a>    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="p">:</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a>    <span class="nd">@property</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a>    <span class="k">def</span> <span class="nf">vec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Vec</span><span class="p">:</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a><span class="sd">        The corresponding PETSc local vector for this variable.</span>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available</span><span class="p">:</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>                <span class="s2">&quot;Vector must be accessed via the mesh `access()` context manager.&quot;</span>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>            <span class="p">)</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a>    <span class="nd">@property</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a><span class="sd">        Numpy proxy array to underlying variable data.</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a><span class="sd">        Note that the returned array is a proxy for all the *local* nodal</span>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a><span class="sd">        data, and is provided as 1d list.</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a><span class="sd">        For both read and write, this array can only be accessed via the</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a><span class="sd">        mesh `access()` context manager.</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>                <span class="s2">&quot;Data must be accessed via the mesh `access()` context manager.&quot;</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>            <span class="p">)</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>    <span class="c1">## ToDo: We should probably deprecate this in favour of using integrals</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a><span class="sd">        The global variable minimum value.</span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;It doesn&#39;t appear that any data has been set.&quot;</span><span class="p">)</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">strideMin</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_components</span><span class="p">)]</span>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a>            <span class="p">)</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a><span class="sd">        The global variable maximum value.</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;It doesn&#39;t appear that any data has been set.&quot;</span><span class="p">)</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a>            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">strideMax</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_components</span><span class="p">)]</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a>            <span class="p">)</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a>    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a><span class="sd">        The global variable sum value.</span>
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;It doesn&#39;t appear that any data has been set.&quot;</span><span class="p">)</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a>            <span class="n">cpts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span><span class="p">):</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a>                <span class="n">cpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">strideSum</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a>            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cpts</span><span class="p">)</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a>    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a><span class="sd">        The global variable norm value.</span>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a><span class="sd">        norm_type: type of norm, one of</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a><span class="sd">            - 0: NORM 1 ||v|| = sum_i | v_i |. ||A|| = max_j || v_*j ||</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a><span class="sd">            - 1: NORM 2 ||v|| = sqrt(sum_i |v_i|^2) (vectors only)</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a><span class="sd">            - 3: NORM INFINITY ||v|| = max_i |v_i|. ||A|| = max_i || v_i* ||, maximum row sum</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;It doesn&#39;t appear that any data has been set.&quot;</span><span class="p">)</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Norm 2 is only available for vectors.&quot;</span><span class="p">)</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">norm_type</span><span class="p">)</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>                <span class="p">[</span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">strideNorm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">)</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_components</span><span class="p">)</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>                <span class="p">]</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>            <span class="p">)</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a><span class="sd">        The global variable mean value.</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;It doesn&#39;t appear that any data has been set.&quot;</span><span class="p">)</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>            <span class="n">vecsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">vecsize</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>            <span class="n">vecsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">strideSum</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">vecsize</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_components</span><span class="p">)]</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>            <span class="p">)</span>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a><span class="sd">        The equivalent of mesh.stats but using the native coordinates for this variable</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a><span class="sd">        Not set up for vector variables so we just skip that for now.</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a><span class="sd">        Returns various norms on the mesh using the native mesh discretisation for this</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a><span class="sd">        variable. It is a wrapper on the various _gvec stats routines for the variable.</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a><span class="sd">          - size</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a><span class="sd">          - mean</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a><span class="sd">          - min</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a><span class="sd">          - max</span>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a><span class="sd">          - sum</span>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a><span class="sd">          - L2 norm</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a><span class="sd">          - rms</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_components</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>                <span class="s2">&quot;stats not available for multi-component variables&quot;</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>            <span class="p">)</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>        <span class="c1">#       This uses a private work MeshVariable and the various norms defined there but</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>        <span class="c1">#       could either be simplified to just use petsc vectors, or extended to</span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>        <span class="c1">#       compute integrals over the elements which is in line with uw1 and uw2</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a>        <span class="kn">from</span> <span class="nn">petsc4py.PETSc</span> <span class="kn">import</span> <span class="n">NormType</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>        <span class="n">vsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>        <span class="n">vmean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>        <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>        <span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a>        <span class="n">vsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a>        <span class="n">vnorm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">NormType</span><span class="o">.</span><span class="n">NORM_2</span><span class="p">)</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a>        <span class="n">vrms</span> <span class="o">=</span> <span class="n">vnorm2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vsize</span><span class="p">)</span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a>        <span class="k">return</span> <span class="n">vsize</span><span class="p">,</span> <span class="n">vmean</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">vsum</span><span class="p">,</span> <span class="n">vnorm2</span><span class="p">,</span> <span class="n">vrms</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>    <span class="nd">@property</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a><span class="sd">        The array of variable vertex coordinates.</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">_get_coords_for_var</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a>    <span class="c1"># vector calculus routines - the advantage of using these inbuilt routines is</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>    <span class="c1"># that they are tied to the appropriate mesh definition.</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a>    <span class="k">def</span> <span class="nf">divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">divergence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym</span><span class="p">)</span>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a>    <span class="k">def</span> <span class="nf">gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym</span><span class="p">)</span>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a>    <span class="k">def</span> <span class="nf">curl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">curl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym</span><span class="p">)</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>    <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>        <span class="c1">## validate if this is a vector ?</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sym</span><span class="p">)</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a><span class="c1">## This is a temporary replacement for the PETSc xdmf generator</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a><span class="c1">## Simplified to allow us to decide how we want to checkpoint</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a><span class="k">def</span> <span class="nf">checkpoint_xdmf</span><span class="p">(</span>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>    <span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>    <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>    <span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a><span class="p">):</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>    <span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>    <span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create xdmf file for checkpoints&quot;&quot;&quot;</span>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>    <span class="c1">## Identify the mesh file. Use the</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>    <span class="c1">## zeroth one if this option is turned off</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">meshUpdates</span><span class="p">:</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>        <span class="n">mesh_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.mesh.00000.h5&quot;</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>        <span class="n">mesh_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>    <span class="c1">## Obtain the mesh information</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>    <span class="n">h5</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">mesh_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a>    <span class="k">if</span> <span class="s2">&quot;viz&quot;</span> <span class="ow">in</span> <span class="n">h5</span> <span class="ow">and</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">in</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;viz&quot;</span><span class="p">]:</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a>        <span class="n">geomPath</span> <span class="o">=</span> <span class="s2">&quot;viz/geometry&quot;</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a>        <span class="n">geom</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;viz&quot;</span><span class="p">][</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a>        <span class="n">geomPath</span> <span class="o">=</span> <span class="s2">&quot;geometry&quot;</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>        <span class="n">geom</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>    <span class="k">if</span> <span class="s2">&quot;viz&quot;</span> <span class="ow">in</span> <span class="n">h5</span> <span class="ow">and</span> <span class="s2">&quot;topology&quot;</span> <span class="ow">in</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;viz&quot;</span><span class="p">]:</span>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a>        <span class="n">topoPath</span> <span class="o">=</span> <span class="s2">&quot;viz/topology&quot;</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>        <span class="n">topo</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;viz&quot;</span><span class="p">][</span><span class="s2">&quot;topology&quot;</span><span class="p">]</span>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>        <span class="n">topoPath</span> <span class="o">=</span> <span class="s2">&quot;topology&quot;</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>        <span class="n">topo</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;topology&quot;</span><span class="p">]</span>
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>    <span class="n">vertices</span> <span class="o">=</span> <span class="n">geom</span><span class="p">[</span><span class="s2">&quot;vertices&quot;</span><span class="p">]</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>    <span class="n">numVertices</span> <span class="o">=</span> <span class="n">vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>    <span class="n">spaceDim</span> <span class="o">=</span> <span class="n">vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a>    <span class="n">cells</span> <span class="o">=</span> <span class="n">topo</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a>    <span class="n">numCells</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>    <span class="n">numCorners</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>    <span class="n">cellDim</span> <span class="o">=</span> <span class="n">topo</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cell_dim&quot;</span><span class="p">]</span>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a>    <span class="n">h5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>    <span class="c1"># We only use a subset of the possible cell types</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>    <span class="k">if</span> <span class="n">spaceDim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a>        <span class="k">if</span> <span class="n">numCorners</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a>            <span class="n">topology_type</span> <span class="o">=</span> <span class="s2">&quot;Triangle&quot;</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>            <span class="n">topology_type</span> <span class="o">=</span> <span class="s2">&quot;Quadrilateral&quot;</span>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>        <span class="n">geomType</span> <span class="o">=</span> <span class="s2">&quot;XY&quot;</span>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>        <span class="k">if</span> <span class="n">numCorners</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>            <span class="n">topology_type</span> <span class="o">=</span> <span class="s2">&quot;Tetrahedron&quot;</span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>            <span class="n">topology_type</span> <span class="o">=</span> <span class="s2">&quot;Hexahedron&quot;</span>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>        <span class="n">geomType</span> <span class="o">=</span> <span class="s2">&quot;XYZ&quot;</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>    <span class="c1">## Create the header</span>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a><span class="s2">&lt;!DOCTYPE Xdmf SYSTEM &quot;Xdmf.dtd&quot; [</span>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a><span class="s2">&lt;!ENTITY MeshData &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mesh_filename</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a>        <span class="n">var_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a>        <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a><span class="s2">&lt;!ENTITY </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">_Data &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">var_filename</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&gt;&quot;&quot;&quot;</span>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a>    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a>        <span class="n">var_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.proxy.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a>        <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a><span class="s2">&lt;!ENTITY </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">_Data &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">var_filename</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&gt;&quot;&quot;&quot;</span>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a>    <span class="n">header</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a><span class="s2">]&gt;&quot;&quot;&quot;</span>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>    <span class="n">xdmf_start</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a><span class="s2">&lt;Xdmf&gt;</span>
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a><span class="s2">  &lt;Domain Name=&quot;domain&quot;&gt;</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a><span class="s2">    &lt;DataItem Name=&quot;cells&quot;</span>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a><span class="s2">              ItemType=&quot;Uniform&quot;</span>
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a><span class="s2">              Format=&quot;HDF&quot;</span>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a><span class="s2">              NumberType=&quot;Float&quot; Precision=&quot;8&quot;</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a><span class="s2">              Dimensions=&quot;</span><span class="si">{</span><span class="n">numCells</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">numCorners</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a><span class="s2">      &amp;MeshData;:/</span><span class="si">{</span><span class="n">topoPath</span><span class="si">}</span><span class="s2">/cells</span>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a><span class="s2">    &lt;/DataItem&gt;</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a><span class="s2">    &lt;DataItem Name=&quot;vertices&quot;</span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a><span class="s2">              Format=&quot;HDF&quot;</span>
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a><span class="s2">              Dimensions=&quot;</span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">spaceDim</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a><span class="s2">      &amp;MeshData;:/</span><span class="si">{</span><span class="n">geomPath</span><span class="si">}</span><span class="s2">/vertices</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a><span class="s2">    &lt;/DataItem&gt;</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a><span class="s2">    &lt;!-- ============================================================ --&gt;</span>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a><span class="s2">      &lt;Grid Name=&quot;domain&quot; GridType=&quot;Uniform&quot;&gt;</span>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a><span class="s2">        &lt;Topology</span>
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a><span class="s2">           TopologyType=&quot;</span><span class="si">{</span><span class="n">topology_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a><span class="s2">           NumberOfElements=&quot;</span><span class="si">{</span><span class="n">numCells</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a><span class="s2">          &lt;DataItem Reference=&quot;XML&quot;&gt;</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a><span class="s2">            /Xdmf/Domain/DataItem[@Name=&quot;cells&quot;]</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a><span class="s2">          &lt;/DataItem&gt;</span>
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a><span class="s2">        &lt;/Topology&gt;</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a><span class="s2">        &lt;Geometry GeometryType=&quot;</span><span class="si">{</span><span class="n">geomType</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a><span class="s2">          &lt;DataItem Reference=&quot;XML&quot;&gt;</span>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a><span class="s2">            /Xdmf/Domain/DataItem[@Name=&quot;vertices&quot;]</span>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a><span class="s2">          &lt;/DataItem&gt;</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a><span class="s2">        &lt;/Geometry&gt;</span>
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a>    <span class="c1">## The mesh Var attributes</span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a>    <span class="n">attributes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a>    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a>        <span class="n">var_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;mesh.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a>        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">num_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a>            <span class="n">variable_type</span> <span class="o">=</span> <span class="s2">&quot;Scalar&quot;</span>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a>            <span class="n">variable_type</span> <span class="o">=</span> <span class="s2">&quot;Vector&quot;</span>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a>        <span class="c1"># We should add a tensor type here ...</span>
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a>        <span class="n">var_attribute</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a><span class="s2">        &lt;Attribute</span>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a><span class="s2">           Name=&quot;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a><span class="s2">           Type=&quot;</span><span class="si">{</span><span class="n">variable_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a><span class="s2">           Center=&quot;Node&quot;&gt;</span>
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a><span class="s2">          &lt;DataItem ItemType=&quot;HyperSlab&quot;</span>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a><span class="s2">        	    Dimensions=&quot;1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a><span class="s2">        	    Type=&quot;HyperSlab&quot;&gt;</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a><span class="s2">            &lt;DataItem</span>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a><span class="s2">               Dimensions=&quot;3 3&quot;</span>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a><span class="s2">               Format=&quot;XML&quot;&gt;</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a><span class="s2">              0 0 0</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a><span class="s2">              1 1 1</span>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a><span class="s2">              1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a><span class="s2">            &lt;/DataItem&gt;</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a><span class="s2">            &lt;DataItem</span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a><span class="s2">               DataType=&quot;Float&quot; Precision=&quot;8&quot;</span>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a><span class="s2">               Dimensions=&quot;1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a><span class="s2">               Format=&quot;HDF&quot;&gt;</span>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a><span class="s2">              &amp;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="o">+</span><span class="s2">&quot;_Data&quot;</span><span class="si">}</span><span class="s2">;:/vertex_fields/</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="o">+</span><span class="s2">&quot;_P&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a><span class="s2">            &lt;/DataItem&gt;</span>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a><span class="s2">          &lt;/DataItem&gt;</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a><span class="s2">        &lt;/Attribute&gt;</span>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a><span class="s2">    &quot;&quot;&quot;</span>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a>        <span class="n">attributes</span> <span class="o">+=</span> <span class="n">var_attribute</span>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a>    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a>        <span class="n">var_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.proxy.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">num_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a>            <span class="n">variable_type</span> <span class="o">=</span> <span class="s2">&quot;Scalar&quot;</span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a>            <span class="n">variable_type</span> <span class="o">=</span> <span class="s2">&quot;Vector&quot;</span>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a>        <span class="c1"># We should add a tensor type here ...</span>
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a>        <span class="n">var_attribute</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a><span class="s2">        &lt;Attribute</span>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a><span class="s2">           Name=&quot;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a><span class="s2">           Type=&quot;</span><span class="si">{</span><span class="n">variable_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a><span class="s2">           Center=&quot;Node&quot;&gt;</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a><span class="s2">          &lt;DataItem ItemType=&quot;HyperSlab&quot;</span>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a><span class="s2">        	    Dimensions=&quot;1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a><span class="s2">        	    Type=&quot;HyperSlab&quot;&gt;</span>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a><span class="s2">            &lt;DataItem</span>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a><span class="s2">               Dimensions=&quot;3 3&quot;</span>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a><span class="s2">               Format=&quot;XML&quot;&gt;</span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a><span class="s2">              0 0 0</span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a><span class="s2">              1 1 1</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a><span class="s2">              1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a><span class="s2">            &lt;/DataItem&gt;</span>
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a><span class="s2">            &lt;DataItem</span>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a><span class="s2">               DataType=&quot;Float&quot; Precision=&quot;8&quot;</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a><span class="s2">               Dimensions=&quot;1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a><span class="s2">               Format=&quot;HDF&quot;&gt;</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a><span class="s2">              &amp;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="o">+</span><span class="s2">&quot;_Data&quot;</span><span class="si">}</span><span class="s2">;:/vertex_fields/</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="o">+</span><span class="s2">&quot;_P&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">_meshVar</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a><span class="s2">            &lt;/DataItem&gt;</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a><span class="s2">          &lt;/DataItem&gt;</span>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a><span class="s2">        &lt;/Attribute&gt;</span>
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a><span class="s2">    &quot;&quot;&quot;</span>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a>        <span class="n">attributes</span> <span class="o">+=</span> <span class="n">var_attribute</span>
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a>
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a>    <span class="n">xdmf_end</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a><span class="s2">    &lt;/Grid&gt;</span>
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a><span class="s2">  &lt;/Domain&gt;</span>
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a><span class="s2">&lt;/Xdmf&gt;</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a><span class="s2">    &quot;&quot;&quot;</span>
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a>    <span class="n">xdmf_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.xdmf&quot;</span>
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xdmf_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xdmf_start</span><span class="p">)</span>
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xdmf_end</span><span class="p">)</span>
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a>    <span class="k">return</span>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a>
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a><span class="k">def</span> <span class="nf">meshVariable_lookup_by_symbol</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">sympy_object</span><span class="p">):</span>
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a sympy object, scan the mesh variables in `mesh` to find the</span>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a><span class="sd">    location (meshvariable, component in the data array) corresponding to the symbol</span>
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a><span class="sd">    or return None if not found</span>
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a>
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>    <span class="k">for</span> <span class="n">meshvar</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a>        <span class="k">if</span> <span class="n">meshvar</span><span class="o">.</span><span class="n">sym</span> <span class="o">==</span> <span class="n">sympy_object</span><span class="p">:</span>
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>            <span class="k">return</span> <span class="n">meshvar</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a>            <span class="k">for</span> <span class="n">comp</span><span class="p">,</span> <span class="n">subvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">meshvar</span><span class="o">.</span><span class="n">sym_1d</span><span class="p">):</span>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a>                <span class="k">if</span> <span class="n">subvar</span> <span class="o">==</span> <span class="n">sympy_object</span><span class="p">:</span>
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a>                    <span class="k">return</span> <span class="n">meshvar</span><span class="p">,</span> <span class="n">comp</span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a>
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a>
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a>
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a><span class="k">def</span> <span class="nf">petsc_dm_find_labeled_points_local</span><span class="p">(</span>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a>    <span class="n">dm</span><span class="p">,</span> <span class="n">label_name</span><span class="p">,</span> <span class="n">label_value</span><span class="p">,</span> <span class="n">sectionIndex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a><span class="p">):</span>
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify local points associated with &quot;Label&quot;</span>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a><span class="sd">    dm -&gt; expects a petscDM object</span>
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a><span class="sd">    label_name -&gt; &quot;String Name for Label&quot;</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a><span class="sd">    sectionIndex -&gt; False: leave points as indexed by the relevant section on the dm</span>
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a><span class="sd">                    True: index into the local coordinate array</span>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a><span class="sd">    NOTE: Assumes uniform element types</span>
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>    <span class="n">pStart</span><span class="p">,</span> <span class="n">pEnd</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getDepthStratum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>    <span class="n">eStart</span><span class="p">,</span> <span class="n">eEnd</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getDepthStratum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>    <span class="n">fStart</span><span class="p">,</span> <span class="n">fEnd</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getDepthStratum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a>    <span class="c1"># print(f&quot;Label: {label_name} / {label_value}&quot;)</span>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a>    <span class="c1"># print(f&quot;points: {pStart}: {pEnd}&quot;)</span>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a>    <span class="c1"># print(f&quot;edges : {eStart}: {eEnd}&quot;)</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a>    <span class="c1"># print(f&quot;faces : {fStart}: {fEnd}&quot;)</span>
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a>    <span class="c1"># print(f&quot;&quot;, flush=True)</span>
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a>
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>    <span class="n">label</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">label_name</span><span class="p">)</span>
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label </span><span class="si">{</span><span class="n">label_name</span><span class="si">}</span><span class="s2"> is not present on the dm&quot;</span><span class="p">)</span>
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a>    <span class="n">pointIS</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getStratumIS</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a>    <span class="n">edgeIS</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getStratumIS</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a>    <span class="n">faceIS</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getStratumIS</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a>    <span class="n">point_indices</span> <span class="o">=</span> <span class="n">pointIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">()</span>
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>    <span class="n">edge_indices</span> <span class="o">=</span> <span class="n">edgeIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">()</span>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a>    <span class="n">face_indices</span> <span class="o">=</span> <span class="n">faceIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">()</span>
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a>
</span><span id="L-2572"><a href="#L-2572"><span class="linenos">2572</span></a>    <span class="c1"># _, iset_lab = label.convertToSection()</span>
</span><span id="L-2573"><a href="#L-2573"><span class="linenos">2573</span></a>    <span class="n">iset_lab</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">getStratumIS</span><span class="p">(</span><span class="n">label_value</span><span class="p">)</span>
</span><span id="L-2574"><a href="#L-2574"><span class="linenos">2574</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">iset_lab</span><span class="p">:</span>
</span><span id="L-2575"><a href="#L-2575"><span class="linenos">2575</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-2576"><a href="#L-2576"><span class="linenos">2576</span></a>
</span><span id="L-2577"><a href="#L-2577"><span class="linenos">2577</span></a>    <span class="c1"># We need to associate edges and faces with their point indices to</span>
</span><span id="L-2578"><a href="#L-2578"><span class="linenos">2578</span></a>    <span class="c1"># build a field representation</span>
</span><span id="L-2579"><a href="#L-2579"><span class="linenos">2579</span></a>
</span><span id="L-2580"><a href="#L-2580"><span class="linenos">2580</span></a>    <span class="n">IndicesP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">iset_lab</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(),</span> <span class="n">pointIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">())</span>
</span><span id="L-2581"><a href="#L-2581"><span class="linenos">2581</span></a>    <span class="n">IndicesE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">iset_lab</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(),</span> <span class="n">edgeIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">())</span>
</span><span id="L-2582"><a href="#L-2582"><span class="linenos">2582</span></a>    <span class="n">IndicesF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">iset_lab</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(),</span> <span class="n">faceIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">())</span>
</span><span id="L-2583"><a href="#L-2583"><span class="linenos">2583</span></a>
</span><span id="L-2584"><a href="#L-2584"><span class="linenos">2584</span></a>    <span class="c1"># print(f&quot;Label {label_name}&quot;)</span>
</span><span id="L-2585"><a href="#L-2585"><span class="linenos">2585</span></a>    <span class="c1"># print(f&quot;P -&gt; {len(IndicesP)}, E-&gt;{len(IndicesE)}, F-&gt;{len(IndicesF)},&quot;)</span>
</span><span id="L-2586"><a href="#L-2586"><span class="linenos">2586</span></a>
</span><span id="L-2587"><a href="#L-2587"><span class="linenos">2587</span></a>    <span class="n">IndicesFe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">IndicesF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dm</span><span class="o">.</span><span class="n">getConeSize</span><span class="p">(</span><span class="n">fStart</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-2588"><a href="#L-2588"><span class="linenos">2588</span></a>    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IndicesF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-2589"><a href="#L-2589"><span class="linenos">2589</span></a>        <span class="n">IndicesFe</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getCone</span><span class="p">(</span><span class="n">IndicesF</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
</span><span id="L-2590"><a href="#L-2590"><span class="linenos">2590</span></a>
</span><span id="L-2591"><a href="#L-2591"><span class="linenos">2591</span></a>    <span class="n">IndicesFE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">IndicesE</span><span class="p">,</span> <span class="n">IndicesFe</span><span class="p">)</span>
</span><span id="L-2592"><a href="#L-2592"><span class="linenos">2592</span></a>
</span><span id="L-2593"><a href="#L-2593"><span class="linenos">2593</span></a>    <span class="c1"># All faces are now recorded as edges</span>
</span><span id="L-2594"><a href="#L-2594"><span class="linenos">2594</span></a>
</span><span id="L-2595"><a href="#L-2595"><span class="linenos">2595</span></a>    <span class="n">IndicesFEP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">IndicesFE</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dm</span><span class="o">.</span><span class="n">getConeSize</span><span class="p">(</span><span class="n">eStart</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-2596"><a href="#L-2596"><span class="linenos">2596</span></a>
</span><span id="L-2597"><a href="#L-2597"><span class="linenos">2597</span></a>    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IndicesFE</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-2598"><a href="#L-2598"><span class="linenos">2598</span></a>        <span class="n">IndicesFEP</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getCone</span><span class="p">(</span><span class="n">IndicesFE</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
</span><span id="L-2599"><a href="#L-2599"><span class="linenos">2599</span></a>
</span><span id="L-2600"><a href="#L-2600"><span class="linenos">2600</span></a>    <span class="c1"># all faces / edges are now points</span>
</span><span id="L-2601"><a href="#L-2601"><span class="linenos">2601</span></a>
</span><span id="L-2602"><a href="#L-2602"><span class="linenos">2602</span></a>    <span class="k">if</span> <span class="n">sectionIndex</span><span class="p">:</span>
</span><span id="L-2603"><a href="#L-2603"><span class="linenos">2603</span></a>        <span class="n">Indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">IndicesP</span><span class="p">,</span> <span class="n">IndicesFEP</span><span class="p">)</span>
</span><span id="L-2604"><a href="#L-2604"><span class="linenos">2604</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2605"><a href="#L-2605"><span class="linenos">2605</span></a>        <span class="n">Indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">IndicesP</span><span class="p">,</span> <span class="n">IndicesFEP</span><span class="p">)</span> <span class="o">-</span> <span class="n">pStart</span>
</span><span id="L-2606"><a href="#L-2606"><span class="linenos">2606</span></a>
</span><span id="L-2607"><a href="#L-2607"><span class="linenos">2607</span></a>    <span class="k">return</span> <span class="n">Indices</span>
</span></pre></div>


            </section>
                <section id="Mesh">
                            <input id="Mesh-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Mesh</span><wbr>(<span class="base"><a href="utilities/_api_tools.html#Stateful">underworld3.utilities._api_tools.Stateful</a></span>, <span class="base"><a href="utilities/_api_tools.html#uw_object">underworld3.utilities._api_tools.uw_object</a></span>):

                <label class="view-source-button" for="Mesh-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh-129"><a href="#Mesh-129"><span class="linenos"> 129</span></a><span class="k">class</span> <span class="nc">Mesh</span><span class="p">(</span><span class="n">Stateful</span><span class="p">,</span> <span class="n">uw_object</span><span class="p">):</span>
</span><span id="Mesh-130"><a href="#Mesh-130"><span class="linenos"> 130</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-131"><a href="#Mesh-131"><span class="linenos"> 131</span></a><span class="sd">    Mesh class for uw - documentation needed</span>
</span><span id="Mesh-132"><a href="#Mesh-132"><span class="linenos"> 132</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Mesh-133"><a href="#Mesh-133"><span class="linenos"> 133</span></a>
</span><span id="Mesh-134"><a href="#Mesh-134"><span class="linenos"> 134</span></a>    <span class="n">mesh_instances</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Mesh-135"><a href="#Mesh-135"><span class="linenos"> 135</span></a>
</span><span id="Mesh-136"><a href="#Mesh-136"><span class="linenos"> 136</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh-137"><a href="#Mesh-137"><span class="linenos"> 137</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Mesh-138"><a href="#Mesh-138"><span class="linenos"> 138</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh-139"><a href="#Mesh-139"><span class="linenos"> 139</span></a>        <span class="n">plex_or_meshfile</span><span class="p">,</span>
</span><span id="Mesh-140"><a href="#Mesh-140"><span class="linenos"> 140</span></a>        <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Mesh-141"><a href="#Mesh-141"><span class="linenos"> 141</span></a>        <span class="n">simplex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Mesh-142"><a href="#Mesh-142"><span class="linenos"> 142</span></a>        <span class="n">coordinate_system_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-143"><a href="#Mesh-143"><span class="linenos"> 143</span></a>        <span class="n">qdegree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="Mesh-144"><a href="#Mesh-144"><span class="linenos"> 144</span></a>        <span class="n">markVertices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-145"><a href="#Mesh-145"><span class="linenos"> 145</span></a>        <span class="n">useRegions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-146"><a href="#Mesh-146"><span class="linenos"> 146</span></a>        <span class="n">useMultipleTags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-147"><a href="#Mesh-147"><span class="linenos"> 147</span></a>        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-148"><a href="#Mesh-148"><span class="linenos"> 148</span></a>        <span class="n">refinement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-149"><a href="#Mesh-149"><span class="linenos"> 149</span></a>        <span class="n">refinement_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-150"><a href="#Mesh-150"><span class="linenos"> 150</span></a>        <span class="n">return_coords_to_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-151"><a href="#Mesh-151"><span class="linenos"> 151</span></a>        <span class="n">boundaries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-152"><a href="#Mesh-152"><span class="linenos"> 152</span></a>        <span class="n">boundary_normals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-153"><a href="#Mesh-153"><span class="linenos"> 153</span></a>        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh-154"><a href="#Mesh-154"><span class="linenos"> 154</span></a>        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="Mesh-155"><a href="#Mesh-155"><span class="linenos"> 155</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Mesh-156"><a href="#Mesh-156"><span class="linenos"> 156</span></a>    <span class="p">):</span>
</span><span id="Mesh-157"><a href="#Mesh-157"><span class="linenos"> 157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">mesh_instances</span>
</span><span id="Mesh-158"><a href="#Mesh-158"><span class="linenos"> 158</span></a>        <span class="n">Mesh</span><span class="o">.</span><span class="n">mesh_instances</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Mesh-159"><a href="#Mesh-159"><span class="linenos"> 159</span></a>
</span><span id="Mesh-160"><a href="#Mesh-160"><span class="linenos"> 160</span></a>        <span class="n">comm</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span>
</span><span id="Mesh-161"><a href="#Mesh-161"><span class="linenos"> 161</span></a>
</span><span id="Mesh-162"><a href="#Mesh-162"><span class="linenos"> 162</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plex_or_meshfile</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">DMPlex</span><span class="p">):</span>
</span><span id="Mesh-163"><a href="#Mesh-163"><span class="linenos"> 163</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;plexmesh&quot;</span>
</span><span id="Mesh-164"><a href="#Mesh-164"><span class="linenos"> 164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">plex_or_meshfile</span>
</span><span id="Mesh-165"><a href="#Mesh-165"><span class="linenos"> 165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Should we build one ?</span>
</span><span id="Mesh-166"><a href="#Mesh-166"><span class="linenos"> 166</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-167"><a href="#Mesh-167"><span class="linenos"> 167</span></a>            <span class="n">comm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comm&quot;</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="Mesh-168"><a href="#Mesh-168"><span class="linenos"> 168</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">plex_or_meshfile</span>
</span><span id="Mesh-169"><a href="#Mesh-169"><span class="linenos"> 169</span></a>            <span class="n">basename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">plex_or_meshfile</span><span class="p">)</span>
</span><span id="Mesh-170"><a href="#Mesh-170"><span class="linenos"> 170</span></a>
</span><span id="Mesh-171"><a href="#Mesh-171"><span class="linenos"> 171</span></a>            <span class="c1"># Note: should be able to handle a .geo as well on this pathway</span>
</span><span id="Mesh-172"><a href="#Mesh-172"><span class="linenos"> 172</span></a>            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.msh&quot;</span><span class="p">:</span>
</span><span id="Mesh-173"><a href="#Mesh-173"><span class="linenos"> 173</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">_from_gmsh</span><span class="p">(</span>
</span><span id="Mesh-174"><a href="#Mesh-174"><span class="linenos"> 174</span></a>                    <span class="n">plex_or_meshfile</span><span class="p">,</span>
</span><span id="Mesh-175"><a href="#Mesh-175"><span class="linenos"> 175</span></a>                    <span class="n">comm</span><span class="p">,</span>
</span><span id="Mesh-176"><a href="#Mesh-176"><span class="linenos"> 176</span></a>                    <span class="n">markVertices</span><span class="o">=</span><span class="n">markVertices</span><span class="p">,</span>
</span><span id="Mesh-177"><a href="#Mesh-177"><span class="linenos"> 177</span></a>                    <span class="n">useRegions</span><span class="o">=</span><span class="n">useRegions</span><span class="p">,</span>
</span><span id="Mesh-178"><a href="#Mesh-178"><span class="linenos"> 178</span></a>                    <span class="n">useMultipleTags</span><span class="o">=</span><span class="n">useMultipleTags</span><span class="p">,</span>
</span><span id="Mesh-179"><a href="#Mesh-179"><span class="linenos"> 179</span></a>                <span class="p">)</span>
</span><span id="Mesh-180"><a href="#Mesh-180"><span class="linenos"> 180</span></a>            <span class="k">elif</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.h5&quot;</span><span class="p">:</span>
</span><span id="Mesh-181"><a href="#Mesh-181"><span class="linenos"> 181</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">_from_plexh5</span><span class="p">(</span>
</span><span id="Mesh-182"><a href="#Mesh-182"><span class="linenos"> 182</span></a>                    <span class="n">plex_or_meshfile</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">return_sf</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Mesh-183"><a href="#Mesh-183"><span class="linenos"> 183</span></a>                <span class="p">)</span>
</span><span id="Mesh-184"><a href="#Mesh-184"><span class="linenos"> 184</span></a>
</span><span id="Mesh-185"><a href="#Mesh-185"><span class="linenos"> 185</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-186"><a href="#Mesh-186"><span class="linenos"> 186</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Mesh-187"><a href="#Mesh-187"><span class="linenos"> 187</span></a>                    <span class="s2">&quot;Mesh file </span><span class="si">%s</span><span class="s2"> has unknown format &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span>
</span><span id="Mesh-188"><a href="#Mesh-188"><span class="linenos"> 188</span></a>                    <span class="o">%</span> <span class="p">(</span><span class="n">plex_or_meshfile</span><span class="p">,</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="Mesh-189"><a href="#Mesh-189"><span class="linenos"> 189</span></a>                <span class="p">)</span>
</span><span id="Mesh-190"><a href="#Mesh-190"><span class="linenos"> 190</span></a>
</span><span id="Mesh-191"><a href="#Mesh-191"><span class="linenos"> 191</span></a>        <span class="c1"># Use grid hashing for point location</span>
</span><span id="Mesh-192"><a href="#Mesh-192"><span class="linenos"> 192</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="Mesh-193"><a href="#Mesh-193"><span class="linenos"> 193</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;dm_plex_hash_location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh-194"><a href="#Mesh-194"><span class="linenos"> 194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setFromOptions</span><span class="p">()</span>
</span><span id="Mesh-195"><a href="#Mesh-195"><span class="linenos"> 195</span></a>
</span><span id="Mesh-196"><a href="#Mesh-196"><span class="linenos"> 196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</span><span id="Mesh-197"><a href="#Mesh-197"><span class="linenos"> 197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span> <span class="o">=</span> <span class="n">boundaries</span>
</span><span id="Mesh-198"><a href="#Mesh-198"><span class="linenos"> 198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_normals</span> <span class="o">=</span> <span class="n">boundary_normals</span>
</span><span id="Mesh-199"><a href="#Mesh-199"><span class="linenos"> 199</span></a>
</span><span id="Mesh-200"><a href="#Mesh-200"><span class="linenos"> 200</span></a>        <span class="n">uw</span><span class="o">.</span><span class="n">adaptivity</span><span class="o">.</span><span class="n">_dm_stack_bcs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">,</span> <span class="s2">&quot;UW_Boundaries&quot;</span><span class="p">)</span>
</span><span id="Mesh-201"><a href="#Mesh-201"><span class="linenos"> 201</span></a>
</span><span id="Mesh-202"><a href="#Mesh-202"><span class="linenos"> 202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">refinement_callback</span> <span class="o">=</span> <span class="n">refinement_callback</span>
</span><span id="Mesh-203"><a href="#Mesh-203"><span class="linenos"> 203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">return_coords_to_bounds</span> <span class="o">=</span> <span class="n">return_coords_to_bounds</span>
</span><span id="Mesh-204"><a href="#Mesh-204"><span class="linenos"> 204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Mesh-205"><a href="#Mesh-205"><span class="linenos"> 205</span></a>
</span><span id="Mesh-206"><a href="#Mesh-206"><span class="linenos"> 206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="Mesh-207"><a href="#Mesh-207"><span class="linenos"> 207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sf1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh-208"><a href="#Mesh-208"><span class="linenos"> 208</span></a>
</span><span id="Mesh-209"><a href="#Mesh-209"><span class="linenos"> 209</span></a>        <span class="c1">## This is where we can refine the dm if required, and rebuild / redistribute</span>
</span><span id="Mesh-210"><a href="#Mesh-210"><span class="linenos"> 210</span></a>
</span><span id="Mesh-211"><a href="#Mesh-211"><span class="linenos"> 211</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">refinement</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-212"><a href="#Mesh-212"><span class="linenos"> 212</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setRefinementUniform</span><span class="p">()</span>
</span><span id="Mesh-213"><a href="#Mesh-213"><span class="linenos"> 213</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">distribute</span><span class="p">()</span>
</span><span id="Mesh-214"><a href="#Mesh-214"><span class="linenos"> 214</span></a>
</span><span id="Mesh-215"><a href="#Mesh-215"><span class="linenos"> 215</span></a>            <span class="c1"># self.dm_hierarchy = self.dm.refineHierarchy(refinement)</span>
</span><span id="Mesh-216"><a href="#Mesh-216"><span class="linenos"> 216</span></a>
</span><span id="Mesh-217"><a href="#Mesh-217"><span class="linenos"> 217</span></a>            <span class="c1"># This is preferable to the refineHierarchy call</span>
</span><span id="Mesh-218"><a href="#Mesh-218"><span class="linenos"> 218</span></a>            <span class="c1"># because we can repair the refined mesh at each</span>
</span><span id="Mesh-219"><a href="#Mesh-219"><span class="linenos"> 219</span></a>            <span class="c1"># step along the way</span>
</span><span id="Mesh-220"><a href="#Mesh-220"><span class="linenos"> 220</span></a>
</span><span id="Mesh-221"><a href="#Mesh-221"><span class="linenos"> 221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">]</span>
</span><span id="Mesh-222"><a href="#Mesh-222"><span class="linenos"> 222</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">refinement</span><span class="p">):</span>
</span><span id="Mesh-223"><a href="#Mesh-223"><span class="linenos"> 223</span></a>                <span class="n">dm_refined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">refine</span><span class="p">()</span>
</span><span id="Mesh-224"><a href="#Mesh-224"><span class="linenos"> 224</span></a>                <span class="n">dm_refined</span><span class="o">.</span><span class="n">setCoarseDM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Mesh-225"><a href="#Mesh-225"><span class="linenos"> 225</span></a>
</span><span id="Mesh-226"><a href="#Mesh-226"><span class="linenos"> 226</span></a>                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refinement_callback</span><span class="p">):</span>
</span><span id="Mesh-227"><a href="#Mesh-227"><span class="linenos"> 227</span></a>                    <span class="n">refinement_callback</span><span class="p">(</span><span class="n">dm_refined</span><span class="p">)</span>
</span><span id="Mesh-228"><a href="#Mesh-228"><span class="linenos"> 228</span></a>
</span><span id="Mesh-229"><a href="#Mesh-229"><span class="linenos"> 229</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm_refined</span><span class="p">)</span>
</span><span id="Mesh-230"><a href="#Mesh-230"><span class="linenos"> 230</span></a>
</span><span id="Mesh-231"><a href="#Mesh-231"><span class="linenos"> 231</span></a>            <span class="c1"># self.dm_hierarchy = [self.dm] + self.dm_hierarchy</span>
</span><span id="Mesh-232"><a href="#Mesh-232"><span class="linenos"> 232</span></a>
</span><span id="Mesh-233"><a href="#Mesh-233"><span class="linenos"> 233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Mesh-234"><a href="#Mesh-234"><span class="linenos"> 234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_hierarchical_dm&quot;</span><span class="p">)</span>
</span><span id="Mesh-235"><a href="#Mesh-235"><span class="linenos"> 235</span></a>
</span><span id="Mesh-236"><a href="#Mesh-236"><span class="linenos"> 236</span></a>            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refinement_callback</span><span class="p">):</span>
</span><span id="Mesh-237"><a href="#Mesh-237"><span class="linenos"> 237</span></a>                <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">:</span>
</span><span id="Mesh-238"><a href="#Mesh-238"><span class="linenos"> 238</span></a>                    <span class="n">refinement_callback</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh-239"><a href="#Mesh-239"><span class="linenos"> 239</span></a>
</span><span id="Mesh-240"><a href="#Mesh-240"><span class="linenos"> 240</span></a>            <span class="c1"># Single level equivalent dm</span>
</span><span id="Mesh-241"><a href="#Mesh-241"><span class="linenos"> 241</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="Mesh-242"><a href="#Mesh-242"><span class="linenos"> 242</span></a>
</span><span id="Mesh-243"><a href="#Mesh-243"><span class="linenos"> 243</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-244"><a href="#Mesh-244"><span class="linenos"> 244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">distribute</span><span class="p">()</span>
</span><span id="Mesh-245"><a href="#Mesh-245"><span class="linenos"> 245</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">]</span>
</span><span id="Mesh-246"><a href="#Mesh-246"><span class="linenos"> 246</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="Mesh-247"><a href="#Mesh-247"><span class="linenos"> 247</span></a>
</span><span id="Mesh-248"><a href="#Mesh-248"><span class="linenos"> 248</span></a>        <span class="c1"># This will be done anyway - the mesh maybe in a</span>
</span><span id="Mesh-249"><a href="#Mesh-249"><span class="linenos"> 249</span></a>        <span class="c1"># partially adapted state</span>
</span><span id="Mesh-250"><a href="#Mesh-250"><span class="linenos"> 250</span></a>
</span><span id="Mesh-251"><a href="#Mesh-251"><span class="linenos"> 251</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="p">:</span>
</span><span id="Mesh-252"><a href="#Mesh-252"><span class="linenos"> 252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sf1</span><span class="p">)</span>
</span><span id="Mesh-253"><a href="#Mesh-253"><span class="linenos"> 253</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-254"><a href="#Mesh-254"><span class="linenos"> 254</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span>  <span class="c1"># could be None !</span>
</span><span id="Mesh-255"><a href="#Mesh-255"><span class="linenos"> 255</span></a>
</span><span id="Mesh-256"><a href="#Mesh-256"><span class="linenos"> 256</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-257"><a href="#Mesh-257"><span class="linenos"> 257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;mesh&quot;</span>
</span><span id="Mesh-258"><a href="#Mesh-258"><span class="linenos"> 258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_mesh&quot;</span><span class="p">)</span>
</span><span id="Mesh-259"><a href="#Mesh-259"><span class="linenos"> 259</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-260"><a href="#Mesh-260"><span class="linenos"> 260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;uw_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Mesh-261"><a href="#Mesh-261"><span class="linenos"> 261</span></a>
</span><span id="Mesh-262"><a href="#Mesh-262"><span class="linenos"> 262</span></a>        <span class="c1"># Set sympy constructs. First a generic, symbolic, Cartesian coordinate system</span>
</span><span id="Mesh-263"><a href="#Mesh-263"><span class="linenos"> 263</span></a>        <span class="c1"># A unique set of vectors / names for each mesh instance</span>
</span><span id="Mesh-264"><a href="#Mesh-264"><span class="linenos"> 264</span></a>
</span><span id="Mesh-265"><a href="#Mesh-265"><span class="linenos"> 265</span></a>        <span class="kn">from</span> <span class="nn">sympy.vector</span> <span class="kn">import</span> <span class="n">CoordSys3D</span>
</span><span id="Mesh-266"><a href="#Mesh-266"><span class="linenos"> 266</span></a>
</span><span id="Mesh-267"><a href="#Mesh-267"><span class="linenos"> 267</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">CoordSys3D</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="Mesh-268"><a href="#Mesh-268"><span class="linenos"> 268</span></a>
</span><span id="Mesh-269"><a href="#Mesh-269"><span class="linenos"> 269</span></a>        <span class="c1"># Tidy some of this printing without changing the</span>
</span><span id="Mesh-270"><a href="#Mesh-270"><span class="linenos"> 270</span></a>        <span class="c1"># underlying vector names (as these are part of the code generation system)</span>
</span><span id="Mesh-271"><a href="#Mesh-271"><span class="linenos"> 271</span></a>
</span><span id="Mesh-272"><a href="#Mesh-272"><span class="linenos"> 272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathrm{\xi_0}&quot;</span>
</span><span id="Mesh-273"><a href="#Mesh-273"><span class="linenos"> 273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathrm{\xi_1}&quot;</span>
</span><span id="Mesh-274"><a href="#Mesh-274"><span class="linenos"> 274</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathrm{\xi_2}&quot;</span>
</span><span id="Mesh-275"><a href="#Mesh-275"><span class="linenos"> 275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathbf{\hat{\mathbf</span><span class="si">{e}</span><span class="s2">}_0}&quot;</span>
</span><span id="Mesh-276"><a href="#Mesh-276"><span class="linenos"> 276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">j</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathbf{\hat{\mathbf</span><span class="si">{e}</span><span class="s2">}_1}&quot;</span>
</span><span id="Mesh-277"><a href="#Mesh-277"><span class="linenos"> 277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathbf{\hat{\mathbf</span><span class="si">{e}</span><span class="s2">}_2}&quot;</span>
</span><span id="Mesh-278"><a href="#Mesh-278"><span class="linenos"> 278</span></a>
</span><span id="Mesh-279"><a href="#Mesh-279"><span class="linenos"> 279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span> <span class="o">=</span> <span class="n">CoordSys3D</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\Gamma&quot;</span><span class="p">)</span>
</span><span id="Mesh-280"><a href="#Mesh-280"><span class="linenos"> 280</span></a>
</span><span id="Mesh-281"><a href="#Mesh-281"><span class="linenos"> 281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\Gamma_x&quot;</span>
</span><span id="Mesh-282"><a href="#Mesh-282"><span class="linenos"> 282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\Gamma_y&quot;</span>
</span><span id="Mesh-283"><a href="#Mesh-283"><span class="linenos"> 283</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\Gamma_z&quot;</span>
</span><span id="Mesh-284"><a href="#Mesh-284"><span class="linenos"> 284</span></a>
</span><span id="Mesh-285"><a href="#Mesh-285"><span class="linenos"> 285</span></a>        <span class="c1"># Now add the appropriate coordinate system for the mesh&#39;s natural geometry</span>
</span><span id="Mesh-286"><a href="#Mesh-286"><span class="linenos"> 286</span></a>        <span class="c1"># This step will usually over-write the defaults we just defined</span>
</span><span id="Mesh-287"><a href="#Mesh-287"><span class="linenos"> 287</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_CoordinateSystem</span> <span class="o">=</span> <span class="n">CoordinateSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate_system_type</span><span class="p">)</span>
</span><span id="Mesh-288"><a href="#Mesh-288"><span class="linenos"> 288</span></a>
</span><span id="Mesh-289"><a href="#Mesh-289"><span class="linenos"> 289</span></a>        <span class="c1"># This was in the _jit extension but ... if</span>
</span><span id="Mesh-290"><a href="#Mesh-290"><span class="linenos"> 290</span></a>        <span class="c1"># not here then the tests fail sometimes (caching ?)</span>
</span><span id="Mesh-291"><a href="#Mesh-291"><span class="linenos"> 291</span></a>
</span><span id="Mesh-292"><a href="#Mesh-292"><span class="linenos"> 292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_x[0]&quot;</span>
</span><span id="Mesh-293"><a href="#Mesh-293"><span class="linenos"> 293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_x[1]&quot;</span>
</span><span id="Mesh-294"><a href="#Mesh-294"><span class="linenos"> 294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_x[2]&quot;</span>
</span><span id="Mesh-295"><a href="#Mesh-295"><span class="linenos"> 295</span></a>
</span><span id="Mesh-296"><a href="#Mesh-296"><span class="linenos"> 296</span></a>        <span class="c1"># Surface integrals also have normal vector information as petsc_n</span>
</span><span id="Mesh-297"><a href="#Mesh-297"><span class="linenos"> 297</span></a>
</span><span id="Mesh-298"><a href="#Mesh-298"><span class="linenos"> 298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_n[0]&quot;</span>
</span><span id="Mesh-299"><a href="#Mesh-299"><span class="linenos"> 299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_n[1]&quot;</span>
</span><span id="Mesh-300"><a href="#Mesh-300"><span class="linenos"> 300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_n[2]&quot;</span>
</span><span id="Mesh-301"><a href="#Mesh-301"><span class="linenos"> 301</span></a>
</span><span id="Mesh-302"><a href="#Mesh-302"><span class="linenos"> 302</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Mesh-303"><a href="#Mesh-303"><span class="linenos"> 303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">()</span>
</span><span id="Mesh-304"><a href="#Mesh-304"><span class="linenos"> 304</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Mesh-305"><a href="#Mesh-305"><span class="linenos"> 305</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span> <span class="o">=</span> <span class="n">simplex</span>
</span><span id="Mesh-306"><a href="#Mesh-306"><span class="linenos"> 306</span></a>
</span><span id="Mesh-307"><a href="#Mesh-307"><span class="linenos"> 307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Mesh-308"><a href="#Mesh-308"><span class="linenos"> 308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_block_vars</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Mesh-309"><a href="#Mesh-309"><span class="linenos"> 309</span></a>
</span><span id="Mesh-310"><a href="#Mesh-310"><span class="linenos"> 310</span></a>        <span class="c1"># a list of equation systems that will</span>
</span><span id="Mesh-311"><a href="#Mesh-311"><span class="linenos"> 311</span></a>        <span class="c1"># need to be rebuilt if the mesh coordinates change</span>
</span><span id="Mesh-312"><a href="#Mesh-312"><span class="linenos"> 312</span></a>
</span><span id="Mesh-313"><a href="#Mesh-313"><span class="linenos"> 313</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_equation_systems_register</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Mesh-314"><a href="#Mesh-314"><span class="linenos"> 314</span></a>
</span><span id="Mesh-315"><a href="#Mesh-315"><span class="linenos"> 315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_hash</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh-316"><a href="#Mesh-316"><span class="linenos"> 316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_interpolated_results</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh-317"><a href="#Mesh-317"><span class="linenos"> 317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh-318"><a href="#Mesh-318"><span class="linenos"> 318</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_quadrature</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh-319"><a href="#Mesh-319"><span class="linenos"> 319</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Mesh-320"><a href="#Mesh-320"><span class="linenos"> 320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh-321"><a href="#Mesh-321"><span class="linenos"> 321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh-322"><a href="#Mesh-322"><span class="linenos"> 322</span></a>
</span><span id="Mesh-323"><a href="#Mesh-323"><span class="linenos"> 323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
</span><span id="Mesh-324"><a href="#Mesh-324"><span class="linenos"> 324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">qdegree</span> <span class="o">=</span> <span class="n">qdegree</span>
</span><span id="Mesh-325"><a href="#Mesh-325"><span class="linenos"> 325</span></a>
</span><span id="Mesh-326"><a href="#Mesh-326"><span class="linenos"> 326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nuke_coords_and_rebuild</span><span class="p">()</span>
</span><span id="Mesh-327"><a href="#Mesh-327"><span class="linenos"> 327</span></a>
</span><span id="Mesh-328"><a href="#Mesh-328"><span class="linenos"> 328</span></a>        <span class="c1">## Coordinate System</span>
</span><span id="Mesh-329"><a href="#Mesh-329"><span class="linenos"> 329</span></a>
</span><span id="Mesh-330"><a href="#Mesh-330"><span class="linenos"> 330</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="Mesh-331"><a href="#Mesh-331"><span class="linenos"> 331</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="Mesh-332"><a href="#Mesh-332"><span class="linenos"> 332</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">CYLINDRICAL2D_NATIVE</span>
</span><span id="Mesh-333"><a href="#Mesh-333"><span class="linenos"> 333</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="Mesh-334"><a href="#Mesh-334"><span class="linenos"> 334</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">CYLINDRICAL3D_NATIVE</span>
</span><span id="Mesh-335"><a href="#Mesh-335"><span class="linenos"> 335</span></a>        <span class="p">):</span>
</span><span id="Mesh-336"><a href="#Mesh-336"><span class="linenos"> 336</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus_cylindrical</span><span class="p">(</span>
</span><span id="Mesh-337"><a href="#Mesh-337"><span class="linenos"> 337</span></a>                <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh-338"><a href="#Mesh-338"><span class="linenos"> 338</span></a>            <span class="p">)</span>
</span><span id="Mesh-339"><a href="#Mesh-339"><span class="linenos"> 339</span></a>        <span class="k">elif</span> <span class="p">(</span>
</span><span id="Mesh-340"><a href="#Mesh-340"><span class="linenos"> 340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="Mesh-341"><a href="#Mesh-341"><span class="linenos"> 341</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">SPHERICAL_NATIVE</span>
</span><span id="Mesh-342"><a href="#Mesh-342"><span class="linenos"> 342</span></a>        <span class="p">):</span>
</span><span id="Mesh-343"><a href="#Mesh-343"><span class="linenos"> 343</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus_spherical</span><span class="p">(</span>
</span><span id="Mesh-344"><a href="#Mesh-344"><span class="linenos"> 344</span></a>                <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh-345"><a href="#Mesh-345"><span class="linenos"> 345</span></a>            <span class="p">)</span>  <span class="c1">## Not yet complete or tested</span>
</span><span id="Mesh-346"><a href="#Mesh-346"><span class="linenos"> 346</span></a>
</span><span id="Mesh-347"><a href="#Mesh-347"><span class="linenos"> 347</span></a>        <span class="k">elif</span> <span class="p">(</span>
</span><span id="Mesh-348"><a href="#Mesh-348"><span class="linenos"> 348</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="Mesh-349"><a href="#Mesh-349"><span class="linenos"> 349</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">SPHERE_SURFACE_NATIVE</span>
</span><span id="Mesh-350"><a href="#Mesh-350"><span class="linenos"> 350</span></a>        <span class="p">):</span>
</span><span id="Mesh-351"><a href="#Mesh-351"><span class="linenos"> 351</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus_spherical_surface2D_lonlat</span><span class="p">(</span>
</span><span id="Mesh-352"><a href="#Mesh-352"><span class="linenos"> 352</span></a>                <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh-353"><a href="#Mesh-353"><span class="linenos"> 353</span></a>            <span class="p">)</span>
</span><span id="Mesh-354"><a href="#Mesh-354"><span class="linenos"> 354</span></a>
</span><span id="Mesh-355"><a href="#Mesh-355"><span class="linenos"> 355</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-356"><a href="#Mesh-356"><span class="linenos"> 356</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Mesh-357"><a href="#Mesh-357"><span class="linenos"> 357</span></a>
</span><span id="Mesh-358"><a href="#Mesh-358"><span class="linenos"> 358</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Mesh-359"><a href="#Mesh-359"><span class="linenos"> 359</span></a>
</span><span id="Mesh-360"><a href="#Mesh-360"><span class="linenos"> 360</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-361"><a href="#Mesh-361"><span class="linenos"> 361</span></a>    <span class="k">def</span> <span class="nf">dim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Mesh-362"><a href="#Mesh-362"><span class="linenos"> 362</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-363"><a href="#Mesh-363"><span class="linenos"> 363</span></a><span class="sd">        The mesh dimensionality.</span>
</span><span id="Mesh-364"><a href="#Mesh-364"><span class="linenos"> 364</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-365"><a href="#Mesh-365"><span class="linenos"> 365</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
</span><span id="Mesh-366"><a href="#Mesh-366"><span class="linenos"> 366</span></a>
</span><span id="Mesh-367"><a href="#Mesh-367"><span class="linenos"> 367</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-368"><a href="#Mesh-368"><span class="linenos"> 368</span></a>    <span class="k">def</span> <span class="nf">cdim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Mesh-369"><a href="#Mesh-369"><span class="linenos"> 369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-370"><a href="#Mesh-370"><span class="linenos"> 370</span></a><span class="sd">        The mesh dimensionality.</span>
</span><span id="Mesh-371"><a href="#Mesh-371"><span class="linenos"> 371</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-372"><a href="#Mesh-372"><span class="linenos"> 372</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinateDim</span><span class="p">()</span>
</span><span id="Mesh-373"><a href="#Mesh-373"><span class="linenos"> 373</span></a>
</span><span id="Mesh-374"><a href="#Mesh-374"><span class="linenos"> 374</span></a>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-375"><a href="#Mesh-375"><span class="linenos"> 375</span></a>
</span><span id="Mesh-376"><a href="#Mesh-376"><span class="linenos"> 376</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="Mesh-377"><a href="#Mesh-377"><span class="linenos"> 377</span></a>
</span><span id="Mesh-378"><a href="#Mesh-378"><span class="linenos"> 378</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-379"><a href="#Mesh-379"><span class="linenos"> 379</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Mesh-380"><a href="#Mesh-380"><span class="linenos"> 380</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh # </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Mesh-381"><a href="#Mesh-381"><span class="linenos"> 381</span></a>
</span><span id="Mesh-382"><a href="#Mesh-382"><span class="linenos"> 382</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-383"><a href="#Mesh-383"><span class="linenos"> 383</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| Variable Name       | component | degree |     type        |&quot;</span><span class="p">)</span>
</span><span id="Mesh-384"><a href="#Mesh-384"><span class="linenos"> 384</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ---------------------------------------------------------- |&quot;</span><span class="p">)</span>
</span><span id="Mesh-385"><a href="#Mesh-385"><span class="linenos"> 385</span></a>                <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Mesh-386"><a href="#Mesh-386"><span class="linenos"> 386</span></a>                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
</span><span id="Mesh-387"><a href="#Mesh-387"><span class="linenos"> 387</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="Mesh-388"><a href="#Mesh-388"><span class="linenos"> 388</span></a>                        <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">clean_name</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">num_components</span><span class="si">:</span><span class="s2">^10</span><span class="si">}</span><span class="s2"> |</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">degree</span><span class="si">:</span><span class="s2">^7</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">vtype</span><span class="o">.</span><span class="n">name</span><span class="si">:</span><span class="s2">^15</span><span class="si">}</span><span class="s2"> |&quot;</span>
</span><span id="Mesh-389"><a href="#Mesh-389"><span class="linenos"> 389</span></a>                    <span class="p">)</span>
</span><span id="Mesh-390"><a href="#Mesh-390"><span class="linenos"> 390</span></a>
</span><span id="Mesh-391"><a href="#Mesh-391"><span class="linenos"> 391</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ---------------------------------------------------------- |&quot;</span><span class="p">)</span>
</span><span id="Mesh-392"><a href="#Mesh-392"><span class="linenos"> 392</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh-393"><a href="#Mesh-393"><span class="linenos"> 393</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-394"><a href="#Mesh-394"><span class="linenos"> 394</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No variables are defined on the mesh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh-395"><a href="#Mesh-395"><span class="linenos"> 395</span></a>
</span><span id="Mesh-396"><a href="#Mesh-396"><span class="linenos"> 396</span></a>        <span class="c1">## Boundary information</span>
</span><span id="Mesh-397"><a href="#Mesh-397"><span class="linenos"> 397</span></a>
</span><span id="Mesh-398"><a href="#Mesh-398"><span class="linenos"> 398</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-399"><a href="#Mesh-399"><span class="linenos"> 399</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-400"><a href="#Mesh-400"><span class="linenos"> 400</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| Boundary Name            | ID    | Min Size | Max Size |&quot;</span><span class="p">)</span>
</span><span id="Mesh-401"><a href="#Mesh-401"><span class="linenos"> 401</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ------------------------------------------------------ |&quot;</span><span class="p">)</span>
</span><span id="Mesh-402"><a href="#Mesh-402"><span class="linenos"> 402</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-403"><a href="#Mesh-403"><span class="linenos"> 403</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No boundary labels are defined on the mesh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Mesh-404"><a href="#Mesh-404"><span class="linenos"> 404</span></a>
</span><span id="Mesh-405"><a href="#Mesh-405"><span class="linenos"> 405</span></a>        <span class="k">for</span> <span class="n">bd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">:</span>
</span><span id="Mesh-406"><a href="#Mesh-406"><span class="linenos"> 406</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="Mesh-407"><a href="#Mesh-407"><span class="linenos"> 407</span></a>            <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
</span><span id="Mesh-408"><a href="#Mesh-408"><span class="linenos"> 408</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">getStratumSize</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="Mesh-409"><a href="#Mesh-409"><span class="linenos"> 409</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-410"><a href="#Mesh-410"><span class="linenos"> 410</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Mesh-411"><a href="#Mesh-411"><span class="linenos"> 411</span></a>
</span><span id="Mesh-412"><a href="#Mesh-412"><span class="linenos"> 412</span></a>            <span class="n">ii</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">gather_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
</span><span id="Mesh-413"><a href="#Mesh-413"><span class="linenos"> 413</span></a>
</span><span id="Mesh-414"><a href="#Mesh-414"><span class="linenos"> 414</span></a>            <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-415"><a href="#Mesh-415"><span class="linenos"> 415</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Mesh-416"><a href="#Mesh-416"><span class="linenos"> 416</span></a>                    <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2">     | </span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">&lt;5</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">ii</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">ii</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> |&quot;</span><span class="p">,</span>
</span><span id="Mesh-417"><a href="#Mesh-417"><span class="linenos"> 417</span></a>                <span class="p">)</span>
</span><span id="Mesh-418"><a href="#Mesh-418"><span class="linenos"> 418</span></a>
</span><span id="Mesh-419"><a href="#Mesh-419"><span class="linenos"> 419</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-420"><a href="#Mesh-420"><span class="linenos"> 420</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ------------------------------------------------------ |&quot;</span><span class="p">)</span>
</span><span id="Mesh-421"><a href="#Mesh-421"><span class="linenos"> 421</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh-422"><a href="#Mesh-422"><span class="linenos"> 422</span></a>
</span><span id="Mesh-423"><a href="#Mesh-423"><span class="linenos"> 423</span></a>        <span class="c1">## Information on the mesh DM</span>
</span><span id="Mesh-424"><a href="#Mesh-424"><span class="linenos"> 424</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
</span><span id="Mesh-425"><a href="#Mesh-425"><span class="linenos"> 425</span></a>
</span><span id="Mesh-426"><a href="#Mesh-426"><span class="linenos"> 426</span></a>    <span class="k">def</span> <span class="nf">clone_dm_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-427"><a href="#Mesh-427"><span class="linenos"> 427</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-428"><a href="#Mesh-428"><span class="linenos"> 428</span></a><span class="sd">        Clone the dm hierarchy on the mesh</span>
</span><span id="Mesh-429"><a href="#Mesh-429"><span class="linenos"> 429</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-430"><a href="#Mesh-430"><span class="linenos"> 430</span></a>
</span><span id="Mesh-431"><a href="#Mesh-431"><span class="linenos"> 431</span></a>        <span class="n">dm_hierarchy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span>
</span><span id="Mesh-432"><a href="#Mesh-432"><span class="linenos"> 432</span></a>
</span><span id="Mesh-433"><a href="#Mesh-433"><span class="linenos"> 433</span></a>        <span class="n">new_dm_hierarchy</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Mesh-434"><a href="#Mesh-434"><span class="linenos"> 434</span></a>        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">dm_hierarchy</span><span class="p">:</span>
</span><span id="Mesh-435"><a href="#Mesh-435"><span class="linenos"> 435</span></a>            <span class="n">new_dm_hierarchy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
</span><span id="Mesh-436"><a href="#Mesh-436"><span class="linenos"> 436</span></a>
</span><span id="Mesh-437"><a href="#Mesh-437"><span class="linenos"> 437</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_dm_hierarchy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="Mesh-438"><a href="#Mesh-438"><span class="linenos"> 438</span></a>            <span class="n">new_dm_hierarchy</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setCoarseDM</span><span class="p">(</span><span class="n">new_dm_hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Mesh-439"><a href="#Mesh-439"><span class="linenos"> 439</span></a>
</span><span id="Mesh-440"><a href="#Mesh-440"><span class="linenos"> 440</span></a>        <span class="k">return</span> <span class="n">new_dm_hierarchy</span>
</span><span id="Mesh-441"><a href="#Mesh-441"><span class="linenos"> 441</span></a>
</span><span id="Mesh-442"><a href="#Mesh-442"><span class="linenos"> 442</span></a>    <span class="k">def</span> <span class="nf">nuke_coords_and_rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-443"><a href="#Mesh-443"><span class="linenos"> 443</span></a>        <span class="c1"># This is a reversion to the old version (3.15 compatible which seems to work in 3.16 too)</span>
</span><span id="Mesh-444"><a href="#Mesh-444"><span class="linenos"> 444</span></a>
</span><span id="Mesh-445"><a href="#Mesh-445"><span class="linenos"> 445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Mesh-446"><a href="#Mesh-446"><span class="linenos"> 446</span></a>
</span><span id="Mesh-447"><a href="#Mesh-447"><span class="linenos"> 447</span></a>        <span class="c1"># let&#39;s go ahead and do an initial projection from linear (the default)</span>
</span><span id="Mesh-448"><a href="#Mesh-448"><span class="linenos"> 448</span></a>        <span class="c1"># to linear. this really is a nothing operation, but a</span>
</span><span id="Mesh-449"><a href="#Mesh-449"><span class="linenos"> 449</span></a>        <span class="c1"># side effect of this operation is that coordinate DM DMField is</span>
</span><span id="Mesh-450"><a href="#Mesh-450"><span class="linenos"> 450</span></a>        <span class="c1"># converted to the required `PetscFE` type. this may become necessary</span>
</span><span id="Mesh-451"><a href="#Mesh-451"><span class="linenos"> 451</span></a>        <span class="c1"># later where we call the interpolation routines to project from the linear</span>
</span><span id="Mesh-452"><a href="#Mesh-452"><span class="linenos"> 452</span></a>        <span class="c1"># mesh coordinates to other mesh coordinates.</span>
</span><span id="Mesh-453"><a href="#Mesh-453"><span class="linenos"> 453</span></a>
</span><span id="Mesh-454"><a href="#Mesh-454"><span class="linenos"> 454</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="Mesh-455"><a href="#Mesh-455"><span class="linenos"> 455</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="Mesh-456"><a href="#Mesh-456"><span class="linenos"> 456</span></a>            <span class="s2">&quot;meshproj_</span><span class="si">{}</span><span class="s2">_petscspace_degree&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_instances</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span>
</span><span id="Mesh-457"><a href="#Mesh-457"><span class="linenos"> 457</span></a>        <span class="p">)</span>
</span><span id="Mesh-458"><a href="#Mesh-458"><span class="linenos"> 458</span></a>
</span><span id="Mesh-459"><a href="#Mesh-459"><span class="linenos"> 459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">FE</span><span class="p">()</span><span class="o">.</span><span class="n">createDefault</span><span class="p">(</span>
</span><span id="Mesh-460"><a href="#Mesh-460"><span class="linenos"> 460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="Mesh-461"><a href="#Mesh-461"><span class="linenos"> 461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">,</span>
</span><span id="Mesh-462"><a href="#Mesh-462"><span class="linenos"> 462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="Mesh-463"><a href="#Mesh-463"><span class="linenos"> 463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">qdegree</span><span class="p">,</span>
</span><span id="Mesh-464"><a href="#Mesh-464"><span class="linenos"> 464</span></a>            <span class="s2">&quot;meshproj_</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_instances</span><span class="p">),</span>
</span><span id="Mesh-465"><a href="#Mesh-465"><span class="linenos"> 465</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span>
</span><span id="Mesh-466"><a href="#Mesh-466"><span class="linenos"> 466</span></a>        <span class="p">)</span>
</span><span id="Mesh-467"><a href="#Mesh-467"><span class="linenos"> 467</span></a>
</span><span id="Mesh-468"><a href="#Mesh-468"><span class="linenos"> 468</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="Mesh-469"><a href="#Mesh-469"><span class="linenos"> 469</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">Sys</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="Mesh-470"><a href="#Mesh-470"><span class="linenos"> 470</span></a>            <span class="ow">and</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Sys</span><span class="o">.</span><span class="n">getVersionInfo</span><span class="p">()[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</span><span id="Mesh-471"><a href="#Mesh-471"><span class="linenos"> 471</span></a>        <span class="p">):</span>
</span><span id="Mesh-472"><a href="#Mesh-472"><span class="linenos"> 472</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">projectCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span><span class="p">)</span>
</span><span id="Mesh-473"><a href="#Mesh-473"><span class="linenos"> 473</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-474"><a href="#Mesh-474"><span class="linenos"> 474</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setCoordinateDisc</span><span class="p">(</span><span class="n">disc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh-475"><a href="#Mesh-475"><span class="linenos"> 475</span></a>
</span><span id="Mesh-476"><a href="#Mesh-476"><span class="linenos"> 476</span></a>        <span class="c1">## LM ToDo: check if this is still a valid issue under 3.18.x / 3.19.x</span>
</span><span id="Mesh-477"><a href="#Mesh-477"><span class="linenos"> 477</span></a>        <span class="c1"># if self.degree == 1:</span>
</span><span id="Mesh-478"><a href="#Mesh-478"><span class="linenos"> 478</span></a>        <span class="c1">#     # We have to be careful as a projection onto an equivalent PETScFE can cause problematic</span>
</span><span id="Mesh-479"><a href="#Mesh-479"><span class="linenos"> 479</span></a>        <span class="c1">#     # issues with petsc that we see in parallel - in which case there is a fallback, pass no</span>
</span><span id="Mesh-480"><a href="#Mesh-480"><span class="linenos"> 480</span></a>        <span class="c1">#     # PETScFE and let PETSc decide. Note that the petsc4py wrapped version does not allow this</span>
</span><span id="Mesh-481"><a href="#Mesh-481"><span class="linenos"> 481</span></a>        <span class="c1">#     # (but it should !)</span>
</span><span id="Mesh-482"><a href="#Mesh-482"><span class="linenos"> 482</span></a>
</span><span id="Mesh-483"><a href="#Mesh-483"><span class="linenos"> 483</span></a>        <span class="c1">#     self.dm.projectCoordinates(self.petsc_fe)</span>
</span><span id="Mesh-484"><a href="#Mesh-484"><span class="linenos"> 484</span></a>
</span><span id="Mesh-485"><a href="#Mesh-485"><span class="linenos"> 485</span></a>        <span class="c1"># else:</span>
</span><span id="Mesh-486"><a href="#Mesh-486"><span class="linenos"> 486</span></a>        <span class="c1">#     uw.cython.petsc_discretisation.petsc_dm_project_coordinates(self.dm)</span>
</span><span id="Mesh-487"><a href="#Mesh-487"><span class="linenos"> 487</span></a>
</span><span id="Mesh-488"><a href="#Mesh-488"><span class="linenos"> 488</span></a>        <span class="c1"># now set copy of this array into dictionary</span>
</span><span id="Mesh-489"><a href="#Mesh-489"><span class="linenos"> 489</span></a>
</span><span id="Mesh-490"><a href="#Mesh-490"><span class="linenos"> 490</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinatesLocal</span><span class="p">()</span><span class="o">.</span><span class="n">array</span>
</span><span id="Mesh-491"><a href="#Mesh-491"><span class="linenos"> 491</span></a>
</span><span id="Mesh-492"><a href="#Mesh-492"><span class="linenos"> 492</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mesh-493"><a href="#Mesh-493"><span class="linenos"> 493</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="Mesh-494"><a href="#Mesh-494"><span class="linenos"> 494</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
</span><span id="Mesh-495"><a href="#Mesh-495"><span class="linenos"> 495</span></a>            <span class="kc">True</span><span class="p">,</span>
</span><span id="Mesh-496"><a href="#Mesh-496"><span class="linenos"> 496</span></a>        <span class="p">)</span>  <span class="c1"># True here assumes continuous basis for coordinates ...</span>
</span><span id="Mesh-497"><a href="#Mesh-497"><span class="linenos"> 497</span></a>
</span><span id="Mesh-498"><a href="#Mesh-498"><span class="linenos"> 498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Mesh-499"><a href="#Mesh-499"><span class="linenos"> 499</span></a>
</span><span id="Mesh-500"><a href="#Mesh-500"><span class="linenos"> 500</span></a>        <span class="c1"># invalidate the cell-search k-d tree and the mesh centroid data / rebuild</span>
</span><span id="Mesh-501"><a href="#Mesh-501"><span class="linenos"> 501</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_kd_tree_index</span><span class="p">()</span>
</span><span id="Mesh-502"><a href="#Mesh-502"><span class="linenos"> 502</span></a>
</span><span id="Mesh-503"><a href="#Mesh-503"><span class="linenos"> 503</span></a>        <span class="p">(</span>
</span><span id="Mesh-504"><a href="#Mesh-504"><span class="linenos"> 504</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_min_size</span><span class="p">,</span>
</span><span id="Mesh-505"><a href="#Mesh-505"><span class="linenos"> 505</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="p">,</span>
</span><span id="Mesh-506"><a href="#Mesh-506"><span class="linenos"> 506</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">,</span>
</span><span id="Mesh-507"><a href="#Mesh-507"><span class="linenos"> 507</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_search_lengths</span><span class="p">,</span>
</span><span id="Mesh-508"><a href="#Mesh-508"><span class="linenos"> 508</span></a>        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mesh_sizes</span><span class="p">()</span>
</span><span id="Mesh-509"><a href="#Mesh-509"><span class="linenos"> 509</span></a>
</span><span id="Mesh-510"><a href="#Mesh-510"><span class="linenos"> 510</span></a>        <span class="k">return</span>
</span><span id="Mesh-511"><a href="#Mesh-511"><span class="linenos"> 511</span></a>
</span><span id="Mesh-512"><a href="#Mesh-512"><span class="linenos"> 512</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh-513"><a href="#Mesh-513"><span class="linenos"> 513</span></a>    <span class="k">def</span> <span class="nf">update_lvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-514"><a href="#Mesh-514"><span class="linenos"> 514</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-515"><a href="#Mesh-515"><span class="linenos"> 515</span></a><span class="sd">        This method creates and/or updates the mesh variable local vector.</span>
</span><span id="Mesh-516"><a href="#Mesh-516"><span class="linenos"> 516</span></a><span class="sd">        If the local vector is already up to date, this method will do nothing.</span>
</span><span id="Mesh-517"><a href="#Mesh-517"><span class="linenos"> 517</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-518"><a href="#Mesh-518"><span class="linenos"> 518</span></a>
</span><span id="Mesh-519"><a href="#Mesh-519"><span class="linenos"> 519</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span><span class="p">:</span>
</span><span id="Mesh-520"><a href="#Mesh-520"><span class="linenos"> 520</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="Mesh-521"><a href="#Mesh-521"><span class="linenos"> 521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clearDS</span><span class="p">()</span>
</span><span id="Mesh-522"><a href="#Mesh-522"><span class="linenos"> 522</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="Mesh-523"><a href="#Mesh-523"><span class="linenos"> 523</span></a>                <span class="c1"># create the local vector (memory chunk) and attach to original dm</span>
</span><span id="Mesh-524"><a href="#Mesh-524"><span class="linenos"> 524</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createLocalVec</span><span class="p">()</span>
</span><span id="Mesh-525"><a href="#Mesh-525"><span class="linenos"> 525</span></a>
</span><span id="Mesh-526"><a href="#Mesh-526"><span class="linenos"> 526</span></a>            <span class="c1"># push avar arrays into the parent dm array</span>
</span><span id="Mesh-527"><a href="#Mesh-527"><span class="linenos"> 527</span></a>            <span class="n">a_global</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="Mesh-528"><a href="#Mesh-528"><span class="linenos"> 528</span></a>
</span><span id="Mesh-529"><a href="#Mesh-529"><span class="linenos"> 529</span></a>            <span class="c1"># The field decomposition seems to fail if coarse DMs are present</span>
</span><span id="Mesh-530"><a href="#Mesh-530"><span class="linenos"> 530</span></a>            <span class="n">names</span><span class="p">,</span> <span class="n">isets</span><span class="p">,</span> <span class="n">dms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createFieldDecomposition</span><span class="p">()</span>
</span><span id="Mesh-531"><a href="#Mesh-531"><span class="linenos"> 531</span></a>
</span><span id="Mesh-532"><a href="#Mesh-532"><span class="linenos"> 532</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">():</span>
</span><span id="Mesh-533"><a href="#Mesh-533"><span class="linenos"> 533</span></a>                <span class="c1"># traverse subdms, taking user generated data in the subdm</span>
</span><span id="Mesh-534"><a href="#Mesh-534"><span class="linenos"> 534</span></a>                <span class="c1"># local vec, pushing it into a global sub vec</span>
</span><span id="Mesh-535"><a href="#Mesh-535"><span class="linenos"> 535</span></a>                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">subiset</span><span class="p">,</span> <span class="n">subdm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">isets</span><span class="p">,</span> <span class="n">dms</span><span class="p">):</span>
</span><span id="Mesh-536"><a href="#Mesh-536"><span class="linenos"> 536</span></a>                    <span class="n">lvec</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">vec</span>
</span><span id="Mesh-537"><a href="#Mesh-537"><span class="linenos"> 537</span></a>                    <span class="n">subvec</span> <span class="o">=</span> <span class="n">a_global</span><span class="o">.</span><span class="n">getSubVector</span><span class="p">(</span><span class="n">subiset</span><span class="p">)</span>
</span><span id="Mesh-538"><a href="#Mesh-538"><span class="linenos"> 538</span></a>                    <span class="n">subdm</span><span class="o">.</span><span class="n">localToGlobal</span><span class="p">(</span><span class="n">lvec</span><span class="p">,</span> <span class="n">subvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh-539"><a href="#Mesh-539"><span class="linenos"> 539</span></a>                    <span class="n">a_global</span><span class="o">.</span><span class="n">restoreSubVector</span><span class="p">(</span><span class="n">subiset</span><span class="p">,</span> <span class="n">subvec</span><span class="p">)</span>
</span><span id="Mesh-540"><a href="#Mesh-540"><span class="linenos"> 540</span></a>
</span><span id="Mesh-541"><a href="#Mesh-541"><span class="linenos"> 541</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">a_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">)</span>
</span><span id="Mesh-542"><a href="#Mesh-542"><span class="linenos"> 542</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">a_global</span><span class="p">)</span>
</span><span id="Mesh-543"><a href="#Mesh-543"><span class="linenos"> 543</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh-544"><a href="#Mesh-544"><span class="linenos"> 544</span></a>
</span><span id="Mesh-545"><a href="#Mesh-545"><span class="linenos"> 545</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-546"><a href="#Mesh-546"><span class="linenos"> 546</span></a>    <span class="k">def</span> <span class="nf">lvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Vec</span><span class="p">:</span>
</span><span id="Mesh-547"><a href="#Mesh-547"><span class="linenos"> 547</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-548"><a href="#Mesh-548"><span class="linenos"> 548</span></a><span class="sd">        Returns a local Petsc vector containing the flattened array</span>
</span><span id="Mesh-549"><a href="#Mesh-549"><span class="linenos"> 549</span></a><span class="sd">        of all the mesh variables.</span>
</span><span id="Mesh-550"><a href="#Mesh-550"><span class="linenos"> 550</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-551"><a href="#Mesh-551"><span class="linenos"> 551</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span><span class="p">:</span>
</span><span id="Mesh-552"><a href="#Mesh-552"><span class="linenos"> 552</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Mesh-553"><a href="#Mesh-553"><span class="linenos"> 553</span></a>                <span class="s2">&quot;Mesh `lvec` needs to be updated using the update_lvec()` method.&quot;</span>
</span><span id="Mesh-554"><a href="#Mesh-554"><span class="linenos"> 554</span></a>            <span class="p">)</span>
</span><span id="Mesh-555"><a href="#Mesh-555"><span class="linenos"> 555</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span>
</span><span id="Mesh-556"><a href="#Mesh-556"><span class="linenos"> 556</span></a>
</span><span id="Mesh-557"><a href="#Mesh-557"><span class="linenos"> 557</span></a>    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-558"><a href="#Mesh-558"><span class="linenos"> 558</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lvec&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="Mesh-559"><a href="#Mesh-559"><span class="linenos"> 559</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Mesh-560"><a href="#Mesh-560"><span class="linenos"> 560</span></a>
</span><span id="Mesh-561"><a href="#Mesh-561"><span class="linenos"> 561</span></a>    <span class="k">def</span> <span class="nf">deform_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="Mesh-562"><a href="#Mesh-562"><span class="linenos"> 562</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-563"><a href="#Mesh-563"><span class="linenos"> 563</span></a><span class="sd">        This method will update the mesh coordinates and reset any cached coordinates in</span>
</span><span id="Mesh-564"><a href="#Mesh-564"><span class="linenos"> 564</span></a><span class="sd">        the mesh and in equation systems that are registered on the mesh.</span>
</span><span id="Mesh-565"><a href="#Mesh-565"><span class="linenos"> 565</span></a>
</span><span id="Mesh-566"><a href="#Mesh-566"><span class="linenos"> 566</span></a><span class="sd">        The coord array that is passed in should match the shape of self.data</span>
</span><span id="Mesh-567"><a href="#Mesh-567"><span class="linenos"> 567</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-568"><a href="#Mesh-568"><span class="linenos"> 568</span></a>
</span><span id="Mesh-569"><a href="#Mesh-569"><span class="linenos"> 569</span></a>        <span class="n">coord_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinatesLocal</span><span class="p">()</span>
</span><span id="Mesh-570"><a href="#Mesh-570"><span class="linenos"> 570</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">coord_vec</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span>
</span><span id="Mesh-571"><a href="#Mesh-571"><span class="linenos"> 571</span></a>        <span class="n">coords</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coords</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
</span><span id="Mesh-572"><a href="#Mesh-572"><span class="linenos"> 572</span></a>
</span><span id="Mesh-573"><a href="#Mesh-573"><span class="linenos"> 573</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setCoordinatesLocal</span><span class="p">(</span><span class="n">coord_vec</span><span class="p">)</span>
</span><span id="Mesh-574"><a href="#Mesh-574"><span class="linenos"> 574</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nuke_coords_and_rebuild</span><span class="p">()</span>
</span><span id="Mesh-575"><a href="#Mesh-575"><span class="linenos"> 575</span></a>
</span><span id="Mesh-576"><a href="#Mesh-576"><span class="linenos"> 576</span></a>        <span class="k">for</span> <span class="n">eq_system</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equation_systems_register</span><span class="p">:</span>
</span><span id="Mesh-577"><a href="#Mesh-577"><span class="linenos"> 577</span></a>            <span class="n">eq_system</span><span class="o">.</span><span class="n">_rebuild_after_mesh_update</span><span class="p">()</span>
</span><span id="Mesh-578"><a href="#Mesh-578"><span class="linenos"> 578</span></a>
</span><span id="Mesh-579"><a href="#Mesh-579"><span class="linenos"> 579</span></a>        <span class="k">return</span>
</span><span id="Mesh-580"><a href="#Mesh-580"><span class="linenos"> 580</span></a>
</span><span id="Mesh-581"><a href="#Mesh-581"><span class="linenos"> 581</span></a>    <span class="k">def</span> <span class="nf">access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">writeable_vars</span><span class="p">:</span> <span class="s2">&quot;MeshVariable&quot;</span><span class="p">):</span>
</span><span id="Mesh-582"><a href="#Mesh-582"><span class="linenos"> 582</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-583"><a href="#Mesh-583"><span class="linenos"> 583</span></a><span class="sd">        This context manager makes the underlying mesh variables data available to</span>
</span><span id="Mesh-584"><a href="#Mesh-584"><span class="linenos"> 584</span></a><span class="sd">        the user. The data should be accessed via the variables `data` handle.</span>
</span><span id="Mesh-585"><a href="#Mesh-585"><span class="linenos"> 585</span></a>
</span><span id="Mesh-586"><a href="#Mesh-586"><span class="linenos"> 586</span></a><span class="sd">        As default, all data is read-only. To enable writeable data, the user should</span>
</span><span id="Mesh-587"><a href="#Mesh-587"><span class="linenos"> 587</span></a><span class="sd">        specify which variable they wish to modify.</span>
</span><span id="Mesh-588"><a href="#Mesh-588"><span class="linenos"> 588</span></a>
</span><span id="Mesh-589"><a href="#Mesh-589"><span class="linenos"> 589</span></a><span class="sd">        Parameters</span>
</span><span id="Mesh-590"><a href="#Mesh-590"><span class="linenos"> 590</span></a><span class="sd">        ----------</span>
</span><span id="Mesh-591"><a href="#Mesh-591"><span class="linenos"> 591</span></a><span class="sd">        writeable_vars</span>
</span><span id="Mesh-592"><a href="#Mesh-592"><span class="linenos"> 592</span></a><span class="sd">            The variables for which data write access is required.</span>
</span><span id="Mesh-593"><a href="#Mesh-593"><span class="linenos"> 593</span></a>
</span><span id="Mesh-594"><a href="#Mesh-594"><span class="linenos"> 594</span></a><span class="sd">        Example</span>
</span><span id="Mesh-595"><a href="#Mesh-595"><span class="linenos"> 595</span></a><span class="sd">        -------</span>
</span><span id="Mesh-596"><a href="#Mesh-596"><span class="linenos"> 596</span></a><span class="sd">        &gt;&gt;&gt; import underworld3 as uw</span>
</span><span id="Mesh-597"><a href="#Mesh-597"><span class="linenos"> 597</span></a><span class="sd">        &gt;&gt;&gt; someMesh = uw.discretisation.FeMesh_Cartesian()</span>
</span><span id="Mesh-598"><a href="#Mesh-598"><span class="linenos"> 598</span></a><span class="sd">        &gt;&gt;&gt; with someMesh.deform_mesh():</span>
</span><span id="Mesh-599"><a href="#Mesh-599"><span class="linenos"> 599</span></a><span class="sd">        ...     someMesh.data[0] = [0.1,0.1]</span>
</span><span id="Mesh-600"><a href="#Mesh-600"><span class="linenos"> 600</span></a><span class="sd">        &gt;&gt;&gt; someMesh.data[0]</span>
</span><span id="Mesh-601"><a href="#Mesh-601"><span class="linenos"> 601</span></a><span class="sd">        array([ 0.1,  0.1])</span>
</span><span id="Mesh-602"><a href="#Mesh-602"><span class="linenos"> 602</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-603"><a href="#Mesh-603"><span class="linenos"> 603</span></a>
</span><span id="Mesh-604"><a href="#Mesh-604"><span class="linenos"> 604</span></a>        <span class="kn">import</span> <span class="nn">time</span>
</span><span id="Mesh-605"><a href="#Mesh-605"><span class="linenos"> 605</span></a>
</span><span id="Mesh-606"><a href="#Mesh-606"><span class="linenos"> 606</span></a>        <span class="n">timing</span><span class="o">.</span><span class="n">_incrementDepth</span><span class="p">()</span>
</span><span id="Mesh-607"><a href="#Mesh-607"><span class="linenos"> 607</span></a>        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Mesh-608"><a href="#Mesh-608"><span class="linenos"> 608</span></a>
</span><span id="Mesh-609"><a href="#Mesh-609"><span class="linenos"> 609</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Mesh-610"><a href="#Mesh-610"><span class="linenos"> 610</span></a>        <span class="n">deaccess_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Mesh-611"><a href="#Mesh-611"><span class="linenos"> 611</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Mesh-612"><a href="#Mesh-612"><span class="linenos"> 612</span></a>            <span class="c1"># if already accessed within higher level context manager, continue.</span>
</span><span id="Mesh-613"><a href="#Mesh-613"><span class="linenos"> 613</span></a>            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Mesh-614"><a href="#Mesh-614"><span class="linenos"> 614</span></a>                <span class="k">continue</span>
</span><span id="Mesh-615"><a href="#Mesh-615"><span class="linenos"> 615</span></a>
</span><span id="Mesh-616"><a href="#Mesh-616"><span class="linenos"> 616</span></a>            <span class="c1"># set flag so variable status can be known elsewhere</span>
</span><span id="Mesh-617"><a href="#Mesh-617"><span class="linenos"> 617</span></a>            <span class="n">var</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Mesh-618"><a href="#Mesh-618"><span class="linenos"> 618</span></a>            <span class="c1"># add to de-access list to rewind this later</span>
</span><span id="Mesh-619"><a href="#Mesh-619"><span class="linenos"> 619</span></a>            <span class="n">deaccess_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span id="Mesh-620"><a href="#Mesh-620"><span class="linenos"> 620</span></a>
</span><span id="Mesh-621"><a href="#Mesh-621"><span class="linenos"> 621</span></a>            <span class="c1"># create &amp; set vec</span>
</span><span id="Mesh-622"><a href="#Mesh-622"><span class="linenos"> 622</span></a>            <span class="n">var</span><span class="o">.</span><span class="n">_set_vec</span><span class="p">(</span><span class="n">available</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh-623"><a href="#Mesh-623"><span class="linenos"> 623</span></a>
</span><span id="Mesh-624"><a href="#Mesh-624"><span class="linenos"> 624</span></a>            <span class="c1"># grab numpy object, setting read only if necessary</span>
</span><span id="Mesh-625"><a href="#Mesh-625"><span class="linenos"> 625</span></a>            <span class="n">var</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">vec</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="p">)</span>
</span><span id="Mesh-626"><a href="#Mesh-626"><span class="linenos"> 626</span></a>
</span><span id="Mesh-627"><a href="#Mesh-627"><span class="linenos"> 627</span></a>            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">writeable_vars</span><span class="p">:</span>
</span><span id="Mesh-628"><a href="#Mesh-628"><span class="linenos"> 628</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">_old_data_flag</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span>
</span><span id="Mesh-629"><a href="#Mesh-629"><span class="linenos"> 629</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh-630"><a href="#Mesh-630"><span class="linenos"> 630</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-631"><a href="#Mesh-631"><span class="linenos"> 631</span></a>                <span class="c1"># increment variable state</span>
</span><span id="Mesh-632"><a href="#Mesh-632"><span class="linenos"> 632</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">_increment</span><span class="p">()</span>
</span><span id="Mesh-633"><a href="#Mesh-633"><span class="linenos"> 633</span></a>
</span><span id="Mesh-634"><a href="#Mesh-634"><span class="linenos"> 634</span></a>            <span class="c1"># make view for each var component</span>
</span><span id="Mesh-635"><a href="#Mesh-635"><span class="linenos"> 635</span></a>
</span><span id="Mesh-636"><a href="#Mesh-636"><span class="linenos"> 636</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="Mesh-637"><a href="#Mesh-637"><span class="linenos"> 637</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="Mesh-638"><a href="#Mesh-638"><span class="linenos"> 638</span></a>                    <span class="c1"># var._data_ij[i, j] = var.data[:, var._data_layout(i, j)]</span>
</span><span id="Mesh-639"><a href="#Mesh-639"><span class="linenos"> 639</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
</span><span id="Mesh-640"><a href="#Mesh-640"><span class="linenos"> 640</span></a>                        <span class="n">data</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">var</span><span class="o">.</span><span class="n">_data_layout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)],</span>
</span><span id="Mesh-641"><a href="#Mesh-641"><span class="linenos"> 641</span></a>                    <span class="p">)</span>
</span><span id="Mesh-642"><a href="#Mesh-642"><span class="linenos"> 642</span></a>
</span><span id="Mesh-643"><a href="#Mesh-643"><span class="linenos"> 643</span></a>        <span class="k">class</span> <span class="nc">exit_manager</span><span class="p">:</span>
</span><span id="Mesh-644"><a href="#Mesh-644"><span class="linenos"> 644</span></a>            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
</span><span id="Mesh-645"><a href="#Mesh-645"><span class="linenos"> 645</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
</span><span id="Mesh-646"><a href="#Mesh-646"><span class="linenos"> 646</span></a>
</span><span id="Mesh-647"><a href="#Mesh-647"><span class="linenos"> 647</span></a>            <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-648"><a href="#Mesh-648"><span class="linenos"> 648</span></a>                <span class="k">pass</span>
</span><span id="Mesh-649"><a href="#Mesh-649"><span class="linenos"> 649</span></a>
</span><span id="Mesh-650"><a href="#Mesh-650"><span class="linenos"> 650</span></a>            <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="Mesh-651"><a href="#Mesh-651"><span class="linenos"> 651</span></a>                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Mesh-652"><a href="#Mesh-652"><span class="linenos"> 652</span></a>                    <span class="c1"># only de-access variables we have set access for.</span>
</span><span id="Mesh-653"><a href="#Mesh-653"><span class="linenos"> 653</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deaccess_list</span><span class="p">:</span>
</span><span id="Mesh-654"><a href="#Mesh-654"><span class="linenos"> 654</span></a>                        <span class="k">continue</span>
</span><span id="Mesh-655"><a href="#Mesh-655"><span class="linenos"> 655</span></a>                    <span class="c1"># set this back, although possibly not required.</span>
</span><span id="Mesh-656"><a href="#Mesh-656"><span class="linenos"> 656</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">writeable_vars</span><span class="p">:</span>
</span><span id="Mesh-657"><a href="#Mesh-657"><span class="linenos"> 657</span></a>                        <span class="n">var</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_old_data_flag</span>
</span><span id="Mesh-658"><a href="#Mesh-658"><span class="linenos"> 658</span></a>                    <span class="c1"># perform sync for any modified vars.</span>
</span><span id="Mesh-659"><a href="#Mesh-659"><span class="linenos"> 659</span></a>
</span><span id="Mesh-660"><a href="#Mesh-660"><span class="linenos"> 660</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">writeable_vars</span><span class="p">:</span>
</span><span id="Mesh-661"><a href="#Mesh-661"><span class="linenos"> 661</span></a>                        <span class="n">indexset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="Mesh-662"><a href="#Mesh-662"><span class="linenos"> 662</span></a>
</span><span id="Mesh-663"><a href="#Mesh-663"><span class="linenos"> 663</span></a>                        <span class="c1"># sync ghost values</span>
</span><span id="Mesh-664"><a href="#Mesh-664"><span class="linenos"> 664</span></a>                        <span class="n">subdm</span><span class="o">.</span><span class="n">localToGlobal</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">vec</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh-665"><a href="#Mesh-665"><span class="linenos"> 665</span></a>                        <span class="n">subdm</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">vec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh-666"><a href="#Mesh-666"><span class="linenos"> 666</span></a>
</span><span id="Mesh-667"><a href="#Mesh-667"><span class="linenos"> 667</span></a>                        <span class="c1"># subdm.destroy()</span>
</span><span id="Mesh-668"><a href="#Mesh-668"><span class="linenos"> 668</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">_stale_lvec</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Mesh-669"><a href="#Mesh-669"><span class="linenos"> 669</span></a>
</span><span id="Mesh-670"><a href="#Mesh-670"><span class="linenos"> 670</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh-671"><a href="#Mesh-671"><span class="linenos"> 671</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_set_vec</span><span class="p">(</span><span class="n">available</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh-672"><a href="#Mesh-672"><span class="linenos"> 672</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh-673"><a href="#Mesh-673"><span class="linenos"> 673</span></a>
</span><span id="Mesh-674"><a href="#Mesh-674"><span class="linenos"> 674</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="Mesh-675"><a href="#Mesh-675"><span class="linenos"> 675</span></a>                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="Mesh-676"><a href="#Mesh-676"><span class="linenos"> 676</span></a>                            <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span>
</span><span id="Mesh-677"><a href="#Mesh-677"><span class="linenos"> 677</span></a>                                <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
</span><span id="Mesh-678"><a href="#Mesh-678"><span class="linenos"> 678</span></a>                            <span class="p">]</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
</span><span id="Mesh-679"><a href="#Mesh-679"><span class="linenos"> 679</span></a>                                <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MeshVariable[...].data is only available within mesh.access() context&quot;</span><span class="p">,</span>
</span><span id="Mesh-680"><a href="#Mesh-680"><span class="linenos"> 680</span></a>                            <span class="p">)</span>
</span><span id="Mesh-681"><a href="#Mesh-681"><span class="linenos"> 681</span></a>
</span><span id="Mesh-682"><a href="#Mesh-682"><span class="linenos"> 682</span></a>                <span class="n">timing</span><span class="o">.</span><span class="n">_decrementDepth</span><span class="p">()</span>
</span><span id="Mesh-683"><a href="#Mesh-683"><span class="linenos"> 683</span></a>                <span class="n">timing</span><span class="o">.</span><span class="n">log_result</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">stime</span><span class="p">,</span> <span class="s2">&quot;Mesh.access&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Mesh-684"><a href="#Mesh-684"><span class="linenos"> 684</span></a>
</span><span id="Mesh-685"><a href="#Mesh-685"><span class="linenos"> 685</span></a>        <span class="k">return</span> <span class="n">exit_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Mesh-686"><a href="#Mesh-686"><span class="linenos"> 686</span></a>
</span><span id="Mesh-687"><a href="#Mesh-687"><span class="linenos"> 687</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-688"><a href="#Mesh-688"><span class="linenos"> 688</span></a>    <span class="k">def</span> <span class="nf">N</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">CoordSys3D</span><span class="p">:</span>
</span><span id="Mesh-689"><a href="#Mesh-689"><span class="linenos"> 689</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-690"><a href="#Mesh-690"><span class="linenos"> 690</span></a><span class="sd">        The mesh coordinate system.</span>
</span><span id="Mesh-691"><a href="#Mesh-691"><span class="linenos"> 691</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-692"><a href="#Mesh-692"><span class="linenos"> 692</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
</span><span id="Mesh-693"><a href="#Mesh-693"><span class="linenos"> 693</span></a>
</span><span id="Mesh-694"><a href="#Mesh-694"><span class="linenos"> 694</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-695"><a href="#Mesh-695"><span class="linenos"> 695</span></a>    <span class="k">def</span> <span class="nf">Gamma_N</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">CoordSys3D</span><span class="p">:</span>
</span><span id="Mesh-696"><a href="#Mesh-696"><span class="linenos"> 696</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-697"><a href="#Mesh-697"><span class="linenos"> 697</span></a><span class="sd">        The mesh coordinate system.</span>
</span><span id="Mesh-698"><a href="#Mesh-698"><span class="linenos"> 698</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-699"><a href="#Mesh-699"><span class="linenos"> 699</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span>
</span><span id="Mesh-700"><a href="#Mesh-700"><span class="linenos"> 700</span></a>
</span><span id="Mesh-701"><a href="#Mesh-701"><span class="linenos"> 701</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-702"><a href="#Mesh-702"><span class="linenos"> 702</span></a>    <span class="k">def</span> <span class="nf">Gamma</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">CoordSys3D</span><span class="p">:</span>
</span><span id="Mesh-703"><a href="#Mesh-703"><span class="linenos"> 703</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-704"><a href="#Mesh-704"><span class="linenos"> 704</span></a><span class="sd">        The mesh coordinate system.</span>
</span><span id="Mesh-705"><a href="#Mesh-705"><span class="linenos"> 705</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-706"><a href="#Mesh-706"><span class="linenos"> 706</span></a>        <span class="k">return</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">base_scalars</span><span class="p">()[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="Mesh-707"><a href="#Mesh-707"><span class="linenos"> 707</span></a>
</span><span id="Mesh-708"><a href="#Mesh-708"><span class="linenos"> 708</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-709"><a href="#Mesh-709"><span class="linenos"> 709</span></a>    <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">:</span>
</span><span id="Mesh-710"><a href="#Mesh-710"><span class="linenos"> 710</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CoordinateSystem</span><span class="o">.</span><span class="n">X</span>
</span><span id="Mesh-711"><a href="#Mesh-711"><span class="linenos"> 711</span></a>
</span><span id="Mesh-712"><a href="#Mesh-712"><span class="linenos"> 712</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-713"><a href="#Mesh-713"><span class="linenos"> 713</span></a>    <span class="k">def</span> <span class="nf">CoordinateSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CoordinateSystem</span><span class="p">:</span>
</span><span id="Mesh-714"><a href="#Mesh-714"><span class="linenos"> 714</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CoordinateSystem</span>
</span><span id="Mesh-715"><a href="#Mesh-715"><span class="linenos"> 715</span></a>
</span><span id="Mesh-716"><a href="#Mesh-716"><span class="linenos"> 716</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-717"><a href="#Mesh-717"><span class="linenos"> 717</span></a>    <span class="k">def</span> <span class="nf">r</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">BaseScalar</span><span class="p">]:</span>
</span><span id="Mesh-718"><a href="#Mesh-718"><span class="linenos"> 718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-719"><a href="#Mesh-719"><span class="linenos"> 719</span></a><span class="sd">        The tuple of base scalar objects (N.x,N.y,N.z) for the mesh.</span>
</span><span id="Mesh-720"><a href="#Mesh-720"><span class="linenos"> 720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-721"><a href="#Mesh-721"><span class="linenos"> 721</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">base_scalars</span><span class="p">()[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">]</span>
</span><span id="Mesh-722"><a href="#Mesh-722"><span class="linenos"> 722</span></a>
</span><span id="Mesh-723"><a href="#Mesh-723"><span class="linenos"> 723</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-724"><a href="#Mesh-724"><span class="linenos"> 724</span></a>    <span class="k">def</span> <span class="nf">rvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">Vector</span><span class="p">:</span>
</span><span id="Mesh-725"><a href="#Mesh-725"><span class="linenos"> 725</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-726"><a href="#Mesh-726"><span class="linenos"> 726</span></a><span class="sd">        The r vector, `r = N.x*N.i + N.y*N.j [+ N.z*N.k]`.</span>
</span><span id="Mesh-727"><a href="#Mesh-727"><span class="linenos"> 727</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-728"><a href="#Mesh-728"><span class="linenos"> 728</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
</span><span id="Mesh-729"><a href="#Mesh-729"><span class="linenos"> 729</span></a>
</span><span id="Mesh-730"><a href="#Mesh-730"><span class="linenos"> 730</span></a>        <span class="n">r_vec</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">zero</span>
</span><span id="Mesh-731"><a href="#Mesh-731"><span class="linenos"> 731</span></a>
</span><span id="Mesh-732"><a href="#Mesh-732"><span class="linenos"> 732</span></a>        <span class="n">N_s</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">base_scalars</span><span class="p">()</span>
</span><span id="Mesh-733"><a href="#Mesh-733"><span class="linenos"> 733</span></a>        <span class="n">N_v</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">base_vectors</span><span class="p">()</span>
</span><span id="Mesh-734"><a href="#Mesh-734"><span class="linenos"> 734</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">):</span>
</span><span id="Mesh-735"><a href="#Mesh-735"><span class="linenos"> 735</span></a>            <span class="n">r_vec</span> <span class="o">+=</span> <span class="n">N_s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">N_v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Mesh-736"><a href="#Mesh-736"><span class="linenos"> 736</span></a>
</span><span id="Mesh-737"><a href="#Mesh-737"><span class="linenos"> 737</span></a>        <span class="k">return</span> <span class="n">r_vec</span>
</span><span id="Mesh-738"><a href="#Mesh-738"><span class="linenos"> 738</span></a>
</span><span id="Mesh-739"><a href="#Mesh-739"><span class="linenos"> 739</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-740"><a href="#Mesh-740"><span class="linenos"> 740</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Mesh-741"><a href="#Mesh-741"><span class="linenos"> 741</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-742"><a href="#Mesh-742"><span class="linenos"> 742</span></a><span class="sd">        The array of mesh element vertex coordinates.</span>
</span><span id="Mesh-743"><a href="#Mesh-743"><span class="linenos"> 743</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-744"><a href="#Mesh-744"><span class="linenos"> 744</span></a>        <span class="c1"># get flat array</span>
</span><span id="Mesh-745"><a href="#Mesh-745"><span class="linenos"> 745</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinatesLocal</span><span class="p">()</span><span class="o">.</span><span class="n">array</span>
</span><span id="Mesh-746"><a href="#Mesh-746"><span class="linenos"> 746</span></a>        <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span>
</span><span id="Mesh-747"><a href="#Mesh-747"><span class="linenos"> 747</span></a>
</span><span id="Mesh-748"><a href="#Mesh-748"><span class="linenos"> 748</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh-749"><a href="#Mesh-749"><span class="linenos"> 749</span></a>    <span class="k">def</span> <span class="nf">write_timestep</span><span class="p">(</span>
</span><span id="Mesh-750"><a href="#Mesh-750"><span class="linenos"> 750</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh-751"><a href="#Mesh-751"><span class="linenos"> 751</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Mesh-752"><a href="#Mesh-752"><span class="linenos"> 752</span></a>        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Mesh-753"><a href="#Mesh-753"><span class="linenos"> 753</span></a>        <span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Mesh-754"><a href="#Mesh-754"><span class="linenos"> 754</span></a>        <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh-755"><a href="#Mesh-755"><span class="linenos"> 755</span></a>        <span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh-756"><a href="#Mesh-756"><span class="linenos"> 756</span></a>        <span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Mesh-757"><a href="#Mesh-757"><span class="linenos"> 757</span></a>    <span class="p">):</span>
</span><span id="Mesh-758"><a href="#Mesh-758"><span class="linenos"> 758</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-759"><a href="#Mesh-759"><span class="linenos"> 759</span></a><span class="sd">        Write the selected mesh, variables and swarm variables (as proxies) for later visualisation.</span>
</span><span id="Mesh-760"><a href="#Mesh-760"><span class="linenos"> 760</span></a><span class="sd">        An xdmf file is generated and the overall package can then be read by paraview or pyvista.</span>
</span><span id="Mesh-761"><a href="#Mesh-761"><span class="linenos"> 761</span></a><span class="sd">        Vertex values (on the mesh points) are stored for all variables regardless of their interpolation order</span>
</span><span id="Mesh-762"><a href="#Mesh-762"><span class="linenos"> 762</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-763"><a href="#Mesh-763"><span class="linenos"> 763</span></a>
</span><span id="Mesh-764"><a href="#Mesh-764"><span class="linenos"> 764</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="Mesh-765"><a href="#Mesh-765"><span class="linenos"> 765</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;viewer_hdf5_sp_output&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh-766"><a href="#Mesh-766"><span class="linenos"> 766</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;viewer_hdf5_collective&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh-767"><a href="#Mesh-767"><span class="linenos"> 767</span></a>
</span><span id="Mesh-768"><a href="#Mesh-768"><span class="linenos"> 768</span></a>        <span class="kn">import</span> <span class="nn">os</span>
</span><span id="Mesh-769"><a href="#Mesh-769"><span class="linenos"> 769</span></a>
</span><span id="Mesh-770"><a href="#Mesh-770"><span class="linenos"> 770</span></a>        <span class="n">output_base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="Mesh-771"><a href="#Mesh-771"><span class="linenos"> 771</span></a>
</span><span id="Mesh-772"><a href="#Mesh-772"><span class="linenos"> 772</span></a>        <span class="c1"># Checkpoint the mesh file itself if required</span>
</span><span id="Mesh-773"><a href="#Mesh-773"><span class="linenos"> 773</span></a>
</span><span id="Mesh-774"><a href="#Mesh-774"><span class="linenos"> 774</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">meshUpdates</span><span class="p">:</span>
</span><span id="Mesh-775"><a href="#Mesh-775"><span class="linenos"> 775</span></a>            <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="Mesh-776"><a href="#Mesh-776"><span class="linenos"> 776</span></a>
</span><span id="Mesh-777"><a href="#Mesh-777"><span class="linenos"> 777</span></a>            <span class="n">mesh_file</span> <span class="o">=</span> <span class="n">output_base_name</span> <span class="o">+</span> <span class="s2">&quot;.mesh.00000.h5&quot;</span>
</span><span id="Mesh-778"><a href="#Mesh-778"><span class="linenos"> 778</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="Mesh-779"><a href="#Mesh-779"><span class="linenos"> 779</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span id="Mesh-780"><a href="#Mesh-780"><span class="linenos"> 780</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="Mesh-781"><a href="#Mesh-781"><span class="linenos"> 781</span></a>
</span><span id="Mesh-782"><a href="#Mesh-782"><span class="linenos"> 782</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-783"><a href="#Mesh-783"><span class="linenos"> 783</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span><span class="p">)</span>
</span><span id="Mesh-784"><a href="#Mesh-784"><span class="linenos"> 784</span></a>
</span><span id="Mesh-785"><a href="#Mesh-785"><span class="linenos"> 785</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-786"><a href="#Mesh-786"><span class="linenos"> 786</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="Mesh-787"><a href="#Mesh-787"><span class="linenos"> 787</span></a>                <span class="n">save_location</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mesh-788"><a href="#Mesh-788"><span class="linenos"> 788</span></a>                    <span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh-789"><a href="#Mesh-789"><span class="linenos"> 789</span></a>                <span class="p">)</span>
</span><span id="Mesh-790"><a href="#Mesh-790"><span class="linenos"> 790</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span>
</span><span id="Mesh-791"><a href="#Mesh-791"><span class="linenos"> 791</span></a>
</span><span id="Mesh-792"><a href="#Mesh-792"><span class="linenos"> 792</span></a>        <span class="k">if</span> <span class="n">swarmVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-793"><a href="#Mesh-793"><span class="linenos"> 793</span></a>            <span class="k">for</span> <span class="n">svar</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="Mesh-794"><a href="#Mesh-794"><span class="linenos"> 794</span></a>                <span class="n">save_location</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mesh-795"><a href="#Mesh-795"><span class="linenos"> 795</span></a>                    <span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.proxy.</span><span class="si">{</span><span class="n">svar</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh-796"><a href="#Mesh-796"><span class="linenos"> 796</span></a>                <span class="p">)</span>
</span><span id="Mesh-797"><a href="#Mesh-797"><span class="linenos"> 797</span></a>                <span class="n">svar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span>
</span><span id="Mesh-798"><a href="#Mesh-798"><span class="linenos"> 798</span></a>
</span><span id="Mesh-799"><a href="#Mesh-799"><span class="linenos"> 799</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-800"><a href="#Mesh-800"><span class="linenos"> 800</span></a>            <span class="n">checkpoint_xdmf</span><span class="p">(</span>
</span><span id="Mesh-801"><a href="#Mesh-801"><span class="linenos"> 801</span></a>                <span class="n">output_base_name</span><span class="p">,</span>
</span><span id="Mesh-802"><a href="#Mesh-802"><span class="linenos"> 802</span></a>                <span class="n">meshUpdates</span><span class="p">,</span>
</span><span id="Mesh-803"><a href="#Mesh-803"><span class="linenos"> 803</span></a>                <span class="n">meshVars</span><span class="p">,</span>
</span><span id="Mesh-804"><a href="#Mesh-804"><span class="linenos"> 804</span></a>                <span class="n">swarmVars</span><span class="p">,</span>
</span><span id="Mesh-805"><a href="#Mesh-805"><span class="linenos"> 805</span></a>                <span class="n">index</span><span class="p">,</span>
</span><span id="Mesh-806"><a href="#Mesh-806"><span class="linenos"> 806</span></a>            <span class="p">)</span>
</span><span id="Mesh-807"><a href="#Mesh-807"><span class="linenos"> 807</span></a>
</span><span id="Mesh-808"><a href="#Mesh-808"><span class="linenos"> 808</span></a>        <span class="k">return</span>
</span><span id="Mesh-809"><a href="#Mesh-809"><span class="linenos"> 809</span></a>
</span><span id="Mesh-810"><a href="#Mesh-810"><span class="linenos"> 810</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh-811"><a href="#Mesh-811"><span class="linenos"> 811</span></a>    <span class="k">def</span> <span class="nf">petsc_save_checkpoint</span><span class="p">(</span>
</span><span id="Mesh-812"><a href="#Mesh-812"><span class="linenos"> 812</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh-813"><a href="#Mesh-813"><span class="linenos"> 813</span></a>        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Mesh-814"><a href="#Mesh-814"><span class="linenos"> 814</span></a>        <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh-815"><a href="#Mesh-815"><span class="linenos"> 815</span></a>        <span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Mesh-816"><a href="#Mesh-816"><span class="linenos"> 816</span></a>    <span class="p">):</span>
</span><span id="Mesh-817"><a href="#Mesh-817"><span class="linenos"> 817</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-818"><a href="#Mesh-818"><span class="linenos"> 818</span></a>
</span><span id="Mesh-819"><a href="#Mesh-819"><span class="linenos"> 819</span></a><span class="sd">        Use PETSc to save the mesh and mesh vars in a h5 and xdmf file.</span>
</span><span id="Mesh-820"><a href="#Mesh-820"><span class="linenos"> 820</span></a>
</span><span id="Mesh-821"><a href="#Mesh-821"><span class="linenos"> 821</span></a><span class="sd">        Parameters</span>
</span><span id="Mesh-822"><a href="#Mesh-822"><span class="linenos"> 822</span></a><span class="sd">        ----------</span>
</span><span id="Mesh-823"><a href="#Mesh-823"><span class="linenos"> 823</span></a><span class="sd">        meshVars:</span>
</span><span id="Mesh-824"><a href="#Mesh-824"><span class="linenos"> 824</span></a><span class="sd">            List of UW mesh variables to save. If left empty then just the mesh is saved.</span>
</span><span id="Mesh-825"><a href="#Mesh-825"><span class="linenos"> 825</span></a><span class="sd">        index :</span>
</span><span id="Mesh-826"><a href="#Mesh-826"><span class="linenos"> 826</span></a><span class="sd">            An index which might correspond to the timestep or output number (for example).</span>
</span><span id="Mesh-827"><a href="#Mesh-827"><span class="linenos"> 827</span></a><span class="sd">        outputPath :</span>
</span><span id="Mesh-828"><a href="#Mesh-828"><span class="linenos"> 828</span></a><span class="sd">            Path to save the data. If left empty it will save the data in the current working directory.</span>
</span><span id="Mesh-829"><a href="#Mesh-829"><span class="linenos"> 829</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-830"><a href="#Mesh-830"><span class="linenos"> 830</span></a>
</span><span id="Mesh-831"><a href="#Mesh-831"><span class="linenos"> 831</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meshVars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Mesh-832"><a href="#Mesh-832"><span class="linenos"> 832</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;`meshVars` does not appear to be a list.&quot;</span><span class="p">)</span>
</span><span id="Mesh-833"><a href="#Mesh-833"><span class="linenos"> 833</span></a>
</span><span id="Mesh-834"><a href="#Mesh-834"><span class="linenos"> 834</span></a>        <span class="kn">from</span> <span class="nn">underworld3.utilities</span> <span class="kn">import</span> <span class="n">generateXdmf</span>
</span><span id="Mesh-835"><a href="#Mesh-835"><span class="linenos"> 835</span></a>
</span><span id="Mesh-836"><a href="#Mesh-836"><span class="linenos"> 836</span></a>        <span class="c1">### save mesh vars</span>
</span><span id="Mesh-837"><a href="#Mesh-837"><span class="linenos"> 837</span></a>        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">outputPath</span><span class="si">}{</span><span class="s1">&#39;_step_&#39;</span><span class="si">}{</span><span class="n">index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh-838"><a href="#Mesh-838"><span class="linenos"> 838</span></a>        <span class="n">xfname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">outputPath</span><span class="si">}{</span><span class="s1">&#39;_step_&#39;</span><span class="si">}{</span><span class="n">index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.xdmf&quot;</span>
</span><span id="Mesh-839"><a href="#Mesh-839"><span class="linenos"> 839</span></a>        <span class="c1">#### create petsc viewer</span>
</span><span id="Mesh-840"><a href="#Mesh-840"><span class="linenos"> 840</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">createHDF5</span><span class="p">(</span>
</span><span id="Mesh-841"><a href="#Mesh-841"><span class="linenos"> 841</span></a>            <span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span>
</span><span id="Mesh-842"><a href="#Mesh-842"><span class="linenos"> 842</span></a>        <span class="p">)</span>
</span><span id="Mesh-843"><a href="#Mesh-843"><span class="linenos"> 843</span></a>
</span><span id="Mesh-844"><a href="#Mesh-844"><span class="linenos"> 844</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh-845"><a href="#Mesh-845"><span class="linenos"> 845</span></a>
</span><span id="Mesh-846"><a href="#Mesh-846"><span class="linenos"> 846</span></a>        <span class="c1">### Empty meshVars will save just the mesh</span>
</span><span id="Mesh-847"><a href="#Mesh-847"><span class="linenos"> 847</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-848"><a href="#Mesh-848"><span class="linenos"> 848</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="Mesh-849"><a href="#Mesh-849"><span class="linenos"> 849</span></a>                <span class="n">viewer</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="Mesh-850"><a href="#Mesh-850"><span class="linenos"> 850</span></a>
</span><span id="Mesh-851"><a href="#Mesh-851"><span class="linenos"> 851</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Mesh-852"><a href="#Mesh-852"><span class="linenos"> 852</span></a>
</span><span id="Mesh-853"><a href="#Mesh-853"><span class="linenos"> 853</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-854"><a href="#Mesh-854"><span class="linenos"> 854</span></a>            <span class="n">generateXdmf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">xfname</span><span class="p">)</span>
</span><span id="Mesh-855"><a href="#Mesh-855"><span class="linenos"> 855</span></a>
</span><span id="Mesh-856"><a href="#Mesh-856"><span class="linenos"> 856</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh-857"><a href="#Mesh-857"><span class="linenos"> 857</span></a>    <span class="k">def</span> <span class="nf">write_checkpoint</span><span class="p">(</span>
</span><span id="Mesh-858"><a href="#Mesh-858"><span class="linenos"> 858</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh-859"><a href="#Mesh-859"><span class="linenos"> 859</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Mesh-860"><a href="#Mesh-860"><span class="linenos"> 860</span></a>        <span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Mesh-861"><a href="#Mesh-861"><span class="linenos"> 861</span></a>        <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh-862"><a href="#Mesh-862"><span class="linenos"> 862</span></a>        <span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh-863"><a href="#Mesh-863"><span class="linenos"> 863</span></a>        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Mesh-864"><a href="#Mesh-864"><span class="linenos"> 864</span></a>        <span class="n">unique_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Mesh-865"><a href="#Mesh-865"><span class="linenos"> 865</span></a>    <span class="p">):</span>
</span><span id="Mesh-866"><a href="#Mesh-866"><span class="linenos"> 866</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Write data in a format that can be restored for restarting the simulation</span>
</span><span id="Mesh-867"><a href="#Mesh-867"><span class="linenos"> 867</span></a><span class="sd">        The difference between this and the visualisation is 1) the parallel section needs</span>
</span><span id="Mesh-868"><a href="#Mesh-868"><span class="linenos"> 868</span></a><span class="sd">        to be stored to reload the data correctly, and 2) the visualisation information (vertex form of fields)</span>
</span><span id="Mesh-869"><a href="#Mesh-869"><span class="linenos"> 869</span></a><span class="sd">        is not stored. This routines uses dmplex *VectorView and *VectorLoad functionality</span>
</span><span id="Mesh-870"><a href="#Mesh-870"><span class="linenos"> 870</span></a>
</span><span id="Mesh-871"><a href="#Mesh-871"><span class="linenos"> 871</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-872"><a href="#Mesh-872"><span class="linenos"> 872</span></a>
</span><span id="Mesh-873"><a href="#Mesh-873"><span class="linenos"> 873</span></a>        <span class="c1"># The mesh checkpoint is the same as the one required for visualisation</span>
</span><span id="Mesh-874"><a href="#Mesh-874"><span class="linenos"> 874</span></a>
</span><span id="Mesh-875"><a href="#Mesh-875"><span class="linenos"> 875</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">meshUpdates</span><span class="p">:</span>
</span><span id="Mesh-876"><a href="#Mesh-876"><span class="linenos"> 876</span></a>            <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="Mesh-877"><a href="#Mesh-877"><span class="linenos"> 877</span></a>
</span><span id="Mesh-878"><a href="#Mesh-878"><span class="linenos"> 878</span></a>            <span class="n">mesh_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.mesh.0.h5&quot;</span>
</span><span id="Mesh-879"><a href="#Mesh-879"><span class="linenos"> 879</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="Mesh-880"><a href="#Mesh-880"><span class="linenos"> 880</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span id="Mesh-881"><a href="#Mesh-881"><span class="linenos"> 881</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="Mesh-882"><a href="#Mesh-882"><span class="linenos"> 882</span></a>
</span><span id="Mesh-883"><a href="#Mesh-883"><span class="linenos"> 883</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-884"><a href="#Mesh-884"><span class="linenos"> 884</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span><span class="p">)</span>
</span><span id="Mesh-885"><a href="#Mesh-885"><span class="linenos"> 885</span></a>
</span><span id="Mesh-886"><a href="#Mesh-886"><span class="linenos"> 886</span></a>        <span class="c1"># Checkpoint file</span>
</span><span id="Mesh-887"><a href="#Mesh-887"><span class="linenos"> 887</span></a>
</span><span id="Mesh-888"><a href="#Mesh-888"><span class="linenos"> 888</span></a>        <span class="k">if</span> <span class="n">unique_id</span><span class="p">:</span>
</span><span id="Mesh-889"><a href="#Mesh-889"><span class="linenos"> 889</span></a>            <span class="n">checkpoint_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">unique</span><span class="si">}</span><span class="s2">.checkpoint.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh-890"><a href="#Mesh-890"><span class="linenos"> 890</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-891"><a href="#Mesh-891"><span class="linenos"> 891</span></a>            <span class="n">checkpoint_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.checkpoint.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh-892"><a href="#Mesh-892"><span class="linenos"> 892</span></a>
</span><span id="Mesh-893"><a href="#Mesh-893"><span class="linenos"> 893</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_mesh&quot;</span><span class="p">)</span>
</span><span id="Mesh-894"><a href="#Mesh-894"><span class="linenos"> 894</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="Mesh-895"><a href="#Mesh-895"><span class="linenos"> 895</span></a>
</span><span id="Mesh-896"><a href="#Mesh-896"><span class="linenos"> 896</span></a>        <span class="c1"># Store the parallel-mesh section information for restoring the checkpoint.</span>
</span><span id="Mesh-897"><a href="#Mesh-897"><span class="linenos"> 897</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">sectionView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh-898"><a href="#Mesh-898"><span class="linenos"> 898</span></a>
</span><span id="Mesh-899"><a href="#Mesh-899"><span class="linenos"> 899</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-900"><a href="#Mesh-900"><span class="linenos"> 900</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="Mesh-901"><a href="#Mesh-901"><span class="linenos"> 901</span></a>                <span class="n">iset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="Mesh-902"><a href="#Mesh-902"><span class="linenos"> 902</span></a>                <span class="n">subdm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="p">)</span>
</span><span id="Mesh-903"><a href="#Mesh-903"><span class="linenos"> 903</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">globalVectorView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="Mesh-904"><a href="#Mesh-904"><span class="linenos"> 904</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">sectionView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">)</span>
</span><span id="Mesh-905"><a href="#Mesh-905"><span class="linenos"> 905</span></a>                <span class="c1"># v._gvec.view(viewer) # would add viz information plus a duplicate of the data</span>
</span><span id="Mesh-906"><a href="#Mesh-906"><span class="linenos"> 906</span></a>
</span><span id="Mesh-907"><a href="#Mesh-907"><span class="linenos"> 907</span></a>        <span class="k">if</span> <span class="n">swarmVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-908"><a href="#Mesh-908"><span class="linenos"> 908</span></a>            <span class="k">for</span> <span class="n">svar</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="Mesh-909"><a href="#Mesh-909"><span class="linenos"> 909</span></a>                <span class="n">var</span> <span class="o">=</span> <span class="n">svar</span><span class="o">.</span><span class="n">_meshVar</span>
</span><span id="Mesh-910"><a href="#Mesh-910"><span class="linenos"> 910</span></a>                <span class="n">iset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="Mesh-911"><a href="#Mesh-911"><span class="linenos"> 911</span></a>                <span class="n">subdm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="p">)</span>
</span><span id="Mesh-912"><a href="#Mesh-912"><span class="linenos"> 912</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">globalVectorView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="Mesh-913"><a href="#Mesh-913"><span class="linenos"> 913</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">sectionView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">)</span>
</span><span id="Mesh-914"><a href="#Mesh-914"><span class="linenos"> 914</span></a>
</span><span id="Mesh-915"><a href="#Mesh-915"><span class="linenos"> 915</span></a>        <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>  <span class="c1"># should not be required</span>
</span><span id="Mesh-916"><a href="#Mesh-916"><span class="linenos"> 916</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Mesh-917"><a href="#Mesh-917"><span class="linenos"> 917</span></a>
</span><span id="Mesh-918"><a href="#Mesh-918"><span class="linenos"> 918</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh-919"><a href="#Mesh-919"><span class="linenos"> 919</span></a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Mesh-920"><a href="#Mesh-920"><span class="linenos"> 920</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-921"><a href="#Mesh-921"><span class="linenos"> 921</span></a><span class="sd">        Save mesh data to the specified hdf5 file.</span>
</span><span id="Mesh-922"><a href="#Mesh-922"><span class="linenos"> 922</span></a>
</span><span id="Mesh-923"><a href="#Mesh-923"><span class="linenos"> 923</span></a>
</span><span id="Mesh-924"><a href="#Mesh-924"><span class="linenos"> 924</span></a><span class="sd">        Parameters</span>
</span><span id="Mesh-925"><a href="#Mesh-925"><span class="linenos"> 925</span></a><span class="sd">        ----------</span>
</span><span id="Mesh-926"><a href="#Mesh-926"><span class="linenos"> 926</span></a><span class="sd">        filename :</span>
</span><span id="Mesh-927"><a href="#Mesh-927"><span class="linenos"> 927</span></a><span class="sd">            The filename for the mesh checkpoint file.</span>
</span><span id="Mesh-928"><a href="#Mesh-928"><span class="linenos"> 928</span></a><span class="sd">        index :</span>
</span><span id="Mesh-929"><a href="#Mesh-929"><span class="linenos"> 929</span></a><span class="sd">            Not yet implemented. An optional index which might</span>
</span><span id="Mesh-930"><a href="#Mesh-930"><span class="linenos"> 930</span></a><span class="sd">            correspond to the timestep (for example).</span>
</span><span id="Mesh-931"><a href="#Mesh-931"><span class="linenos"> 931</span></a>
</span><span id="Mesh-932"><a href="#Mesh-932"><span class="linenos"> 932</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-933"><a href="#Mesh-933"><span class="linenos"> 933</span></a>
</span><span id="Mesh-934"><a href="#Mesh-934"><span class="linenos"> 934</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="Mesh-935"><a href="#Mesh-935"><span class="linenos"> 935</span></a>        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
</span><span id="Mesh-936"><a href="#Mesh-936"><span class="linenos"> 936</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Recording `index` not currently supported&quot;</span><span class="p">)</span>
</span><span id="Mesh-937"><a href="#Mesh-937"><span class="linenos"> 937</span></a>            <span class="c1">## JM:To enable timestep recording, the following needs to be called.</span>
</span><span id="Mesh-938"><a href="#Mesh-938"><span class="linenos"> 938</span></a>            <span class="c1">## I&#39;m unsure if the corresponding xdmf functionality is enabled via</span>
</span><span id="Mesh-939"><a href="#Mesh-939"><span class="linenos"> 939</span></a>            <span class="c1">## the PETSc xdmf script.</span>
</span><span id="Mesh-940"><a href="#Mesh-940"><span class="linenos"> 940</span></a>            <span class="c1"># viewer.pushTimestepping(viewer)</span>
</span><span id="Mesh-941"><a href="#Mesh-941"><span class="linenos"> 941</span></a>            <span class="c1"># viewer.setTimestep(index)</span>
</span><span id="Mesh-942"><a href="#Mesh-942"><span class="linenos"> 942</span></a>
</span><span id="Mesh-943"><a href="#Mesh-943"><span class="linenos"> 943</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh-944"><a href="#Mesh-944"><span class="linenos"> 944</span></a>
</span><span id="Mesh-945"><a href="#Mesh-945"><span class="linenos"> 945</span></a>        <span class="c1"># Not sure if the files are correctly written if we do not explicitly destroy the viewer</span>
</span><span id="Mesh-946"><a href="#Mesh-946"><span class="linenos"> 946</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Mesh-947"><a href="#Mesh-947"><span class="linenos"> 947</span></a>
</span><span id="Mesh-948"><a href="#Mesh-948"><span class="linenos"> 948</span></a>    <span class="k">def</span> <span class="nf">vtk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Mesh-949"><a href="#Mesh-949"><span class="linenos"> 949</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-950"><a href="#Mesh-950"><span class="linenos"> 950</span></a><span class="sd">        Save mesh to the specified file</span>
</span><span id="Mesh-951"><a href="#Mesh-951"><span class="linenos"> 951</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-952"><a href="#Mesh-952"><span class="linenos"> 952</span></a>
</span><span id="Mesh-953"><a href="#Mesh-953"><span class="linenos"> 953</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span><span class="o">.</span><span class="n">createVTK</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="Mesh-954"><a href="#Mesh-954"><span class="linenos"> 954</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh-955"><a href="#Mesh-955"><span class="linenos"> 955</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Mesh-956"><a href="#Mesh-956"><span class="linenos"> 956</span></a>
</span><span id="Mesh-957"><a href="#Mesh-957"><span class="linenos"> 957</span></a>    <span class="k">def</span> <span class="nf">generate_xdmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Mesh-958"><a href="#Mesh-958"><span class="linenos"> 958</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-959"><a href="#Mesh-959"><span class="linenos"> 959</span></a><span class="sd">        This method generates an xdmf schema for the specified file.</span>
</span><span id="Mesh-960"><a href="#Mesh-960"><span class="linenos"> 960</span></a>
</span><span id="Mesh-961"><a href="#Mesh-961"><span class="linenos"> 961</span></a><span class="sd">        The filename of the generated file will be the same as the hdf5 file</span>
</span><span id="Mesh-962"><a href="#Mesh-962"><span class="linenos"> 962</span></a><span class="sd">        but with the `xmf` extension.</span>
</span><span id="Mesh-963"><a href="#Mesh-963"><span class="linenos"> 963</span></a>
</span><span id="Mesh-964"><a href="#Mesh-964"><span class="linenos"> 964</span></a><span class="sd">        Parameters</span>
</span><span id="Mesh-965"><a href="#Mesh-965"><span class="linenos"> 965</span></a><span class="sd">        ----------</span>
</span><span id="Mesh-966"><a href="#Mesh-966"><span class="linenos"> 966</span></a><span class="sd">        filename :</span>
</span><span id="Mesh-967"><a href="#Mesh-967"><span class="linenos"> 967</span></a><span class="sd">            File name of the checkpointed hdf5 file for which the</span>
</span><span id="Mesh-968"><a href="#Mesh-968"><span class="linenos"> 968</span></a><span class="sd">            xdmf schema will be written.</span>
</span><span id="Mesh-969"><a href="#Mesh-969"><span class="linenos"> 969</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-970"><a href="#Mesh-970"><span class="linenos"> 970</span></a>        <span class="kn">from</span> <span class="nn">underworld3.utilities</span> <span class="kn">import</span> <span class="n">generateXdmf</span>
</span><span id="Mesh-971"><a href="#Mesh-971"><span class="linenos"> 971</span></a>
</span><span id="Mesh-972"><a href="#Mesh-972"><span class="linenos"> 972</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-973"><a href="#Mesh-973"><span class="linenos"> 973</span></a>            <span class="n">generateXdmf</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="Mesh-974"><a href="#Mesh-974"><span class="linenos"> 974</span></a>
</span><span id="Mesh-975"><a href="#Mesh-975"><span class="linenos"> 975</span></a>        <span class="k">return</span>
</span><span id="Mesh-976"><a href="#Mesh-976"><span class="linenos"> 976</span></a>
</span><span id="Mesh-977"><a href="#Mesh-977"><span class="linenos"> 977</span></a>    <span class="c1"># ToDo: rename this so it does not clash with the vars built in</span>
</span><span id="Mesh-978"><a href="#Mesh-978"><span class="linenos"> 978</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-979"><a href="#Mesh-979"><span class="linenos"> 979</span></a>    <span class="k">def</span> <span class="nf">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-980"><a href="#Mesh-980"><span class="linenos"> 980</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-981"><a href="#Mesh-981"><span class="linenos"> 981</span></a><span class="sd">        A list of variables recorded on the mesh.</span>
</span><span id="Mesh-982"><a href="#Mesh-982"><span class="linenos"> 982</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-983"><a href="#Mesh-983"><span class="linenos"> 983</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span>
</span><span id="Mesh-984"><a href="#Mesh-984"><span class="linenos"> 984</span></a>
</span><span id="Mesh-985"><a href="#Mesh-985"><span class="linenos"> 985</span></a>        <span class="c1"># ToDo: rename this so it does not clash with the vars built in</span>
</span><span id="Mesh-986"><a href="#Mesh-986"><span class="linenos"> 986</span></a>
</span><span id="Mesh-987"><a href="#Mesh-987"><span class="linenos"> 987</span></a>    <span class="nd">@property</span>
</span><span id="Mesh-988"><a href="#Mesh-988"><span class="linenos"> 988</span></a>    <span class="k">def</span> <span class="nf">block_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-989"><a href="#Mesh-989"><span class="linenos"> 989</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-990"><a href="#Mesh-990"><span class="linenos"> 990</span></a><span class="sd">        A list of variables recorded on the mesh.</span>
</span><span id="Mesh-991"><a href="#Mesh-991"><span class="linenos"> 991</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-992"><a href="#Mesh-992"><span class="linenos"> 992</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_vars</span>
</span><span id="Mesh-993"><a href="#Mesh-993"><span class="linenos"> 993</span></a>
</span><span id="Mesh-994"><a href="#Mesh-994"><span class="linenos"> 994</span></a>    <span class="k">def</span> <span class="nf">_get_coords_for_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
</span><span id="Mesh-995"><a href="#Mesh-995"><span class="linenos"> 995</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-996"><a href="#Mesh-996"><span class="linenos"> 996</span></a><span class="sd">        This function returns the vertex array for the</span>
</span><span id="Mesh-997"><a href="#Mesh-997"><span class="linenos"> 997</span></a><span class="sd">        provided variable. If the array does not already exist,</span>
</span><span id="Mesh-998"><a href="#Mesh-998"><span class="linenos"> 998</span></a><span class="sd">        it is first created and then returned.</span>
</span><span id="Mesh-999"><a href="#Mesh-999"><span class="linenos"> 999</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1000"><a href="#Mesh-1000"><span class="linenos">1000</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">continuous</span><span class="p">)</span>
</span><span id="Mesh-1001"><a href="#Mesh-1001"><span class="linenos">1001</span></a>
</span><span id="Mesh-1002"><a href="#Mesh-1002"><span class="linenos">1002</span></a>        <span class="c1"># if array already created, return.</span>
</span><span id="Mesh-1003"><a href="#Mesh-1003"><span class="linenos">1003</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">:</span>
</span><span id="Mesh-1004"><a href="#Mesh-1004"><span class="linenos">1004</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="Mesh-1005"><a href="#Mesh-1005"><span class="linenos">1005</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-1006"><a href="#Mesh-1006"><span class="linenos">1006</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords_for_basis</span><span class="p">(</span>
</span><span id="Mesh-1007"><a href="#Mesh-1007"><span class="linenos">1007</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">continuous</span>
</span><span id="Mesh-1008"><a href="#Mesh-1008"><span class="linenos">1008</span></a>            <span class="p">)</span>
</span><span id="Mesh-1009"><a href="#Mesh-1009"><span class="linenos">1009</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="Mesh-1010"><a href="#Mesh-1010"><span class="linenos">1010</span></a>
</span><span id="Mesh-1011"><a href="#Mesh-1011"><span class="linenos">1011</span></a>    <span class="k">def</span> <span class="nf">_get_coords_for_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">continuous</span><span class="p">):</span>
</span><span id="Mesh-1012"><a href="#Mesh-1012"><span class="linenos">1012</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-1013"><a href="#Mesh-1013"><span class="linenos">1013</span></a><span class="sd">        This function returns the vertex array for the</span>
</span><span id="Mesh-1014"><a href="#Mesh-1014"><span class="linenos">1014</span></a><span class="sd">        provided variable. If the array does not already exist,</span>
</span><span id="Mesh-1015"><a href="#Mesh-1015"><span class="linenos">1015</span></a><span class="sd">        it is first created and then returned.</span>
</span><span id="Mesh-1016"><a href="#Mesh-1016"><span class="linenos">1016</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1017"><a href="#Mesh-1017"><span class="linenos">1017</span></a>
</span><span id="Mesh-1018"><a href="#Mesh-1018"><span class="linenos">1018</span></a>        <span class="n">dmold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinateDM</span><span class="p">()</span>
</span><span id="Mesh-1019"><a href="#Mesh-1019"><span class="linenos">1019</span></a>        <span class="n">dmold</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="Mesh-1020"><a href="#Mesh-1020"><span class="linenos">1020</span></a>        <span class="n">dmnew</span> <span class="o">=</span> <span class="n">dmold</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="Mesh-1021"><a href="#Mesh-1021"><span class="linenos">1021</span></a>
</span><span id="Mesh-1022"><a href="#Mesh-1022"><span class="linenos">1022</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="Mesh-1023"><a href="#Mesh-1023"><span class="linenos">1023</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;coordinterp_petscspace_degree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">degree</span>
</span><span id="Mesh-1024"><a href="#Mesh-1024"><span class="linenos">1024</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;coordinterp_petscdualspace_lagrange_continuity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">continuous</span>
</span><span id="Mesh-1025"><a href="#Mesh-1025"><span class="linenos">1025</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;coordinterp_petscdualspace_lagrange_node_endpoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh-1026"><a href="#Mesh-1026"><span class="linenos">1026</span></a>
</span><span id="Mesh-1027"><a href="#Mesh-1027"><span class="linenos">1027</span></a>        <span class="n">dmfe</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">FE</span><span class="p">()</span><span class="o">.</span><span class="n">createDefault</span><span class="p">(</span>
</span><span id="Mesh-1028"><a href="#Mesh-1028"><span class="linenos">1028</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="Mesh-1029"><a href="#Mesh-1029"><span class="linenos">1029</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">,</span>
</span><span id="Mesh-1030"><a href="#Mesh-1030"><span class="linenos">1030</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="Mesh-1031"><a href="#Mesh-1031"><span class="linenos">1031</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">qdegree</span><span class="p">,</span>
</span><span id="Mesh-1032"><a href="#Mesh-1032"><span class="linenos">1032</span></a>            <span class="s2">&quot;coordinterp_&quot;</span><span class="p">,</span>
</span><span id="Mesh-1033"><a href="#Mesh-1033"><span class="linenos">1033</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span>
</span><span id="Mesh-1034"><a href="#Mesh-1034"><span class="linenos">1034</span></a>        <span class="p">)</span>
</span><span id="Mesh-1035"><a href="#Mesh-1035"><span class="linenos">1035</span></a>
</span><span id="Mesh-1036"><a href="#Mesh-1036"><span class="linenos">1036</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">setField</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dmfe</span><span class="p">)</span>
</span><span id="Mesh-1037"><a href="#Mesh-1037"><span class="linenos">1037</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="Mesh-1038"><a href="#Mesh-1038"><span class="linenos">1038</span></a>
</span><span id="Mesh-1039"><a href="#Mesh-1039"><span class="linenos">1039</span></a>        <span class="n">matInterp</span><span class="p">,</span> <span class="n">vecScale</span> <span class="o">=</span> <span class="n">dmold</span><span class="o">.</span><span class="n">createInterpolation</span><span class="p">(</span><span class="n">dmnew</span><span class="p">)</span>
</span><span id="Mesh-1040"><a href="#Mesh-1040"><span class="linenos">1040</span></a>        <span class="n">coordsOld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinates</span><span class="p">()</span>
</span><span id="Mesh-1041"><a href="#Mesh-1041"><span class="linenos">1041</span></a>        <span class="n">coordsNewL</span> <span class="o">=</span> <span class="n">dmnew</span><span class="o">.</span><span class="n">getLocalVec</span><span class="p">()</span>
</span><span id="Mesh-1042"><a href="#Mesh-1042"><span class="linenos">1042</span></a>        <span class="n">coordsNewG</span> <span class="o">=</span> <span class="n">dmnew</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="Mesh-1043"><a href="#Mesh-1043"><span class="linenos">1043</span></a>        <span class="n">matInterp</span><span class="o">.</span><span class="n">mult</span><span class="p">(</span><span class="n">coordsOld</span><span class="p">,</span> <span class="n">coordsNewG</span><span class="p">)</span>
</span><span id="Mesh-1044"><a href="#Mesh-1044"><span class="linenos">1044</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">coordsNewG</span><span class="p">,</span> <span class="n">coordsNewL</span><span class="p">)</span>
</span><span id="Mesh-1045"><a href="#Mesh-1045"><span class="linenos">1045</span></a>
</span><span id="Mesh-1046"><a href="#Mesh-1046"><span class="linenos">1046</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">coordsNewL</span><span class="o">.</span><span class="n">array</span>
</span><span id="Mesh-1047"><a href="#Mesh-1047"><span class="linenos">1047</span></a>        <span class="n">arrcopy</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Mesh-1048"><a href="#Mesh-1048"><span class="linenos">1048</span></a>
</span><span id="Mesh-1049"><a href="#Mesh-1049"><span class="linenos">1049</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">coordsNewG</span><span class="p">)</span>
</span><span id="Mesh-1050"><a href="#Mesh-1050"><span class="linenos">1050</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">restoreLocalVec</span><span class="p">(</span><span class="n">coordsNewL</span><span class="p">)</span>
</span><span id="Mesh-1051"><a href="#Mesh-1051"><span class="linenos">1051</span></a>        <span class="n">dmnew</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Mesh-1052"><a href="#Mesh-1052"><span class="linenos">1052</span></a>        <span class="n">dmfe</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Mesh-1053"><a href="#Mesh-1053"><span class="linenos">1053</span></a>
</span><span id="Mesh-1054"><a href="#Mesh-1054"><span class="linenos">1054</span></a>        <span class="k">return</span> <span class="n">arrcopy</span>
</span><span id="Mesh-1055"><a href="#Mesh-1055"><span class="linenos">1055</span></a>
</span><span id="Mesh-1056"><a href="#Mesh-1056"><span class="linenos">1056</span></a>    <span class="k">def</span> <span class="nf">_build_kd_tree_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-1057"><a href="#Mesh-1057"><span class="linenos">1057</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-1058"><a href="#Mesh-1058"><span class="linenos">1058</span></a>            <span class="k">return</span>
</span><span id="Mesh-1059"><a href="#Mesh-1059"><span class="linenos">1059</span></a>
</span><span id="Mesh-1060"><a href="#Mesh-1060"><span class="linenos">1060</span></a>        <span class="c1">## Bootstrapping - the kd-tree is needed to build the index but</span>
</span><span id="Mesh-1061"><a href="#Mesh-1061"><span class="linenos">1061</span></a>        <span class="c1">## the index is also used in the kd-tree.</span>
</span><span id="Mesh-1062"><a href="#Mesh-1062"><span class="linenos">1062</span></a>
</span><span id="Mesh-1063"><a href="#Mesh-1063"><span class="linenos">1063</span></a>        <span class="kn">from</span> <span class="nn">underworld3.swarm</span> <span class="kn">import</span> <span class="n">Swarm</span><span class="p">,</span> <span class="n">SwarmPICLayout</span>
</span><span id="Mesh-1064"><a href="#Mesh-1064"><span class="linenos">1064</span></a>
</span><span id="Mesh-1065"><a href="#Mesh-1065"><span class="linenos">1065</span></a>        <span class="c1"># Create a temp swarm which we&#39;ll use to populate particles</span>
</span><span id="Mesh-1066"><a href="#Mesh-1066"><span class="linenos">1066</span></a>        <span class="c1"># at gauss points. These will then be used as basis for</span>
</span><span id="Mesh-1067"><a href="#Mesh-1067"><span class="linenos">1067</span></a>        <span class="c1"># kd-tree indexing back to owning cells.</span>
</span><span id="Mesh-1068"><a href="#Mesh-1068"><span class="linenos">1068</span></a>
</span><span id="Mesh-1069"><a href="#Mesh-1069"><span class="linenos">1069</span></a>        <span class="n">tempSwarm</span> <span class="o">=</span> <span class="n">Swarm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Mesh-1070"><a href="#Mesh-1070"><span class="linenos">1070</span></a>        <span class="c1"># 4^dim pop is used. This number may need to be considered</span>
</span><span id="Mesh-1071"><a href="#Mesh-1071"><span class="linenos">1071</span></a>        <span class="c1"># more carefully, or possibly should be coded to be set dynamically.</span>
</span><span id="Mesh-1072"><a href="#Mesh-1072"><span class="linenos">1072</span></a>
</span><span id="Mesh-1073"><a href="#Mesh-1073"><span class="linenos">1073</span></a>        <span class="c1"># We can&#39;t use our own populate function since this needs THIS kd_tree to exist</span>
</span><span id="Mesh-1074"><a href="#Mesh-1074"><span class="linenos">1074</span></a>        <span class="c1"># We will need to use a standard layout instead</span>
</span><span id="Mesh-1075"><a href="#Mesh-1075"><span class="linenos">1075</span></a>
</span><span id="Mesh-1076"><a href="#Mesh-1076"><span class="linenos">1076</span></a>        <span class="n">tempSwarm</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">finalizeFieldRegister</span><span class="p">()</span>
</span><span id="Mesh-1077"><a href="#Mesh-1077"><span class="linenos">1077</span></a>        <span class="n">tempSwarm</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">insertPointUsingCellDM</span><span class="p">(</span><span class="n">SwarmPICLayout</span><span class="o">.</span><span class="n">GAUSS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="Mesh-1078"><a href="#Mesh-1078"><span class="linenos">1078</span></a>
</span><span id="Mesh-1079"><a href="#Mesh-1079"><span class="linenos">1079</span></a>        <span class="k">with</span> <span class="n">tempSwarm</span><span class="o">.</span><span class="n">access</span><span class="p">():</span>
</span><span id="Mesh-1080"><a href="#Mesh-1080"><span class="linenos">1080</span></a>            <span class="c1"># Build index on particle coords</span>
</span><span id="Mesh-1081"><a href="#Mesh-1081"><span class="linenos">1081</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_indexCoords</span> <span class="o">=</span> <span class="n">tempSwarm</span><span class="o">.</span><span class="n">particle_coordinates</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Mesh-1082"><a href="#Mesh-1082"><span class="linenos">1082</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">kdtree</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_indexCoords</span><span class="p">)</span>
</span><span id="Mesh-1083"><a href="#Mesh-1083"><span class="linenos">1083</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">build_index</span><span class="p">()</span>
</span><span id="Mesh-1084"><a href="#Mesh-1084"><span class="linenos">1084</span></a>
</span><span id="Mesh-1085"><a href="#Mesh-1085"><span class="linenos">1085</span></a>            <span class="c1"># Grab mapping back to cell_ids.</span>
</span><span id="Mesh-1086"><a href="#Mesh-1086"><span class="linenos">1086</span></a>            <span class="c1"># Note that this is the numpy array that we eventually return from this</span>
</span><span id="Mesh-1087"><a href="#Mesh-1087"><span class="linenos">1087</span></a>            <span class="c1"># method. As such, we take measures to ensure that we use `numpy.int64` here</span>
</span><span id="Mesh-1088"><a href="#Mesh-1088"><span class="linenos">1088</span></a>            <span class="c1"># because we cast from this type in  `_function.evaluate` to construct</span>
</span><span id="Mesh-1089"><a href="#Mesh-1089"><span class="linenos">1089</span></a>            <span class="c1"># the PETSc cell-sf datasets, and if instead a `numpy.int32` is used it</span>
</span><span id="Mesh-1090"><a href="#Mesh-1090"><span class="linenos">1090</span></a>            <span class="c1"># will cause bugs that are difficult to find.</span>
</span><span id="Mesh-1091"><a href="#Mesh-1091"><span class="linenos">1091</span></a>
</span><span id="Mesh-1092"><a href="#Mesh-1092"><span class="linenos">1092</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_indexMap</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="Mesh-1093"><a href="#Mesh-1093"><span class="linenos">1093</span></a>                <span class="n">tempSwarm</span><span class="o">.</span><span class="n">particle_cellid</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span>
</span><span id="Mesh-1094"><a href="#Mesh-1094"><span class="linenos">1094</span></a>            <span class="p">)</span>
</span><span id="Mesh-1095"><a href="#Mesh-1095"><span class="linenos">1095</span></a>
</span><span id="Mesh-1096"><a href="#Mesh-1096"><span class="linenos">1096</span></a>        <span class="c1"># Use the &quot;OK&quot; version above to find these lengths</span>
</span><span id="Mesh-1097"><a href="#Mesh-1097"><span class="linenos">1097</span></a>        <span class="p">(</span>
</span><span id="Mesh-1098"><a href="#Mesh-1098"><span class="linenos">1098</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_min_size</span><span class="p">,</span>
</span><span id="Mesh-1099"><a href="#Mesh-1099"><span class="linenos">1099</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="p">,</span>
</span><span id="Mesh-1100"><a href="#Mesh-1100"><span class="linenos">1100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">,</span>
</span><span id="Mesh-1101"><a href="#Mesh-1101"><span class="linenos">1101</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_search_lengths</span><span class="p">,</span>
</span><span id="Mesh-1102"><a href="#Mesh-1102"><span class="linenos">1102</span></a>        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mesh_sizes</span><span class="p">()</span>
</span><span id="Mesh-1103"><a href="#Mesh-1103"><span class="linenos">1103</span></a>
</span><span id="Mesh-1104"><a href="#Mesh-1104"><span class="linenos">1104</span></a>        <span class="c1">## Now, we can use this information to rebuild the index more carefully</span>
</span><span id="Mesh-1105"><a href="#Mesh-1105"><span class="linenos">1105</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-1106"><a href="#Mesh-1106"><span class="linenos">1106</span></a><span class="sd">        tempSwarm2 = Swarm(self)</span>
</span><span id="Mesh-1107"><a href="#Mesh-1107"><span class="linenos">1107</span></a><span class="sd">        tempSwarm2.populate(fill_param=4)</span>
</span><span id="Mesh-1108"><a href="#Mesh-1108"><span class="linenos">1108</span></a>
</span><span id="Mesh-1109"><a href="#Mesh-1109"><span class="linenos">1109</span></a><span class="sd">        with tempSwarm2.access():</span>
</span><span id="Mesh-1110"><a href="#Mesh-1110"><span class="linenos">1110</span></a><span class="sd">            # Build index on particle coords</span>
</span><span id="Mesh-1111"><a href="#Mesh-1111"><span class="linenos">1111</span></a><span class="sd">            self._indexCoords = tempSwarm2.particle_coordinates.data.copy()</span>
</span><span id="Mesh-1112"><a href="#Mesh-1112"><span class="linenos">1112</span></a><span class="sd">            self._index = uw.kdtree.KDTree(self._indexCoords)</span>
</span><span id="Mesh-1113"><a href="#Mesh-1113"><span class="linenos">1113</span></a><span class="sd">            self._index.build_index()</span>
</span><span id="Mesh-1114"><a href="#Mesh-1114"><span class="linenos">1114</span></a>
</span><span id="Mesh-1115"><a href="#Mesh-1115"><span class="linenos">1115</span></a><span class="sd">            # Grab mapping back to cell_ids.</span>
</span><span id="Mesh-1116"><a href="#Mesh-1116"><span class="linenos">1116</span></a><span class="sd">            # Note that this is the numpy array that we eventually return from this</span>
</span><span id="Mesh-1117"><a href="#Mesh-1117"><span class="linenos">1117</span></a><span class="sd">            # method. As such, we take measures to ensure that we use `numpy.int64` here</span>
</span><span id="Mesh-1118"><a href="#Mesh-1118"><span class="linenos">1118</span></a><span class="sd">            # because we cast from this type in  `_function.evaluate` to construct</span>
</span><span id="Mesh-1119"><a href="#Mesh-1119"><span class="linenos">1119</span></a><span class="sd">            # the PETSc cell-sf datasets, and if instead a `numpy.int32` is used it</span>
</span><span id="Mesh-1120"><a href="#Mesh-1120"><span class="linenos">1120</span></a><span class="sd">            # will cause bugs that are difficult to find.</span>
</span><span id="Mesh-1121"><a href="#Mesh-1121"><span class="linenos">1121</span></a>
</span><span id="Mesh-1122"><a href="#Mesh-1122"><span class="linenos">1122</span></a><span class="sd">            self._indexMap = numpy.array(</span>
</span><span id="Mesh-1123"><a href="#Mesh-1123"><span class="linenos">1123</span></a><span class="sd">                tempSwarm2.particle_cellid.data[:, 0], dtype=numpy.int64</span>
</span><span id="Mesh-1124"><a href="#Mesh-1124"><span class="linenos">1124</span></a><span class="sd">            )</span>
</span><span id="Mesh-1125"><a href="#Mesh-1125"><span class="linenos">1125</span></a>
</span><span id="Mesh-1126"><a href="#Mesh-1126"><span class="linenos">1126</span></a><span class="sd">        # update these</span>
</span><span id="Mesh-1127"><a href="#Mesh-1127"><span class="linenos">1127</span></a><span class="sd">        self._min_sizes, self._radii, self._centroids, self._search_lengths = self._get_mesh_sizes()</span>
</span><span id="Mesh-1128"><a href="#Mesh-1128"><span class="linenos">1128</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1129"><a href="#Mesh-1129"><span class="linenos">1129</span></a>        <span class="k">return</span>
</span><span id="Mesh-1130"><a href="#Mesh-1130"><span class="linenos">1130</span></a>
</span><span id="Mesh-1131"><a href="#Mesh-1131"><span class="linenos">1131</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh-1132"><a href="#Mesh-1132"><span class="linenos">1132</span></a>    <span class="k">def</span> <span class="nf">get_closest_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Mesh-1133"><a href="#Mesh-1133"><span class="linenos">1133</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-1134"><a href="#Mesh-1134"><span class="linenos">1134</span></a><span class="sd">        This method uses a kd-tree algorithm to find the closest</span>
</span><span id="Mesh-1135"><a href="#Mesh-1135"><span class="linenos">1135</span></a><span class="sd">        cells to the provided coords. For a regular mesh, this should</span>
</span><span id="Mesh-1136"><a href="#Mesh-1136"><span class="linenos">1136</span></a><span class="sd">        be exactly the owning cell, but if the mesh is deformed, this</span>
</span><span id="Mesh-1137"><a href="#Mesh-1137"><span class="linenos">1137</span></a><span class="sd">        is not guaranteed. Note, the nearest point does may not be all</span>
</span><span id="Mesh-1138"><a href="#Mesh-1138"><span class="linenos">1138</span></a><span class="sd">        that close by - use get_closest_local_cells to filter out points</span>
</span><span id="Mesh-1139"><a href="#Mesh-1139"><span class="linenos">1139</span></a><span class="sd">        that are (probably) not within any local cell.</span>
</span><span id="Mesh-1140"><a href="#Mesh-1140"><span class="linenos">1140</span></a>
</span><span id="Mesh-1141"><a href="#Mesh-1141"><span class="linenos">1141</span></a><span class="sd">        Parameters:</span>
</span><span id="Mesh-1142"><a href="#Mesh-1142"><span class="linenos">1142</span></a><span class="sd">        -----------</span>
</span><span id="Mesh-1143"><a href="#Mesh-1143"><span class="linenos">1143</span></a><span class="sd">        coords:</span>
</span><span id="Mesh-1144"><a href="#Mesh-1144"><span class="linenos">1144</span></a><span class="sd">            An array of the coordinates for which we wish to determine the</span>
</span><span id="Mesh-1145"><a href="#Mesh-1145"><span class="linenos">1145</span></a><span class="sd">            closest cells. This should be a 2-dimensional array of</span>
</span><span id="Mesh-1146"><a href="#Mesh-1146"><span class="linenos">1146</span></a><span class="sd">            shape (n_coords,dim).</span>
</span><span id="Mesh-1147"><a href="#Mesh-1147"><span class="linenos">1147</span></a>
</span><span id="Mesh-1148"><a href="#Mesh-1148"><span class="linenos">1148</span></a><span class="sd">        Returns:</span>
</span><span id="Mesh-1149"><a href="#Mesh-1149"><span class="linenos">1149</span></a><span class="sd">        --------</span>
</span><span id="Mesh-1150"><a href="#Mesh-1150"><span class="linenos">1150</span></a><span class="sd">        closest_cells:</span>
</span><span id="Mesh-1151"><a href="#Mesh-1151"><span class="linenos">1151</span></a><span class="sd">            An array of indices representing the cells closest to the provided</span>
</span><span id="Mesh-1152"><a href="#Mesh-1152"><span class="linenos">1152</span></a><span class="sd">            coordinates. This will be a 1-dimensional array of</span>
</span><span id="Mesh-1153"><a href="#Mesh-1153"><span class="linenos">1153</span></a><span class="sd">            shape (n_coords).</span>
</span><span id="Mesh-1154"><a href="#Mesh-1154"><span class="linenos">1154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1155"><a href="#Mesh-1155"><span class="linenos">1155</span></a>
</span><span id="Mesh-1156"><a href="#Mesh-1156"><span class="linenos">1156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_kd_tree_index</span><span class="p">()</span>
</span><span id="Mesh-1157"><a href="#Mesh-1157"><span class="linenos">1157</span></a>
</span><span id="Mesh-1158"><a href="#Mesh-1158"><span class="linenos">1158</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-1159"><a href="#Mesh-1159"><span class="linenos">1159</span></a>            <span class="n">closest_points</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="Mesh-1160"><a href="#Mesh-1160"><span class="linenos">1160</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-1161"><a href="#Mesh-1161"><span class="linenos">1161</span></a>            <span class="c1">### returns an empty array if no coords are on a proc</span>
</span><span id="Mesh-1162"><a href="#Mesh-1162"><span class="linenos">1162</span></a>            <span class="n">closest_points</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>
</span><span id="Mesh-1163"><a href="#Mesh-1163"><span class="linenos">1163</span></a>
</span><span id="Mesh-1164"><a href="#Mesh-1164"><span class="linenos">1164</span></a>        <span class="k">if</span> <span class="n">found</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-1165"><a href="#Mesh-1165"><span class="linenos">1165</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="Mesh-1166"><a href="#Mesh-1166"><span class="linenos">1166</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Mesh-1167"><a href="#Mesh-1167"><span class="linenos">1167</span></a>                    <span class="s2">&quot;An error was encountered attempting to find the closest cells to the provided coordinates.&quot;</span>
</span><span id="Mesh-1168"><a href="#Mesh-1168"><span class="linenos">1168</span></a>                <span class="p">)</span>
</span><span id="Mesh-1169"><a href="#Mesh-1169"><span class="linenos">1169</span></a>
</span><span id="Mesh-1170"><a href="#Mesh-1170"><span class="linenos">1170</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexMap</span><span class="p">[</span><span class="n">closest_points</span><span class="p">]</span>
</span><span id="Mesh-1171"><a href="#Mesh-1171"><span class="linenos">1171</span></a>
</span><span id="Mesh-1172"><a href="#Mesh-1172"><span class="linenos">1172</span></a>    <span class="k">def</span> <span class="nf">get_closest_local_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Mesh-1173"><a href="#Mesh-1173"><span class="linenos">1173</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-1174"><a href="#Mesh-1174"><span class="linenos">1174</span></a><span class="sd">        This method uses a kd-tree algorithm to find the closest</span>
</span><span id="Mesh-1175"><a href="#Mesh-1175"><span class="linenos">1175</span></a><span class="sd">        cells to the provided coords. For a regular mesh, this should</span>
</span><span id="Mesh-1176"><a href="#Mesh-1176"><span class="linenos">1176</span></a><span class="sd">        be exactly the owning cell, but if the mesh is deformed, this</span>
</span><span id="Mesh-1177"><a href="#Mesh-1177"><span class="linenos">1177</span></a><span class="sd">        is not guaranteed. Also compares the distance from the cell to the</span>
</span><span id="Mesh-1178"><a href="#Mesh-1178"><span class="linenos">1178</span></a><span class="sd">        point - if this is larger than the &quot;cell size&quot; then returns -1</span>
</span><span id="Mesh-1179"><a href="#Mesh-1179"><span class="linenos">1179</span></a>
</span><span id="Mesh-1180"><a href="#Mesh-1180"><span class="linenos">1180</span></a><span class="sd">        Parameters:</span>
</span><span id="Mesh-1181"><a href="#Mesh-1181"><span class="linenos">1181</span></a><span class="sd">        -----------</span>
</span><span id="Mesh-1182"><a href="#Mesh-1182"><span class="linenos">1182</span></a><span class="sd">        coords:</span>
</span><span id="Mesh-1183"><a href="#Mesh-1183"><span class="linenos">1183</span></a><span class="sd">            An array of the coordinates for which we wish to determine the</span>
</span><span id="Mesh-1184"><a href="#Mesh-1184"><span class="linenos">1184</span></a><span class="sd">            closest cells. This should be a 2-dimensional array of</span>
</span><span id="Mesh-1185"><a href="#Mesh-1185"><span class="linenos">1185</span></a><span class="sd">            shape (n_coords,dim).</span>
</span><span id="Mesh-1186"><a href="#Mesh-1186"><span class="linenos">1186</span></a>
</span><span id="Mesh-1187"><a href="#Mesh-1187"><span class="linenos">1187</span></a><span class="sd">        Returns:</span>
</span><span id="Mesh-1188"><a href="#Mesh-1188"><span class="linenos">1188</span></a><span class="sd">        --------</span>
</span><span id="Mesh-1189"><a href="#Mesh-1189"><span class="linenos">1189</span></a><span class="sd">        closest_cells:</span>
</span><span id="Mesh-1190"><a href="#Mesh-1190"><span class="linenos">1190</span></a><span class="sd">            An array of indices representing the cells closest to the provided</span>
</span><span id="Mesh-1191"><a href="#Mesh-1191"><span class="linenos">1191</span></a><span class="sd">            coordinates. This will be a 1-dimensional array of</span>
</span><span id="Mesh-1192"><a href="#Mesh-1192"><span class="linenos">1192</span></a><span class="sd">            shape (n_coords).</span>
</span><span id="Mesh-1193"><a href="#Mesh-1193"><span class="linenos">1193</span></a>
</span><span id="Mesh-1194"><a href="#Mesh-1194"><span class="linenos">1194</span></a>
</span><span id="Mesh-1195"><a href="#Mesh-1195"><span class="linenos">1195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1196"><a href="#Mesh-1196"><span class="linenos">1196</span></a>
</span><span id="Mesh-1197"><a href="#Mesh-1197"><span class="linenos">1197</span></a>        <span class="c1"># Create index if required</span>
</span><span id="Mesh-1198"><a href="#Mesh-1198"><span class="linenos">1198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_kd_tree_index</span><span class="p">()</span>
</span><span id="Mesh-1199"><a href="#Mesh-1199"><span class="linenos">1199</span></a>
</span><span id="Mesh-1200"><a href="#Mesh-1200"><span class="linenos">1200</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh-1201"><a href="#Mesh-1201"><span class="linenos">1201</span></a>            <span class="n">closest_points</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="Mesh-1202"><a href="#Mesh-1202"><span class="linenos">1202</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh-1203"><a href="#Mesh-1203"><span class="linenos">1203</span></a>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Mesh-1204"><a href="#Mesh-1204"><span class="linenos">1204</span></a>
</span><span id="Mesh-1205"><a href="#Mesh-1205"><span class="linenos">1205</span></a>        <span class="c1"># This is tuned a little bit so that points on a single CPU are never lost</span>
</span><span id="Mesh-1206"><a href="#Mesh-1206"><span class="linenos">1206</span></a>
</span><span id="Mesh-1207"><a href="#Mesh-1207"><span class="linenos">1207</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexMap</span><span class="p">[</span><span class="n">closest_points</span><span class="p">]</span>
</span><span id="Mesh-1208"><a href="#Mesh-1208"><span class="linenos">1208</span></a>        <span class="n">invalid</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mesh-1209"><a href="#Mesh-1209"><span class="linenos">1209</span></a>            <span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># 2.5 * self._search_lengths[cells]</span>
</span><span id="Mesh-1210"><a href="#Mesh-1210"><span class="linenos">1210</span></a>        <span class="p">)</span>  <span class="c1"># 0.25 * self._radii[cells] ** 2</span>
</span><span id="Mesh-1211"><a href="#Mesh-1211"><span class="linenos">1211</span></a>        <span class="n">cells</span><span class="p">[</span><span class="n">invalid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Mesh-1212"><a href="#Mesh-1212"><span class="linenos">1212</span></a>
</span><span id="Mesh-1213"><a href="#Mesh-1213"><span class="linenos">1213</span></a>        <span class="k">return</span> <span class="n">cells</span>
</span><span id="Mesh-1214"><a href="#Mesh-1214"><span class="linenos">1214</span></a>
</span><span id="Mesh-1215"><a href="#Mesh-1215"><span class="linenos">1215</span></a>    <span class="k">def</span> <span class="nf">_get_mesh_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Mesh-1216"><a href="#Mesh-1216"><span class="linenos">1216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-1217"><a href="#Mesh-1217"><span class="linenos">1217</span></a><span class="sd">        Obtain the (local) mesh radii and centroids using</span>
</span><span id="Mesh-1218"><a href="#Mesh-1218"><span class="linenos">1218</span></a><span class="sd">        This routine is called when the mesh is built / rebuilt</span>
</span><span id="Mesh-1219"><a href="#Mesh-1219"><span class="linenos">1219</span></a>
</span><span id="Mesh-1220"><a href="#Mesh-1220"><span class="linenos">1220</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1221"><a href="#Mesh-1221"><span class="linenos">1221</span></a>
</span><span id="Mesh-1222"><a href="#Mesh-1222"><span class="linenos">1222</span></a>        <span class="n">centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords_for_basis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh-1223"><a href="#Mesh-1223"><span class="linenos">1223</span></a>        <span class="n">centroids_kd_tree</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">kdtree</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span>
</span><span id="Mesh-1224"><a href="#Mesh-1224"><span class="linenos">1224</span></a>
</span><span id="Mesh-1225"><a href="#Mesh-1225"><span class="linenos">1225</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="Mesh-1226"><a href="#Mesh-1226"><span class="linenos">1226</span></a>
</span><span id="Mesh-1227"><a href="#Mesh-1227"><span class="linenos">1227</span></a>        <span class="n">cStart</span><span class="p">,</span> <span class="n">cEnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getHeightStratum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Mesh-1228"><a href="#Mesh-1228"><span class="linenos">1228</span></a>        <span class="n">pStart</span><span class="p">,</span> <span class="n">pEnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getDepthStratum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Mesh-1229"><a href="#Mesh-1229"><span class="linenos">1229</span></a>        <span class="n">cell_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Mesh-1230"><a href="#Mesh-1230"><span class="linenos">1230</span></a>        <span class="n">cell_min_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Mesh-1231"><a href="#Mesh-1231"><span class="linenos">1231</span></a>        <span class="n">cell_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Mesh-1232"><a href="#Mesh-1232"><span class="linenos">1232</span></a>
</span><span id="Mesh-1233"><a href="#Mesh-1233"><span class="linenos">1233</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cEnd</span> <span class="o">-</span> <span class="n">cStart</span><span class="p">):</span>
</span><span id="Mesh-1234"><a href="#Mesh-1234"><span class="linenos">1234</span></a>            <span class="n">cell_num_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getConeSize</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="Mesh-1235"><a href="#Mesh-1235"><span class="linenos">1235</span></a>            <span class="n">cell_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getTransitiveClosure</span><span class="p">(</span><span class="n">cell</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="n">cell_num_points</span><span class="p">:]</span>
</span><span id="Mesh-1236"><a href="#Mesh-1236"><span class="linenos">1236</span></a>            <span class="n">cell_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cell_points</span> <span class="o">-</span> <span class="n">pStart</span><span class="p">]</span>
</span><span id="Mesh-1237"><a href="#Mesh-1237"><span class="linenos">1237</span></a>
</span><span id="Mesh-1238"><a href="#Mesh-1238"><span class="linenos">1238</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">distsq</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">centroids_kd_tree</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">cell_coords</span><span class="p">)</span>
</span><span id="Mesh-1239"><a href="#Mesh-1239"><span class="linenos">1239</span></a>
</span><span id="Mesh-1240"><a href="#Mesh-1240"><span class="linenos">1240</span></a>            <span class="n">cell_length</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distsq</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</span><span id="Mesh-1241"><a href="#Mesh-1241"><span class="linenos">1241</span></a>            <span class="n">cell_r</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distsq</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span><span id="Mesh-1242"><a href="#Mesh-1242"><span class="linenos">1242</span></a>            <span class="n">cell_min_r</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distsq</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="Mesh-1243"><a href="#Mesh-1243"><span class="linenos">1243</span></a>
</span><span id="Mesh-1244"><a href="#Mesh-1244"><span class="linenos">1244</span></a>        <span class="k">return</span> <span class="n">cell_min_r</span><span class="p">,</span> <span class="n">cell_r</span><span class="p">,</span> <span class="n">centroids</span><span class="p">,</span> <span class="n">cell_length</span>
</span><span id="Mesh-1245"><a href="#Mesh-1245"><span class="linenos">1245</span></a>
</span><span id="Mesh-1246"><a href="#Mesh-1246"><span class="linenos">1246</span></a>    <span class="c1"># ==========</span>
</span><span id="Mesh-1247"><a href="#Mesh-1247"><span class="linenos">1247</span></a>
</span><span id="Mesh-1248"><a href="#Mesh-1248"><span class="linenos">1248</span></a>    <span class="c1"># Deprecated in favour of _get_mesh_sizes (above)</span>
</span><span id="Mesh-1249"><a href="#Mesh-1249"><span class="linenos">1249</span></a>    <span class="k">def</span> <span class="nf">_get_mesh_centroids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh-1250"><a href="#Mesh-1250"><span class="linenos">1250</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-1251"><a href="#Mesh-1251"><span class="linenos">1251</span></a><span class="sd">        Obtain and cache the (local) mesh centroids using underworld swarm technology.</span>
</span><span id="Mesh-1252"><a href="#Mesh-1252"><span class="linenos">1252</span></a><span class="sd">        This routine is called when the mesh is built / rebuilt</span>
</span><span id="Mesh-1253"><a href="#Mesh-1253"><span class="linenos">1253</span></a>
</span><span id="Mesh-1254"><a href="#Mesh-1254"><span class="linenos">1254</span></a><span class="sd">        The global cell number corresponding to a centroid is (supposed to be)</span>
</span><span id="Mesh-1255"><a href="#Mesh-1255"><span class="linenos">1255</span></a><span class="sd">        self.dm.getCellNumbering().array.min() + index</span>
</span><span id="Mesh-1256"><a href="#Mesh-1256"><span class="linenos">1256</span></a>
</span><span id="Mesh-1257"><a href="#Mesh-1257"><span class="linenos">1257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1258"><a href="#Mesh-1258"><span class="linenos">1258</span></a>
</span><span id="Mesh-1259"><a href="#Mesh-1259"><span class="linenos">1259</span></a>        <span class="c1"># (</span>
</span><span id="Mesh-1260"><a href="#Mesh-1260"><span class="linenos">1260</span></a>        <span class="c1">#     sizes,</span>
</span><span id="Mesh-1261"><a href="#Mesh-1261"><span class="linenos">1261</span></a>        <span class="c1">#     centroids,</span>
</span><span id="Mesh-1262"><a href="#Mesh-1262"><span class="linenos">1262</span></a>        <span class="c1"># ) = petsc_discretisation.petsc_fvm_get_local_cell_sizes(self)</span>
</span><span id="Mesh-1263"><a href="#Mesh-1263"><span class="linenos">1263</span></a>
</span><span id="Mesh-1264"><a href="#Mesh-1264"><span class="linenos">1264</span></a>        <span class="n">centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coords_for_basis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh-1265"><a href="#Mesh-1265"><span class="linenos">1265</span></a>
</span><span id="Mesh-1266"><a href="#Mesh-1266"><span class="linenos">1266</span></a>        <span class="k">return</span> <span class="n">centroids</span>
</span><span id="Mesh-1267"><a href="#Mesh-1267"><span class="linenos">1267</span></a>
</span><span id="Mesh-1268"><a href="#Mesh-1268"><span class="linenos">1268</span></a>    <span class="k">def</span> <span class="nf">get_min_radius_old</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Mesh-1269"><a href="#Mesh-1269"><span class="linenos">1269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-1270"><a href="#Mesh-1270"><span class="linenos">1270</span></a><span class="sd">        This method returns the global minimum distance from any cell centroid to a face.</span>
</span><span id="Mesh-1271"><a href="#Mesh-1271"><span class="linenos">1271</span></a><span class="sd">        It wraps to the PETSc `DMPlexGetMinRadius` routine. The petsc4py equivalent always</span>
</span><span id="Mesh-1272"><a href="#Mesh-1272"><span class="linenos">1272</span></a><span class="sd">        returns zero.</span>
</span><span id="Mesh-1273"><a href="#Mesh-1273"><span class="linenos">1273</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1274"><a href="#Mesh-1274"><span class="linenos">1274</span></a>
</span><span id="Mesh-1275"><a href="#Mesh-1275"><span class="linenos">1275</span></a>        <span class="c1">## Note: The petsc4py version of DMPlexComputeGeometryFVM does not compute all cells and</span>
</span><span id="Mesh-1276"><a href="#Mesh-1276"><span class="linenos">1276</span></a>        <span class="c1">## does not obtain the minimum radius for the mesh.</span>
</span><span id="Mesh-1277"><a href="#Mesh-1277"><span class="linenos">1277</span></a>
</span><span id="Mesh-1278"><a href="#Mesh-1278"><span class="linenos">1278</span></a>        <span class="kn">from</span> <span class="nn">underworld3.cython.petsc_discretisation</span> <span class="kn">import</span> <span class="n">petsc_fvm_get_min_radius</span>
</span><span id="Mesh-1279"><a href="#Mesh-1279"><span class="linenos">1279</span></a>
</span><span id="Mesh-1280"><a href="#Mesh-1280"><span class="linenos">1280</span></a>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_min_radius&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_radius</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Mesh-1281"><a href="#Mesh-1281"><span class="linenos">1281</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_min_radius</span> <span class="o">=</span> <span class="n">petsc_fvm_get_min_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Mesh-1282"><a href="#Mesh-1282"><span class="linenos">1282</span></a>
</span><span id="Mesh-1283"><a href="#Mesh-1283"><span class="linenos">1283</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_radius</span>
</span><span id="Mesh-1284"><a href="#Mesh-1284"><span class="linenos">1284</span></a>
</span><span id="Mesh-1285"><a href="#Mesh-1285"><span class="linenos">1285</span></a>    <span class="k">def</span> <span class="nf">get_min_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Mesh-1286"><a href="#Mesh-1286"><span class="linenos">1286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-1287"><a href="#Mesh-1287"><span class="linenos">1287</span></a><span class="sd">        This method returns the global minimum distance from any cell centroid to a face.</span>
</span><span id="Mesh-1288"><a href="#Mesh-1288"><span class="linenos">1288</span></a><span class="sd">        It wraps to the PETSc `DMPlexGetMinRadius` routine. The petsc4py equivalent always</span>
</span><span id="Mesh-1289"><a href="#Mesh-1289"><span class="linenos">1289</span></a><span class="sd">        returns zero.</span>
</span><span id="Mesh-1290"><a href="#Mesh-1290"><span class="linenos">1290</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1291"><a href="#Mesh-1291"><span class="linenos">1291</span></a>
</span><span id="Mesh-1292"><a href="#Mesh-1292"><span class="linenos">1292</span></a>        <span class="c1">## Note: The petsc4py version of DMPlexComputeGeometryFVM does not compute all cells and</span>
</span><span id="Mesh-1293"><a href="#Mesh-1293"><span class="linenos">1293</span></a>        <span class="c1">## does not obtain the minimum radius for the mesh.</span>
</span><span id="Mesh-1294"><a href="#Mesh-1294"><span class="linenos">1294</span></a>
</span><span id="Mesh-1295"><a href="#Mesh-1295"><span class="linenos">1295</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="Mesh-1296"><a href="#Mesh-1296"><span class="linenos">1296</span></a>
</span><span id="Mesh-1297"><a href="#Mesh-1297"><span class="linenos">1297</span></a>        <span class="n">all_min_radii</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">gather_data</span><span class="p">(</span>
</span><span id="Mesh-1298"><a href="#Mesh-1298"><span class="linenos">1298</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="o">.</span><span class="n">min</span><span class="p">(),)),</span> <span class="n">bcast</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Mesh-1299"><a href="#Mesh-1299"><span class="linenos">1299</span></a>        <span class="p">)</span>
</span><span id="Mesh-1300"><a href="#Mesh-1300"><span class="linenos">1300</span></a>
</span><span id="Mesh-1301"><a href="#Mesh-1301"><span class="linenos">1301</span></a>        <span class="k">return</span> <span class="n">all_min_radii</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="Mesh-1302"><a href="#Mesh-1302"><span class="linenos">1302</span></a>
</span><span id="Mesh-1303"><a href="#Mesh-1303"><span class="linenos">1303</span></a>    <span class="c1"># def get_boundary_subdm(self) -&gt; PETSc.DM:</span>
</span><span id="Mesh-1304"><a href="#Mesh-1304"><span class="linenos">1304</span></a>    <span class="c1">#     &quot;&quot;&quot;</span>
</span><span id="Mesh-1305"><a href="#Mesh-1305"><span class="linenos">1305</span></a>    <span class="c1">#     This method returns the boundary subdm that wraps DMPlexCreateSubmesh</span>
</span><span id="Mesh-1306"><a href="#Mesh-1306"><span class="linenos">1306</span></a>    <span class="c1">#     &quot;&quot;&quot;</span>
</span><span id="Mesh-1307"><a href="#Mesh-1307"><span class="linenos">1307</span></a>    <span class="c1">#     from underworld3.petsc_discretisation import petsc_create_surface_submesh</span>
</span><span id="Mesh-1308"><a href="#Mesh-1308"><span class="linenos">1308</span></a>    <span class="c1">#     return petsc_create_surface_submesh(self, &quot;Boundary&quot;, 666, )</span>
</span><span id="Mesh-1309"><a href="#Mesh-1309"><span class="linenos">1309</span></a>
</span><span id="Mesh-1310"><a href="#Mesh-1310"><span class="linenos">1310</span></a>    <span class="c1"># This should be deprecated in favour of using integrals</span>
</span><span id="Mesh-1311"><a href="#Mesh-1311"><span class="linenos">1311</span></a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uw_function</span><span class="p">,</span> <span class="n">uw_meshVariable</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Mesh-1312"><a href="#Mesh-1312"><span class="linenos">1312</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh-1313"><a href="#Mesh-1313"><span class="linenos">1313</span></a><span class="sd">        Returns various norms on the mesh for the provided function.</span>
</span><span id="Mesh-1314"><a href="#Mesh-1314"><span class="linenos">1314</span></a><span class="sd">          - size</span>
</span><span id="Mesh-1315"><a href="#Mesh-1315"><span class="linenos">1315</span></a><span class="sd">          - mean</span>
</span><span id="Mesh-1316"><a href="#Mesh-1316"><span class="linenos">1316</span></a><span class="sd">          - min</span>
</span><span id="Mesh-1317"><a href="#Mesh-1317"><span class="linenos">1317</span></a><span class="sd">          - max</span>
</span><span id="Mesh-1318"><a href="#Mesh-1318"><span class="linenos">1318</span></a><span class="sd">          - sum</span>
</span><span id="Mesh-1319"><a href="#Mesh-1319"><span class="linenos">1319</span></a><span class="sd">          - L2 norm</span>
</span><span id="Mesh-1320"><a href="#Mesh-1320"><span class="linenos">1320</span></a><span class="sd">          - rms</span>
</span><span id="Mesh-1321"><a href="#Mesh-1321"><span class="linenos">1321</span></a>
</span><span id="Mesh-1322"><a href="#Mesh-1322"><span class="linenos">1322</span></a><span class="sd">          NOTE: this currently assumes scalar variables !</span>
</span><span id="Mesh-1323"><a href="#Mesh-1323"><span class="linenos">1323</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh-1324"><a href="#Mesh-1324"><span class="linenos">1324</span></a>
</span><span id="Mesh-1325"><a href="#Mesh-1325"><span class="linenos">1325</span></a>        <span class="c1">#       This uses a private work MeshVariable and the various norms defined there but</span>
</span><span id="Mesh-1326"><a href="#Mesh-1326"><span class="linenos">1326</span></a>        <span class="c1">#       could either be simplified to just use petsc vectors, or extended to</span>
</span><span id="Mesh-1327"><a href="#Mesh-1327"><span class="linenos">1327</span></a>        <span class="c1">#       compute integrals over the elements which is in line with uw1 and uw2</span>
</span><span id="Mesh-1328"><a href="#Mesh-1328"><span class="linenos">1328</span></a>
</span><span id="Mesh-1329"><a href="#Mesh-1329"><span class="linenos">1329</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-1330"><a href="#Mesh-1330"><span class="linenos">1330</span></a>            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
</span><span id="Mesh-1331"><a href="#Mesh-1331"><span class="linenos">1331</span></a>
</span><span id="Mesh-1332"><a href="#Mesh-1332"><span class="linenos">1332</span></a>        <span class="kn">from</span> <span class="nn">petsc4py.PETSc</span> <span class="kn">import</span> <span class="n">NormType</span>
</span><span id="Mesh-1333"><a href="#Mesh-1333"><span class="linenos">1333</span></a>
</span><span id="Mesh-1334"><a href="#Mesh-1334"><span class="linenos">1334</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">uw_meshVariable</span>
</span><span id="Mesh-1335"><a href="#Mesh-1335"><span class="linenos">1335</span></a>
</span><span id="Mesh-1336"><a href="#Mesh-1336"><span class="linenos">1336</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
</span><span id="Mesh-1337"><a href="#Mesh-1337"><span class="linenos">1337</span></a>            <span class="n">tmp</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
</span><span id="Mesh-1338"><a href="#Mesh-1338"><span class="linenos">1338</span></a>                <span class="n">uw_function</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">basis</span>
</span><span id="Mesh-1339"><a href="#Mesh-1339"><span class="linenos">1339</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Mesh-1340"><a href="#Mesh-1340"><span class="linenos">1340</span></a>
</span><span id="Mesh-1341"><a href="#Mesh-1341"><span class="linenos">1341</span></a>        <span class="n">vsize</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
</span><span id="Mesh-1342"><a href="#Mesh-1342"><span class="linenos">1342</span></a>        <span class="n">vmean</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="Mesh-1343"><a href="#Mesh-1343"><span class="linenos">1343</span></a>        <span class="n">vmax</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Mesh-1344"><a href="#Mesh-1344"><span class="linenos">1344</span></a>        <span class="n">vmin</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Mesh-1345"><a href="#Mesh-1345"><span class="linenos">1345</span></a>        <span class="n">vsum</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Mesh-1346"><a href="#Mesh-1346"><span class="linenos">1346</span></a>        <span class="n">vnorm2</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">NormType</span><span class="o">.</span><span class="n">NORM_2</span><span class="p">)</span>
</span><span id="Mesh-1347"><a href="#Mesh-1347"><span class="linenos">1347</span></a>        <span class="n">vrms</span> <span class="o">=</span> <span class="n">vnorm2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vsize</span><span class="p">)</span>
</span><span id="Mesh-1348"><a href="#Mesh-1348"><span class="linenos">1348</span></a>
</span><span id="Mesh-1349"><a href="#Mesh-1349"><span class="linenos">1349</span></a>        <span class="k">return</span> <span class="n">vsize</span><span class="p">,</span> <span class="n">vmean</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">vsum</span><span class="p">,</span> <span class="n">vnorm2</span><span class="p">,</span> <span class="n">vrms</span>
</span><span id="Mesh-1350"><a href="#Mesh-1350"><span class="linenos">1350</span></a>
</span><span id="Mesh-1351"><a href="#Mesh-1351"><span class="linenos">1351</span></a>    <span class="k">def</span> <span class="nf">meshVariable_mask_from_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_name</span><span class="p">,</span> <span class="n">label_value</span><span class="p">):</span>
</span><span id="Mesh-1352"><a href="#Mesh-1352"><span class="linenos">1352</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract single label value and make a point mask&quot;&quot;&quot;</span>
</span><span id="Mesh-1353"><a href="#Mesh-1353"><span class="linenos">1353</span></a>
</span><span id="Mesh-1354"><a href="#Mesh-1354"><span class="linenos">1354</span></a>        <span class="n">meshVar</span> <span class="o">=</span> <span class="n">MeshVariable</span><span class="p">(</span>
</span><span id="Mesh-1355"><a href="#Mesh-1355"><span class="linenos">1355</span></a>            <span class="sa">f</span><span class="s2">&quot;Mask_</span><span class="si">{</span><span class="n">label_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">label_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mesh-1356"><a href="#Mesh-1356"><span class="linenos">1356</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh-1357"><a href="#Mesh-1357"><span class="linenos">1357</span></a>            <span class="n">vtype</span><span class="o">=</span><span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SCALAR</span><span class="p">,</span>
</span><span id="Mesh-1358"><a href="#Mesh-1358"><span class="linenos">1358</span></a>            <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Mesh-1359"><a href="#Mesh-1359"><span class="linenos">1359</span></a>            <span class="n">continuous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Mesh-1360"><a href="#Mesh-1360"><span class="linenos">1360</span></a>            <span class="n">varsymbol</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;\cal</span><span class="se">{{</span><span class="s2">M</span><span class="se">}}</span><span class="s2">^</span><span class="se">{{</span><span class="s2">[</span><span class="si">{</span><span class="n">label_name</span><span class="si">:</span><span class="s2">.4</span><span class="si">}</span><span class="s2">]</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mesh-1361"><a href="#Mesh-1361"><span class="linenos">1361</span></a>        <span class="p">)</span>
</span><span id="Mesh-1362"><a href="#Mesh-1362"><span class="linenos">1362</span></a>
</span><span id="Mesh-1363"><a href="#Mesh-1363"><span class="linenos">1363</span></a>        <span class="n">point_indices</span> <span class="o">=</span> <span class="n">petsc_dm_find_labeled_points_local</span><span class="p">(</span>
</span><span id="Mesh-1364"><a href="#Mesh-1364"><span class="linenos">1364</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span>
</span><span id="Mesh-1365"><a href="#Mesh-1365"><span class="linenos">1365</span></a>            <span class="n">label_name</span><span class="p">,</span>
</span><span id="Mesh-1366"><a href="#Mesh-1366"><span class="linenos">1366</span></a>            <span class="n">label_value</span><span class="p">,</span>
</span><span id="Mesh-1367"><a href="#Mesh-1367"><span class="linenos">1367</span></a>            <span class="n">sectionIndex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Mesh-1368"><a href="#Mesh-1368"><span class="linenos">1368</span></a>        <span class="p">)</span>
</span><span id="Mesh-1369"><a href="#Mesh-1369"><span class="linenos">1369</span></a>
</span><span id="Mesh-1370"><a href="#Mesh-1370"><span class="linenos">1370</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">meshVar</span><span class="p">):</span>
</span><span id="Mesh-1371"><a href="#Mesh-1371"><span class="linenos">1371</span></a>            <span class="n">meshVar</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Mesh-1372"><a href="#Mesh-1372"><span class="linenos">1372</span></a>            <span class="k">if</span> <span class="n">point_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh-1373"><a href="#Mesh-1373"><span class="linenos">1373</span></a>                <span class="n">meshVar</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">point_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Mesh-1374"><a href="#Mesh-1374"><span class="linenos">1374</span></a>
</span><span id="Mesh-1375"><a href="#Mesh-1375"><span class="linenos">1375</span></a>        <span class="k">return</span> <span class="n">meshVar</span>
</span></pre></div>


            <div class="docstring"><p>Mesh class for uw - documentation needed</p>
</div>


                            <div id="Mesh.__init__" class="classattr">
                                        <input id="Mesh.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@timing.routine_timer_decorator</div>

        <span class="name">Mesh</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">plex_or_meshfile</span>,</span><span class="param">	<span class="n">degree</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">simplex</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">coordinate_system_type</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">qdegree</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">markVertices</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">useRegions</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">useMultipleTags</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">filename</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">refinement</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">refinement_callback</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">return_coords_to_bounds</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">boundaries</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">boundary_normals</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">name</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">*</span><span class="n">args</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="Mesh.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.__init__-136"><a href="#Mesh.__init__-136"><span class="linenos">136</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh.__init__-137"><a href="#Mesh.__init__-137"><span class="linenos">137</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Mesh.__init__-138"><a href="#Mesh.__init__-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh.__init__-139"><a href="#Mesh.__init__-139"><span class="linenos">139</span></a>        <span class="n">plex_or_meshfile</span><span class="p">,</span>
</span><span id="Mesh.__init__-140"><a href="#Mesh.__init__-140"><span class="linenos">140</span></a>        <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Mesh.__init__-141"><a href="#Mesh.__init__-141"><span class="linenos">141</span></a>        <span class="n">simplex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Mesh.__init__-142"><a href="#Mesh.__init__-142"><span class="linenos">142</span></a>        <span class="n">coordinate_system_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-143"><a href="#Mesh.__init__-143"><span class="linenos">143</span></a>        <span class="n">qdegree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="Mesh.__init__-144"><a href="#Mesh.__init__-144"><span class="linenos">144</span></a>        <span class="n">markVertices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-145"><a href="#Mesh.__init__-145"><span class="linenos">145</span></a>        <span class="n">useRegions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-146"><a href="#Mesh.__init__-146"><span class="linenos">146</span></a>        <span class="n">useMultipleTags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-147"><a href="#Mesh.__init__-147"><span class="linenos">147</span></a>        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-148"><a href="#Mesh.__init__-148"><span class="linenos">148</span></a>        <span class="n">refinement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-149"><a href="#Mesh.__init__-149"><span class="linenos">149</span></a>        <span class="n">refinement_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-150"><a href="#Mesh.__init__-150"><span class="linenos">150</span></a>        <span class="n">return_coords_to_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-151"><a href="#Mesh.__init__-151"><span class="linenos">151</span></a>        <span class="n">boundaries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-152"><a href="#Mesh.__init__-152"><span class="linenos">152</span></a>        <span class="n">boundary_normals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-153"><a href="#Mesh.__init__-153"><span class="linenos">153</span></a>        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mesh.__init__-154"><a href="#Mesh.__init__-154"><span class="linenos">154</span></a>        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="Mesh.__init__-155"><a href="#Mesh.__init__-155"><span class="linenos">155</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Mesh.__init__-156"><a href="#Mesh.__init__-156"><span class="linenos">156</span></a>    <span class="p">):</span>
</span><span id="Mesh.__init__-157"><a href="#Mesh.__init__-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">mesh_instances</span>
</span><span id="Mesh.__init__-158"><a href="#Mesh.__init__-158"><span class="linenos">158</span></a>        <span class="n">Mesh</span><span class="o">.</span><span class="n">mesh_instances</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Mesh.__init__-159"><a href="#Mesh.__init__-159"><span class="linenos">159</span></a>
</span><span id="Mesh.__init__-160"><a href="#Mesh.__init__-160"><span class="linenos">160</span></a>        <span class="n">comm</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span>
</span><span id="Mesh.__init__-161"><a href="#Mesh.__init__-161"><span class="linenos">161</span></a>
</span><span id="Mesh.__init__-162"><a href="#Mesh.__init__-162"><span class="linenos">162</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plex_or_meshfile</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">DMPlex</span><span class="p">):</span>
</span><span id="Mesh.__init__-163"><a href="#Mesh.__init__-163"><span class="linenos">163</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;plexmesh&quot;</span>
</span><span id="Mesh.__init__-164"><a href="#Mesh.__init__-164"><span class="linenos">164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">plex_or_meshfile</span>
</span><span id="Mesh.__init__-165"><a href="#Mesh.__init__-165"><span class="linenos">165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Should we build one ?</span>
</span><span id="Mesh.__init__-166"><a href="#Mesh.__init__-166"><span class="linenos">166</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.__init__-167"><a href="#Mesh.__init__-167"><span class="linenos">167</span></a>            <span class="n">comm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comm&quot;</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="Mesh.__init__-168"><a href="#Mesh.__init__-168"><span class="linenos">168</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">plex_or_meshfile</span>
</span><span id="Mesh.__init__-169"><a href="#Mesh.__init__-169"><span class="linenos">169</span></a>            <span class="n">basename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">plex_or_meshfile</span><span class="p">)</span>
</span><span id="Mesh.__init__-170"><a href="#Mesh.__init__-170"><span class="linenos">170</span></a>
</span><span id="Mesh.__init__-171"><a href="#Mesh.__init__-171"><span class="linenos">171</span></a>            <span class="c1"># Note: should be able to handle a .geo as well on this pathway</span>
</span><span id="Mesh.__init__-172"><a href="#Mesh.__init__-172"><span class="linenos">172</span></a>            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.msh&quot;</span><span class="p">:</span>
</span><span id="Mesh.__init__-173"><a href="#Mesh.__init__-173"><span class="linenos">173</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">_from_gmsh</span><span class="p">(</span>
</span><span id="Mesh.__init__-174"><a href="#Mesh.__init__-174"><span class="linenos">174</span></a>                    <span class="n">plex_or_meshfile</span><span class="p">,</span>
</span><span id="Mesh.__init__-175"><a href="#Mesh.__init__-175"><span class="linenos">175</span></a>                    <span class="n">comm</span><span class="p">,</span>
</span><span id="Mesh.__init__-176"><a href="#Mesh.__init__-176"><span class="linenos">176</span></a>                    <span class="n">markVertices</span><span class="o">=</span><span class="n">markVertices</span><span class="p">,</span>
</span><span id="Mesh.__init__-177"><a href="#Mesh.__init__-177"><span class="linenos">177</span></a>                    <span class="n">useRegions</span><span class="o">=</span><span class="n">useRegions</span><span class="p">,</span>
</span><span id="Mesh.__init__-178"><a href="#Mesh.__init__-178"><span class="linenos">178</span></a>                    <span class="n">useMultipleTags</span><span class="o">=</span><span class="n">useMultipleTags</span><span class="p">,</span>
</span><span id="Mesh.__init__-179"><a href="#Mesh.__init__-179"><span class="linenos">179</span></a>                <span class="p">)</span>
</span><span id="Mesh.__init__-180"><a href="#Mesh.__init__-180"><span class="linenos">180</span></a>            <span class="k">elif</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.h5&quot;</span><span class="p">:</span>
</span><span id="Mesh.__init__-181"><a href="#Mesh.__init__-181"><span class="linenos">181</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">_from_plexh5</span><span class="p">(</span>
</span><span id="Mesh.__init__-182"><a href="#Mesh.__init__-182"><span class="linenos">182</span></a>                    <span class="n">plex_or_meshfile</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">return_sf</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Mesh.__init__-183"><a href="#Mesh.__init__-183"><span class="linenos">183</span></a>                <span class="p">)</span>
</span><span id="Mesh.__init__-184"><a href="#Mesh.__init__-184"><span class="linenos">184</span></a>
</span><span id="Mesh.__init__-185"><a href="#Mesh.__init__-185"><span class="linenos">185</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.__init__-186"><a href="#Mesh.__init__-186"><span class="linenos">186</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Mesh.__init__-187"><a href="#Mesh.__init__-187"><span class="linenos">187</span></a>                    <span class="s2">&quot;Mesh file </span><span class="si">%s</span><span class="s2"> has unknown format &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span>
</span><span id="Mesh.__init__-188"><a href="#Mesh.__init__-188"><span class="linenos">188</span></a>                    <span class="o">%</span> <span class="p">(</span><span class="n">plex_or_meshfile</span><span class="p">,</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="Mesh.__init__-189"><a href="#Mesh.__init__-189"><span class="linenos">189</span></a>                <span class="p">)</span>
</span><span id="Mesh.__init__-190"><a href="#Mesh.__init__-190"><span class="linenos">190</span></a>
</span><span id="Mesh.__init__-191"><a href="#Mesh.__init__-191"><span class="linenos">191</span></a>        <span class="c1"># Use grid hashing for point location</span>
</span><span id="Mesh.__init__-192"><a href="#Mesh.__init__-192"><span class="linenos">192</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="Mesh.__init__-193"><a href="#Mesh.__init__-193"><span class="linenos">193</span></a>        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;dm_plex_hash_location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh.__init__-194"><a href="#Mesh.__init__-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setFromOptions</span><span class="p">()</span>
</span><span id="Mesh.__init__-195"><a href="#Mesh.__init__-195"><span class="linenos">195</span></a>
</span><span id="Mesh.__init__-196"><a href="#Mesh.__init__-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</span><span id="Mesh.__init__-197"><a href="#Mesh.__init__-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span> <span class="o">=</span> <span class="n">boundaries</span>
</span><span id="Mesh.__init__-198"><a href="#Mesh.__init__-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_normals</span> <span class="o">=</span> <span class="n">boundary_normals</span>
</span><span id="Mesh.__init__-199"><a href="#Mesh.__init__-199"><span class="linenos">199</span></a>
</span><span id="Mesh.__init__-200"><a href="#Mesh.__init__-200"><span class="linenos">200</span></a>        <span class="n">uw</span><span class="o">.</span><span class="n">adaptivity</span><span class="o">.</span><span class="n">_dm_stack_bcs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">,</span> <span class="s2">&quot;UW_Boundaries&quot;</span><span class="p">)</span>
</span><span id="Mesh.__init__-201"><a href="#Mesh.__init__-201"><span class="linenos">201</span></a>
</span><span id="Mesh.__init__-202"><a href="#Mesh.__init__-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">refinement_callback</span> <span class="o">=</span> <span class="n">refinement_callback</span>
</span><span id="Mesh.__init__-203"><a href="#Mesh.__init__-203"><span class="linenos">203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">return_coords_to_bounds</span> <span class="o">=</span> <span class="n">return_coords_to_bounds</span>
</span><span id="Mesh.__init__-204"><a href="#Mesh.__init__-204"><span class="linenos">204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Mesh.__init__-205"><a href="#Mesh.__init__-205"><span class="linenos">205</span></a>
</span><span id="Mesh.__init__-206"><a href="#Mesh.__init__-206"><span class="linenos">206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="Mesh.__init__-207"><a href="#Mesh.__init__-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sf1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh.__init__-208"><a href="#Mesh.__init__-208"><span class="linenos">208</span></a>
</span><span id="Mesh.__init__-209"><a href="#Mesh.__init__-209"><span class="linenos">209</span></a>        <span class="c1">## This is where we can refine the dm if required, and rebuild / redistribute</span>
</span><span id="Mesh.__init__-210"><a href="#Mesh.__init__-210"><span class="linenos">210</span></a>
</span><span id="Mesh.__init__-211"><a href="#Mesh.__init__-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">refinement</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.__init__-212"><a href="#Mesh.__init__-212"><span class="linenos">212</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setRefinementUniform</span><span class="p">()</span>
</span><span id="Mesh.__init__-213"><a href="#Mesh.__init__-213"><span class="linenos">213</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">distribute</span><span class="p">()</span>
</span><span id="Mesh.__init__-214"><a href="#Mesh.__init__-214"><span class="linenos">214</span></a>
</span><span id="Mesh.__init__-215"><a href="#Mesh.__init__-215"><span class="linenos">215</span></a>            <span class="c1"># self.dm_hierarchy = self.dm.refineHierarchy(refinement)</span>
</span><span id="Mesh.__init__-216"><a href="#Mesh.__init__-216"><span class="linenos">216</span></a>
</span><span id="Mesh.__init__-217"><a href="#Mesh.__init__-217"><span class="linenos">217</span></a>            <span class="c1"># This is preferable to the refineHierarchy call</span>
</span><span id="Mesh.__init__-218"><a href="#Mesh.__init__-218"><span class="linenos">218</span></a>            <span class="c1"># because we can repair the refined mesh at each</span>
</span><span id="Mesh.__init__-219"><a href="#Mesh.__init__-219"><span class="linenos">219</span></a>            <span class="c1"># step along the way</span>
</span><span id="Mesh.__init__-220"><a href="#Mesh.__init__-220"><span class="linenos">220</span></a>
</span><span id="Mesh.__init__-221"><a href="#Mesh.__init__-221"><span class="linenos">221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">]</span>
</span><span id="Mesh.__init__-222"><a href="#Mesh.__init__-222"><span class="linenos">222</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">refinement</span><span class="p">):</span>
</span><span id="Mesh.__init__-223"><a href="#Mesh.__init__-223"><span class="linenos">223</span></a>                <span class="n">dm_refined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">refine</span><span class="p">()</span>
</span><span id="Mesh.__init__-224"><a href="#Mesh.__init__-224"><span class="linenos">224</span></a>                <span class="n">dm_refined</span><span class="o">.</span><span class="n">setCoarseDM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Mesh.__init__-225"><a href="#Mesh.__init__-225"><span class="linenos">225</span></a>
</span><span id="Mesh.__init__-226"><a href="#Mesh.__init__-226"><span class="linenos">226</span></a>                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refinement_callback</span><span class="p">):</span>
</span><span id="Mesh.__init__-227"><a href="#Mesh.__init__-227"><span class="linenos">227</span></a>                    <span class="n">refinement_callback</span><span class="p">(</span><span class="n">dm_refined</span><span class="p">)</span>
</span><span id="Mesh.__init__-228"><a href="#Mesh.__init__-228"><span class="linenos">228</span></a>
</span><span id="Mesh.__init__-229"><a href="#Mesh.__init__-229"><span class="linenos">229</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm_refined</span><span class="p">)</span>
</span><span id="Mesh.__init__-230"><a href="#Mesh.__init__-230"><span class="linenos">230</span></a>
</span><span id="Mesh.__init__-231"><a href="#Mesh.__init__-231"><span class="linenos">231</span></a>            <span class="c1"># self.dm_hierarchy = [self.dm] + self.dm_hierarchy</span>
</span><span id="Mesh.__init__-232"><a href="#Mesh.__init__-232"><span class="linenos">232</span></a>
</span><span id="Mesh.__init__-233"><a href="#Mesh.__init__-233"><span class="linenos">233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Mesh.__init__-234"><a href="#Mesh.__init__-234"><span class="linenos">234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_hierarchical_dm&quot;</span><span class="p">)</span>
</span><span id="Mesh.__init__-235"><a href="#Mesh.__init__-235"><span class="linenos">235</span></a>
</span><span id="Mesh.__init__-236"><a href="#Mesh.__init__-236"><span class="linenos">236</span></a>            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refinement_callback</span><span class="p">):</span>
</span><span id="Mesh.__init__-237"><a href="#Mesh.__init__-237"><span class="linenos">237</span></a>                <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span><span class="p">:</span>
</span><span id="Mesh.__init__-238"><a href="#Mesh.__init__-238"><span class="linenos">238</span></a>                    <span class="n">refinement_callback</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh.__init__-239"><a href="#Mesh.__init__-239"><span class="linenos">239</span></a>
</span><span id="Mesh.__init__-240"><a href="#Mesh.__init__-240"><span class="linenos">240</span></a>            <span class="c1"># Single level equivalent dm</span>
</span><span id="Mesh.__init__-241"><a href="#Mesh.__init__-241"><span class="linenos">241</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="Mesh.__init__-242"><a href="#Mesh.__init__-242"><span class="linenos">242</span></a>
</span><span id="Mesh.__init__-243"><a href="#Mesh.__init__-243"><span class="linenos">243</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.__init__-244"><a href="#Mesh.__init__-244"><span class="linenos">244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">distribute</span><span class="p">()</span>
</span><span id="Mesh.__init__-245"><a href="#Mesh.__init__-245"><span class="linenos">245</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">]</span>
</span><span id="Mesh.__init__-246"><a href="#Mesh.__init__-246"><span class="linenos">246</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="Mesh.__init__-247"><a href="#Mesh.__init__-247"><span class="linenos">247</span></a>
</span><span id="Mesh.__init__-248"><a href="#Mesh.__init__-248"><span class="linenos">248</span></a>        <span class="c1"># This will be done anyway - the mesh maybe in a</span>
</span><span id="Mesh.__init__-249"><a href="#Mesh.__init__-249"><span class="linenos">249</span></a>        <span class="c1"># partially adapted state</span>
</span><span id="Mesh.__init__-250"><a href="#Mesh.__init__-250"><span class="linenos">250</span></a>
</span><span id="Mesh.__init__-251"><a href="#Mesh.__init__-251"><span class="linenos">251</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="p">:</span>
</span><span id="Mesh.__init__-252"><a href="#Mesh.__init__-252"><span class="linenos">252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sf1</span><span class="p">)</span>
</span><span id="Mesh.__init__-253"><a href="#Mesh.__init__-253"><span class="linenos">253</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.__init__-254"><a href="#Mesh.__init__-254"><span class="linenos">254</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sf0</span>  <span class="c1"># could be None !</span>
</span><span id="Mesh.__init__-255"><a href="#Mesh.__init__-255"><span class="linenos">255</span></a>
</span><span id="Mesh.__init__-256"><a href="#Mesh.__init__-256"><span class="linenos">256</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh.__init__-257"><a href="#Mesh.__init__-257"><span class="linenos">257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;mesh&quot;</span>
</span><span id="Mesh.__init__-258"><a href="#Mesh.__init__-258"><span class="linenos">258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_mesh&quot;</span><span class="p">)</span>
</span><span id="Mesh.__init__-259"><a href="#Mesh.__init__-259"><span class="linenos">259</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.__init__-260"><a href="#Mesh.__init__-260"><span class="linenos">260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;uw_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Mesh.__init__-261"><a href="#Mesh.__init__-261"><span class="linenos">261</span></a>
</span><span id="Mesh.__init__-262"><a href="#Mesh.__init__-262"><span class="linenos">262</span></a>        <span class="c1"># Set sympy constructs. First a generic, symbolic, Cartesian coordinate system</span>
</span><span id="Mesh.__init__-263"><a href="#Mesh.__init__-263"><span class="linenos">263</span></a>        <span class="c1"># A unique set of vectors / names for each mesh instance</span>
</span><span id="Mesh.__init__-264"><a href="#Mesh.__init__-264"><span class="linenos">264</span></a>
</span><span id="Mesh.__init__-265"><a href="#Mesh.__init__-265"><span class="linenos">265</span></a>        <span class="kn">from</span> <span class="nn">sympy.vector</span> <span class="kn">import</span> <span class="n">CoordSys3D</span>
</span><span id="Mesh.__init__-266"><a href="#Mesh.__init__-266"><span class="linenos">266</span></a>
</span><span id="Mesh.__init__-267"><a href="#Mesh.__init__-267"><span class="linenos">267</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">CoordSys3D</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="Mesh.__init__-268"><a href="#Mesh.__init__-268"><span class="linenos">268</span></a>
</span><span id="Mesh.__init__-269"><a href="#Mesh.__init__-269"><span class="linenos">269</span></a>        <span class="c1"># Tidy some of this printing without changing the</span>
</span><span id="Mesh.__init__-270"><a href="#Mesh.__init__-270"><span class="linenos">270</span></a>        <span class="c1"># underlying vector names (as these are part of the code generation system)</span>
</span><span id="Mesh.__init__-271"><a href="#Mesh.__init__-271"><span class="linenos">271</span></a>
</span><span id="Mesh.__init__-272"><a href="#Mesh.__init__-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathrm{\xi_0}&quot;</span>
</span><span id="Mesh.__init__-273"><a href="#Mesh.__init__-273"><span class="linenos">273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathrm{\xi_1}&quot;</span>
</span><span id="Mesh.__init__-274"><a href="#Mesh.__init__-274"><span class="linenos">274</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathrm{\xi_2}&quot;</span>
</span><span id="Mesh.__init__-275"><a href="#Mesh.__init__-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathbf{\hat{\mathbf</span><span class="si">{e}</span><span class="s2">}_0}&quot;</span>
</span><span id="Mesh.__init__-276"><a href="#Mesh.__init__-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">j</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathbf{\hat{\mathbf</span><span class="si">{e}</span><span class="s2">}_1}&quot;</span>
</span><span id="Mesh.__init__-277"><a href="#Mesh.__init__-277"><span class="linenos">277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\mathbf{\hat{\mathbf</span><span class="si">{e}</span><span class="s2">}_2}&quot;</span>
</span><span id="Mesh.__init__-278"><a href="#Mesh.__init__-278"><span class="linenos">278</span></a>
</span><span id="Mesh.__init__-279"><a href="#Mesh.__init__-279"><span class="linenos">279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span> <span class="o">=</span> <span class="n">CoordSys3D</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\Gamma&quot;</span><span class="p">)</span>
</span><span id="Mesh.__init__-280"><a href="#Mesh.__init__-280"><span class="linenos">280</span></a>
</span><span id="Mesh.__init__-281"><a href="#Mesh.__init__-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\Gamma_x&quot;</span>
</span><span id="Mesh.__init__-282"><a href="#Mesh.__init__-282"><span class="linenos">282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\Gamma_y&quot;</span>
</span><span id="Mesh.__init__-283"><a href="#Mesh.__init__-283"><span class="linenos">283</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_latex_form</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\Gamma_z&quot;</span>
</span><span id="Mesh.__init__-284"><a href="#Mesh.__init__-284"><span class="linenos">284</span></a>
</span><span id="Mesh.__init__-285"><a href="#Mesh.__init__-285"><span class="linenos">285</span></a>        <span class="c1"># Now add the appropriate coordinate system for the mesh&#39;s natural geometry</span>
</span><span id="Mesh.__init__-286"><a href="#Mesh.__init__-286"><span class="linenos">286</span></a>        <span class="c1"># This step will usually over-write the defaults we just defined</span>
</span><span id="Mesh.__init__-287"><a href="#Mesh.__init__-287"><span class="linenos">287</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_CoordinateSystem</span> <span class="o">=</span> <span class="n">CoordinateSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate_system_type</span><span class="p">)</span>
</span><span id="Mesh.__init__-288"><a href="#Mesh.__init__-288"><span class="linenos">288</span></a>
</span><span id="Mesh.__init__-289"><a href="#Mesh.__init__-289"><span class="linenos">289</span></a>        <span class="c1"># This was in the _jit extension but ... if</span>
</span><span id="Mesh.__init__-290"><a href="#Mesh.__init__-290"><span class="linenos">290</span></a>        <span class="c1"># not here then the tests fail sometimes (caching ?)</span>
</span><span id="Mesh.__init__-291"><a href="#Mesh.__init__-291"><span class="linenos">291</span></a>
</span><span id="Mesh.__init__-292"><a href="#Mesh.__init__-292"><span class="linenos">292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_x[0]&quot;</span>
</span><span id="Mesh.__init__-293"><a href="#Mesh.__init__-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_x[1]&quot;</span>
</span><span id="Mesh.__init__-294"><a href="#Mesh.__init__-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_x[2]&quot;</span>
</span><span id="Mesh.__init__-295"><a href="#Mesh.__init__-295"><span class="linenos">295</span></a>
</span><span id="Mesh.__init__-296"><a href="#Mesh.__init__-296"><span class="linenos">296</span></a>        <span class="c1"># Surface integrals also have normal vector information as petsc_n</span>
</span><span id="Mesh.__init__-297"><a href="#Mesh.__init__-297"><span class="linenos">297</span></a>
</span><span id="Mesh.__init__-298"><a href="#Mesh.__init__-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_n[0]&quot;</span>
</span><span id="Mesh.__init__-299"><a href="#Mesh.__init__-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_n[1]&quot;</span>
</span><span id="Mesh.__init__-300"><a href="#Mesh.__init__-300"><span class="linenos">300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">_ccodestr</span> <span class="o">=</span> <span class="s2">&quot;petsc_n[2]&quot;</span>
</span><span id="Mesh.__init__-301"><a href="#Mesh.__init__-301"><span class="linenos">301</span></a>
</span><span id="Mesh.__init__-302"><a href="#Mesh.__init__-302"><span class="linenos">302</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Mesh.__init__-303"><a href="#Mesh.__init__-303"><span class="linenos">303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">()</span>
</span><span id="Mesh.__init__-304"><a href="#Mesh.__init__-304"><span class="linenos">304</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Mesh.__init__-305"><a href="#Mesh.__init__-305"><span class="linenos">305</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span> <span class="o">=</span> <span class="n">simplex</span>
</span><span id="Mesh.__init__-306"><a href="#Mesh.__init__-306"><span class="linenos">306</span></a>
</span><span id="Mesh.__init__-307"><a href="#Mesh.__init__-307"><span class="linenos">307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Mesh.__init__-308"><a href="#Mesh.__init__-308"><span class="linenos">308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_block_vars</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Mesh.__init__-309"><a href="#Mesh.__init__-309"><span class="linenos">309</span></a>
</span><span id="Mesh.__init__-310"><a href="#Mesh.__init__-310"><span class="linenos">310</span></a>        <span class="c1"># a list of equation systems that will</span>
</span><span id="Mesh.__init__-311"><a href="#Mesh.__init__-311"><span class="linenos">311</span></a>        <span class="c1"># need to be rebuilt if the mesh coordinates change</span>
</span><span id="Mesh.__init__-312"><a href="#Mesh.__init__-312"><span class="linenos">312</span></a>
</span><span id="Mesh.__init__-313"><a href="#Mesh.__init__-313"><span class="linenos">313</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_equation_systems_register</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Mesh.__init__-314"><a href="#Mesh.__init__-314"><span class="linenos">314</span></a>
</span><span id="Mesh.__init__-315"><a href="#Mesh.__init__-315"><span class="linenos">315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_hash</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh.__init__-316"><a href="#Mesh.__init__-316"><span class="linenos">316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_interpolated_results</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh.__init__-317"><a href="#Mesh.__init__-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh.__init__-318"><a href="#Mesh.__init__-318"><span class="linenos">318</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_quadrature</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh.__init__-319"><a href="#Mesh.__init__-319"><span class="linenos">319</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Mesh.__init__-320"><a href="#Mesh.__init__-320"><span class="linenos">320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh.__init__-321"><a href="#Mesh.__init__-321"><span class="linenos">321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh.__init__-322"><a href="#Mesh.__init__-322"><span class="linenos">322</span></a>
</span><span id="Mesh.__init__-323"><a href="#Mesh.__init__-323"><span class="linenos">323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
</span><span id="Mesh.__init__-324"><a href="#Mesh.__init__-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">qdegree</span> <span class="o">=</span> <span class="n">qdegree</span>
</span><span id="Mesh.__init__-325"><a href="#Mesh.__init__-325"><span class="linenos">325</span></a>
</span><span id="Mesh.__init__-326"><a href="#Mesh.__init__-326"><span class="linenos">326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nuke_coords_and_rebuild</span><span class="p">()</span>
</span><span id="Mesh.__init__-327"><a href="#Mesh.__init__-327"><span class="linenos">327</span></a>
</span><span id="Mesh.__init__-328"><a href="#Mesh.__init__-328"><span class="linenos">328</span></a>        <span class="c1">## Coordinate System</span>
</span><span id="Mesh.__init__-329"><a href="#Mesh.__init__-329"><span class="linenos">329</span></a>
</span><span id="Mesh.__init__-330"><a href="#Mesh.__init__-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="Mesh.__init__-331"><a href="#Mesh.__init__-331"><span class="linenos">331</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="Mesh.__init__-332"><a href="#Mesh.__init__-332"><span class="linenos">332</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">CYLINDRICAL2D_NATIVE</span>
</span><span id="Mesh.__init__-333"><a href="#Mesh.__init__-333"><span class="linenos">333</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="Mesh.__init__-334"><a href="#Mesh.__init__-334"><span class="linenos">334</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">CYLINDRICAL3D_NATIVE</span>
</span><span id="Mesh.__init__-335"><a href="#Mesh.__init__-335"><span class="linenos">335</span></a>        <span class="p">):</span>
</span><span id="Mesh.__init__-336"><a href="#Mesh.__init__-336"><span class="linenos">336</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus_cylindrical</span><span class="p">(</span>
</span><span id="Mesh.__init__-337"><a href="#Mesh.__init__-337"><span class="linenos">337</span></a>                <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh.__init__-338"><a href="#Mesh.__init__-338"><span class="linenos">338</span></a>            <span class="p">)</span>
</span><span id="Mesh.__init__-339"><a href="#Mesh.__init__-339"><span class="linenos">339</span></a>        <span class="k">elif</span> <span class="p">(</span>
</span><span id="Mesh.__init__-340"><a href="#Mesh.__init__-340"><span class="linenos">340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="Mesh.__init__-341"><a href="#Mesh.__init__-341"><span class="linenos">341</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">SPHERICAL_NATIVE</span>
</span><span id="Mesh.__init__-342"><a href="#Mesh.__init__-342"><span class="linenos">342</span></a>        <span class="p">):</span>
</span><span id="Mesh.__init__-343"><a href="#Mesh.__init__-343"><span class="linenos">343</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus_spherical</span><span class="p">(</span>
</span><span id="Mesh.__init__-344"><a href="#Mesh.__init__-344"><span class="linenos">344</span></a>                <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh.__init__-345"><a href="#Mesh.__init__-345"><span class="linenos">345</span></a>            <span class="p">)</span>  <span class="c1">## Not yet complete or tested</span>
</span><span id="Mesh.__init__-346"><a href="#Mesh.__init__-346"><span class="linenos">346</span></a>
</span><span id="Mesh.__init__-347"><a href="#Mesh.__init__-347"><span class="linenos">347</span></a>        <span class="k">elif</span> <span class="p">(</span>
</span><span id="Mesh.__init__-348"><a href="#Mesh.__init__-348"><span class="linenos">348</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">coordinate_type</span>
</span><span id="Mesh.__init__-349"><a href="#Mesh.__init__-349"><span class="linenos">349</span></a>            <span class="o">==</span> <span class="n">CoordinateSystemType</span><span class="o">.</span><span class="n">SPHERE_SURFACE_NATIVE</span>
</span><span id="Mesh.__init__-350"><a href="#Mesh.__init__-350"><span class="linenos">350</span></a>        <span class="p">):</span>
</span><span id="Mesh.__init__-351"><a href="#Mesh.__init__-351"><span class="linenos">351</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus_spherical_surface2D_lonlat</span><span class="p">(</span>
</span><span id="Mesh.__init__-352"><a href="#Mesh.__init__-352"><span class="linenos">352</span></a>                <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh.__init__-353"><a href="#Mesh.__init__-353"><span class="linenos">353</span></a>            <span class="p">)</span>
</span><span id="Mesh.__init__-354"><a href="#Mesh.__init__-354"><span class="linenos">354</span></a>
</span><span id="Mesh.__init__-355"><a href="#Mesh.__init__-355"><span class="linenos">355</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.__init__-356"><a href="#Mesh.__init__-356"><span class="linenos">356</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">vector_calculus</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Mesh.__init__-357"><a href="#Mesh.__init__-357"><span class="linenos">357</span></a>
</span><span id="Mesh.__init__-358"><a href="#Mesh.__init__-358"><span class="linenos">358</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Mesh.mesh_instances" class="classattr">
                                <div class="attr variable">
            <span class="name">mesh_instances</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#Mesh.mesh_instances"></a>
    
    

                            </div>
                            <div id="Mesh.instance" class="classattr">
                                <div class="attr variable">
            <span class="name">instance</span>

        
    </div>
    <a class="headerlink" href="#Mesh.instance"></a>
    
    

                            </div>
                            <div id="Mesh.filename" class="classattr">
                                <div class="attr variable">
            <span class="name">filename</span>

        
    </div>
    <a class="headerlink" href="#Mesh.filename"></a>
    
    

                            </div>
                            <div id="Mesh.boundaries" class="classattr">
                                <div class="attr variable">
            <span class="name">boundaries</span>

        
    </div>
    <a class="headerlink" href="#Mesh.boundaries"></a>
    
    

                            </div>
                            <div id="Mesh.boundary_normals" class="classattr">
                                <div class="attr variable">
            <span class="name">boundary_normals</span>

        
    </div>
    <a class="headerlink" href="#Mesh.boundary_normals"></a>
    
    

                            </div>
                            <div id="Mesh.refinement_callback" class="classattr">
                                <div class="attr variable">
            <span class="name">refinement_callback</span>

        
    </div>
    <a class="headerlink" href="#Mesh.refinement_callback"></a>
    
    

                            </div>
                            <div id="Mesh.return_coords_to_bounds" class="classattr">
                                <div class="attr variable">
            <span class="name">return_coords_to_bounds</span>

        
    </div>
    <a class="headerlink" href="#Mesh.return_coords_to_bounds"></a>
    
    

                            </div>
                            <div id="Mesh.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span>

        
    </div>
    <a class="headerlink" href="#Mesh.name"></a>
    
    

                            </div>
                            <div id="Mesh.dm0" class="classattr">
                                <div class="attr variable">
            <span class="name">dm0</span>

        
    </div>
    <a class="headerlink" href="#Mesh.dm0"></a>
    
    

                            </div>
                            <div id="Mesh.sf1" class="classattr">
                                <div class="attr variable">
            <span class="name">sf1</span>

        
    </div>
    <a class="headerlink" href="#Mesh.sf1"></a>
    
    

                            </div>
                            <div id="Mesh.petsc_fe" class="classattr">
                                <div class="attr variable">
            <span class="name">petsc_fe</span>

        
    </div>
    <a class="headerlink" href="#Mesh.petsc_fe"></a>
    
    

                            </div>
                            <div id="Mesh.degree" class="classattr">
                                <div class="attr variable">
            <span class="name">degree</span>

        
    </div>
    <a class="headerlink" href="#Mesh.degree"></a>
    
    

                            </div>
                            <div id="Mesh.qdegree" class="classattr">
                                <div class="attr variable">
            <span class="name">qdegree</span>

        
    </div>
    <a class="headerlink" href="#Mesh.qdegree"></a>
    
    

                            </div>
                            <div id="Mesh.dim" class="classattr">
                                        <input id="Mesh.dim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">dim</span><span class="annotation">: int</span>

                <label class="view-source-button" for="Mesh.dim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.dim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.dim-360"><a href="#Mesh.dim-360"><span class="linenos">360</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.dim-361"><a href="#Mesh.dim-361"><span class="linenos">361</span></a>    <span class="k">def</span> <span class="nf">dim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Mesh.dim-362"><a href="#Mesh.dim-362"><span class="linenos">362</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.dim-363"><a href="#Mesh.dim-363"><span class="linenos">363</span></a><span class="sd">        The mesh dimensionality.</span>
</span><span id="Mesh.dim-364"><a href="#Mesh.dim-364"><span class="linenos">364</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.dim-365"><a href="#Mesh.dim-365"><span class="linenos">365</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getDimension</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>The mesh dimensionality.</p>
</div>


                            </div>
                            <div id="Mesh.cdim" class="classattr">
                                        <input id="Mesh.cdim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">cdim</span><span class="annotation">: int</span>

                <label class="view-source-button" for="Mesh.cdim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.cdim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.cdim-367"><a href="#Mesh.cdim-367"><span class="linenos">367</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.cdim-368"><a href="#Mesh.cdim-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="nf">cdim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Mesh.cdim-369"><a href="#Mesh.cdim-369"><span class="linenos">369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.cdim-370"><a href="#Mesh.cdim-370"><span class="linenos">370</span></a><span class="sd">        The mesh dimensionality.</span>
</span><span id="Mesh.cdim-371"><a href="#Mesh.cdim-371"><span class="linenos">371</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.cdim-372"><a href="#Mesh.cdim-372"><span class="linenos">372</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinateDim</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>The mesh dimensionality.</p>
</div>


                            </div>
                            <div id="Mesh.view" class="classattr">
                                        <input id="Mesh.view-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">view</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.view-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.view"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.view-374"><a href="#Mesh.view-374"><span class="linenos">374</span></a>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh.view-375"><a href="#Mesh.view-375"><span class="linenos">375</span></a>
</span><span id="Mesh.view-376"><a href="#Mesh.view-376"><span class="linenos">376</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="Mesh.view-377"><a href="#Mesh.view-377"><span class="linenos">377</span></a>
</span><span id="Mesh.view-378"><a href="#Mesh.view-378"><span class="linenos">378</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.view-379"><a href="#Mesh.view-379"><span class="linenos">379</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-380"><a href="#Mesh.view-380"><span class="linenos">380</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh # </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-381"><a href="#Mesh.view-381"><span class="linenos">381</span></a>
</span><span id="Mesh.view-382"><a href="#Mesh.view-382"><span class="linenos">382</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.view-383"><a href="#Mesh.view-383"><span class="linenos">383</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| Variable Name       | component | degree |     type        |&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-384"><a href="#Mesh.view-384"><span class="linenos">384</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ---------------------------------------------------------- |&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-385"><a href="#Mesh.view-385"><span class="linenos">385</span></a>                <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Mesh.view-386"><a href="#Mesh.view-386"><span class="linenos">386</span></a>                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
</span><span id="Mesh.view-387"><a href="#Mesh.view-387"><span class="linenos">387</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="Mesh.view-388"><a href="#Mesh.view-388"><span class="linenos">388</span></a>                        <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">clean_name</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">num_components</span><span class="si">:</span><span class="s2">^10</span><span class="si">}</span><span class="s2"> |</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">degree</span><span class="si">:</span><span class="s2">^7</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">vtype</span><span class="o">.</span><span class="n">name</span><span class="si">:</span><span class="s2">^15</span><span class="si">}</span><span class="s2"> |&quot;</span>
</span><span id="Mesh.view-389"><a href="#Mesh.view-389"><span class="linenos">389</span></a>                    <span class="p">)</span>
</span><span id="Mesh.view-390"><a href="#Mesh.view-390"><span class="linenos">390</span></a>
</span><span id="Mesh.view-391"><a href="#Mesh.view-391"><span class="linenos">391</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ---------------------------------------------------------- |&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-392"><a href="#Mesh.view-392"><span class="linenos">392</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh.view-393"><a href="#Mesh.view-393"><span class="linenos">393</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.view-394"><a href="#Mesh.view-394"><span class="linenos">394</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No variables are defined on the mesh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh.view-395"><a href="#Mesh.view-395"><span class="linenos">395</span></a>
</span><span id="Mesh.view-396"><a href="#Mesh.view-396"><span class="linenos">396</span></a>        <span class="c1">## Boundary information</span>
</span><span id="Mesh.view-397"><a href="#Mesh.view-397"><span class="linenos">397</span></a>
</span><span id="Mesh.view-398"><a href="#Mesh.view-398"><span class="linenos">398</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.view-399"><a href="#Mesh.view-399"><span class="linenos">399</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.view-400"><a href="#Mesh.view-400"><span class="linenos">400</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| Boundary Name            | ID    | Min Size | Max Size |&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-401"><a href="#Mesh.view-401"><span class="linenos">401</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ------------------------------------------------------ |&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-402"><a href="#Mesh.view-402"><span class="linenos">402</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.view-403"><a href="#Mesh.view-403"><span class="linenos">403</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No boundary labels are defined on the mesh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-404"><a href="#Mesh.view-404"><span class="linenos">404</span></a>
</span><span id="Mesh.view-405"><a href="#Mesh.view-405"><span class="linenos">405</span></a>        <span class="k">for</span> <span class="n">bd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">:</span>
</span><span id="Mesh.view-406"><a href="#Mesh.view-406"><span class="linenos">406</span></a>            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="Mesh.view-407"><a href="#Mesh.view-407"><span class="linenos">407</span></a>            <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
</span><span id="Mesh.view-408"><a href="#Mesh.view-408"><span class="linenos">408</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">getStratumSize</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="Mesh.view-409"><a href="#Mesh.view-409"><span class="linenos">409</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.view-410"><a href="#Mesh.view-410"><span class="linenos">410</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Mesh.view-411"><a href="#Mesh.view-411"><span class="linenos">411</span></a>
</span><span id="Mesh.view-412"><a href="#Mesh.view-412"><span class="linenos">412</span></a>            <span class="n">ii</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">gather_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-413"><a href="#Mesh.view-413"><span class="linenos">413</span></a>
</span><span id="Mesh.view-414"><a href="#Mesh.view-414"><span class="linenos">414</span></a>            <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.view-415"><a href="#Mesh.view-415"><span class="linenos">415</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Mesh.view-416"><a href="#Mesh.view-416"><span class="linenos">416</span></a>                    <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2">     | </span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">&lt;5</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">ii</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">ii</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> |&quot;</span><span class="p">,</span>
</span><span id="Mesh.view-417"><a href="#Mesh.view-417"><span class="linenos">417</span></a>                <span class="p">)</span>
</span><span id="Mesh.view-418"><a href="#Mesh.view-418"><span class="linenos">418</span></a>
</span><span id="Mesh.view-419"><a href="#Mesh.view-419"><span class="linenos">419</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.view-420"><a href="#Mesh.view-420"><span class="linenos">420</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| ------------------------------------------------------ |&quot;</span><span class="p">)</span>
</span><span id="Mesh.view-421"><a href="#Mesh.view-421"><span class="linenos">421</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh.view-422"><a href="#Mesh.view-422"><span class="linenos">422</span></a>
</span><span id="Mesh.view-423"><a href="#Mesh.view-423"><span class="linenos">423</span></a>        <span class="c1">## Information on the mesh DM</span>
</span><span id="Mesh.view-424"><a href="#Mesh.view-424"><span class="linenos">424</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Mesh.clone_dm_hierarchy" class="classattr">
                                        <input id="Mesh.clone_dm_hierarchy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clone_dm_hierarchy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.clone_dm_hierarchy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.clone_dm_hierarchy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.clone_dm_hierarchy-426"><a href="#Mesh.clone_dm_hierarchy-426"><span class="linenos">426</span></a>    <span class="k">def</span> <span class="nf">clone_dm_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh.clone_dm_hierarchy-427"><a href="#Mesh.clone_dm_hierarchy-427"><span class="linenos">427</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.clone_dm_hierarchy-428"><a href="#Mesh.clone_dm_hierarchy-428"><span class="linenos">428</span></a><span class="sd">        Clone the dm hierarchy on the mesh</span>
</span><span id="Mesh.clone_dm_hierarchy-429"><a href="#Mesh.clone_dm_hierarchy-429"><span class="linenos">429</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.clone_dm_hierarchy-430"><a href="#Mesh.clone_dm_hierarchy-430"><span class="linenos">430</span></a>
</span><span id="Mesh.clone_dm_hierarchy-431"><a href="#Mesh.clone_dm_hierarchy-431"><span class="linenos">431</span></a>        <span class="n">dm_hierarchy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_hierarchy</span>
</span><span id="Mesh.clone_dm_hierarchy-432"><a href="#Mesh.clone_dm_hierarchy-432"><span class="linenos">432</span></a>
</span><span id="Mesh.clone_dm_hierarchy-433"><a href="#Mesh.clone_dm_hierarchy-433"><span class="linenos">433</span></a>        <span class="n">new_dm_hierarchy</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Mesh.clone_dm_hierarchy-434"><a href="#Mesh.clone_dm_hierarchy-434"><span class="linenos">434</span></a>        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="n">dm_hierarchy</span><span class="p">:</span>
</span><span id="Mesh.clone_dm_hierarchy-435"><a href="#Mesh.clone_dm_hierarchy-435"><span class="linenos">435</span></a>            <span class="n">new_dm_hierarchy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
</span><span id="Mesh.clone_dm_hierarchy-436"><a href="#Mesh.clone_dm_hierarchy-436"><span class="linenos">436</span></a>
</span><span id="Mesh.clone_dm_hierarchy-437"><a href="#Mesh.clone_dm_hierarchy-437"><span class="linenos">437</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_dm_hierarchy</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="Mesh.clone_dm_hierarchy-438"><a href="#Mesh.clone_dm_hierarchy-438"><span class="linenos">438</span></a>            <span class="n">new_dm_hierarchy</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setCoarseDM</span><span class="p">(</span><span class="n">new_dm_hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Mesh.clone_dm_hierarchy-439"><a href="#Mesh.clone_dm_hierarchy-439"><span class="linenos">439</span></a>
</span><span id="Mesh.clone_dm_hierarchy-440"><a href="#Mesh.clone_dm_hierarchy-440"><span class="linenos">440</span></a>        <span class="k">return</span> <span class="n">new_dm_hierarchy</span>
</span></pre></div>


            <div class="docstring"><p>Clone the dm hierarchy on the mesh</p>
</div>


                            </div>
                            <div id="Mesh.nuke_coords_and_rebuild" class="classattr">
                                        <input id="Mesh.nuke_coords_and_rebuild-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nuke_coords_and_rebuild</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.nuke_coords_and_rebuild-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.nuke_coords_and_rebuild"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.nuke_coords_and_rebuild-442"><a href="#Mesh.nuke_coords_and_rebuild-442"><span class="linenos">442</span></a>    <span class="k">def</span> <span class="nf">nuke_coords_and_rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh.nuke_coords_and_rebuild-443"><a href="#Mesh.nuke_coords_and_rebuild-443"><span class="linenos">443</span></a>        <span class="c1"># This is a reversion to the old version (3.15 compatible which seems to work in 3.16 too)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-444"><a href="#Mesh.nuke_coords_and_rebuild-444"><span class="linenos">444</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-445"><a href="#Mesh.nuke_coords_and_rebuild-445"><span class="linenos">445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Mesh.nuke_coords_and_rebuild-446"><a href="#Mesh.nuke_coords_and_rebuild-446"><span class="linenos">446</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-447"><a href="#Mesh.nuke_coords_and_rebuild-447"><span class="linenos">447</span></a>        <span class="c1"># let&#39;s go ahead and do an initial projection from linear (the default)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-448"><a href="#Mesh.nuke_coords_and_rebuild-448"><span class="linenos">448</span></a>        <span class="c1"># to linear. this really is a nothing operation, but a</span>
</span><span id="Mesh.nuke_coords_and_rebuild-449"><a href="#Mesh.nuke_coords_and_rebuild-449"><span class="linenos">449</span></a>        <span class="c1"># side effect of this operation is that coordinate DM DMField is</span>
</span><span id="Mesh.nuke_coords_and_rebuild-450"><a href="#Mesh.nuke_coords_and_rebuild-450"><span class="linenos">450</span></a>        <span class="c1"># converted to the required `PetscFE` type. this may become necessary</span>
</span><span id="Mesh.nuke_coords_and_rebuild-451"><a href="#Mesh.nuke_coords_and_rebuild-451"><span class="linenos">451</span></a>        <span class="c1"># later where we call the interpolation routines to project from the linear</span>
</span><span id="Mesh.nuke_coords_and_rebuild-452"><a href="#Mesh.nuke_coords_and_rebuild-452"><span class="linenos">452</span></a>        <span class="c1"># mesh coordinates to other mesh coordinates.</span>
</span><span id="Mesh.nuke_coords_and_rebuild-453"><a href="#Mesh.nuke_coords_and_rebuild-453"><span class="linenos">453</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-454"><a href="#Mesh.nuke_coords_and_rebuild-454"><span class="linenos">454</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="Mesh.nuke_coords_and_rebuild-455"><a href="#Mesh.nuke_coords_and_rebuild-455"><span class="linenos">455</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="Mesh.nuke_coords_and_rebuild-456"><a href="#Mesh.nuke_coords_and_rebuild-456"><span class="linenos">456</span></a>            <span class="s2">&quot;meshproj_</span><span class="si">{}</span><span class="s2">_petscspace_degree&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_instances</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span>
</span><span id="Mesh.nuke_coords_and_rebuild-457"><a href="#Mesh.nuke_coords_and_rebuild-457"><span class="linenos">457</span></a>        <span class="p">)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-458"><a href="#Mesh.nuke_coords_and_rebuild-458"><span class="linenos">458</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-459"><a href="#Mesh.nuke_coords_and_rebuild-459"><span class="linenos">459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">FE</span><span class="p">()</span><span class="o">.</span><span class="n">createDefault</span><span class="p">(</span>
</span><span id="Mesh.nuke_coords_and_rebuild-460"><a href="#Mesh.nuke_coords_and_rebuild-460"><span class="linenos">460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-461"><a href="#Mesh.nuke_coords_and_rebuild-461"><span class="linenos">461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-462"><a href="#Mesh.nuke_coords_and_rebuild-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-463"><a href="#Mesh.nuke_coords_and_rebuild-463"><span class="linenos">463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">qdegree</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-464"><a href="#Mesh.nuke_coords_and_rebuild-464"><span class="linenos">464</span></a>            <span class="s2">&quot;meshproj_</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_instances</span><span class="p">),</span>
</span><span id="Mesh.nuke_coords_and_rebuild-465"><a href="#Mesh.nuke_coords_and_rebuild-465"><span class="linenos">465</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-466"><a href="#Mesh.nuke_coords_and_rebuild-466"><span class="linenos">466</span></a>        <span class="p">)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-467"><a href="#Mesh.nuke_coords_and_rebuild-467"><span class="linenos">467</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-468"><a href="#Mesh.nuke_coords_and_rebuild-468"><span class="linenos">468</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="Mesh.nuke_coords_and_rebuild-469"><a href="#Mesh.nuke_coords_and_rebuild-469"><span class="linenos">469</span></a>            <span class="n">PETSc</span><span class="o">.</span><span class="n">Sys</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-470"><a href="#Mesh.nuke_coords_and_rebuild-470"><span class="linenos">470</span></a>            <span class="ow">and</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Sys</span><span class="o">.</span><span class="n">getVersionInfo</span><span class="p">()[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</span><span id="Mesh.nuke_coords_and_rebuild-471"><a href="#Mesh.nuke_coords_and_rebuild-471"><span class="linenos">471</span></a>        <span class="p">):</span>
</span><span id="Mesh.nuke_coords_and_rebuild-472"><a href="#Mesh.nuke_coords_and_rebuild-472"><span class="linenos">472</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">projectCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span><span class="p">)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-473"><a href="#Mesh.nuke_coords_and_rebuild-473"><span class="linenos">473</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.nuke_coords_and_rebuild-474"><a href="#Mesh.nuke_coords_and_rebuild-474"><span class="linenos">474</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setCoordinateDisc</span><span class="p">(</span><span class="n">disc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petsc_fe</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-475"><a href="#Mesh.nuke_coords_and_rebuild-475"><span class="linenos">475</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-476"><a href="#Mesh.nuke_coords_and_rebuild-476"><span class="linenos">476</span></a>        <span class="c1">## LM ToDo: check if this is still a valid issue under 3.18.x / 3.19.x</span>
</span><span id="Mesh.nuke_coords_and_rebuild-477"><a href="#Mesh.nuke_coords_and_rebuild-477"><span class="linenos">477</span></a>        <span class="c1"># if self.degree == 1:</span>
</span><span id="Mesh.nuke_coords_and_rebuild-478"><a href="#Mesh.nuke_coords_and_rebuild-478"><span class="linenos">478</span></a>        <span class="c1">#     # We have to be careful as a projection onto an equivalent PETScFE can cause problematic</span>
</span><span id="Mesh.nuke_coords_and_rebuild-479"><a href="#Mesh.nuke_coords_and_rebuild-479"><span class="linenos">479</span></a>        <span class="c1">#     # issues with petsc that we see in parallel - in which case there is a fallback, pass no</span>
</span><span id="Mesh.nuke_coords_and_rebuild-480"><a href="#Mesh.nuke_coords_and_rebuild-480"><span class="linenos">480</span></a>        <span class="c1">#     # PETScFE and let PETSc decide. Note that the petsc4py wrapped version does not allow this</span>
</span><span id="Mesh.nuke_coords_and_rebuild-481"><a href="#Mesh.nuke_coords_and_rebuild-481"><span class="linenos">481</span></a>        <span class="c1">#     # (but it should !)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-482"><a href="#Mesh.nuke_coords_and_rebuild-482"><span class="linenos">482</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-483"><a href="#Mesh.nuke_coords_and_rebuild-483"><span class="linenos">483</span></a>        <span class="c1">#     self.dm.projectCoordinates(self.petsc_fe)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-484"><a href="#Mesh.nuke_coords_and_rebuild-484"><span class="linenos">484</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-485"><a href="#Mesh.nuke_coords_and_rebuild-485"><span class="linenos">485</span></a>        <span class="c1"># else:</span>
</span><span id="Mesh.nuke_coords_and_rebuild-486"><a href="#Mesh.nuke_coords_and_rebuild-486"><span class="linenos">486</span></a>        <span class="c1">#     uw.cython.petsc_discretisation.petsc_dm_project_coordinates(self.dm)</span>
</span><span id="Mesh.nuke_coords_and_rebuild-487"><a href="#Mesh.nuke_coords_and_rebuild-487"><span class="linenos">487</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-488"><a href="#Mesh.nuke_coords_and_rebuild-488"><span class="linenos">488</span></a>        <span class="c1"># now set copy of this array into dictionary</span>
</span><span id="Mesh.nuke_coords_and_rebuild-489"><a href="#Mesh.nuke_coords_and_rebuild-489"><span class="linenos">489</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-490"><a href="#Mesh.nuke_coords_and_rebuild-490"><span class="linenos">490</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinatesLocal</span><span class="p">()</span><span class="o">.</span><span class="n">array</span>
</span><span id="Mesh.nuke_coords_and_rebuild-491"><a href="#Mesh.nuke_coords_and_rebuild-491"><span class="linenos">491</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-492"><a href="#Mesh.nuke_coords_and_rebuild-492"><span class="linenos">492</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mesh.nuke_coords_and_rebuild-493"><a href="#Mesh.nuke_coords_and_rebuild-493"><span class="linenos">493</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">isSimplex</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-494"><a href="#Mesh.nuke_coords_and_rebuild-494"><span class="linenos">494</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-495"><a href="#Mesh.nuke_coords_and_rebuild-495"><span class="linenos">495</span></a>            <span class="kc">True</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-496"><a href="#Mesh.nuke_coords_and_rebuild-496"><span class="linenos">496</span></a>        <span class="p">)</span>  <span class="c1"># True here assumes continuous basis for coordinates ...</span>
</span><span id="Mesh.nuke_coords_and_rebuild-497"><a href="#Mesh.nuke_coords_and_rebuild-497"><span class="linenos">497</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-498"><a href="#Mesh.nuke_coords_and_rebuild-498"><span class="linenos">498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Mesh.nuke_coords_and_rebuild-499"><a href="#Mesh.nuke_coords_and_rebuild-499"><span class="linenos">499</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-500"><a href="#Mesh.nuke_coords_and_rebuild-500"><span class="linenos">500</span></a>        <span class="c1"># invalidate the cell-search k-d tree and the mesh centroid data / rebuild</span>
</span><span id="Mesh.nuke_coords_and_rebuild-501"><a href="#Mesh.nuke_coords_and_rebuild-501"><span class="linenos">501</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_kd_tree_index</span><span class="p">()</span>
</span><span id="Mesh.nuke_coords_and_rebuild-502"><a href="#Mesh.nuke_coords_and_rebuild-502"><span class="linenos">502</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-503"><a href="#Mesh.nuke_coords_and_rebuild-503"><span class="linenos">503</span></a>        <span class="p">(</span>
</span><span id="Mesh.nuke_coords_and_rebuild-504"><a href="#Mesh.nuke_coords_and_rebuild-504"><span class="linenos">504</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_min_size</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-505"><a href="#Mesh.nuke_coords_and_rebuild-505"><span class="linenos">505</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-506"><a href="#Mesh.nuke_coords_and_rebuild-506"><span class="linenos">506</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-507"><a href="#Mesh.nuke_coords_and_rebuild-507"><span class="linenos">507</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_search_lengths</span><span class="p">,</span>
</span><span id="Mesh.nuke_coords_and_rebuild-508"><a href="#Mesh.nuke_coords_and_rebuild-508"><span class="linenos">508</span></a>        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mesh_sizes</span><span class="p">()</span>
</span><span id="Mesh.nuke_coords_and_rebuild-509"><a href="#Mesh.nuke_coords_and_rebuild-509"><span class="linenos">509</span></a>
</span><span id="Mesh.nuke_coords_and_rebuild-510"><a href="#Mesh.nuke_coords_and_rebuild-510"><span class="linenos">510</span></a>        <span class="k">return</span>
</span></pre></div>


    

                            </div>
                            <div id="Mesh.update_lvec" class="classattr">
                                        <input id="Mesh.update_lvec-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@timing.routine_timer_decorator</div>

        <span class="def">def</span>
        <span class="name">update_lvec</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.update_lvec-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.update_lvec"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.update_lvec-512"><a href="#Mesh.update_lvec-512"><span class="linenos">512</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh.update_lvec-513"><a href="#Mesh.update_lvec-513"><span class="linenos">513</span></a>    <span class="k">def</span> <span class="nf">update_lvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh.update_lvec-514"><a href="#Mesh.update_lvec-514"><span class="linenos">514</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.update_lvec-515"><a href="#Mesh.update_lvec-515"><span class="linenos">515</span></a><span class="sd">        This method creates and/or updates the mesh variable local vector.</span>
</span><span id="Mesh.update_lvec-516"><a href="#Mesh.update_lvec-516"><span class="linenos">516</span></a><span class="sd">        If the local vector is already up to date, this method will do nothing.</span>
</span><span id="Mesh.update_lvec-517"><a href="#Mesh.update_lvec-517"><span class="linenos">517</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.update_lvec-518"><a href="#Mesh.update_lvec-518"><span class="linenos">518</span></a>
</span><span id="Mesh.update_lvec-519"><a href="#Mesh.update_lvec-519"><span class="linenos">519</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span><span class="p">:</span>
</span><span id="Mesh.update_lvec-520"><a href="#Mesh.update_lvec-520"><span class="linenos">520</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">:</span>
</span><span id="Mesh.update_lvec-521"><a href="#Mesh.update_lvec-521"><span class="linenos">521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clearDS</span><span class="p">()</span>
</span><span id="Mesh.update_lvec-522"><a href="#Mesh.update_lvec-522"><span class="linenos">522</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="Mesh.update_lvec-523"><a href="#Mesh.update_lvec-523"><span class="linenos">523</span></a>                <span class="c1"># create the local vector (memory chunk) and attach to original dm</span>
</span><span id="Mesh.update_lvec-524"><a href="#Mesh.update_lvec-524"><span class="linenos">524</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createLocalVec</span><span class="p">()</span>
</span><span id="Mesh.update_lvec-525"><a href="#Mesh.update_lvec-525"><span class="linenos">525</span></a>
</span><span id="Mesh.update_lvec-526"><a href="#Mesh.update_lvec-526"><span class="linenos">526</span></a>            <span class="c1"># push avar arrays into the parent dm array</span>
</span><span id="Mesh.update_lvec-527"><a href="#Mesh.update_lvec-527"><span class="linenos">527</span></a>            <span class="n">a_global</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="Mesh.update_lvec-528"><a href="#Mesh.update_lvec-528"><span class="linenos">528</span></a>
</span><span id="Mesh.update_lvec-529"><a href="#Mesh.update_lvec-529"><span class="linenos">529</span></a>            <span class="c1"># The field decomposition seems to fail if coarse DMs are present</span>
</span><span id="Mesh.update_lvec-530"><a href="#Mesh.update_lvec-530"><span class="linenos">530</span></a>            <span class="n">names</span><span class="p">,</span> <span class="n">isets</span><span class="p">,</span> <span class="n">dms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createFieldDecomposition</span><span class="p">()</span>
</span><span id="Mesh.update_lvec-531"><a href="#Mesh.update_lvec-531"><span class="linenos">531</span></a>
</span><span id="Mesh.update_lvec-532"><a href="#Mesh.update_lvec-532"><span class="linenos">532</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">():</span>
</span><span id="Mesh.update_lvec-533"><a href="#Mesh.update_lvec-533"><span class="linenos">533</span></a>                <span class="c1"># traverse subdms, taking user generated data in the subdm</span>
</span><span id="Mesh.update_lvec-534"><a href="#Mesh.update_lvec-534"><span class="linenos">534</span></a>                <span class="c1"># local vec, pushing it into a global sub vec</span>
</span><span id="Mesh.update_lvec-535"><a href="#Mesh.update_lvec-535"><span class="linenos">535</span></a>                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">subiset</span><span class="p">,</span> <span class="n">subdm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">isets</span><span class="p">,</span> <span class="n">dms</span><span class="p">):</span>
</span><span id="Mesh.update_lvec-536"><a href="#Mesh.update_lvec-536"><span class="linenos">536</span></a>                    <span class="n">lvec</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">vec</span>
</span><span id="Mesh.update_lvec-537"><a href="#Mesh.update_lvec-537"><span class="linenos">537</span></a>                    <span class="n">subvec</span> <span class="o">=</span> <span class="n">a_global</span><span class="o">.</span><span class="n">getSubVector</span><span class="p">(</span><span class="n">subiset</span><span class="p">)</span>
</span><span id="Mesh.update_lvec-538"><a href="#Mesh.update_lvec-538"><span class="linenos">538</span></a>                    <span class="n">subdm</span><span class="o">.</span><span class="n">localToGlobal</span><span class="p">(</span><span class="n">lvec</span><span class="p">,</span> <span class="n">subvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh.update_lvec-539"><a href="#Mesh.update_lvec-539"><span class="linenos">539</span></a>                    <span class="n">a_global</span><span class="o">.</span><span class="n">restoreSubVector</span><span class="p">(</span><span class="n">subiset</span><span class="p">,</span> <span class="n">subvec</span><span class="p">)</span>
</span><span id="Mesh.update_lvec-540"><a href="#Mesh.update_lvec-540"><span class="linenos">540</span></a>
</span><span id="Mesh.update_lvec-541"><a href="#Mesh.update_lvec-541"><span class="linenos">541</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">a_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span><span class="p">)</span>
</span><span id="Mesh.update_lvec-542"><a href="#Mesh.update_lvec-542"><span class="linenos">542</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">a_global</span><span class="p">)</span>
</span><span id="Mesh.update_lvec-543"><a href="#Mesh.update_lvec-543"><span class="linenos">543</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>This method creates and/or updates the mesh variable local vector.
If the local vector is already up to date, this method will do nothing.</p>
</div>


                            </div>
                            <div id="Mesh.lvec" class="classattr">
                                        <input id="Mesh.lvec-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">lvec</span><span class="annotation">: petsc4py.PETSc.Vec</span>

                <label class="view-source-button" for="Mesh.lvec-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.lvec"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.lvec-545"><a href="#Mesh.lvec-545"><span class="linenos">545</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.lvec-546"><a href="#Mesh.lvec-546"><span class="linenos">546</span></a>    <span class="k">def</span> <span class="nf">lvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Vec</span><span class="p">:</span>
</span><span id="Mesh.lvec-547"><a href="#Mesh.lvec-547"><span class="linenos">547</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.lvec-548"><a href="#Mesh.lvec-548"><span class="linenos">548</span></a><span class="sd">        Returns a local Petsc vector containing the flattened array</span>
</span><span id="Mesh.lvec-549"><a href="#Mesh.lvec-549"><span class="linenos">549</span></a><span class="sd">        of all the mesh variables.</span>
</span><span id="Mesh.lvec-550"><a href="#Mesh.lvec-550"><span class="linenos">550</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.lvec-551"><a href="#Mesh.lvec-551"><span class="linenos">551</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stale_lvec</span><span class="p">:</span>
</span><span id="Mesh.lvec-552"><a href="#Mesh.lvec-552"><span class="linenos">552</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Mesh.lvec-553"><a href="#Mesh.lvec-553"><span class="linenos">553</span></a>                <span class="s2">&quot;Mesh `lvec` needs to be updated using the update_lvec()` method.&quot;</span>
</span><span id="Mesh.lvec-554"><a href="#Mesh.lvec-554"><span class="linenos">554</span></a>            <span class="p">)</span>
</span><span id="Mesh.lvec-555"><a href="#Mesh.lvec-555"><span class="linenos">555</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvec</span>
</span></pre></div>


            <div class="docstring"><p>Returns a local Petsc vector containing the flattened array
of all the mesh variables.</p>
</div>


                            </div>
                            <div id="Mesh.deform_mesh" class="classattr">
                                        <input id="Mesh.deform_mesh-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">deform_mesh</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">new_coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.deform_mesh-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.deform_mesh"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.deform_mesh-561"><a href="#Mesh.deform_mesh-561"><span class="linenos">561</span></a>    <span class="k">def</span> <span class="nf">deform_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="Mesh.deform_mesh-562"><a href="#Mesh.deform_mesh-562"><span class="linenos">562</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.deform_mesh-563"><a href="#Mesh.deform_mesh-563"><span class="linenos">563</span></a><span class="sd">        This method will update the mesh coordinates and reset any cached coordinates in</span>
</span><span id="Mesh.deform_mesh-564"><a href="#Mesh.deform_mesh-564"><span class="linenos">564</span></a><span class="sd">        the mesh and in equation systems that are registered on the mesh.</span>
</span><span id="Mesh.deform_mesh-565"><a href="#Mesh.deform_mesh-565"><span class="linenos">565</span></a>
</span><span id="Mesh.deform_mesh-566"><a href="#Mesh.deform_mesh-566"><span class="linenos">566</span></a><span class="sd">        The coord array that is passed in should match the shape of self.data</span>
</span><span id="Mesh.deform_mesh-567"><a href="#Mesh.deform_mesh-567"><span class="linenos">567</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.deform_mesh-568"><a href="#Mesh.deform_mesh-568"><span class="linenos">568</span></a>
</span><span id="Mesh.deform_mesh-569"><a href="#Mesh.deform_mesh-569"><span class="linenos">569</span></a>        <span class="n">coord_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinatesLocal</span><span class="p">()</span>
</span><span id="Mesh.deform_mesh-570"><a href="#Mesh.deform_mesh-570"><span class="linenos">570</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">coord_vec</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span>
</span><span id="Mesh.deform_mesh-571"><a href="#Mesh.deform_mesh-571"><span class="linenos">571</span></a>        <span class="n">coords</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coords</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
</span><span id="Mesh.deform_mesh-572"><a href="#Mesh.deform_mesh-572"><span class="linenos">572</span></a>
</span><span id="Mesh.deform_mesh-573"><a href="#Mesh.deform_mesh-573"><span class="linenos">573</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setCoordinatesLocal</span><span class="p">(</span><span class="n">coord_vec</span><span class="p">)</span>
</span><span id="Mesh.deform_mesh-574"><a href="#Mesh.deform_mesh-574"><span class="linenos">574</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nuke_coords_and_rebuild</span><span class="p">()</span>
</span><span id="Mesh.deform_mesh-575"><a href="#Mesh.deform_mesh-575"><span class="linenos">575</span></a>
</span><span id="Mesh.deform_mesh-576"><a href="#Mesh.deform_mesh-576"><span class="linenos">576</span></a>        <span class="k">for</span> <span class="n">eq_system</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equation_systems_register</span><span class="p">:</span>
</span><span id="Mesh.deform_mesh-577"><a href="#Mesh.deform_mesh-577"><span class="linenos">577</span></a>            <span class="n">eq_system</span><span class="o">.</span><span class="n">_rebuild_after_mesh_update</span><span class="p">()</span>
</span><span id="Mesh.deform_mesh-578"><a href="#Mesh.deform_mesh-578"><span class="linenos">578</span></a>
</span><span id="Mesh.deform_mesh-579"><a href="#Mesh.deform_mesh-579"><span class="linenos">579</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>This method will update the mesh coordinates and reset any cached coordinates in
the mesh and in equation systems that are registered on the mesh.</p>

<p>The coord array that is passed in should match the shape of self.data</p>
</div>


                            </div>
                            <div id="Mesh.access" class="classattr">
                                        <input id="Mesh.access-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">access</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">writeable_vars</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">MeshVariable</span><span class="o">&gt;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.access-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.access"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.access-581"><a href="#Mesh.access-581"><span class="linenos">581</span></a>    <span class="k">def</span> <span class="nf">access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">writeable_vars</span><span class="p">:</span> <span class="s2">&quot;MeshVariable&quot;</span><span class="p">):</span>
</span><span id="Mesh.access-582"><a href="#Mesh.access-582"><span class="linenos">582</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.access-583"><a href="#Mesh.access-583"><span class="linenos">583</span></a><span class="sd">        This context manager makes the underlying mesh variables data available to</span>
</span><span id="Mesh.access-584"><a href="#Mesh.access-584"><span class="linenos">584</span></a><span class="sd">        the user. The data should be accessed via the variables `data` handle.</span>
</span><span id="Mesh.access-585"><a href="#Mesh.access-585"><span class="linenos">585</span></a>
</span><span id="Mesh.access-586"><a href="#Mesh.access-586"><span class="linenos">586</span></a><span class="sd">        As default, all data is read-only. To enable writeable data, the user should</span>
</span><span id="Mesh.access-587"><a href="#Mesh.access-587"><span class="linenos">587</span></a><span class="sd">        specify which variable they wish to modify.</span>
</span><span id="Mesh.access-588"><a href="#Mesh.access-588"><span class="linenos">588</span></a>
</span><span id="Mesh.access-589"><a href="#Mesh.access-589"><span class="linenos">589</span></a><span class="sd">        Parameters</span>
</span><span id="Mesh.access-590"><a href="#Mesh.access-590"><span class="linenos">590</span></a><span class="sd">        ----------</span>
</span><span id="Mesh.access-591"><a href="#Mesh.access-591"><span class="linenos">591</span></a><span class="sd">        writeable_vars</span>
</span><span id="Mesh.access-592"><a href="#Mesh.access-592"><span class="linenos">592</span></a><span class="sd">            The variables for which data write access is required.</span>
</span><span id="Mesh.access-593"><a href="#Mesh.access-593"><span class="linenos">593</span></a>
</span><span id="Mesh.access-594"><a href="#Mesh.access-594"><span class="linenos">594</span></a><span class="sd">        Example</span>
</span><span id="Mesh.access-595"><a href="#Mesh.access-595"><span class="linenos">595</span></a><span class="sd">        -------</span>
</span><span id="Mesh.access-596"><a href="#Mesh.access-596"><span class="linenos">596</span></a><span class="sd">        &gt;&gt;&gt; import underworld3 as uw</span>
</span><span id="Mesh.access-597"><a href="#Mesh.access-597"><span class="linenos">597</span></a><span class="sd">        &gt;&gt;&gt; someMesh = uw.discretisation.FeMesh_Cartesian()</span>
</span><span id="Mesh.access-598"><a href="#Mesh.access-598"><span class="linenos">598</span></a><span class="sd">        &gt;&gt;&gt; with someMesh.deform_mesh():</span>
</span><span id="Mesh.access-599"><a href="#Mesh.access-599"><span class="linenos">599</span></a><span class="sd">        ...     someMesh.data[0] = [0.1,0.1]</span>
</span><span id="Mesh.access-600"><a href="#Mesh.access-600"><span class="linenos">600</span></a><span class="sd">        &gt;&gt;&gt; someMesh.data[0]</span>
</span><span id="Mesh.access-601"><a href="#Mesh.access-601"><span class="linenos">601</span></a><span class="sd">        array([ 0.1,  0.1])</span>
</span><span id="Mesh.access-602"><a href="#Mesh.access-602"><span class="linenos">602</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.access-603"><a href="#Mesh.access-603"><span class="linenos">603</span></a>
</span><span id="Mesh.access-604"><a href="#Mesh.access-604"><span class="linenos">604</span></a>        <span class="kn">import</span> <span class="nn">time</span>
</span><span id="Mesh.access-605"><a href="#Mesh.access-605"><span class="linenos">605</span></a>
</span><span id="Mesh.access-606"><a href="#Mesh.access-606"><span class="linenos">606</span></a>        <span class="n">timing</span><span class="o">.</span><span class="n">_incrementDepth</span><span class="p">()</span>
</span><span id="Mesh.access-607"><a href="#Mesh.access-607"><span class="linenos">607</span></a>        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Mesh.access-608"><a href="#Mesh.access-608"><span class="linenos">608</span></a>
</span><span id="Mesh.access-609"><a href="#Mesh.access-609"><span class="linenos">609</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Mesh.access-610"><a href="#Mesh.access-610"><span class="linenos">610</span></a>        <span class="n">deaccess_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Mesh.access-611"><a href="#Mesh.access-611"><span class="linenos">611</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Mesh.access-612"><a href="#Mesh.access-612"><span class="linenos">612</span></a>            <span class="c1"># if already accessed within higher level context manager, continue.</span>
</span><span id="Mesh.access-613"><a href="#Mesh.access-613"><span class="linenos">613</span></a>            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Mesh.access-614"><a href="#Mesh.access-614"><span class="linenos">614</span></a>                <span class="k">continue</span>
</span><span id="Mesh.access-615"><a href="#Mesh.access-615"><span class="linenos">615</span></a>
</span><span id="Mesh.access-616"><a href="#Mesh.access-616"><span class="linenos">616</span></a>            <span class="c1"># set flag so variable status can be known elsewhere</span>
</span><span id="Mesh.access-617"><a href="#Mesh.access-617"><span class="linenos">617</span></a>            <span class="n">var</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Mesh.access-618"><a href="#Mesh.access-618"><span class="linenos">618</span></a>            <span class="c1"># add to de-access list to rewind this later</span>
</span><span id="Mesh.access-619"><a href="#Mesh.access-619"><span class="linenos">619</span></a>            <span class="n">deaccess_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span id="Mesh.access-620"><a href="#Mesh.access-620"><span class="linenos">620</span></a>
</span><span id="Mesh.access-621"><a href="#Mesh.access-621"><span class="linenos">621</span></a>            <span class="c1"># create &amp; set vec</span>
</span><span id="Mesh.access-622"><a href="#Mesh.access-622"><span class="linenos">622</span></a>            <span class="n">var</span><span class="o">.</span><span class="n">_set_vec</span><span class="p">(</span><span class="n">available</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh.access-623"><a href="#Mesh.access-623"><span class="linenos">623</span></a>
</span><span id="Mesh.access-624"><a href="#Mesh.access-624"><span class="linenos">624</span></a>            <span class="c1"># grab numpy object, setting read only if necessary</span>
</span><span id="Mesh.access-625"><a href="#Mesh.access-625"><span class="linenos">625</span></a>            <span class="n">var</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">vec</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="p">)</span>
</span><span id="Mesh.access-626"><a href="#Mesh.access-626"><span class="linenos">626</span></a>
</span><span id="Mesh.access-627"><a href="#Mesh.access-627"><span class="linenos">627</span></a>            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">writeable_vars</span><span class="p">:</span>
</span><span id="Mesh.access-628"><a href="#Mesh.access-628"><span class="linenos">628</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">_old_data_flag</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span>
</span><span id="Mesh.access-629"><a href="#Mesh.access-629"><span class="linenos">629</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh.access-630"><a href="#Mesh.access-630"><span class="linenos">630</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.access-631"><a href="#Mesh.access-631"><span class="linenos">631</span></a>                <span class="c1"># increment variable state</span>
</span><span id="Mesh.access-632"><a href="#Mesh.access-632"><span class="linenos">632</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">_increment</span><span class="p">()</span>
</span><span id="Mesh.access-633"><a href="#Mesh.access-633"><span class="linenos">633</span></a>
</span><span id="Mesh.access-634"><a href="#Mesh.access-634"><span class="linenos">634</span></a>            <span class="c1"># make view for each var component</span>
</span><span id="Mesh.access-635"><a href="#Mesh.access-635"><span class="linenos">635</span></a>
</span><span id="Mesh.access-636"><a href="#Mesh.access-636"><span class="linenos">636</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="Mesh.access-637"><a href="#Mesh.access-637"><span class="linenos">637</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="Mesh.access-638"><a href="#Mesh.access-638"><span class="linenos">638</span></a>                    <span class="c1"># var._data_ij[i, j] = var.data[:, var._data_layout(i, j)]</span>
</span><span id="Mesh.access-639"><a href="#Mesh.access-639"><span class="linenos">639</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
</span><span id="Mesh.access-640"><a href="#Mesh.access-640"><span class="linenos">640</span></a>                        <span class="n">data</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">var</span><span class="o">.</span><span class="n">_data_layout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)],</span>
</span><span id="Mesh.access-641"><a href="#Mesh.access-641"><span class="linenos">641</span></a>                    <span class="p">)</span>
</span><span id="Mesh.access-642"><a href="#Mesh.access-642"><span class="linenos">642</span></a>
</span><span id="Mesh.access-643"><a href="#Mesh.access-643"><span class="linenos">643</span></a>        <span class="k">class</span> <span class="nc">exit_manager</span><span class="p">:</span>
</span><span id="Mesh.access-644"><a href="#Mesh.access-644"><span class="linenos">644</span></a>            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
</span><span id="Mesh.access-645"><a href="#Mesh.access-645"><span class="linenos">645</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
</span><span id="Mesh.access-646"><a href="#Mesh.access-646"><span class="linenos">646</span></a>
</span><span id="Mesh.access-647"><a href="#Mesh.access-647"><span class="linenos">647</span></a>            <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh.access-648"><a href="#Mesh.access-648"><span class="linenos">648</span></a>                <span class="k">pass</span>
</span><span id="Mesh.access-649"><a href="#Mesh.access-649"><span class="linenos">649</span></a>
</span><span id="Mesh.access-650"><a href="#Mesh.access-650"><span class="linenos">650</span></a>            <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="Mesh.access-651"><a href="#Mesh.access-651"><span class="linenos">651</span></a>                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Mesh.access-652"><a href="#Mesh.access-652"><span class="linenos">652</span></a>                    <span class="c1"># only de-access variables we have set access for.</span>
</span><span id="Mesh.access-653"><a href="#Mesh.access-653"><span class="linenos">653</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deaccess_list</span><span class="p">:</span>
</span><span id="Mesh.access-654"><a href="#Mesh.access-654"><span class="linenos">654</span></a>                        <span class="k">continue</span>
</span><span id="Mesh.access-655"><a href="#Mesh.access-655"><span class="linenos">655</span></a>                    <span class="c1"># set this back, although possibly not required.</span>
</span><span id="Mesh.access-656"><a href="#Mesh.access-656"><span class="linenos">656</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">writeable_vars</span><span class="p">:</span>
</span><span id="Mesh.access-657"><a href="#Mesh.access-657"><span class="linenos">657</span></a>                        <span class="n">var</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_old_data_flag</span>
</span><span id="Mesh.access-658"><a href="#Mesh.access-658"><span class="linenos">658</span></a>                    <span class="c1"># perform sync for any modified vars.</span>
</span><span id="Mesh.access-659"><a href="#Mesh.access-659"><span class="linenos">659</span></a>
</span><span id="Mesh.access-660"><a href="#Mesh.access-660"><span class="linenos">660</span></a>                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">writeable_vars</span><span class="p">:</span>
</span><span id="Mesh.access-661"><a href="#Mesh.access-661"><span class="linenos">661</span></a>                        <span class="n">indexset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="Mesh.access-662"><a href="#Mesh.access-662"><span class="linenos">662</span></a>
</span><span id="Mesh.access-663"><a href="#Mesh.access-663"><span class="linenos">663</span></a>                        <span class="c1"># sync ghost values</span>
</span><span id="Mesh.access-664"><a href="#Mesh.access-664"><span class="linenos">664</span></a>                        <span class="n">subdm</span><span class="o">.</span><span class="n">localToGlobal</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">vec</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh.access-665"><a href="#Mesh.access-665"><span class="linenos">665</span></a>                        <span class="n">subdm</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">vec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh.access-666"><a href="#Mesh.access-666"><span class="linenos">666</span></a>
</span><span id="Mesh.access-667"><a href="#Mesh.access-667"><span class="linenos">667</span></a>                        <span class="c1"># subdm.destroy()</span>
</span><span id="Mesh.access-668"><a href="#Mesh.access-668"><span class="linenos">668</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">_stale_lvec</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Mesh.access-669"><a href="#Mesh.access-669"><span class="linenos">669</span></a>
</span><span id="Mesh.access-670"><a href="#Mesh.access-670"><span class="linenos">670</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mesh.access-671"><a href="#Mesh.access-671"><span class="linenos">671</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_set_vec</span><span class="p">(</span><span class="n">available</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh.access-672"><a href="#Mesh.access-672"><span class="linenos">672</span></a>                    <span class="n">var</span><span class="o">.</span><span class="n">_is_accessed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Mesh.access-673"><a href="#Mesh.access-673"><span class="linenos">673</span></a>
</span><span id="Mesh.access-674"><a href="#Mesh.access-674"><span class="linenos">674</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="Mesh.access-675"><a href="#Mesh.access-675"><span class="linenos">675</span></a>                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="Mesh.access-676"><a href="#Mesh.access-676"><span class="linenos">676</span></a>                            <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">_data_container</span><span class="p">[</span>
</span><span id="Mesh.access-677"><a href="#Mesh.access-677"><span class="linenos">677</span></a>                                <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
</span><span id="Mesh.access-678"><a href="#Mesh.access-678"><span class="linenos">678</span></a>                            <span class="p">]</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
</span><span id="Mesh.access-679"><a href="#Mesh.access-679"><span class="linenos">679</span></a>                                <span class="n">data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MeshVariable[...].data is only available within mesh.access() context&quot;</span><span class="p">,</span>
</span><span id="Mesh.access-680"><a href="#Mesh.access-680"><span class="linenos">680</span></a>                            <span class="p">)</span>
</span><span id="Mesh.access-681"><a href="#Mesh.access-681"><span class="linenos">681</span></a>
</span><span id="Mesh.access-682"><a href="#Mesh.access-682"><span class="linenos">682</span></a>                <span class="n">timing</span><span class="o">.</span><span class="n">_decrementDepth</span><span class="p">()</span>
</span><span id="Mesh.access-683"><a href="#Mesh.access-683"><span class="linenos">683</span></a>                <span class="n">timing</span><span class="o">.</span><span class="n">log_result</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">stime</span><span class="p">,</span> <span class="s2">&quot;Mesh.access&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Mesh.access-684"><a href="#Mesh.access-684"><span class="linenos">684</span></a>
</span><span id="Mesh.access-685"><a href="#Mesh.access-685"><span class="linenos">685</span></a>        <span class="k">return</span> <span class="n">exit_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This context manager makes the underlying mesh variables data available to
the user. The data should be accessed via the variables <code><a href="#Mesh.data">data</a></code> handle.</p>

<p>As default, all data is read-only. To enable writeable data, the user should
specify which variable they wish to modify.</p>

<h2 id="parameters">Parameters</h2>

<p>writeable_vars
    The variables for which data write access is required.</p>

<h2 id="example">Example</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">underworld3</span> <span class="k">as</span> <span class="nn">uw</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">someMesh</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">discretisation</span><span class="o">.</span><span class="n">FeMesh_Cartesian</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">someMesh</span><span class="o">.</span><span class="n">deform_mesh</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">someMesh</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">someMesh</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">array([ 0.1,  0.1])</span>
</code></pre>
</div>
</div>


                            </div>
                            <div id="Mesh.N" class="classattr">
                                        <input id="Mesh.N-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">N</span><span class="annotation">: sympy.vector.coordsysrect.CoordSys3D</span>

                <label class="view-source-button" for="Mesh.N-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.N"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.N-687"><a href="#Mesh.N-687"><span class="linenos">687</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.N-688"><a href="#Mesh.N-688"><span class="linenos">688</span></a>    <span class="k">def</span> <span class="nf">N</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">CoordSys3D</span><span class="p">:</span>
</span><span id="Mesh.N-689"><a href="#Mesh.N-689"><span class="linenos">689</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.N-690"><a href="#Mesh.N-690"><span class="linenos">690</span></a><span class="sd">        The mesh coordinate system.</span>
</span><span id="Mesh.N-691"><a href="#Mesh.N-691"><span class="linenos">691</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.N-692"><a href="#Mesh.N-692"><span class="linenos">692</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
</span></pre></div>


            <div class="docstring"><p>The mesh coordinate system.</p>
</div>


                            </div>
                            <div id="Mesh.Gamma_N" class="classattr">
                                        <input id="Mesh.Gamma_N-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">Gamma_N</span><span class="annotation">: sympy.vector.coordsysrect.CoordSys3D</span>

                <label class="view-source-button" for="Mesh.Gamma_N-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.Gamma_N"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.Gamma_N-694"><a href="#Mesh.Gamma_N-694"><span class="linenos">694</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.Gamma_N-695"><a href="#Mesh.Gamma_N-695"><span class="linenos">695</span></a>    <span class="k">def</span> <span class="nf">Gamma_N</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">CoordSys3D</span><span class="p">:</span>
</span><span id="Mesh.Gamma_N-696"><a href="#Mesh.Gamma_N-696"><span class="linenos">696</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.Gamma_N-697"><a href="#Mesh.Gamma_N-697"><span class="linenos">697</span></a><span class="sd">        The mesh coordinate system.</span>
</span><span id="Mesh.Gamma_N-698"><a href="#Mesh.Gamma_N-698"><span class="linenos">698</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.Gamma_N-699"><a href="#Mesh.Gamma_N-699"><span class="linenos">699</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span>
</span></pre></div>


            <div class="docstring"><p>The mesh coordinate system.</p>
</div>


                            </div>
                            <div id="Mesh.Gamma" class="classattr">
                                        <input id="Mesh.Gamma-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">Gamma</span><span class="annotation">: sympy.vector.coordsysrect.CoordSys3D</span>

                <label class="view-source-button" for="Mesh.Gamma-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.Gamma"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.Gamma-701"><a href="#Mesh.Gamma-701"><span class="linenos">701</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.Gamma-702"><a href="#Mesh.Gamma-702"><span class="linenos">702</span></a>    <span class="k">def</span> <span class="nf">Gamma</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">CoordSys3D</span><span class="p">:</span>
</span><span id="Mesh.Gamma-703"><a href="#Mesh.Gamma-703"><span class="linenos">703</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.Gamma-704"><a href="#Mesh.Gamma-704"><span class="linenos">704</span></a><span class="sd">        The mesh coordinate system.</span>
</span><span id="Mesh.Gamma-705"><a href="#Mesh.Gamma-705"><span class="linenos">705</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.Gamma-706"><a href="#Mesh.Gamma-706"><span class="linenos">706</span></a>        <span class="k">return</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Gamma</span><span class="o">.</span><span class="n">base_scalars</span><span class="p">()[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span></pre></div>


            <div class="docstring"><p>The mesh coordinate system.</p>
</div>


                            </div>
                            <div id="Mesh.X" class="classattr">
                                        <input id="Mesh.X-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">X</span><span class="annotation">: sympy.matrices.dense.MutableDenseMatrix</span>

                <label class="view-source-button" for="Mesh.X-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.X"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.X-708"><a href="#Mesh.X-708"><span class="linenos">708</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.X-709"><a href="#Mesh.X-709"><span class="linenos">709</span></a>    <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">:</span>
</span><span id="Mesh.X-710"><a href="#Mesh.X-710"><span class="linenos">710</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CoordinateSystem</span><span class="o">.</span><span class="n">X</span>
</span></pre></div>


    

                            </div>
                            <div id="Mesh.CoordinateSystem" class="classattr">
                                        <input id="Mesh.CoordinateSystem-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">CoordinateSystem</span><span class="annotation">: <a href="coordinates.html#CoordinateSystem">underworld3.coordinates.CoordinateSystem</a></span>

                <label class="view-source-button" for="Mesh.CoordinateSystem-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.CoordinateSystem"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.CoordinateSystem-712"><a href="#Mesh.CoordinateSystem-712"><span class="linenos">712</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.CoordinateSystem-713"><a href="#Mesh.CoordinateSystem-713"><span class="linenos">713</span></a>    <span class="k">def</span> <span class="nf">CoordinateSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CoordinateSystem</span><span class="p">:</span>
</span><span id="Mesh.CoordinateSystem-714"><a href="#Mesh.CoordinateSystem-714"><span class="linenos">714</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CoordinateSystem</span>
</span></pre></div>


    

                            </div>
                            <div id="Mesh.r" class="classattr">
                                        <input id="Mesh.r-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">r</span><span class="annotation">: Tuple[sympy.vector.scalar.BaseScalar]</span>

                <label class="view-source-button" for="Mesh.r-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.r"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.r-716"><a href="#Mesh.r-716"><span class="linenos">716</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.r-717"><a href="#Mesh.r-717"><span class="linenos">717</span></a>    <span class="k">def</span> <span class="nf">r</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">BaseScalar</span><span class="p">]:</span>
</span><span id="Mesh.r-718"><a href="#Mesh.r-718"><span class="linenos">718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.r-719"><a href="#Mesh.r-719"><span class="linenos">719</span></a><span class="sd">        The tuple of base scalar objects (N.x,N.y,N.z) for the mesh.</span>
</span><span id="Mesh.r-720"><a href="#Mesh.r-720"><span class="linenos">720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.r-721"><a href="#Mesh.r-721"><span class="linenos">721</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">base_scalars</span><span class="p">()[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>The tuple of base scalar objects (N.x,N.y,N.z) for the mesh.</p>
</div>


                            </div>
                            <div id="Mesh.rvec" class="classattr">
                                        <input id="Mesh.rvec-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">rvec</span><span class="annotation">: sympy.vector.vector.Vector</span>

                <label class="view-source-button" for="Mesh.rvec-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.rvec"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.rvec-723"><a href="#Mesh.rvec-723"><span class="linenos">723</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.rvec-724"><a href="#Mesh.rvec-724"><span class="linenos">724</span></a>    <span class="k">def</span> <span class="nf">rvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">Vector</span><span class="p">:</span>
</span><span id="Mesh.rvec-725"><a href="#Mesh.rvec-725"><span class="linenos">725</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.rvec-726"><a href="#Mesh.rvec-726"><span class="linenos">726</span></a><span class="sd">        The r vector, `r = N.x*N.i + N.y*N.j [+ N.z*N.k]`.</span>
</span><span id="Mesh.rvec-727"><a href="#Mesh.rvec-727"><span class="linenos">727</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.rvec-728"><a href="#Mesh.rvec-728"><span class="linenos">728</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
</span><span id="Mesh.rvec-729"><a href="#Mesh.rvec-729"><span class="linenos">729</span></a>
</span><span id="Mesh.rvec-730"><a href="#Mesh.rvec-730"><span class="linenos">730</span></a>        <span class="n">r_vec</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">zero</span>
</span><span id="Mesh.rvec-731"><a href="#Mesh.rvec-731"><span class="linenos">731</span></a>
</span><span id="Mesh.rvec-732"><a href="#Mesh.rvec-732"><span class="linenos">732</span></a>        <span class="n">N_s</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">base_scalars</span><span class="p">()</span>
</span><span id="Mesh.rvec-733"><a href="#Mesh.rvec-733"><span class="linenos">733</span></a>        <span class="n">N_v</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">base_vectors</span><span class="p">()</span>
</span><span id="Mesh.rvec-734"><a href="#Mesh.rvec-734"><span class="linenos">734</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">):</span>
</span><span id="Mesh.rvec-735"><a href="#Mesh.rvec-735"><span class="linenos">735</span></a>            <span class="n">r_vec</span> <span class="o">+=</span> <span class="n">N_s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">N_v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Mesh.rvec-736"><a href="#Mesh.rvec-736"><span class="linenos">736</span></a>
</span><span id="Mesh.rvec-737"><a href="#Mesh.rvec-737"><span class="linenos">737</span></a>        <span class="k">return</span> <span class="n">r_vec</span>
</span></pre></div>


            <div class="docstring"><p>The r vector, <code>r = N.x*N.i + N.y*N.j [+ N.z*N.k]</code>.</p>
</div>


                            </div>
                            <div id="Mesh.data" class="classattr">
                                        <input id="Mesh.data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">data</span><span class="annotation">: numpy.ndarray</span>

                <label class="view-source-button" for="Mesh.data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.data-739"><a href="#Mesh.data-739"><span class="linenos">739</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.data-740"><a href="#Mesh.data-740"><span class="linenos">740</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Mesh.data-741"><a href="#Mesh.data-741"><span class="linenos">741</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.data-742"><a href="#Mesh.data-742"><span class="linenos">742</span></a><span class="sd">        The array of mesh element vertex coordinates.</span>
</span><span id="Mesh.data-743"><a href="#Mesh.data-743"><span class="linenos">743</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.data-744"><a href="#Mesh.data-744"><span class="linenos">744</span></a>        <span class="c1"># get flat array</span>
</span><span id="Mesh.data-745"><a href="#Mesh.data-745"><span class="linenos">745</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getCoordinatesLocal</span><span class="p">()</span><span class="o">.</span><span class="n">array</span>
</span><span id="Mesh.data-746"><a href="#Mesh.data-746"><span class="linenos">746</span></a>        <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdim</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>The array of mesh element vertex coordinates.</p>
</div>


                            </div>
                            <div id="Mesh.write_timestep" class="classattr">
                                        <input id="Mesh.write_timestep-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@timing.routine_timer_decorator</div>

        <span class="def">def</span>
        <span class="name">write_timestep</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">index</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.write_timestep-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.write_timestep"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.write_timestep-748"><a href="#Mesh.write_timestep-748"><span class="linenos">748</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh.write_timestep-749"><a href="#Mesh.write_timestep-749"><span class="linenos">749</span></a>    <span class="k">def</span> <span class="nf">write_timestep</span><span class="p">(</span>
</span><span id="Mesh.write_timestep-750"><a href="#Mesh.write_timestep-750"><span class="linenos">750</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-751"><a href="#Mesh.write_timestep-751"><span class="linenos">751</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-752"><a href="#Mesh.write_timestep-752"><span class="linenos">752</span></a>        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-753"><a href="#Mesh.write_timestep-753"><span class="linenos">753</span></a>        <span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-754"><a href="#Mesh.write_timestep-754"><span class="linenos">754</span></a>        <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh.write_timestep-755"><a href="#Mesh.write_timestep-755"><span class="linenos">755</span></a>        <span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh.write_timestep-756"><a href="#Mesh.write_timestep-756"><span class="linenos">756</span></a>        <span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-757"><a href="#Mesh.write_timestep-757"><span class="linenos">757</span></a>    <span class="p">):</span>
</span><span id="Mesh.write_timestep-758"><a href="#Mesh.write_timestep-758"><span class="linenos">758</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.write_timestep-759"><a href="#Mesh.write_timestep-759"><span class="linenos">759</span></a><span class="sd">        Write the selected mesh, variables and swarm variables (as proxies) for later visualisation.</span>
</span><span id="Mesh.write_timestep-760"><a href="#Mesh.write_timestep-760"><span class="linenos">760</span></a><span class="sd">        An xdmf file is generated and the overall package can then be read by paraview or pyvista.</span>
</span><span id="Mesh.write_timestep-761"><a href="#Mesh.write_timestep-761"><span class="linenos">761</span></a><span class="sd">        Vertex values (on the mesh points) are stored for all variables regardless of their interpolation order</span>
</span><span id="Mesh.write_timestep-762"><a href="#Mesh.write_timestep-762"><span class="linenos">762</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.write_timestep-763"><a href="#Mesh.write_timestep-763"><span class="linenos">763</span></a>
</span><span id="Mesh.write_timestep-764"><a href="#Mesh.write_timestep-764"><span class="linenos">764</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
</span><span id="Mesh.write_timestep-765"><a href="#Mesh.write_timestep-765"><span class="linenos">765</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;viewer_hdf5_sp_output&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Mesh.write_timestep-766"><a href="#Mesh.write_timestep-766"><span class="linenos">766</span></a>        <span class="n">options</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;viewer_hdf5_collective&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Mesh.write_timestep-767"><a href="#Mesh.write_timestep-767"><span class="linenos">767</span></a>
</span><span id="Mesh.write_timestep-768"><a href="#Mesh.write_timestep-768"><span class="linenos">768</span></a>        <span class="kn">import</span> <span class="nn">os</span>
</span><span id="Mesh.write_timestep-769"><a href="#Mesh.write_timestep-769"><span class="linenos">769</span></a>
</span><span id="Mesh.write_timestep-770"><a href="#Mesh.write_timestep-770"><span class="linenos">770</span></a>        <span class="n">output_base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="Mesh.write_timestep-771"><a href="#Mesh.write_timestep-771"><span class="linenos">771</span></a>
</span><span id="Mesh.write_timestep-772"><a href="#Mesh.write_timestep-772"><span class="linenos">772</span></a>        <span class="c1"># Checkpoint the mesh file itself if required</span>
</span><span id="Mesh.write_timestep-773"><a href="#Mesh.write_timestep-773"><span class="linenos">773</span></a>
</span><span id="Mesh.write_timestep-774"><a href="#Mesh.write_timestep-774"><span class="linenos">774</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">meshUpdates</span><span class="p">:</span>
</span><span id="Mesh.write_timestep-775"><a href="#Mesh.write_timestep-775"><span class="linenos">775</span></a>            <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="Mesh.write_timestep-776"><a href="#Mesh.write_timestep-776"><span class="linenos">776</span></a>
</span><span id="Mesh.write_timestep-777"><a href="#Mesh.write_timestep-777"><span class="linenos">777</span></a>            <span class="n">mesh_file</span> <span class="o">=</span> <span class="n">output_base_name</span> <span class="o">+</span> <span class="s2">&quot;.mesh.00000.h5&quot;</span>
</span><span id="Mesh.write_timestep-778"><a href="#Mesh.write_timestep-778"><span class="linenos">778</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="Mesh.write_timestep-779"><a href="#Mesh.write_timestep-779"><span class="linenos">779</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span id="Mesh.write_timestep-780"><a href="#Mesh.write_timestep-780"><span class="linenos">780</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="Mesh.write_timestep-781"><a href="#Mesh.write_timestep-781"><span class="linenos">781</span></a>
</span><span id="Mesh.write_timestep-782"><a href="#Mesh.write_timestep-782"><span class="linenos">782</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.write_timestep-783"><a href="#Mesh.write_timestep-783"><span class="linenos">783</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span><span class="p">)</span>
</span><span id="Mesh.write_timestep-784"><a href="#Mesh.write_timestep-784"><span class="linenos">784</span></a>
</span><span id="Mesh.write_timestep-785"><a href="#Mesh.write_timestep-785"><span class="linenos">785</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh.write_timestep-786"><a href="#Mesh.write_timestep-786"><span class="linenos">786</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="Mesh.write_timestep-787"><a href="#Mesh.write_timestep-787"><span class="linenos">787</span></a>                <span class="n">save_location</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mesh.write_timestep-788"><a href="#Mesh.write_timestep-788"><span class="linenos">788</span></a>                    <span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh.write_timestep-789"><a href="#Mesh.write_timestep-789"><span class="linenos">789</span></a>                <span class="p">)</span>
</span><span id="Mesh.write_timestep-790"><a href="#Mesh.write_timestep-790"><span class="linenos">790</span></a>                <span class="n">var</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span>
</span><span id="Mesh.write_timestep-791"><a href="#Mesh.write_timestep-791"><span class="linenos">791</span></a>
</span><span id="Mesh.write_timestep-792"><a href="#Mesh.write_timestep-792"><span class="linenos">792</span></a>        <span class="k">if</span> <span class="n">swarmVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh.write_timestep-793"><a href="#Mesh.write_timestep-793"><span class="linenos">793</span></a>            <span class="k">for</span> <span class="n">svar</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="Mesh.write_timestep-794"><a href="#Mesh.write_timestep-794"><span class="linenos">794</span></a>                <span class="n">save_location</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mesh.write_timestep-795"><a href="#Mesh.write_timestep-795"><span class="linenos">795</span></a>                    <span class="n">output_base_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.proxy.</span><span class="si">{</span><span class="n">svar</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh.write_timestep-796"><a href="#Mesh.write_timestep-796"><span class="linenos">796</span></a>                <span class="p">)</span>
</span><span id="Mesh.write_timestep-797"><a href="#Mesh.write_timestep-797"><span class="linenos">797</span></a>                <span class="n">svar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span>
</span><span id="Mesh.write_timestep-798"><a href="#Mesh.write_timestep-798"><span class="linenos">798</span></a>
</span><span id="Mesh.write_timestep-799"><a href="#Mesh.write_timestep-799"><span class="linenos">799</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.write_timestep-800"><a href="#Mesh.write_timestep-800"><span class="linenos">800</span></a>            <span class="n">checkpoint_xdmf</span><span class="p">(</span>
</span><span id="Mesh.write_timestep-801"><a href="#Mesh.write_timestep-801"><span class="linenos">801</span></a>                <span class="n">output_base_name</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-802"><a href="#Mesh.write_timestep-802"><span class="linenos">802</span></a>                <span class="n">meshUpdates</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-803"><a href="#Mesh.write_timestep-803"><span class="linenos">803</span></a>                <span class="n">meshVars</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-804"><a href="#Mesh.write_timestep-804"><span class="linenos">804</span></a>                <span class="n">swarmVars</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-805"><a href="#Mesh.write_timestep-805"><span class="linenos">805</span></a>                <span class="n">index</span><span class="p">,</span>
</span><span id="Mesh.write_timestep-806"><a href="#Mesh.write_timestep-806"><span class="linenos">806</span></a>            <span class="p">)</span>
</span><span id="Mesh.write_timestep-807"><a href="#Mesh.write_timestep-807"><span class="linenos">807</span></a>
</span><span id="Mesh.write_timestep-808"><a href="#Mesh.write_timestep-808"><span class="linenos">808</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Write the selected mesh, variables and swarm variables (as proxies) for later visualisation.
An xdmf file is generated and the overall package can then be read by paraview or pyvista.
Vertex values (on the mesh points) are stored for all variables regardless of their interpolation order</p>
</div>


                            </div>
                            <div id="Mesh.petsc_save_checkpoint" class="classattr">
                                        <input id="Mesh.petsc_save_checkpoint-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@timing.routine_timer_decorator</div>

        <span class="def">def</span>
        <span class="name">petsc_save_checkpoint</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">index</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.petsc_save_checkpoint-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.petsc_save_checkpoint"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.petsc_save_checkpoint-810"><a href="#Mesh.petsc_save_checkpoint-810"><span class="linenos">810</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh.petsc_save_checkpoint-811"><a href="#Mesh.petsc_save_checkpoint-811"><span class="linenos">811</span></a>    <span class="k">def</span> <span class="nf">petsc_save_checkpoint</span><span class="p">(</span>
</span><span id="Mesh.petsc_save_checkpoint-812"><a href="#Mesh.petsc_save_checkpoint-812"><span class="linenos">812</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh.petsc_save_checkpoint-813"><a href="#Mesh.petsc_save_checkpoint-813"><span class="linenos">813</span></a>        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Mesh.petsc_save_checkpoint-814"><a href="#Mesh.petsc_save_checkpoint-814"><span class="linenos">814</span></a>        <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh.petsc_save_checkpoint-815"><a href="#Mesh.petsc_save_checkpoint-815"><span class="linenos">815</span></a>        <span class="n">outputPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Mesh.petsc_save_checkpoint-816"><a href="#Mesh.petsc_save_checkpoint-816"><span class="linenos">816</span></a>    <span class="p">):</span>
</span><span id="Mesh.petsc_save_checkpoint-817"><a href="#Mesh.petsc_save_checkpoint-817"><span class="linenos">817</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.petsc_save_checkpoint-818"><a href="#Mesh.petsc_save_checkpoint-818"><span class="linenos">818</span></a>
</span><span id="Mesh.petsc_save_checkpoint-819"><a href="#Mesh.petsc_save_checkpoint-819"><span class="linenos">819</span></a><span class="sd">        Use PETSc to save the mesh and mesh vars in a h5 and xdmf file.</span>
</span><span id="Mesh.petsc_save_checkpoint-820"><a href="#Mesh.petsc_save_checkpoint-820"><span class="linenos">820</span></a>
</span><span id="Mesh.petsc_save_checkpoint-821"><a href="#Mesh.petsc_save_checkpoint-821"><span class="linenos">821</span></a><span class="sd">        Parameters</span>
</span><span id="Mesh.petsc_save_checkpoint-822"><a href="#Mesh.petsc_save_checkpoint-822"><span class="linenos">822</span></a><span class="sd">        ----------</span>
</span><span id="Mesh.petsc_save_checkpoint-823"><a href="#Mesh.petsc_save_checkpoint-823"><span class="linenos">823</span></a><span class="sd">        meshVars:</span>
</span><span id="Mesh.petsc_save_checkpoint-824"><a href="#Mesh.petsc_save_checkpoint-824"><span class="linenos">824</span></a><span class="sd">            List of UW mesh variables to save. If left empty then just the mesh is saved.</span>
</span><span id="Mesh.petsc_save_checkpoint-825"><a href="#Mesh.petsc_save_checkpoint-825"><span class="linenos">825</span></a><span class="sd">        index :</span>
</span><span id="Mesh.petsc_save_checkpoint-826"><a href="#Mesh.petsc_save_checkpoint-826"><span class="linenos">826</span></a><span class="sd">            An index which might correspond to the timestep or output number (for example).</span>
</span><span id="Mesh.petsc_save_checkpoint-827"><a href="#Mesh.petsc_save_checkpoint-827"><span class="linenos">827</span></a><span class="sd">        outputPath :</span>
</span><span id="Mesh.petsc_save_checkpoint-828"><a href="#Mesh.petsc_save_checkpoint-828"><span class="linenos">828</span></a><span class="sd">            Path to save the data. If left empty it will save the data in the current working directory.</span>
</span><span id="Mesh.petsc_save_checkpoint-829"><a href="#Mesh.petsc_save_checkpoint-829"><span class="linenos">829</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.petsc_save_checkpoint-830"><a href="#Mesh.petsc_save_checkpoint-830"><span class="linenos">830</span></a>
</span><span id="Mesh.petsc_save_checkpoint-831"><a href="#Mesh.petsc_save_checkpoint-831"><span class="linenos">831</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meshVars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Mesh.petsc_save_checkpoint-832"><a href="#Mesh.petsc_save_checkpoint-832"><span class="linenos">832</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;`meshVars` does not appear to be a list.&quot;</span><span class="p">)</span>
</span><span id="Mesh.petsc_save_checkpoint-833"><a href="#Mesh.petsc_save_checkpoint-833"><span class="linenos">833</span></a>
</span><span id="Mesh.petsc_save_checkpoint-834"><a href="#Mesh.petsc_save_checkpoint-834"><span class="linenos">834</span></a>        <span class="kn">from</span> <span class="nn">underworld3.utilities</span> <span class="kn">import</span> <span class="n">generateXdmf</span>
</span><span id="Mesh.petsc_save_checkpoint-835"><a href="#Mesh.petsc_save_checkpoint-835"><span class="linenos">835</span></a>
</span><span id="Mesh.petsc_save_checkpoint-836"><a href="#Mesh.petsc_save_checkpoint-836"><span class="linenos">836</span></a>        <span class="c1">### save mesh vars</span>
</span><span id="Mesh.petsc_save_checkpoint-837"><a href="#Mesh.petsc_save_checkpoint-837"><span class="linenos">837</span></a>        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">outputPath</span><span class="si">}{</span><span class="s1">&#39;_step_&#39;</span><span class="si">}{</span><span class="n">index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh.petsc_save_checkpoint-838"><a href="#Mesh.petsc_save_checkpoint-838"><span class="linenos">838</span></a>        <span class="n">xfname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">outputPath</span><span class="si">}{</span><span class="s1">&#39;_step_&#39;</span><span class="si">}{</span><span class="n">index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.xdmf&quot;</span>
</span><span id="Mesh.petsc_save_checkpoint-839"><a href="#Mesh.petsc_save_checkpoint-839"><span class="linenos">839</span></a>        <span class="c1">#### create petsc viewer</span>
</span><span id="Mesh.petsc_save_checkpoint-840"><a href="#Mesh.petsc_save_checkpoint-840"><span class="linenos">840</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">createHDF5</span><span class="p">(</span>
</span><span id="Mesh.petsc_save_checkpoint-841"><a href="#Mesh.petsc_save_checkpoint-841"><span class="linenos">841</span></a>            <span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span>
</span><span id="Mesh.petsc_save_checkpoint-842"><a href="#Mesh.petsc_save_checkpoint-842"><span class="linenos">842</span></a>        <span class="p">)</span>
</span><span id="Mesh.petsc_save_checkpoint-843"><a href="#Mesh.petsc_save_checkpoint-843"><span class="linenos">843</span></a>
</span><span id="Mesh.petsc_save_checkpoint-844"><a href="#Mesh.petsc_save_checkpoint-844"><span class="linenos">844</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh.petsc_save_checkpoint-845"><a href="#Mesh.petsc_save_checkpoint-845"><span class="linenos">845</span></a>
</span><span id="Mesh.petsc_save_checkpoint-846"><a href="#Mesh.petsc_save_checkpoint-846"><span class="linenos">846</span></a>        <span class="c1">### Empty meshVars will save just the mesh</span>
</span><span id="Mesh.petsc_save_checkpoint-847"><a href="#Mesh.petsc_save_checkpoint-847"><span class="linenos">847</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh.petsc_save_checkpoint-848"><a href="#Mesh.petsc_save_checkpoint-848"><span class="linenos">848</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="Mesh.petsc_save_checkpoint-849"><a href="#Mesh.petsc_save_checkpoint-849"><span class="linenos">849</span></a>                <span class="n">viewer</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="Mesh.petsc_save_checkpoint-850"><a href="#Mesh.petsc_save_checkpoint-850"><span class="linenos">850</span></a>
</span><span id="Mesh.petsc_save_checkpoint-851"><a href="#Mesh.petsc_save_checkpoint-851"><span class="linenos">851</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Mesh.petsc_save_checkpoint-852"><a href="#Mesh.petsc_save_checkpoint-852"><span class="linenos">852</span></a>
</span><span id="Mesh.petsc_save_checkpoint-853"><a href="#Mesh.petsc_save_checkpoint-853"><span class="linenos">853</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.petsc_save_checkpoint-854"><a href="#Mesh.petsc_save_checkpoint-854"><span class="linenos">854</span></a>            <span class="n">generateXdmf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">xfname</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Use PETSc to save the mesh and mesh vars in a h5 and xdmf file.</p>

<h2 id="parameters">Parameters</h2>

<p>meshVars:
    List of UW mesh variables to save. If left empty then just the mesh is saved.
index :
    An index which might correspond to the timestep or output number (for example).
outputPath :
    Path to save the data. If left empty it will save the data in the current working directory.</p>
</div>


                            </div>
                            <div id="Mesh.write_checkpoint" class="classattr">
                                        <input id="Mesh.write_checkpoint-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@timing.routine_timer_decorator</div>

        <span class="def">def</span>
        <span class="name">write_checkpoint</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">unique_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.write_checkpoint-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.write_checkpoint"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.write_checkpoint-856"><a href="#Mesh.write_checkpoint-856"><span class="linenos">856</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh.write_checkpoint-857"><a href="#Mesh.write_checkpoint-857"><span class="linenos">857</span></a>    <span class="k">def</span> <span class="nf">write_checkpoint</span><span class="p">(</span>
</span><span id="Mesh.write_checkpoint-858"><a href="#Mesh.write_checkpoint-858"><span class="linenos">858</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh.write_checkpoint-859"><a href="#Mesh.write_checkpoint-859"><span class="linenos">859</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Mesh.write_checkpoint-860"><a href="#Mesh.write_checkpoint-860"><span class="linenos">860</span></a>        <span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Mesh.write_checkpoint-861"><a href="#Mesh.write_checkpoint-861"><span class="linenos">861</span></a>        <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh.write_checkpoint-862"><a href="#Mesh.write_checkpoint-862"><span class="linenos">862</span></a>        <span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Mesh.write_checkpoint-863"><a href="#Mesh.write_checkpoint-863"><span class="linenos">863</span></a>        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Mesh.write_checkpoint-864"><a href="#Mesh.write_checkpoint-864"><span class="linenos">864</span></a>        <span class="n">unique_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Mesh.write_checkpoint-865"><a href="#Mesh.write_checkpoint-865"><span class="linenos">865</span></a>    <span class="p">):</span>
</span><span id="Mesh.write_checkpoint-866"><a href="#Mesh.write_checkpoint-866"><span class="linenos">866</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Write data in a format that can be restored for restarting the simulation</span>
</span><span id="Mesh.write_checkpoint-867"><a href="#Mesh.write_checkpoint-867"><span class="linenos">867</span></a><span class="sd">        The difference between this and the visualisation is 1) the parallel section needs</span>
</span><span id="Mesh.write_checkpoint-868"><a href="#Mesh.write_checkpoint-868"><span class="linenos">868</span></a><span class="sd">        to be stored to reload the data correctly, and 2) the visualisation information (vertex form of fields)</span>
</span><span id="Mesh.write_checkpoint-869"><a href="#Mesh.write_checkpoint-869"><span class="linenos">869</span></a><span class="sd">        is not stored. This routines uses dmplex *VectorView and *VectorLoad functionality</span>
</span><span id="Mesh.write_checkpoint-870"><a href="#Mesh.write_checkpoint-870"><span class="linenos">870</span></a>
</span><span id="Mesh.write_checkpoint-871"><a href="#Mesh.write_checkpoint-871"><span class="linenos">871</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.write_checkpoint-872"><a href="#Mesh.write_checkpoint-872"><span class="linenos">872</span></a>
</span><span id="Mesh.write_checkpoint-873"><a href="#Mesh.write_checkpoint-873"><span class="linenos">873</span></a>        <span class="c1"># The mesh checkpoint is the same as the one required for visualisation</span>
</span><span id="Mesh.write_checkpoint-874"><a href="#Mesh.write_checkpoint-874"><span class="linenos">874</span></a>
</span><span id="Mesh.write_checkpoint-875"><a href="#Mesh.write_checkpoint-875"><span class="linenos">875</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">meshUpdates</span><span class="p">:</span>
</span><span id="Mesh.write_checkpoint-876"><a href="#Mesh.write_checkpoint-876"><span class="linenos">876</span></a>            <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="Mesh.write_checkpoint-877"><a href="#Mesh.write_checkpoint-877"><span class="linenos">877</span></a>
</span><span id="Mesh.write_checkpoint-878"><a href="#Mesh.write_checkpoint-878"><span class="linenos">878</span></a>            <span class="n">mesh_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.mesh.0.h5&quot;</span>
</span><span id="Mesh.write_checkpoint-879"><a href="#Mesh.write_checkpoint-879"><span class="linenos">879</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-880"><a href="#Mesh.write_checkpoint-880"><span class="linenos">880</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span id="Mesh.write_checkpoint-881"><a href="#Mesh.write_checkpoint-881"><span class="linenos">881</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-882"><a href="#Mesh.write_checkpoint-882"><span class="linenos">882</span></a>
</span><span id="Mesh.write_checkpoint-883"><a href="#Mesh.write_checkpoint-883"><span class="linenos">883</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.write_checkpoint-884"><a href="#Mesh.write_checkpoint-884"><span class="linenos">884</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-885"><a href="#Mesh.write_checkpoint-885"><span class="linenos">885</span></a>
</span><span id="Mesh.write_checkpoint-886"><a href="#Mesh.write_checkpoint-886"><span class="linenos">886</span></a>        <span class="c1"># Checkpoint file</span>
</span><span id="Mesh.write_checkpoint-887"><a href="#Mesh.write_checkpoint-887"><span class="linenos">887</span></a>
</span><span id="Mesh.write_checkpoint-888"><a href="#Mesh.write_checkpoint-888"><span class="linenos">888</span></a>        <span class="k">if</span> <span class="n">unique_id</span><span class="p">:</span>
</span><span id="Mesh.write_checkpoint-889"><a href="#Mesh.write_checkpoint-889"><span class="linenos">889</span></a>            <span class="n">checkpoint_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">unique</span><span class="si">}</span><span class="s2">.checkpoint.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh.write_checkpoint-890"><a href="#Mesh.write_checkpoint-890"><span class="linenos">890</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.write_checkpoint-891"><a href="#Mesh.write_checkpoint-891"><span class="linenos">891</span></a>            <span class="n">checkpoint_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.checkpoint.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="Mesh.write_checkpoint-892"><a href="#Mesh.write_checkpoint-892"><span class="linenos">892</span></a>
</span><span id="Mesh.write_checkpoint-893"><a href="#Mesh.write_checkpoint-893"><span class="linenos">893</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;uw_mesh&quot;</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-894"><a href="#Mesh.write_checkpoint-894"><span class="linenos">894</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-895"><a href="#Mesh.write_checkpoint-895"><span class="linenos">895</span></a>
</span><span id="Mesh.write_checkpoint-896"><a href="#Mesh.write_checkpoint-896"><span class="linenos">896</span></a>        <span class="c1"># Store the parallel-mesh section information for restoring the checkpoint.</span>
</span><span id="Mesh.write_checkpoint-897"><a href="#Mesh.write_checkpoint-897"><span class="linenos">897</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">sectionView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-898"><a href="#Mesh.write_checkpoint-898"><span class="linenos">898</span></a>
</span><span id="Mesh.write_checkpoint-899"><a href="#Mesh.write_checkpoint-899"><span class="linenos">899</span></a>        <span class="k">if</span> <span class="n">meshVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh.write_checkpoint-900"><a href="#Mesh.write_checkpoint-900"><span class="linenos">900</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="Mesh.write_checkpoint-901"><a href="#Mesh.write_checkpoint-901"><span class="linenos">901</span></a>                <span class="n">iset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-902"><a href="#Mesh.write_checkpoint-902"><span class="linenos">902</span></a>                <span class="n">subdm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-903"><a href="#Mesh.write_checkpoint-903"><span class="linenos">903</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">globalVectorView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-904"><a href="#Mesh.write_checkpoint-904"><span class="linenos">904</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">sectionView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-905"><a href="#Mesh.write_checkpoint-905"><span class="linenos">905</span></a>                <span class="c1"># v._gvec.view(viewer) # would add viz information plus a duplicate of the data</span>
</span><span id="Mesh.write_checkpoint-906"><a href="#Mesh.write_checkpoint-906"><span class="linenos">906</span></a>
</span><span id="Mesh.write_checkpoint-907"><a href="#Mesh.write_checkpoint-907"><span class="linenos">907</span></a>        <span class="k">if</span> <span class="n">swarmVars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh.write_checkpoint-908"><a href="#Mesh.write_checkpoint-908"><span class="linenos">908</span></a>            <span class="k">for</span> <span class="n">svar</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="Mesh.write_checkpoint-909"><a href="#Mesh.write_checkpoint-909"><span class="linenos">909</span></a>                <span class="n">var</span> <span class="o">=</span> <span class="n">svar</span><span class="o">.</span><span class="n">_meshVar</span>
</span><span id="Mesh.write_checkpoint-910"><a href="#Mesh.write_checkpoint-910"><span class="linenos">910</span></a>                <span class="n">iset</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-911"><a href="#Mesh.write_checkpoint-911"><span class="linenos">911</span></a>                <span class="n">subdm</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-912"><a href="#Mesh.write_checkpoint-912"><span class="linenos">912</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">globalVectorView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">_gvec</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-913"><a href="#Mesh.write_checkpoint-913"><span class="linenos">913</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">sectionView</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">subdm</span><span class="p">)</span>
</span><span id="Mesh.write_checkpoint-914"><a href="#Mesh.write_checkpoint-914"><span class="linenos">914</span></a>
</span><span id="Mesh.write_checkpoint-915"><a href="#Mesh.write_checkpoint-915"><span class="linenos">915</span></a>        <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>  <span class="c1"># should not be required</span>
</span><span id="Mesh.write_checkpoint-916"><a href="#Mesh.write_checkpoint-916"><span class="linenos">916</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Write data in a format that can be restored for restarting the simulation
The difference between this and the visualisation is 1) the parallel section needs
to be stored to reload the data correctly, and 2) the visualisation information (vertex form of fields)
is not stored. This routines uses dmplex *VectorView and *VectorLoad functionality</p>
</div>


                            </div>
                            <div id="Mesh.write" class="classattr">
                                        <input id="Mesh.write-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@timing.routine_timer_decorator</div>

        <span class="def">def</span>
        <span class="name">write</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.write-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.write"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.write-918"><a href="#Mesh.write-918"><span class="linenos">918</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh.write-919"><a href="#Mesh.write-919"><span class="linenos">919</span></a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Mesh.write-920"><a href="#Mesh.write-920"><span class="linenos">920</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.write-921"><a href="#Mesh.write-921"><span class="linenos">921</span></a><span class="sd">        Save mesh data to the specified hdf5 file.</span>
</span><span id="Mesh.write-922"><a href="#Mesh.write-922"><span class="linenos">922</span></a>
</span><span id="Mesh.write-923"><a href="#Mesh.write-923"><span class="linenos">923</span></a>
</span><span id="Mesh.write-924"><a href="#Mesh.write-924"><span class="linenos">924</span></a><span class="sd">        Parameters</span>
</span><span id="Mesh.write-925"><a href="#Mesh.write-925"><span class="linenos">925</span></a><span class="sd">        ----------</span>
</span><span id="Mesh.write-926"><a href="#Mesh.write-926"><span class="linenos">926</span></a><span class="sd">        filename :</span>
</span><span id="Mesh.write-927"><a href="#Mesh.write-927"><span class="linenos">927</span></a><span class="sd">            The filename for the mesh checkpoint file.</span>
</span><span id="Mesh.write-928"><a href="#Mesh.write-928"><span class="linenos">928</span></a><span class="sd">        index :</span>
</span><span id="Mesh.write-929"><a href="#Mesh.write-929"><span class="linenos">929</span></a><span class="sd">            Not yet implemented. An optional index which might</span>
</span><span id="Mesh.write-930"><a href="#Mesh.write-930"><span class="linenos">930</span></a><span class="sd">            correspond to the timestep (for example).</span>
</span><span id="Mesh.write-931"><a href="#Mesh.write-931"><span class="linenos">931</span></a>
</span><span id="Mesh.write-932"><a href="#Mesh.write-932"><span class="linenos">932</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.write-933"><a href="#Mesh.write-933"><span class="linenos">933</span></a>
</span><span id="Mesh.write-934"><a href="#Mesh.write-934"><span class="linenos">934</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ViewerHDF5</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="Mesh.write-935"><a href="#Mesh.write-935"><span class="linenos">935</span></a>        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
</span><span id="Mesh.write-936"><a href="#Mesh.write-936"><span class="linenos">936</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Recording `index` not currently supported&quot;</span><span class="p">)</span>
</span><span id="Mesh.write-937"><a href="#Mesh.write-937"><span class="linenos">937</span></a>            <span class="c1">## JM:To enable timestep recording, the following needs to be called.</span>
</span><span id="Mesh.write-938"><a href="#Mesh.write-938"><span class="linenos">938</span></a>            <span class="c1">## I&#39;m unsure if the corresponding xdmf functionality is enabled via</span>
</span><span id="Mesh.write-939"><a href="#Mesh.write-939"><span class="linenos">939</span></a>            <span class="c1">## the PETSc xdmf script.</span>
</span><span id="Mesh.write-940"><a href="#Mesh.write-940"><span class="linenos">940</span></a>            <span class="c1"># viewer.pushTimestepping(viewer)</span>
</span><span id="Mesh.write-941"><a href="#Mesh.write-941"><span class="linenos">941</span></a>            <span class="c1"># viewer.setTimestep(index)</span>
</span><span id="Mesh.write-942"><a href="#Mesh.write-942"><span class="linenos">942</span></a>
</span><span id="Mesh.write-943"><a href="#Mesh.write-943"><span class="linenos">943</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh.write-944"><a href="#Mesh.write-944"><span class="linenos">944</span></a>
</span><span id="Mesh.write-945"><a href="#Mesh.write-945"><span class="linenos">945</span></a>        <span class="c1"># Not sure if the files are correctly written if we do not explicitly destroy the viewer</span>
</span><span id="Mesh.write-946"><a href="#Mesh.write-946"><span class="linenos">946</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Save mesh data to the specified hdf5 file.</p>

<h2 id="parameters">Parameters</h2>

<p>filename :
    The filename for the mesh checkpoint file.
index :
    Not yet implemented. An optional index which might
    correspond to the timestep (for example).</p>
</div>


                            </div>
                            <div id="Mesh.vtk" class="classattr">
                                        <input id="Mesh.vtk-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">vtk</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.vtk-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.vtk"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.vtk-948"><a href="#Mesh.vtk-948"><span class="linenos">948</span></a>    <span class="k">def</span> <span class="nf">vtk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Mesh.vtk-949"><a href="#Mesh.vtk-949"><span class="linenos">949</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.vtk-950"><a href="#Mesh.vtk-950"><span class="linenos">950</span></a><span class="sd">        Save mesh to the specified file</span>
</span><span id="Mesh.vtk-951"><a href="#Mesh.vtk-951"><span class="linenos">951</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.vtk-952"><a href="#Mesh.vtk-952"><span class="linenos">952</span></a>
</span><span id="Mesh.vtk-953"><a href="#Mesh.vtk-953"><span class="linenos">953</span></a>        <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span><span class="o">.</span><span class="n">createVTK</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
</span><span id="Mesh.vtk-954"><a href="#Mesh.vtk-954"><span class="linenos">954</span></a>        <span class="n">viewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span>
</span><span id="Mesh.vtk-955"><a href="#Mesh.vtk-955"><span class="linenos">955</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Save mesh to the specified file</p>
</div>


                            </div>
                            <div id="Mesh.generate_xdmf" class="classattr">
                                        <input id="Mesh.generate_xdmf-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_xdmf</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.generate_xdmf-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.generate_xdmf"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.generate_xdmf-957"><a href="#Mesh.generate_xdmf-957"><span class="linenos">957</span></a>    <span class="k">def</span> <span class="nf">generate_xdmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Mesh.generate_xdmf-958"><a href="#Mesh.generate_xdmf-958"><span class="linenos">958</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.generate_xdmf-959"><a href="#Mesh.generate_xdmf-959"><span class="linenos">959</span></a><span class="sd">        This method generates an xdmf schema for the specified file.</span>
</span><span id="Mesh.generate_xdmf-960"><a href="#Mesh.generate_xdmf-960"><span class="linenos">960</span></a>
</span><span id="Mesh.generate_xdmf-961"><a href="#Mesh.generate_xdmf-961"><span class="linenos">961</span></a><span class="sd">        The filename of the generated file will be the same as the hdf5 file</span>
</span><span id="Mesh.generate_xdmf-962"><a href="#Mesh.generate_xdmf-962"><span class="linenos">962</span></a><span class="sd">        but with the `xmf` extension.</span>
</span><span id="Mesh.generate_xdmf-963"><a href="#Mesh.generate_xdmf-963"><span class="linenos">963</span></a>
</span><span id="Mesh.generate_xdmf-964"><a href="#Mesh.generate_xdmf-964"><span class="linenos">964</span></a><span class="sd">        Parameters</span>
</span><span id="Mesh.generate_xdmf-965"><a href="#Mesh.generate_xdmf-965"><span class="linenos">965</span></a><span class="sd">        ----------</span>
</span><span id="Mesh.generate_xdmf-966"><a href="#Mesh.generate_xdmf-966"><span class="linenos">966</span></a><span class="sd">        filename :</span>
</span><span id="Mesh.generate_xdmf-967"><a href="#Mesh.generate_xdmf-967"><span class="linenos">967</span></a><span class="sd">            File name of the checkpointed hdf5 file for which the</span>
</span><span id="Mesh.generate_xdmf-968"><a href="#Mesh.generate_xdmf-968"><span class="linenos">968</span></a><span class="sd">            xdmf schema will be written.</span>
</span><span id="Mesh.generate_xdmf-969"><a href="#Mesh.generate_xdmf-969"><span class="linenos">969</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.generate_xdmf-970"><a href="#Mesh.generate_xdmf-970"><span class="linenos">970</span></a>        <span class="kn">from</span> <span class="nn">underworld3.utilities</span> <span class="kn">import</span> <span class="n">generateXdmf</span>
</span><span id="Mesh.generate_xdmf-971"><a href="#Mesh.generate_xdmf-971"><span class="linenos">971</span></a>
</span><span id="Mesh.generate_xdmf-972"><a href="#Mesh.generate_xdmf-972"><span class="linenos">972</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.generate_xdmf-973"><a href="#Mesh.generate_xdmf-973"><span class="linenos">973</span></a>            <span class="n">generateXdmf</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="Mesh.generate_xdmf-974"><a href="#Mesh.generate_xdmf-974"><span class="linenos">974</span></a>
</span><span id="Mesh.generate_xdmf-975"><a href="#Mesh.generate_xdmf-975"><span class="linenos">975</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>This method generates an xdmf schema for the specified file.</p>

<p>The filename of the generated file will be the same as the hdf5 file
but with the <code>xmf</code> extension.</p>

<h2 id="parameters">Parameters</h2>

<p>filename :
    File name of the checkpointed hdf5 file for which the
    xdmf schema will be written.</p>
</div>


                            </div>
                            <div id="Mesh.vars" class="classattr">
                                        <input id="Mesh.vars-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">vars</span>

                <label class="view-source-button" for="Mesh.vars-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.vars"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.vars-978"><a href="#Mesh.vars-978"><span class="linenos">978</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.vars-979"><a href="#Mesh.vars-979"><span class="linenos">979</span></a>    <span class="k">def</span> <span class="nf">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh.vars-980"><a href="#Mesh.vars-980"><span class="linenos">980</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.vars-981"><a href="#Mesh.vars-981"><span class="linenos">981</span></a><span class="sd">        A list of variables recorded on the mesh.</span>
</span><span id="Mesh.vars-982"><a href="#Mesh.vars-982"><span class="linenos">982</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.vars-983"><a href="#Mesh.vars-983"><span class="linenos">983</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span>
</span><span id="Mesh.vars-984"><a href="#Mesh.vars-984"><span class="linenos">984</span></a>
</span><span id="Mesh.vars-985"><a href="#Mesh.vars-985"><span class="linenos">985</span></a>        <span class="c1"># ToDo: rename this so it does not clash with the vars built in</span>
</span></pre></div>


            <div class="docstring"><p>A list of variables recorded on the mesh.</p>
</div>


                            </div>
                            <div id="Mesh.block_vars" class="classattr">
                                        <input id="Mesh.block_vars-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">block_vars</span>

                <label class="view-source-button" for="Mesh.block_vars-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.block_vars"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.block_vars-987"><a href="#Mesh.block_vars-987"><span class="linenos">987</span></a>    <span class="nd">@property</span>
</span><span id="Mesh.block_vars-988"><a href="#Mesh.block_vars-988"><span class="linenos">988</span></a>    <span class="k">def</span> <span class="nf">block_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mesh.block_vars-989"><a href="#Mesh.block_vars-989"><span class="linenos">989</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.block_vars-990"><a href="#Mesh.block_vars-990"><span class="linenos">990</span></a><span class="sd">        A list of variables recorded on the mesh.</span>
</span><span id="Mesh.block_vars-991"><a href="#Mesh.block_vars-991"><span class="linenos">991</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.block_vars-992"><a href="#Mesh.block_vars-992"><span class="linenos">992</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_vars</span>
</span></pre></div>


            <div class="docstring"><p>A list of variables recorded on the mesh.</p>
</div>


                            </div>
                            <div id="Mesh.get_closest_cells" class="classattr">
                                        <input id="Mesh.get_closest_cells-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@timing.routine_timer_decorator</div>

        <span class="def">def</span>
        <span class="name">get_closest_cells</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="Mesh.get_closest_cells-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.get_closest_cells"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.get_closest_cells-1131"><a href="#Mesh.get_closest_cells-1131"><span class="linenos">1131</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">routine_timer_decorator</span>
</span><span id="Mesh.get_closest_cells-1132"><a href="#Mesh.get_closest_cells-1132"><span class="linenos">1132</span></a>    <span class="k">def</span> <span class="nf">get_closest_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Mesh.get_closest_cells-1133"><a href="#Mesh.get_closest_cells-1133"><span class="linenos">1133</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.get_closest_cells-1134"><a href="#Mesh.get_closest_cells-1134"><span class="linenos">1134</span></a><span class="sd">        This method uses a kd-tree algorithm to find the closest</span>
</span><span id="Mesh.get_closest_cells-1135"><a href="#Mesh.get_closest_cells-1135"><span class="linenos">1135</span></a><span class="sd">        cells to the provided coords. For a regular mesh, this should</span>
</span><span id="Mesh.get_closest_cells-1136"><a href="#Mesh.get_closest_cells-1136"><span class="linenos">1136</span></a><span class="sd">        be exactly the owning cell, but if the mesh is deformed, this</span>
</span><span id="Mesh.get_closest_cells-1137"><a href="#Mesh.get_closest_cells-1137"><span class="linenos">1137</span></a><span class="sd">        is not guaranteed. Note, the nearest point does may not be all</span>
</span><span id="Mesh.get_closest_cells-1138"><a href="#Mesh.get_closest_cells-1138"><span class="linenos">1138</span></a><span class="sd">        that close by - use get_closest_local_cells to filter out points</span>
</span><span id="Mesh.get_closest_cells-1139"><a href="#Mesh.get_closest_cells-1139"><span class="linenos">1139</span></a><span class="sd">        that are (probably) not within any local cell.</span>
</span><span id="Mesh.get_closest_cells-1140"><a href="#Mesh.get_closest_cells-1140"><span class="linenos">1140</span></a>
</span><span id="Mesh.get_closest_cells-1141"><a href="#Mesh.get_closest_cells-1141"><span class="linenos">1141</span></a><span class="sd">        Parameters:</span>
</span><span id="Mesh.get_closest_cells-1142"><a href="#Mesh.get_closest_cells-1142"><span class="linenos">1142</span></a><span class="sd">        -----------</span>
</span><span id="Mesh.get_closest_cells-1143"><a href="#Mesh.get_closest_cells-1143"><span class="linenos">1143</span></a><span class="sd">        coords:</span>
</span><span id="Mesh.get_closest_cells-1144"><a href="#Mesh.get_closest_cells-1144"><span class="linenos">1144</span></a><span class="sd">            An array of the coordinates for which we wish to determine the</span>
</span><span id="Mesh.get_closest_cells-1145"><a href="#Mesh.get_closest_cells-1145"><span class="linenos">1145</span></a><span class="sd">            closest cells. This should be a 2-dimensional array of</span>
</span><span id="Mesh.get_closest_cells-1146"><a href="#Mesh.get_closest_cells-1146"><span class="linenos">1146</span></a><span class="sd">            shape (n_coords,dim).</span>
</span><span id="Mesh.get_closest_cells-1147"><a href="#Mesh.get_closest_cells-1147"><span class="linenos">1147</span></a>
</span><span id="Mesh.get_closest_cells-1148"><a href="#Mesh.get_closest_cells-1148"><span class="linenos">1148</span></a><span class="sd">        Returns:</span>
</span><span id="Mesh.get_closest_cells-1149"><a href="#Mesh.get_closest_cells-1149"><span class="linenos">1149</span></a><span class="sd">        --------</span>
</span><span id="Mesh.get_closest_cells-1150"><a href="#Mesh.get_closest_cells-1150"><span class="linenos">1150</span></a><span class="sd">        closest_cells:</span>
</span><span id="Mesh.get_closest_cells-1151"><a href="#Mesh.get_closest_cells-1151"><span class="linenos">1151</span></a><span class="sd">            An array of indices representing the cells closest to the provided</span>
</span><span id="Mesh.get_closest_cells-1152"><a href="#Mesh.get_closest_cells-1152"><span class="linenos">1152</span></a><span class="sd">            coordinates. This will be a 1-dimensional array of</span>
</span><span id="Mesh.get_closest_cells-1153"><a href="#Mesh.get_closest_cells-1153"><span class="linenos">1153</span></a><span class="sd">            shape (n_coords).</span>
</span><span id="Mesh.get_closest_cells-1154"><a href="#Mesh.get_closest_cells-1154"><span class="linenos">1154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.get_closest_cells-1155"><a href="#Mesh.get_closest_cells-1155"><span class="linenos">1155</span></a>
</span><span id="Mesh.get_closest_cells-1156"><a href="#Mesh.get_closest_cells-1156"><span class="linenos">1156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_kd_tree_index</span><span class="p">()</span>
</span><span id="Mesh.get_closest_cells-1157"><a href="#Mesh.get_closest_cells-1157"><span class="linenos">1157</span></a>
</span><span id="Mesh.get_closest_cells-1158"><a href="#Mesh.get_closest_cells-1158"><span class="linenos">1158</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.get_closest_cells-1159"><a href="#Mesh.get_closest_cells-1159"><span class="linenos">1159</span></a>            <span class="n">closest_points</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="Mesh.get_closest_cells-1160"><a href="#Mesh.get_closest_cells-1160"><span class="linenos">1160</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.get_closest_cells-1161"><a href="#Mesh.get_closest_cells-1161"><span class="linenos">1161</span></a>            <span class="c1">### returns an empty array if no coords are on a proc</span>
</span><span id="Mesh.get_closest_cells-1162"><a href="#Mesh.get_closest_cells-1162"><span class="linenos">1162</span></a>            <span class="n">closest_points</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>
</span><span id="Mesh.get_closest_cells-1163"><a href="#Mesh.get_closest_cells-1163"><span class="linenos">1163</span></a>
</span><span id="Mesh.get_closest_cells-1164"><a href="#Mesh.get_closest_cells-1164"><span class="linenos">1164</span></a>        <span class="k">if</span> <span class="n">found</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh.get_closest_cells-1165"><a href="#Mesh.get_closest_cells-1165"><span class="linenos">1165</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="Mesh.get_closest_cells-1166"><a href="#Mesh.get_closest_cells-1166"><span class="linenos">1166</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Mesh.get_closest_cells-1167"><a href="#Mesh.get_closest_cells-1167"><span class="linenos">1167</span></a>                    <span class="s2">&quot;An error was encountered attempting to find the closest cells to the provided coordinates.&quot;</span>
</span><span id="Mesh.get_closest_cells-1168"><a href="#Mesh.get_closest_cells-1168"><span class="linenos">1168</span></a>                <span class="p">)</span>
</span><span id="Mesh.get_closest_cells-1169"><a href="#Mesh.get_closest_cells-1169"><span class="linenos">1169</span></a>
</span><span id="Mesh.get_closest_cells-1170"><a href="#Mesh.get_closest_cells-1170"><span class="linenos">1170</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexMap</span><span class="p">[</span><span class="n">closest_points</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>This method uses a kd-tree algorithm to find the closest
cells to the provided coords. For a regular mesh, this should
be exactly the owning cell, but if the mesh is deformed, this
is not guaranteed. Note, the nearest point does may not be all
that close by - use get_closest_local_cells to filter out points
that are (probably) not within any local cell.</p>

<h2 id="parameters">Parameters:</h2>

<p>coords:
    An array of the coordinates for which we wish to determine the
    closest cells. This should be a 2-dimensional array of
    shape (n_coords,dim).</p>

<h2 id="returns">Returns:</h2>

<p>closest_cells:
    An array of indices representing the cells closest to the provided
    coordinates. This will be a 1-dimensional array of
    shape (n_coords).</p>
</div>


                            </div>
                            <div id="Mesh.get_closest_local_cells" class="classattr">
                                        <input id="Mesh.get_closest_local_cells-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_closest_local_cells</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="Mesh.get_closest_local_cells-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.get_closest_local_cells"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.get_closest_local_cells-1172"><a href="#Mesh.get_closest_local_cells-1172"><span class="linenos">1172</span></a>    <span class="k">def</span> <span class="nf">get_closest_local_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Mesh.get_closest_local_cells-1173"><a href="#Mesh.get_closest_local_cells-1173"><span class="linenos">1173</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.get_closest_local_cells-1174"><a href="#Mesh.get_closest_local_cells-1174"><span class="linenos">1174</span></a><span class="sd">        This method uses a kd-tree algorithm to find the closest</span>
</span><span id="Mesh.get_closest_local_cells-1175"><a href="#Mesh.get_closest_local_cells-1175"><span class="linenos">1175</span></a><span class="sd">        cells to the provided coords. For a regular mesh, this should</span>
</span><span id="Mesh.get_closest_local_cells-1176"><a href="#Mesh.get_closest_local_cells-1176"><span class="linenos">1176</span></a><span class="sd">        be exactly the owning cell, but if the mesh is deformed, this</span>
</span><span id="Mesh.get_closest_local_cells-1177"><a href="#Mesh.get_closest_local_cells-1177"><span class="linenos">1177</span></a><span class="sd">        is not guaranteed. Also compares the distance from the cell to the</span>
</span><span id="Mesh.get_closest_local_cells-1178"><a href="#Mesh.get_closest_local_cells-1178"><span class="linenos">1178</span></a><span class="sd">        point - if this is larger than the &quot;cell size&quot; then returns -1</span>
</span><span id="Mesh.get_closest_local_cells-1179"><a href="#Mesh.get_closest_local_cells-1179"><span class="linenos">1179</span></a>
</span><span id="Mesh.get_closest_local_cells-1180"><a href="#Mesh.get_closest_local_cells-1180"><span class="linenos">1180</span></a><span class="sd">        Parameters:</span>
</span><span id="Mesh.get_closest_local_cells-1181"><a href="#Mesh.get_closest_local_cells-1181"><span class="linenos">1181</span></a><span class="sd">        -----------</span>
</span><span id="Mesh.get_closest_local_cells-1182"><a href="#Mesh.get_closest_local_cells-1182"><span class="linenos">1182</span></a><span class="sd">        coords:</span>
</span><span id="Mesh.get_closest_local_cells-1183"><a href="#Mesh.get_closest_local_cells-1183"><span class="linenos">1183</span></a><span class="sd">            An array of the coordinates for which we wish to determine the</span>
</span><span id="Mesh.get_closest_local_cells-1184"><a href="#Mesh.get_closest_local_cells-1184"><span class="linenos">1184</span></a><span class="sd">            closest cells. This should be a 2-dimensional array of</span>
</span><span id="Mesh.get_closest_local_cells-1185"><a href="#Mesh.get_closest_local_cells-1185"><span class="linenos">1185</span></a><span class="sd">            shape (n_coords,dim).</span>
</span><span id="Mesh.get_closest_local_cells-1186"><a href="#Mesh.get_closest_local_cells-1186"><span class="linenos">1186</span></a>
</span><span id="Mesh.get_closest_local_cells-1187"><a href="#Mesh.get_closest_local_cells-1187"><span class="linenos">1187</span></a><span class="sd">        Returns:</span>
</span><span id="Mesh.get_closest_local_cells-1188"><a href="#Mesh.get_closest_local_cells-1188"><span class="linenos">1188</span></a><span class="sd">        --------</span>
</span><span id="Mesh.get_closest_local_cells-1189"><a href="#Mesh.get_closest_local_cells-1189"><span class="linenos">1189</span></a><span class="sd">        closest_cells:</span>
</span><span id="Mesh.get_closest_local_cells-1190"><a href="#Mesh.get_closest_local_cells-1190"><span class="linenos">1190</span></a><span class="sd">            An array of indices representing the cells closest to the provided</span>
</span><span id="Mesh.get_closest_local_cells-1191"><a href="#Mesh.get_closest_local_cells-1191"><span class="linenos">1191</span></a><span class="sd">            coordinates. This will be a 1-dimensional array of</span>
</span><span id="Mesh.get_closest_local_cells-1192"><a href="#Mesh.get_closest_local_cells-1192"><span class="linenos">1192</span></a><span class="sd">            shape (n_coords).</span>
</span><span id="Mesh.get_closest_local_cells-1193"><a href="#Mesh.get_closest_local_cells-1193"><span class="linenos">1193</span></a>
</span><span id="Mesh.get_closest_local_cells-1194"><a href="#Mesh.get_closest_local_cells-1194"><span class="linenos">1194</span></a>
</span><span id="Mesh.get_closest_local_cells-1195"><a href="#Mesh.get_closest_local_cells-1195"><span class="linenos">1195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.get_closest_local_cells-1196"><a href="#Mesh.get_closest_local_cells-1196"><span class="linenos">1196</span></a>
</span><span id="Mesh.get_closest_local_cells-1197"><a href="#Mesh.get_closest_local_cells-1197"><span class="linenos">1197</span></a>        <span class="c1"># Create index if required</span>
</span><span id="Mesh.get_closest_local_cells-1198"><a href="#Mesh.get_closest_local_cells-1198"><span class="linenos">1198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_kd_tree_index</span><span class="p">()</span>
</span><span id="Mesh.get_closest_local_cells-1199"><a href="#Mesh.get_closest_local_cells-1199"><span class="linenos">1199</span></a>
</span><span id="Mesh.get_closest_local_cells-1200"><a href="#Mesh.get_closest_local_cells-1200"><span class="linenos">1200</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Mesh.get_closest_local_cells-1201"><a href="#Mesh.get_closest_local_cells-1201"><span class="linenos">1201</span></a>            <span class="n">closest_points</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span><span id="Mesh.get_closest_local_cells-1202"><a href="#Mesh.get_closest_local_cells-1202"><span class="linenos">1202</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mesh.get_closest_local_cells-1203"><a href="#Mesh.get_closest_local_cells-1203"><span class="linenos">1203</span></a>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Mesh.get_closest_local_cells-1204"><a href="#Mesh.get_closest_local_cells-1204"><span class="linenos">1204</span></a>
</span><span id="Mesh.get_closest_local_cells-1205"><a href="#Mesh.get_closest_local_cells-1205"><span class="linenos">1205</span></a>        <span class="c1"># This is tuned a little bit so that points on a single CPU are never lost</span>
</span><span id="Mesh.get_closest_local_cells-1206"><a href="#Mesh.get_closest_local_cells-1206"><span class="linenos">1206</span></a>
</span><span id="Mesh.get_closest_local_cells-1207"><a href="#Mesh.get_closest_local_cells-1207"><span class="linenos">1207</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexMap</span><span class="p">[</span><span class="n">closest_points</span><span class="p">]</span>
</span><span id="Mesh.get_closest_local_cells-1208"><a href="#Mesh.get_closest_local_cells-1208"><span class="linenos">1208</span></a>        <span class="n">invalid</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mesh.get_closest_local_cells-1209"><a href="#Mesh.get_closest_local_cells-1209"><span class="linenos">1209</span></a>            <span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># 2.5 * self._search_lengths[cells]</span>
</span><span id="Mesh.get_closest_local_cells-1210"><a href="#Mesh.get_closest_local_cells-1210"><span class="linenos">1210</span></a>        <span class="p">)</span>  <span class="c1"># 0.25 * self._radii[cells] ** 2</span>
</span><span id="Mesh.get_closest_local_cells-1211"><a href="#Mesh.get_closest_local_cells-1211"><span class="linenos">1211</span></a>        <span class="n">cells</span><span class="p">[</span><span class="n">invalid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Mesh.get_closest_local_cells-1212"><a href="#Mesh.get_closest_local_cells-1212"><span class="linenos">1212</span></a>
</span><span id="Mesh.get_closest_local_cells-1213"><a href="#Mesh.get_closest_local_cells-1213"><span class="linenos">1213</span></a>        <span class="k">return</span> <span class="n">cells</span>
</span></pre></div>


            <div class="docstring"><p>This method uses a kd-tree algorithm to find the closest
cells to the provided coords. For a regular mesh, this should
be exactly the owning cell, but if the mesh is deformed, this
is not guaranteed. Also compares the distance from the cell to the
point - if this is larger than the "cell size" then returns -1</p>

<h2 id="parameters">Parameters:</h2>

<p>coords:
    An array of the coordinates for which we wish to determine the
    closest cells. This should be a 2-dimensional array of
    shape (n_coords,dim).</p>

<h2 id="returns">Returns:</h2>

<p>closest_cells:
    An array of indices representing the cells closest to the provided
    coordinates. This will be a 1-dimensional array of
    shape (n_coords).</p>
</div>


                            </div>
                            <div id="Mesh.get_min_radius_old" class="classattr">
                                        <input id="Mesh.get_min_radius_old-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_min_radius_old</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Mesh.get_min_radius_old-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.get_min_radius_old"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.get_min_radius_old-1268"><a href="#Mesh.get_min_radius_old-1268"><span class="linenos">1268</span></a>    <span class="k">def</span> <span class="nf">get_min_radius_old</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Mesh.get_min_radius_old-1269"><a href="#Mesh.get_min_radius_old-1269"><span class="linenos">1269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.get_min_radius_old-1270"><a href="#Mesh.get_min_radius_old-1270"><span class="linenos">1270</span></a><span class="sd">        This method returns the global minimum distance from any cell centroid to a face.</span>
</span><span id="Mesh.get_min_radius_old-1271"><a href="#Mesh.get_min_radius_old-1271"><span class="linenos">1271</span></a><span class="sd">        It wraps to the PETSc `DMPlexGetMinRadius` routine. The petsc4py equivalent always</span>
</span><span id="Mesh.get_min_radius_old-1272"><a href="#Mesh.get_min_radius_old-1272"><span class="linenos">1272</span></a><span class="sd">        returns zero.</span>
</span><span id="Mesh.get_min_radius_old-1273"><a href="#Mesh.get_min_radius_old-1273"><span class="linenos">1273</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.get_min_radius_old-1274"><a href="#Mesh.get_min_radius_old-1274"><span class="linenos">1274</span></a>
</span><span id="Mesh.get_min_radius_old-1275"><a href="#Mesh.get_min_radius_old-1275"><span class="linenos">1275</span></a>        <span class="c1">## Note: The petsc4py version of DMPlexComputeGeometryFVM does not compute all cells and</span>
</span><span id="Mesh.get_min_radius_old-1276"><a href="#Mesh.get_min_radius_old-1276"><span class="linenos">1276</span></a>        <span class="c1">## does not obtain the minimum radius for the mesh.</span>
</span><span id="Mesh.get_min_radius_old-1277"><a href="#Mesh.get_min_radius_old-1277"><span class="linenos">1277</span></a>
</span><span id="Mesh.get_min_radius_old-1278"><a href="#Mesh.get_min_radius_old-1278"><span class="linenos">1278</span></a>        <span class="kn">from</span> <span class="nn">underworld3.cython.petsc_discretisation</span> <span class="kn">import</span> <span class="n">petsc_fvm_get_min_radius</span>
</span><span id="Mesh.get_min_radius_old-1279"><a href="#Mesh.get_min_radius_old-1279"><span class="linenos">1279</span></a>
</span><span id="Mesh.get_min_radius_old-1280"><a href="#Mesh.get_min_radius_old-1280"><span class="linenos">1280</span></a>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_min_radius&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_radius</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Mesh.get_min_radius_old-1281"><a href="#Mesh.get_min_radius_old-1281"><span class="linenos">1281</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_min_radius</span> <span class="o">=</span> <span class="n">petsc_fvm_get_min_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Mesh.get_min_radius_old-1282"><a href="#Mesh.get_min_radius_old-1282"><span class="linenos">1282</span></a>
</span><span id="Mesh.get_min_radius_old-1283"><a href="#Mesh.get_min_radius_old-1283"><span class="linenos">1283</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_radius</span>
</span></pre></div>


            <div class="docstring"><p>This method returns the global minimum distance from any cell centroid to a face.
It wraps to the PETSc <code>DMPlexGetMinRadius</code> routine. The petsc4py equivalent always
returns zero.</p>
</div>


                            </div>
                            <div id="Mesh.get_min_radius" class="classattr">
                                        <input id="Mesh.get_min_radius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_min_radius</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Mesh.get_min_radius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.get_min_radius"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.get_min_radius-1285"><a href="#Mesh.get_min_radius-1285"><span class="linenos">1285</span></a>    <span class="k">def</span> <span class="nf">get_min_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Mesh.get_min_radius-1286"><a href="#Mesh.get_min_radius-1286"><span class="linenos">1286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.get_min_radius-1287"><a href="#Mesh.get_min_radius-1287"><span class="linenos">1287</span></a><span class="sd">        This method returns the global minimum distance from any cell centroid to a face.</span>
</span><span id="Mesh.get_min_radius-1288"><a href="#Mesh.get_min_radius-1288"><span class="linenos">1288</span></a><span class="sd">        It wraps to the PETSc `DMPlexGetMinRadius` routine. The petsc4py equivalent always</span>
</span><span id="Mesh.get_min_radius-1289"><a href="#Mesh.get_min_radius-1289"><span class="linenos">1289</span></a><span class="sd">        returns zero.</span>
</span><span id="Mesh.get_min_radius-1290"><a href="#Mesh.get_min_radius-1290"><span class="linenos">1290</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.get_min_radius-1291"><a href="#Mesh.get_min_radius-1291"><span class="linenos">1291</span></a>
</span><span id="Mesh.get_min_radius-1292"><a href="#Mesh.get_min_radius-1292"><span class="linenos">1292</span></a>        <span class="c1">## Note: The petsc4py version of DMPlexComputeGeometryFVM does not compute all cells and</span>
</span><span id="Mesh.get_min_radius-1293"><a href="#Mesh.get_min_radius-1293"><span class="linenos">1293</span></a>        <span class="c1">## does not obtain the minimum radius for the mesh.</span>
</span><span id="Mesh.get_min_radius-1294"><a href="#Mesh.get_min_radius-1294"><span class="linenos">1294</span></a>
</span><span id="Mesh.get_min_radius-1295"><a href="#Mesh.get_min_radius-1295"><span class="linenos">1295</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="Mesh.get_min_radius-1296"><a href="#Mesh.get_min_radius-1296"><span class="linenos">1296</span></a>
</span><span id="Mesh.get_min_radius-1297"><a href="#Mesh.get_min_radius-1297"><span class="linenos">1297</span></a>        <span class="n">all_min_radii</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">gather_data</span><span class="p">(</span>
</span><span id="Mesh.get_min_radius-1298"><a href="#Mesh.get_min_radius-1298"><span class="linenos">1298</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_radii</span><span class="o">.</span><span class="n">min</span><span class="p">(),)),</span> <span class="n">bcast</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Mesh.get_min_radius-1299"><a href="#Mesh.get_min_radius-1299"><span class="linenos">1299</span></a>        <span class="p">)</span>
</span><span id="Mesh.get_min_radius-1300"><a href="#Mesh.get_min_radius-1300"><span class="linenos">1300</span></a>
</span><span id="Mesh.get_min_radius-1301"><a href="#Mesh.get_min_radius-1301"><span class="linenos">1301</span></a>        <span class="k">return</span> <span class="n">all_min_radii</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>This method returns the global minimum distance from any cell centroid to a face.
It wraps to the PETSc <code>DMPlexGetMinRadius</code> routine. The petsc4py equivalent always
returns zero.</p>
</div>


                            </div>
                            <div id="Mesh.stats" class="classattr">
                                        <input id="Mesh.stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">uw_function</span>, </span><span class="param"><span class="n">uw_meshVariable</span>, </span><span class="param"><span class="n">basis</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.stats-1311"><a href="#Mesh.stats-1311"><span class="linenos">1311</span></a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uw_function</span><span class="p">,</span> <span class="n">uw_meshVariable</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Mesh.stats-1312"><a href="#Mesh.stats-1312"><span class="linenos">1312</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Mesh.stats-1313"><a href="#Mesh.stats-1313"><span class="linenos">1313</span></a><span class="sd">        Returns various norms on the mesh for the provided function.</span>
</span><span id="Mesh.stats-1314"><a href="#Mesh.stats-1314"><span class="linenos">1314</span></a><span class="sd">          - size</span>
</span><span id="Mesh.stats-1315"><a href="#Mesh.stats-1315"><span class="linenos">1315</span></a><span class="sd">          - mean</span>
</span><span id="Mesh.stats-1316"><a href="#Mesh.stats-1316"><span class="linenos">1316</span></a><span class="sd">          - min</span>
</span><span id="Mesh.stats-1317"><a href="#Mesh.stats-1317"><span class="linenos">1317</span></a><span class="sd">          - max</span>
</span><span id="Mesh.stats-1318"><a href="#Mesh.stats-1318"><span class="linenos">1318</span></a><span class="sd">          - sum</span>
</span><span id="Mesh.stats-1319"><a href="#Mesh.stats-1319"><span class="linenos">1319</span></a><span class="sd">          - L2 norm</span>
</span><span id="Mesh.stats-1320"><a href="#Mesh.stats-1320"><span class="linenos">1320</span></a><span class="sd">          - rms</span>
</span><span id="Mesh.stats-1321"><a href="#Mesh.stats-1321"><span class="linenos">1321</span></a>
</span><span id="Mesh.stats-1322"><a href="#Mesh.stats-1322"><span class="linenos">1322</span></a><span class="sd">          NOTE: this currently assumes scalar variables !</span>
</span><span id="Mesh.stats-1323"><a href="#Mesh.stats-1323"><span class="linenos">1323</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mesh.stats-1324"><a href="#Mesh.stats-1324"><span class="linenos">1324</span></a>
</span><span id="Mesh.stats-1325"><a href="#Mesh.stats-1325"><span class="linenos">1325</span></a>        <span class="c1">#       This uses a private work MeshVariable and the various norms defined there but</span>
</span><span id="Mesh.stats-1326"><a href="#Mesh.stats-1326"><span class="linenos">1326</span></a>        <span class="c1">#       could either be simplified to just use petsc vectors, or extended to</span>
</span><span id="Mesh.stats-1327"><a href="#Mesh.stats-1327"><span class="linenos">1327</span></a>        <span class="c1">#       compute integrals over the elements which is in line with uw1 and uw2</span>
</span><span id="Mesh.stats-1328"><a href="#Mesh.stats-1328"><span class="linenos">1328</span></a>
</span><span id="Mesh.stats-1329"><a href="#Mesh.stats-1329"><span class="linenos">1329</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh.stats-1330"><a href="#Mesh.stats-1330"><span class="linenos">1330</span></a>            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
</span><span id="Mesh.stats-1331"><a href="#Mesh.stats-1331"><span class="linenos">1331</span></a>
</span><span id="Mesh.stats-1332"><a href="#Mesh.stats-1332"><span class="linenos">1332</span></a>        <span class="kn">from</span> <span class="nn">petsc4py.PETSc</span> <span class="kn">import</span> <span class="n">NormType</span>
</span><span id="Mesh.stats-1333"><a href="#Mesh.stats-1333"><span class="linenos">1333</span></a>
</span><span id="Mesh.stats-1334"><a href="#Mesh.stats-1334"><span class="linenos">1334</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">uw_meshVariable</span>
</span><span id="Mesh.stats-1335"><a href="#Mesh.stats-1335"><span class="linenos">1335</span></a>
</span><span id="Mesh.stats-1336"><a href="#Mesh.stats-1336"><span class="linenos">1336</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
</span><span id="Mesh.stats-1337"><a href="#Mesh.stats-1337"><span class="linenos">1337</span></a>            <span class="n">tmp</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
</span><span id="Mesh.stats-1338"><a href="#Mesh.stats-1338"><span class="linenos">1338</span></a>                <span class="n">uw_function</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">basis</span>
</span><span id="Mesh.stats-1339"><a href="#Mesh.stats-1339"><span class="linenos">1339</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Mesh.stats-1340"><a href="#Mesh.stats-1340"><span class="linenos">1340</span></a>
</span><span id="Mesh.stats-1341"><a href="#Mesh.stats-1341"><span class="linenos">1341</span></a>        <span class="n">vsize</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">_gvec</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
</span><span id="Mesh.stats-1342"><a href="#Mesh.stats-1342"><span class="linenos">1342</span></a>        <span class="n">vmean</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="Mesh.stats-1343"><a href="#Mesh.stats-1343"><span class="linenos">1343</span></a>        <span class="n">vmax</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Mesh.stats-1344"><a href="#Mesh.stats-1344"><span class="linenos">1344</span></a>        <span class="n">vmin</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Mesh.stats-1345"><a href="#Mesh.stats-1345"><span class="linenos">1345</span></a>        <span class="n">vsum</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Mesh.stats-1346"><a href="#Mesh.stats-1346"><span class="linenos">1346</span></a>        <span class="n">vnorm2</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">NormType</span><span class="o">.</span><span class="n">NORM_2</span><span class="p">)</span>
</span><span id="Mesh.stats-1347"><a href="#Mesh.stats-1347"><span class="linenos">1347</span></a>        <span class="n">vrms</span> <span class="o">=</span> <span class="n">vnorm2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vsize</span><span class="p">)</span>
</span><span id="Mesh.stats-1348"><a href="#Mesh.stats-1348"><span class="linenos">1348</span></a>
</span><span id="Mesh.stats-1349"><a href="#Mesh.stats-1349"><span class="linenos">1349</span></a>        <span class="k">return</span> <span class="n">vsize</span><span class="p">,</span> <span class="n">vmean</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">vsum</span><span class="p">,</span> <span class="n">vnorm2</span><span class="p">,</span> <span class="n">vrms</span>
</span></pre></div>


            <div class="docstring"><p>Returns various norms on the mesh for the provided function.</p>

<ul>
<li>size</li>
<li>mean</li>
<li>min</li>
<li>max</li>
<li>sum</li>
<li>L2 norm</li>
<li>rms</li>
</ul>

<p>NOTE: this currently assumes scalar variables !</p>
</div>


                            </div>
                            <div id="Mesh.meshVariable_mask_from_label" class="classattr">
                                        <input id="Mesh.meshVariable_mask_from_label-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">meshVariable_mask_from_label</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">label_name</span>, </span><span class="param"><span class="n">label_value</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mesh.meshVariable_mask_from_label-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mesh.meshVariable_mask_from_label"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mesh.meshVariable_mask_from_label-1351"><a href="#Mesh.meshVariable_mask_from_label-1351"><span class="linenos">1351</span></a>    <span class="k">def</span> <span class="nf">meshVariable_mask_from_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_name</span><span class="p">,</span> <span class="n">label_value</span><span class="p">):</span>
</span><span id="Mesh.meshVariable_mask_from_label-1352"><a href="#Mesh.meshVariable_mask_from_label-1352"><span class="linenos">1352</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract single label value and make a point mask&quot;&quot;&quot;</span>
</span><span id="Mesh.meshVariable_mask_from_label-1353"><a href="#Mesh.meshVariable_mask_from_label-1353"><span class="linenos">1353</span></a>
</span><span id="Mesh.meshVariable_mask_from_label-1354"><a href="#Mesh.meshVariable_mask_from_label-1354"><span class="linenos">1354</span></a>        <span class="n">meshVar</span> <span class="o">=</span> <span class="n">MeshVariable</span><span class="p">(</span>
</span><span id="Mesh.meshVariable_mask_from_label-1355"><a href="#Mesh.meshVariable_mask_from_label-1355"><span class="linenos">1355</span></a>            <span class="sa">f</span><span class="s2">&quot;Mask_</span><span class="si">{</span><span class="n">label_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">label_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1356"><a href="#Mesh.meshVariable_mask_from_label-1356"><span class="linenos">1356</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1357"><a href="#Mesh.meshVariable_mask_from_label-1357"><span class="linenos">1357</span></a>            <span class="n">vtype</span><span class="o">=</span><span class="n">uw</span><span class="o">.</span><span class="n">VarType</span><span class="o">.</span><span class="n">SCALAR</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1358"><a href="#Mesh.meshVariable_mask_from_label-1358"><span class="linenos">1358</span></a>            <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1359"><a href="#Mesh.meshVariable_mask_from_label-1359"><span class="linenos">1359</span></a>            <span class="n">continuous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1360"><a href="#Mesh.meshVariable_mask_from_label-1360"><span class="linenos">1360</span></a>            <span class="n">varsymbol</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;\cal</span><span class="se">{{</span><span class="s2">M</span><span class="se">}}</span><span class="s2">^</span><span class="se">{{</span><span class="s2">[</span><span class="si">{</span><span class="n">label_name</span><span class="si">:</span><span class="s2">.4</span><span class="si">}</span><span class="s2">]</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1361"><a href="#Mesh.meshVariable_mask_from_label-1361"><span class="linenos">1361</span></a>        <span class="p">)</span>
</span><span id="Mesh.meshVariable_mask_from_label-1362"><a href="#Mesh.meshVariable_mask_from_label-1362"><span class="linenos">1362</span></a>
</span><span id="Mesh.meshVariable_mask_from_label-1363"><a href="#Mesh.meshVariable_mask_from_label-1363"><span class="linenos">1363</span></a>        <span class="n">point_indices</span> <span class="o">=</span> <span class="n">petsc_dm_find_labeled_points_local</span><span class="p">(</span>
</span><span id="Mesh.meshVariable_mask_from_label-1364"><a href="#Mesh.meshVariable_mask_from_label-1364"><span class="linenos">1364</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1365"><a href="#Mesh.meshVariable_mask_from_label-1365"><span class="linenos">1365</span></a>            <span class="n">label_name</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1366"><a href="#Mesh.meshVariable_mask_from_label-1366"><span class="linenos">1366</span></a>            <span class="n">label_value</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1367"><a href="#Mesh.meshVariable_mask_from_label-1367"><span class="linenos">1367</span></a>            <span class="n">sectionIndex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Mesh.meshVariable_mask_from_label-1368"><a href="#Mesh.meshVariable_mask_from_label-1368"><span class="linenos">1368</span></a>        <span class="p">)</span>
</span><span id="Mesh.meshVariable_mask_from_label-1369"><a href="#Mesh.meshVariable_mask_from_label-1369"><span class="linenos">1369</span></a>
</span><span id="Mesh.meshVariable_mask_from_label-1370"><a href="#Mesh.meshVariable_mask_from_label-1370"><span class="linenos">1370</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">meshVar</span><span class="p">):</span>
</span><span id="Mesh.meshVariable_mask_from_label-1371"><a href="#Mesh.meshVariable_mask_from_label-1371"><span class="linenos">1371</span></a>            <span class="n">meshVar</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Mesh.meshVariable_mask_from_label-1372"><a href="#Mesh.meshVariable_mask_from_label-1372"><span class="linenos">1372</span></a>            <span class="k">if</span> <span class="n">point_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mesh.meshVariable_mask_from_label-1373"><a href="#Mesh.meshVariable_mask_from_label-1373"><span class="linenos">1373</span></a>                <span class="n">meshVar</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">point_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Mesh.meshVariable_mask_from_label-1374"><a href="#Mesh.meshVariable_mask_from_label-1374"><span class="linenos">1374</span></a>
</span><span id="Mesh.meshVariable_mask_from_label-1375"><a href="#Mesh.meshVariable_mask_from_label-1375"><span class="linenos">1375</span></a>        <span class="k">return</span> <span class="n">meshVar</span>
</span></pre></div>


            <div class="docstring"><p>Extract single label value and make a point mask</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="utilities/_api_tools.html#uw_object">underworld3.utilities._api_tools.uw_object</a></dt>
                                <dd id="Mesh.total_instances" class="function"><a href="utilities/_api_tools.html#uw_object.total_instances">total_instances</a></dd>

            </div>
            <div><dt><a href="utilities/_api_tools.html#uw_object_counter">underworld3.utilities._api_tools.uw_object_counter</a></dt>
                                <dd id="Mesh.instance_number" class="variable"><a href="utilities/_api_tools.html#uw_object_counter.instance_number">instance_number</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="MeshVariable">
                            <input id="MeshVariable-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">MeshVariable</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">varname</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span>,</span><span class="param">	<span class="n">mesh</span><span class="p">:</span> <span class="n"><a href="#Mesh">Mesh</a></span>,</span><span class="param">	<span class="n">num_components</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">vtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="_var_types.html#VarType">underworld3._var_types.VarType</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">varsymbol</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MeshVariable-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MeshVariable"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MeshVariable-1382"><a href="#MeshVariable-1382"><span class="linenos">1382</span></a><span class="k">def</span> <span class="nf">MeshVariable</span><span class="p">(</span>
</span><span id="MeshVariable-1383"><a href="#MeshVariable-1383"><span class="linenos">1383</span></a>    <span class="n">varname</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
</span><span id="MeshVariable-1384"><a href="#MeshVariable-1384"><span class="linenos">1384</span></a>    <span class="n">mesh</span><span class="p">:</span> <span class="s2">&quot;Mesh&quot;</span><span class="p">,</span>
</span><span id="MeshVariable-1385"><a href="#MeshVariable-1385"><span class="linenos">1385</span></a>    <span class="n">num_components</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MeshVariable-1386"><a href="#MeshVariable-1386"><span class="linenos">1386</span></a>    <span class="n">vtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;uw.VarType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MeshVariable-1387"><a href="#MeshVariable-1387"><span class="linenos">1387</span></a>    <span class="n">degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="MeshVariable-1388"><a href="#MeshVariable-1388"><span class="linenos">1388</span></a>    <span class="n">continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MeshVariable-1389"><a href="#MeshVariable-1389"><span class="linenos">1389</span></a>    <span class="n">varsymbol</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MeshVariable-1390"><a href="#MeshVariable-1390"><span class="linenos">1390</span></a><span class="p">):</span>
</span><span id="MeshVariable-1391"><a href="#MeshVariable-1391"><span class="linenos">1391</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MeshVariable-1392"><a href="#MeshVariable-1392"><span class="linenos">1392</span></a><span class="sd">    The MeshVariable class generates a variable supported by a finite element mesh and the</span>
</span><span id="MeshVariable-1393"><a href="#MeshVariable-1393"><span class="linenos">1393</span></a><span class="sd">    underlying sympy representation that makes it possible to construct expressions that</span>
</span><span id="MeshVariable-1394"><a href="#MeshVariable-1394"><span class="linenos">1394</span></a><span class="sd">    depend on the values of the MeshVariable.</span>
</span><span id="MeshVariable-1395"><a href="#MeshVariable-1395"><span class="linenos">1395</span></a>
</span><span id="MeshVariable-1396"><a href="#MeshVariable-1396"><span class="linenos">1396</span></a><span class="sd">    To set / read nodal values, use the numpy interface via the &#39;data&#39; property.</span>
</span><span id="MeshVariable-1397"><a href="#MeshVariable-1397"><span class="linenos">1397</span></a>
</span><span id="MeshVariable-1398"><a href="#MeshVariable-1398"><span class="linenos">1398</span></a><span class="sd">    Parameters</span>
</span><span id="MeshVariable-1399"><a href="#MeshVariable-1399"><span class="linenos">1399</span></a><span class="sd">    ----------</span>
</span><span id="MeshVariable-1400"><a href="#MeshVariable-1400"><span class="linenos">1400</span></a><span class="sd">    varname :</span>
</span><span id="MeshVariable-1401"><a href="#MeshVariable-1401"><span class="linenos">1401</span></a><span class="sd">        A textual name for this variable.</span>
</span><span id="MeshVariable-1402"><a href="#MeshVariable-1402"><span class="linenos">1402</span></a><span class="sd">    mesh :</span>
</span><span id="MeshVariable-1403"><a href="#MeshVariable-1403"><span class="linenos">1403</span></a><span class="sd">        The supporting underworld mesh.</span>
</span><span id="MeshVariable-1404"><a href="#MeshVariable-1404"><span class="linenos">1404</span></a><span class="sd">    num_components :</span>
</span><span id="MeshVariable-1405"><a href="#MeshVariable-1405"><span class="linenos">1405</span></a><span class="sd">        The number of components this variable has.</span>
</span><span id="MeshVariable-1406"><a href="#MeshVariable-1406"><span class="linenos">1406</span></a><span class="sd">        For example, scalars will have `num_components=1`,</span>
</span><span id="MeshVariable-1407"><a href="#MeshVariable-1407"><span class="linenos">1407</span></a><span class="sd">        while a 2d vector would have `num_components=2`.</span>
</span><span id="MeshVariable-1408"><a href="#MeshVariable-1408"><span class="linenos">1408</span></a><span class="sd">    vtype :</span>
</span><span id="MeshVariable-1409"><a href="#MeshVariable-1409"><span class="linenos">1409</span></a><span class="sd">        Optional. The underworld variable type for this variable.</span>
</span><span id="MeshVariable-1410"><a href="#MeshVariable-1410"><span class="linenos">1410</span></a><span class="sd">        If not defined it will be inferred from `num_components`</span>
</span><span id="MeshVariable-1411"><a href="#MeshVariable-1411"><span class="linenos">1411</span></a><span class="sd">        if possible.</span>
</span><span id="MeshVariable-1412"><a href="#MeshVariable-1412"><span class="linenos">1412</span></a><span class="sd">    degree :</span>
</span><span id="MeshVariable-1413"><a href="#MeshVariable-1413"><span class="linenos">1413</span></a><span class="sd">        The polynomial degree for this variable.</span>
</span><span id="MeshVariable-1414"><a href="#MeshVariable-1414"><span class="linenos">1414</span></a><span class="sd">    varsymbol:</span>
</span><span id="MeshVariable-1415"><a href="#MeshVariable-1415"><span class="linenos">1415</span></a><span class="sd">        A symbolic form for printing etc (sympy / latex)</span>
</span><span id="MeshVariable-1416"><a href="#MeshVariable-1416"><span class="linenos">1416</span></a>
</span><span id="MeshVariable-1417"><a href="#MeshVariable-1417"><span class="linenos">1417</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MeshVariable-1418"><a href="#MeshVariable-1418"><span class="linenos">1418</span></a>
</span><span id="MeshVariable-1419"><a href="#MeshVariable-1419"><span class="linenos">1419</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="MeshVariable-1420"><a href="#MeshVariable-1420"><span class="linenos">1420</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">varname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="sa">R</span><span class="s2">&quot;+ \dots&quot;</span>
</span><span id="MeshVariable-1421"><a href="#MeshVariable-1421"><span class="linenos">1421</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="MeshVariable-1422"><a href="#MeshVariable-1422"><span class="linenos">1422</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">varname</span>
</span><span id="MeshVariable-1423"><a href="#MeshVariable-1423"><span class="linenos">1423</span></a>
</span><span id="MeshVariable-1424"><a href="#MeshVariable-1424"><span class="linenos">1424</span></a>    <span class="c1">## Smash if already defined (we should check this BEFORE the old meshVariable object is destroyed)</span>
</span><span id="MeshVariable-1425"><a href="#MeshVariable-1425"><span class="linenos">1425</span></a>
</span><span id="MeshVariable-1426"><a href="#MeshVariable-1426"><span class="linenos">1426</span></a>    <span class="kn">import</span> <span class="nn">re</span>
</span><span id="MeshVariable-1427"><a href="#MeshVariable-1427"><span class="linenos">1427</span></a>
</span><span id="MeshVariable-1428"><a href="#MeshVariable-1428"><span class="linenos">1428</span></a>    <span class="n">clean_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9_]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="MeshVariable-1429"><a href="#MeshVariable-1429"><span class="linenos">1429</span></a>
</span><span id="MeshVariable-1430"><a href="#MeshVariable-1430"><span class="linenos">1430</span></a>    <span class="k">if</span> <span class="n">clean_name</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="MeshVariable-1431"><a href="#MeshVariable-1431"><span class="linenos">1431</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable with name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> already exists on the mesh - Skipping.&quot;</span><span class="p">)</span>
</span><span id="MeshVariable-1432"><a href="#MeshVariable-1432"><span class="linenos">1432</span></a>        <span class="k">return</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">clean_name</span><span class="p">]</span>
</span><span id="MeshVariable-1433"><a href="#MeshVariable-1433"><span class="linenos">1433</span></a>
</span><span id="MeshVariable-1434"><a href="#MeshVariable-1434"><span class="linenos">1434</span></a>    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">_accessed</span><span class="p">:</span>
</span><span id="MeshVariable-1435"><a href="#MeshVariable-1435"><span class="linenos">1435</span></a>        <span class="c1">## Before adding a new variable, we first snapshot the data from the mesh.dm</span>
</span><span id="MeshVariable-1436"><a href="#MeshVariable-1436"><span class="linenos">1436</span></a>        <span class="c1">## (if not accessed, then this will not be necessary and may break)</span>
</span><span id="MeshVariable-1437"><a href="#MeshVariable-1437"><span class="linenos">1437</span></a>
</span><span id="MeshVariable-1438"><a href="#MeshVariable-1438"><span class="linenos">1438</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">update_lvec</span><span class="p">()</span>
</span><span id="MeshVariable-1439"><a href="#MeshVariable-1439"><span class="linenos">1439</span></a>
</span><span id="MeshVariable-1440"><a href="#MeshVariable-1440"><span class="linenos">1440</span></a>        <span class="n">old_gvec</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="MeshVariable-1441"><a href="#MeshVariable-1441"><span class="linenos">1441</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">localToGlobal</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">_lvec</span><span class="p">,</span> <span class="n">old_gvec</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MeshVariable-1442"><a href="#MeshVariable-1442"><span class="linenos">1442</span></a>
</span><span id="MeshVariable-1443"><a href="#MeshVariable-1443"><span class="linenos">1443</span></a>    <span class="n">new_meshVariable</span> <span class="o">=</span> <span class="n">_MeshVariable</span><span class="p">(</span>
</span><span id="MeshVariable-1444"><a href="#MeshVariable-1444"><span class="linenos">1444</span></a>        <span class="n">varname</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">num_components</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">varsymbol</span>
</span><span id="MeshVariable-1445"><a href="#MeshVariable-1445"><span class="linenos">1445</span></a>    <span class="p">)</span>
</span><span id="MeshVariable-1446"><a href="#MeshVariable-1446"><span class="linenos">1446</span></a>
</span><span id="MeshVariable-1447"><a href="#MeshVariable-1447"><span class="linenos">1447</span></a>    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">_accessed</span><span class="p">:</span>
</span><span id="MeshVariable-1448"><a href="#MeshVariable-1448"><span class="linenos">1448</span></a>        <span class="c1">## Recreate the mesh variable dm and restore the data</span>
</span><span id="MeshVariable-1449"><a href="#MeshVariable-1449"><span class="linenos">1449</span></a>
</span><span id="MeshVariable-1450"><a href="#MeshVariable-1450"><span class="linenos">1450</span></a>        <span class="n">dm0</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span>
</span><span id="MeshVariable-1451"><a href="#MeshVariable-1451"><span class="linenos">1451</span></a>        <span class="n">dm1</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MeshVariable-1452"><a href="#MeshVariable-1452"><span class="linenos">1452</span></a>        <span class="n">dm0</span><span class="o">.</span><span class="n">copyFields</span><span class="p">(</span><span class="n">dm1</span><span class="p">)</span>
</span><span id="MeshVariable-1453"><a href="#MeshVariable-1453"><span class="linenos">1453</span></a>        <span class="n">dm1</span><span class="o">.</span><span class="n">createDS</span><span class="p">()</span>
</span><span id="MeshVariable-1454"><a href="#MeshVariable-1454"><span class="linenos">1454</span></a>
</span><span id="MeshVariable-1455"><a href="#MeshVariable-1455"><span class="linenos">1455</span></a>        <span class="c1"># print(f&quot;{uw.mpi.rank}: Here 1&quot;, flush=True)</span>
</span><span id="MeshVariable-1456"><a href="#MeshVariable-1456"><span class="linenos">1456</span></a>
</span><span id="MeshVariable-1457"><a href="#MeshVariable-1457"><span class="linenos">1457</span></a>        <span class="n">mdm_is</span><span class="p">,</span> <span class="n">subdm</span> <span class="o">=</span> <span class="n">dm1</span><span class="o">.</span><span class="n">createSubDM</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dm1</span><span class="o">.</span><span class="n">getNumFields</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="MeshVariable-1458"><a href="#MeshVariable-1458"><span class="linenos">1458</span></a>
</span><span id="MeshVariable-1459"><a href="#MeshVariable-1459"><span class="linenos">1459</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">_lvec</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="MeshVariable-1460"><a href="#MeshVariable-1460"><span class="linenos">1460</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">_lvec</span> <span class="o">=</span> <span class="n">dm1</span><span class="o">.</span><span class="n">createLocalVec</span><span class="p">()</span>
</span><span id="MeshVariable-1461"><a href="#MeshVariable-1461"><span class="linenos">1461</span></a>        <span class="n">new_gvec</span> <span class="o">=</span> <span class="n">dm1</span><span class="o">.</span><span class="n">getGlobalVec</span><span class="p">()</span>
</span><span id="MeshVariable-1462"><a href="#MeshVariable-1462"><span class="linenos">1462</span></a>        <span class="n">new_gvec_sub</span> <span class="o">=</span> <span class="n">new_gvec</span><span class="o">.</span><span class="n">getSubVector</span><span class="p">(</span><span class="n">mdm_is</span><span class="p">)</span>
</span><span id="MeshVariable-1463"><a href="#MeshVariable-1463"><span class="linenos">1463</span></a>
</span><span id="MeshVariable-1464"><a href="#MeshVariable-1464"><span class="linenos">1464</span></a>        <span class="c1"># Copy the array data and push to gvec</span>
</span><span id="MeshVariable-1465"><a href="#MeshVariable-1465"><span class="linenos">1465</span></a>        <span class="n">new_gvec_sub</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_gvec</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
</span><span id="MeshVariable-1466"><a href="#MeshVariable-1466"><span class="linenos">1466</span></a>        <span class="n">new_gvec</span><span class="o">.</span><span class="n">restoreSubVector</span><span class="p">(</span><span class="n">mdm_is</span><span class="p">,</span> <span class="n">new_gvec_sub</span><span class="p">)</span>
</span><span id="MeshVariable-1467"><a href="#MeshVariable-1467"><span class="linenos">1467</span></a>
</span><span id="MeshVariable-1468"><a href="#MeshVariable-1468"><span class="linenos">1468</span></a>        <span class="c1"># print(f&quot;{uw.mpi.rank}: Here 2&quot;, flush=True)</span>
</span><span id="MeshVariable-1469"><a href="#MeshVariable-1469"><span class="linenos">1469</span></a>
</span><span id="MeshVariable-1470"><a href="#MeshVariable-1470"><span class="linenos">1470</span></a>        <span class="c1"># Copy the data to mesh._lvec and delete gvec</span>
</span><span id="MeshVariable-1471"><a href="#MeshVariable-1471"><span class="linenos">1471</span></a>        <span class="n">dm1</span><span class="o">.</span><span class="n">globalToLocal</span><span class="p">(</span><span class="n">new_gvec</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">_lvec</span><span class="p">)</span>
</span><span id="MeshVariable-1472"><a href="#MeshVariable-1472"><span class="linenos">1472</span></a>
</span><span id="MeshVariable-1473"><a href="#MeshVariable-1473"><span class="linenos">1473</span></a>        <span class="n">dm1</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">new_gvec</span><span class="p">)</span>
</span><span id="MeshVariable-1474"><a href="#MeshVariable-1474"><span class="linenos">1474</span></a>        <span class="n">dm0</span><span class="o">.</span><span class="n">restoreGlobalVec</span><span class="p">(</span><span class="n">old_gvec</span><span class="p">)</span>
</span><span id="MeshVariable-1475"><a href="#MeshVariable-1475"><span class="linenos">1475</span></a>
</span><span id="MeshVariable-1476"><a href="#MeshVariable-1476"><span class="linenos">1476</span></a>        <span class="c1"># destroy old dm</span>
</span><span id="MeshVariable-1477"><a href="#MeshVariable-1477"><span class="linenos">1477</span></a>        <span class="n">dm0</span><span class="o">.</span><span class="n">destroy</span>
</span><span id="MeshVariable-1478"><a href="#MeshVariable-1478"><span class="linenos">1478</span></a>
</span><span id="MeshVariable-1479"><a href="#MeshVariable-1479"><span class="linenos">1479</span></a>        <span class="c1"># Set new dm on mesh</span>
</span><span id="MeshVariable-1480"><a href="#MeshVariable-1480"><span class="linenos">1480</span></a>        <span class="n">mesh</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">dm1</span>
</span><span id="MeshVariable-1481"><a href="#MeshVariable-1481"><span class="linenos">1481</span></a>
</span><span id="MeshVariable-1482"><a href="#MeshVariable-1482"><span class="linenos">1482</span></a>    <span class="k">return</span> <span class="n">new_meshVariable</span>
</span></pre></div>


            <div class="docstring"><p>The MeshVariable class generates a variable supported by a finite element mesh and the
underlying sympy representation that makes it possible to construct expressions that
depend on the values of the MeshVariable.</p>

<p>To set / read nodal values, use the numpy interface via the 'data' property.</p>

<h2 id="parameters">Parameters</h2>

<p>varname :
    A textual name for this variable.
mesh :
    The supporting underworld mesh.
num_components :
    The number of components this variable has.
    For example, scalars will have <code>num_components=1</code>,
    while a 2d vector would have <code>num_components=2</code>.
vtype :
    Optional. The underworld variable type for this variable.
    If not defined it will be inferred from <code>num_components</code>
    if possible.
degree :
    The polynomial degree for this variable.
varsymbol:
    A symbolic form for printing etc (sympy / latex)</p>
</div>


                </section>
                <section id="checkpoint_xdmf">
                            <input id="checkpoint_xdmf-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">checkpoint_xdmf</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="checkpoint_xdmf-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#checkpoint_xdmf"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="checkpoint_xdmf-2319"><a href="#checkpoint_xdmf-2319"><span class="linenos">2319</span></a><span class="k">def</span> <span class="nf">checkpoint_xdmf</span><span class="p">(</span>
</span><span id="checkpoint_xdmf-2320"><a href="#checkpoint_xdmf-2320"><span class="linenos">2320</span></a>    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="checkpoint_xdmf-2321"><a href="#checkpoint_xdmf-2321"><span class="linenos">2321</span></a>    <span class="n">meshUpdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="checkpoint_xdmf-2322"><a href="#checkpoint_xdmf-2322"><span class="linenos">2322</span></a>    <span class="n">meshVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="checkpoint_xdmf-2323"><a href="#checkpoint_xdmf-2323"><span class="linenos">2323</span></a>    <span class="n">swarmVars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="checkpoint_xdmf-2324"><a href="#checkpoint_xdmf-2324"><span class="linenos">2324</span></a>    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="checkpoint_xdmf-2325"><a href="#checkpoint_xdmf-2325"><span class="linenos">2325</span></a><span class="p">):</span>
</span><span id="checkpoint_xdmf-2326"><a href="#checkpoint_xdmf-2326"><span class="linenos">2326</span></a>    <span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="checkpoint_xdmf-2327"><a href="#checkpoint_xdmf-2327"><span class="linenos">2327</span></a>    <span class="kn">import</span> <span class="nn">os</span>
</span><span id="checkpoint_xdmf-2328"><a href="#checkpoint_xdmf-2328"><span class="linenos">2328</span></a>
</span><span id="checkpoint_xdmf-2329"><a href="#checkpoint_xdmf-2329"><span class="linenos">2329</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create xdmf file for checkpoints&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2330"><a href="#checkpoint_xdmf-2330"><span class="linenos">2330</span></a>
</span><span id="checkpoint_xdmf-2331"><a href="#checkpoint_xdmf-2331"><span class="linenos">2331</span></a>    <span class="c1">## Identify the mesh file. Use the</span>
</span><span id="checkpoint_xdmf-2332"><a href="#checkpoint_xdmf-2332"><span class="linenos">2332</span></a>    <span class="c1">## zeroth one if this option is turned off</span>
</span><span id="checkpoint_xdmf-2333"><a href="#checkpoint_xdmf-2333"><span class="linenos">2333</span></a>
</span><span id="checkpoint_xdmf-2334"><a href="#checkpoint_xdmf-2334"><span class="linenos">2334</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">meshUpdates</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2335"><a href="#checkpoint_xdmf-2335"><span class="linenos">2335</span></a>        <span class="n">mesh_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.mesh.00000.h5&quot;</span>
</span><span id="checkpoint_xdmf-2336"><a href="#checkpoint_xdmf-2336"><span class="linenos">2336</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2337"><a href="#checkpoint_xdmf-2337"><span class="linenos">2337</span></a>        <span class="n">mesh_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="checkpoint_xdmf-2338"><a href="#checkpoint_xdmf-2338"><span class="linenos">2338</span></a>
</span><span id="checkpoint_xdmf-2339"><a href="#checkpoint_xdmf-2339"><span class="linenos">2339</span></a>    <span class="c1">## Obtain the mesh information</span>
</span><span id="checkpoint_xdmf-2340"><a href="#checkpoint_xdmf-2340"><span class="linenos">2340</span></a>
</span><span id="checkpoint_xdmf-2341"><a href="#checkpoint_xdmf-2341"><span class="linenos">2341</span></a>    <span class="n">h5</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">mesh_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
</span><span id="checkpoint_xdmf-2342"><a href="#checkpoint_xdmf-2342"><span class="linenos">2342</span></a>    <span class="k">if</span> <span class="s2">&quot;viz&quot;</span> <span class="ow">in</span> <span class="n">h5</span> <span class="ow">and</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">in</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;viz&quot;</span><span class="p">]:</span>
</span><span id="checkpoint_xdmf-2343"><a href="#checkpoint_xdmf-2343"><span class="linenos">2343</span></a>        <span class="n">geomPath</span> <span class="o">=</span> <span class="s2">&quot;viz/geometry&quot;</span>
</span><span id="checkpoint_xdmf-2344"><a href="#checkpoint_xdmf-2344"><span class="linenos">2344</span></a>        <span class="n">geom</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;viz&quot;</span><span class="p">][</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2345"><a href="#checkpoint_xdmf-2345"><span class="linenos">2345</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2346"><a href="#checkpoint_xdmf-2346"><span class="linenos">2346</span></a>        <span class="n">geomPath</span> <span class="o">=</span> <span class="s2">&quot;geometry&quot;</span>
</span><span id="checkpoint_xdmf-2347"><a href="#checkpoint_xdmf-2347"><span class="linenos">2347</span></a>        <span class="n">geom</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2348"><a href="#checkpoint_xdmf-2348"><span class="linenos">2348</span></a>
</span><span id="checkpoint_xdmf-2349"><a href="#checkpoint_xdmf-2349"><span class="linenos">2349</span></a>    <span class="k">if</span> <span class="s2">&quot;viz&quot;</span> <span class="ow">in</span> <span class="n">h5</span> <span class="ow">and</span> <span class="s2">&quot;topology&quot;</span> <span class="ow">in</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;viz&quot;</span><span class="p">]:</span>
</span><span id="checkpoint_xdmf-2350"><a href="#checkpoint_xdmf-2350"><span class="linenos">2350</span></a>        <span class="n">topoPath</span> <span class="o">=</span> <span class="s2">&quot;viz/topology&quot;</span>
</span><span id="checkpoint_xdmf-2351"><a href="#checkpoint_xdmf-2351"><span class="linenos">2351</span></a>        <span class="n">topo</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;viz&quot;</span><span class="p">][</span><span class="s2">&quot;topology&quot;</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2352"><a href="#checkpoint_xdmf-2352"><span class="linenos">2352</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2353"><a href="#checkpoint_xdmf-2353"><span class="linenos">2353</span></a>        <span class="n">topoPath</span> <span class="o">=</span> <span class="s2">&quot;topology&quot;</span>
</span><span id="checkpoint_xdmf-2354"><a href="#checkpoint_xdmf-2354"><span class="linenos">2354</span></a>        <span class="n">topo</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;topology&quot;</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2355"><a href="#checkpoint_xdmf-2355"><span class="linenos">2355</span></a>
</span><span id="checkpoint_xdmf-2356"><a href="#checkpoint_xdmf-2356"><span class="linenos">2356</span></a>    <span class="n">vertices</span> <span class="o">=</span> <span class="n">geom</span><span class="p">[</span><span class="s2">&quot;vertices&quot;</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2357"><a href="#checkpoint_xdmf-2357"><span class="linenos">2357</span></a>    <span class="n">numVertices</span> <span class="o">=</span> <span class="n">vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2358"><a href="#checkpoint_xdmf-2358"><span class="linenos">2358</span></a>    <span class="n">spaceDim</span> <span class="o">=</span> <span class="n">vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2359"><a href="#checkpoint_xdmf-2359"><span class="linenos">2359</span></a>    <span class="n">cells</span> <span class="o">=</span> <span class="n">topo</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2360"><a href="#checkpoint_xdmf-2360"><span class="linenos">2360</span></a>    <span class="n">numCells</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2361"><a href="#checkpoint_xdmf-2361"><span class="linenos">2361</span></a>    <span class="n">numCorners</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2362"><a href="#checkpoint_xdmf-2362"><span class="linenos">2362</span></a>    <span class="n">cellDim</span> <span class="o">=</span> <span class="n">topo</span><span class="p">[</span><span class="s2">&quot;cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cell_dim&quot;</span><span class="p">]</span>
</span><span id="checkpoint_xdmf-2363"><a href="#checkpoint_xdmf-2363"><span class="linenos">2363</span></a>
</span><span id="checkpoint_xdmf-2364"><a href="#checkpoint_xdmf-2364"><span class="linenos">2364</span></a>    <span class="n">h5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="checkpoint_xdmf-2365"><a href="#checkpoint_xdmf-2365"><span class="linenos">2365</span></a>
</span><span id="checkpoint_xdmf-2366"><a href="#checkpoint_xdmf-2366"><span class="linenos">2366</span></a>    <span class="c1"># We only use a subset of the possible cell types</span>
</span><span id="checkpoint_xdmf-2367"><a href="#checkpoint_xdmf-2367"><span class="linenos">2367</span></a>    <span class="k">if</span> <span class="n">spaceDim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2368"><a href="#checkpoint_xdmf-2368"><span class="linenos">2368</span></a>        <span class="k">if</span> <span class="n">numCorners</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2369"><a href="#checkpoint_xdmf-2369"><span class="linenos">2369</span></a>            <span class="n">topology_type</span> <span class="o">=</span> <span class="s2">&quot;Triangle&quot;</span>
</span><span id="checkpoint_xdmf-2370"><a href="#checkpoint_xdmf-2370"><span class="linenos">2370</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2371"><a href="#checkpoint_xdmf-2371"><span class="linenos">2371</span></a>            <span class="n">topology_type</span> <span class="o">=</span> <span class="s2">&quot;Quadrilateral&quot;</span>
</span><span id="checkpoint_xdmf-2372"><a href="#checkpoint_xdmf-2372"><span class="linenos">2372</span></a>        <span class="n">geomType</span> <span class="o">=</span> <span class="s2">&quot;XY&quot;</span>
</span><span id="checkpoint_xdmf-2373"><a href="#checkpoint_xdmf-2373"><span class="linenos">2373</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2374"><a href="#checkpoint_xdmf-2374"><span class="linenos">2374</span></a>        <span class="k">if</span> <span class="n">numCorners</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2375"><a href="#checkpoint_xdmf-2375"><span class="linenos">2375</span></a>            <span class="n">topology_type</span> <span class="o">=</span> <span class="s2">&quot;Tetrahedron&quot;</span>
</span><span id="checkpoint_xdmf-2376"><a href="#checkpoint_xdmf-2376"><span class="linenos">2376</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2377"><a href="#checkpoint_xdmf-2377"><span class="linenos">2377</span></a>            <span class="n">topology_type</span> <span class="o">=</span> <span class="s2">&quot;Hexahedron&quot;</span>
</span><span id="checkpoint_xdmf-2378"><a href="#checkpoint_xdmf-2378"><span class="linenos">2378</span></a>        <span class="n">geomType</span> <span class="o">=</span> <span class="s2">&quot;XYZ&quot;</span>
</span><span id="checkpoint_xdmf-2379"><a href="#checkpoint_xdmf-2379"><span class="linenos">2379</span></a>
</span><span id="checkpoint_xdmf-2380"><a href="#checkpoint_xdmf-2380"><span class="linenos">2380</span></a>    <span class="c1">## Create the header</span>
</span><span id="checkpoint_xdmf-2381"><a href="#checkpoint_xdmf-2381"><span class="linenos">2381</span></a>
</span><span id="checkpoint_xdmf-2382"><a href="#checkpoint_xdmf-2382"><span class="linenos">2382</span></a>    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
</span><span id="checkpoint_xdmf-2383"><a href="#checkpoint_xdmf-2383"><span class="linenos">2383</span></a><span class="s2">&lt;!DOCTYPE Xdmf SYSTEM &quot;Xdmf.dtd&quot; [</span>
</span><span id="checkpoint_xdmf-2384"><a href="#checkpoint_xdmf-2384"><span class="linenos">2384</span></a><span class="s2">&lt;!ENTITY MeshData &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mesh_filename</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2385"><a href="#checkpoint_xdmf-2385"><span class="linenos">2385</span></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2386"><a href="#checkpoint_xdmf-2386"><span class="linenos">2386</span></a>    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2387"><a href="#checkpoint_xdmf-2387"><span class="linenos">2387</span></a>        <span class="n">var_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="checkpoint_xdmf-2388"><a href="#checkpoint_xdmf-2388"><span class="linenos">2388</span></a>        <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2389"><a href="#checkpoint_xdmf-2389"><span class="linenos">2389</span></a><span class="s2">&lt;!ENTITY </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">_Data &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">var_filename</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&gt;&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2390"><a href="#checkpoint_xdmf-2390"><span class="linenos">2390</span></a>
</span><span id="checkpoint_xdmf-2391"><a href="#checkpoint_xdmf-2391"><span class="linenos">2391</span></a>    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2392"><a href="#checkpoint_xdmf-2392"><span class="linenos">2392</span></a>        <span class="n">var_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.proxy.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="checkpoint_xdmf-2393"><a href="#checkpoint_xdmf-2393"><span class="linenos">2393</span></a>        <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2394"><a href="#checkpoint_xdmf-2394"><span class="linenos">2394</span></a><span class="s2">&lt;!ENTITY </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">_Data &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">var_filename</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&gt;&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2395"><a href="#checkpoint_xdmf-2395"><span class="linenos">2395</span></a>
</span><span id="checkpoint_xdmf-2396"><a href="#checkpoint_xdmf-2396"><span class="linenos">2396</span></a>    <span class="n">header</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2397"><a href="#checkpoint_xdmf-2397"><span class="linenos">2397</span></a><span class="s2">]&gt;&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2398"><a href="#checkpoint_xdmf-2398"><span class="linenos">2398</span></a>
</span><span id="checkpoint_xdmf-2399"><a href="#checkpoint_xdmf-2399"><span class="linenos">2399</span></a>    <span class="n">xdmf_start</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2400"><a href="#checkpoint_xdmf-2400"><span class="linenos">2400</span></a><span class="s2">&lt;Xdmf&gt;</span>
</span><span id="checkpoint_xdmf-2401"><a href="#checkpoint_xdmf-2401"><span class="linenos">2401</span></a><span class="s2">  &lt;Domain Name=&quot;domain&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2402"><a href="#checkpoint_xdmf-2402"><span class="linenos">2402</span></a><span class="s2">    &lt;DataItem Name=&quot;cells&quot;</span>
</span><span id="checkpoint_xdmf-2403"><a href="#checkpoint_xdmf-2403"><span class="linenos">2403</span></a><span class="s2">              ItemType=&quot;Uniform&quot;</span>
</span><span id="checkpoint_xdmf-2404"><a href="#checkpoint_xdmf-2404"><span class="linenos">2404</span></a><span class="s2">              Format=&quot;HDF&quot;</span>
</span><span id="checkpoint_xdmf-2405"><a href="#checkpoint_xdmf-2405"><span class="linenos">2405</span></a><span class="s2">              NumberType=&quot;Float&quot; Precision=&quot;8&quot;</span>
</span><span id="checkpoint_xdmf-2406"><a href="#checkpoint_xdmf-2406"><span class="linenos">2406</span></a><span class="s2">              Dimensions=&quot;</span><span class="si">{</span><span class="n">numCells</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">numCorners</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2407"><a href="#checkpoint_xdmf-2407"><span class="linenos">2407</span></a><span class="s2">      &amp;MeshData;:/</span><span class="si">{</span><span class="n">topoPath</span><span class="si">}</span><span class="s2">/cells</span>
</span><span id="checkpoint_xdmf-2408"><a href="#checkpoint_xdmf-2408"><span class="linenos">2408</span></a><span class="s2">    &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2409"><a href="#checkpoint_xdmf-2409"><span class="linenos">2409</span></a><span class="s2">    &lt;DataItem Name=&quot;vertices&quot;</span>
</span><span id="checkpoint_xdmf-2410"><a href="#checkpoint_xdmf-2410"><span class="linenos">2410</span></a><span class="s2">              Format=&quot;HDF&quot;</span>
</span><span id="checkpoint_xdmf-2411"><a href="#checkpoint_xdmf-2411"><span class="linenos">2411</span></a><span class="s2">              Dimensions=&quot;</span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">spaceDim</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2412"><a href="#checkpoint_xdmf-2412"><span class="linenos">2412</span></a><span class="s2">      &amp;MeshData;:/</span><span class="si">{</span><span class="n">geomPath</span><span class="si">}</span><span class="s2">/vertices</span>
</span><span id="checkpoint_xdmf-2413"><a href="#checkpoint_xdmf-2413"><span class="linenos">2413</span></a><span class="s2">    &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2414"><a href="#checkpoint_xdmf-2414"><span class="linenos">2414</span></a><span class="s2">    &lt;!-- ============================================================ --&gt;</span>
</span><span id="checkpoint_xdmf-2415"><a href="#checkpoint_xdmf-2415"><span class="linenos">2415</span></a><span class="s2">      &lt;Grid Name=&quot;domain&quot; GridType=&quot;Uniform&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2416"><a href="#checkpoint_xdmf-2416"><span class="linenos">2416</span></a><span class="s2">        &lt;Topology</span>
</span><span id="checkpoint_xdmf-2417"><a href="#checkpoint_xdmf-2417"><span class="linenos">2417</span></a><span class="s2">           TopologyType=&quot;</span><span class="si">{</span><span class="n">topology_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="checkpoint_xdmf-2418"><a href="#checkpoint_xdmf-2418"><span class="linenos">2418</span></a><span class="s2">           NumberOfElements=&quot;</span><span class="si">{</span><span class="n">numCells</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2419"><a href="#checkpoint_xdmf-2419"><span class="linenos">2419</span></a><span class="s2">          &lt;DataItem Reference=&quot;XML&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2420"><a href="#checkpoint_xdmf-2420"><span class="linenos">2420</span></a><span class="s2">            /Xdmf/Domain/DataItem[@Name=&quot;cells&quot;]</span>
</span><span id="checkpoint_xdmf-2421"><a href="#checkpoint_xdmf-2421"><span class="linenos">2421</span></a><span class="s2">          &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2422"><a href="#checkpoint_xdmf-2422"><span class="linenos">2422</span></a><span class="s2">        &lt;/Topology&gt;</span>
</span><span id="checkpoint_xdmf-2423"><a href="#checkpoint_xdmf-2423"><span class="linenos">2423</span></a><span class="s2">        &lt;Geometry GeometryType=&quot;</span><span class="si">{</span><span class="n">geomType</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2424"><a href="#checkpoint_xdmf-2424"><span class="linenos">2424</span></a><span class="s2">          &lt;DataItem Reference=&quot;XML&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2425"><a href="#checkpoint_xdmf-2425"><span class="linenos">2425</span></a><span class="s2">            /Xdmf/Domain/DataItem[@Name=&quot;vertices&quot;]</span>
</span><span id="checkpoint_xdmf-2426"><a href="#checkpoint_xdmf-2426"><span class="linenos">2426</span></a><span class="s2">          &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2427"><a href="#checkpoint_xdmf-2427"><span class="linenos">2427</span></a><span class="s2">        &lt;/Geometry&gt;</span>
</span><span id="checkpoint_xdmf-2428"><a href="#checkpoint_xdmf-2428"><span class="linenos">2428</span></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2429"><a href="#checkpoint_xdmf-2429"><span class="linenos">2429</span></a>
</span><span id="checkpoint_xdmf-2430"><a href="#checkpoint_xdmf-2430"><span class="linenos">2430</span></a>    <span class="c1">## The mesh Var attributes</span>
</span><span id="checkpoint_xdmf-2431"><a href="#checkpoint_xdmf-2431"><span class="linenos">2431</span></a>
</span><span id="checkpoint_xdmf-2432"><a href="#checkpoint_xdmf-2432"><span class="linenos">2432</span></a>    <span class="n">attributes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2433"><a href="#checkpoint_xdmf-2433"><span class="linenos">2433</span></a>    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">meshVars</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2434"><a href="#checkpoint_xdmf-2434"><span class="linenos">2434</span></a>        <span class="n">var_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;mesh.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="checkpoint_xdmf-2435"><a href="#checkpoint_xdmf-2435"><span class="linenos">2435</span></a>        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">num_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2436"><a href="#checkpoint_xdmf-2436"><span class="linenos">2436</span></a>            <span class="n">variable_type</span> <span class="o">=</span> <span class="s2">&quot;Scalar&quot;</span>
</span><span id="checkpoint_xdmf-2437"><a href="#checkpoint_xdmf-2437"><span class="linenos">2437</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2438"><a href="#checkpoint_xdmf-2438"><span class="linenos">2438</span></a>            <span class="n">variable_type</span> <span class="o">=</span> <span class="s2">&quot;Vector&quot;</span>
</span><span id="checkpoint_xdmf-2439"><a href="#checkpoint_xdmf-2439"><span class="linenos">2439</span></a>        <span class="c1"># We should add a tensor type here ...</span>
</span><span id="checkpoint_xdmf-2440"><a href="#checkpoint_xdmf-2440"><span class="linenos">2440</span></a>
</span><span id="checkpoint_xdmf-2441"><a href="#checkpoint_xdmf-2441"><span class="linenos">2441</span></a>        <span class="n">var_attribute</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2442"><a href="#checkpoint_xdmf-2442"><span class="linenos">2442</span></a><span class="s2">        &lt;Attribute</span>
</span><span id="checkpoint_xdmf-2443"><a href="#checkpoint_xdmf-2443"><span class="linenos">2443</span></a><span class="s2">           Name=&quot;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="checkpoint_xdmf-2444"><a href="#checkpoint_xdmf-2444"><span class="linenos">2444</span></a><span class="s2">           Type=&quot;</span><span class="si">{</span><span class="n">variable_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="checkpoint_xdmf-2445"><a href="#checkpoint_xdmf-2445"><span class="linenos">2445</span></a><span class="s2">           Center=&quot;Node&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2446"><a href="#checkpoint_xdmf-2446"><span class="linenos">2446</span></a><span class="s2">          &lt;DataItem ItemType=&quot;HyperSlab&quot;</span>
</span><span id="checkpoint_xdmf-2447"><a href="#checkpoint_xdmf-2447"><span class="linenos">2447</span></a><span class="s2">        	    Dimensions=&quot;1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="checkpoint_xdmf-2448"><a href="#checkpoint_xdmf-2448"><span class="linenos">2448</span></a><span class="s2">        	    Type=&quot;HyperSlab&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2449"><a href="#checkpoint_xdmf-2449"><span class="linenos">2449</span></a><span class="s2">            &lt;DataItem</span>
</span><span id="checkpoint_xdmf-2450"><a href="#checkpoint_xdmf-2450"><span class="linenos">2450</span></a><span class="s2">               Dimensions=&quot;3 3&quot;</span>
</span><span id="checkpoint_xdmf-2451"><a href="#checkpoint_xdmf-2451"><span class="linenos">2451</span></a><span class="s2">               Format=&quot;XML&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2452"><a href="#checkpoint_xdmf-2452"><span class="linenos">2452</span></a><span class="s2">              0 0 0</span>
</span><span id="checkpoint_xdmf-2453"><a href="#checkpoint_xdmf-2453"><span class="linenos">2453</span></a><span class="s2">              1 1 1</span>
</span><span id="checkpoint_xdmf-2454"><a href="#checkpoint_xdmf-2454"><span class="linenos">2454</span></a><span class="s2">              1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span>
</span><span id="checkpoint_xdmf-2455"><a href="#checkpoint_xdmf-2455"><span class="linenos">2455</span></a><span class="s2">            &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2456"><a href="#checkpoint_xdmf-2456"><span class="linenos">2456</span></a><span class="s2">            &lt;DataItem</span>
</span><span id="checkpoint_xdmf-2457"><a href="#checkpoint_xdmf-2457"><span class="linenos">2457</span></a><span class="s2">               DataType=&quot;Float&quot; Precision=&quot;8&quot;</span>
</span><span id="checkpoint_xdmf-2458"><a href="#checkpoint_xdmf-2458"><span class="linenos">2458</span></a><span class="s2">               Dimensions=&quot;1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="checkpoint_xdmf-2459"><a href="#checkpoint_xdmf-2459"><span class="linenos">2459</span></a><span class="s2">               Format=&quot;HDF&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2460"><a href="#checkpoint_xdmf-2460"><span class="linenos">2460</span></a><span class="s2">              &amp;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="o">+</span><span class="s2">&quot;_Data&quot;</span><span class="si">}</span><span class="s2">;:/vertex_fields/</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="o">+</span><span class="s2">&quot;_P&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span><span class="si">}</span>
</span><span id="checkpoint_xdmf-2461"><a href="#checkpoint_xdmf-2461"><span class="linenos">2461</span></a><span class="s2">            &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2462"><a href="#checkpoint_xdmf-2462"><span class="linenos">2462</span></a><span class="s2">          &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2463"><a href="#checkpoint_xdmf-2463"><span class="linenos">2463</span></a><span class="s2">        &lt;/Attribute&gt;</span>
</span><span id="checkpoint_xdmf-2464"><a href="#checkpoint_xdmf-2464"><span class="linenos">2464</span></a><span class="s2">    &quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2465"><a href="#checkpoint_xdmf-2465"><span class="linenos">2465</span></a>        <span class="n">attributes</span> <span class="o">+=</span> <span class="n">var_attribute</span>
</span><span id="checkpoint_xdmf-2466"><a href="#checkpoint_xdmf-2466"><span class="linenos">2466</span></a>
</span><span id="checkpoint_xdmf-2467"><a href="#checkpoint_xdmf-2467"><span class="linenos">2467</span></a>    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">swarmVars</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2468"><a href="#checkpoint_xdmf-2468"><span class="linenos">2468</span></a>        <span class="n">var_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.proxy.</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.h5&quot;</span>
</span><span id="checkpoint_xdmf-2469"><a href="#checkpoint_xdmf-2469"><span class="linenos">2469</span></a>        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">num_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2470"><a href="#checkpoint_xdmf-2470"><span class="linenos">2470</span></a>            <span class="n">variable_type</span> <span class="o">=</span> <span class="s2">&quot;Scalar&quot;</span>
</span><span id="checkpoint_xdmf-2471"><a href="#checkpoint_xdmf-2471"><span class="linenos">2471</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2472"><a href="#checkpoint_xdmf-2472"><span class="linenos">2472</span></a>            <span class="n">variable_type</span> <span class="o">=</span> <span class="s2">&quot;Vector&quot;</span>
</span><span id="checkpoint_xdmf-2473"><a href="#checkpoint_xdmf-2473"><span class="linenos">2473</span></a>        <span class="c1"># We should add a tensor type here ...</span>
</span><span id="checkpoint_xdmf-2474"><a href="#checkpoint_xdmf-2474"><span class="linenos">2474</span></a>
</span><span id="checkpoint_xdmf-2475"><a href="#checkpoint_xdmf-2475"><span class="linenos">2475</span></a>        <span class="n">var_attribute</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2476"><a href="#checkpoint_xdmf-2476"><span class="linenos">2476</span></a><span class="s2">        &lt;Attribute</span>
</span><span id="checkpoint_xdmf-2477"><a href="#checkpoint_xdmf-2477"><span class="linenos">2477</span></a><span class="s2">           Name=&quot;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="checkpoint_xdmf-2478"><a href="#checkpoint_xdmf-2478"><span class="linenos">2478</span></a><span class="s2">           Type=&quot;</span><span class="si">{</span><span class="n">variable_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="checkpoint_xdmf-2479"><a href="#checkpoint_xdmf-2479"><span class="linenos">2479</span></a><span class="s2">           Center=&quot;Node&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2480"><a href="#checkpoint_xdmf-2480"><span class="linenos">2480</span></a><span class="s2">          &lt;DataItem ItemType=&quot;HyperSlab&quot;</span>
</span><span id="checkpoint_xdmf-2481"><a href="#checkpoint_xdmf-2481"><span class="linenos">2481</span></a><span class="s2">        	    Dimensions=&quot;1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="checkpoint_xdmf-2482"><a href="#checkpoint_xdmf-2482"><span class="linenos">2482</span></a><span class="s2">        	    Type=&quot;HyperSlab&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2483"><a href="#checkpoint_xdmf-2483"><span class="linenos">2483</span></a><span class="s2">            &lt;DataItem</span>
</span><span id="checkpoint_xdmf-2484"><a href="#checkpoint_xdmf-2484"><span class="linenos">2484</span></a><span class="s2">               Dimensions=&quot;3 3&quot;</span>
</span><span id="checkpoint_xdmf-2485"><a href="#checkpoint_xdmf-2485"><span class="linenos">2485</span></a><span class="s2">               Format=&quot;XML&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2486"><a href="#checkpoint_xdmf-2486"><span class="linenos">2486</span></a><span class="s2">              0 0 0</span>
</span><span id="checkpoint_xdmf-2487"><a href="#checkpoint_xdmf-2487"><span class="linenos">2487</span></a><span class="s2">              1 1 1</span>
</span><span id="checkpoint_xdmf-2488"><a href="#checkpoint_xdmf-2488"><span class="linenos">2488</span></a><span class="s2">              1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span>
</span><span id="checkpoint_xdmf-2489"><a href="#checkpoint_xdmf-2489"><span class="linenos">2489</span></a><span class="s2">            &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2490"><a href="#checkpoint_xdmf-2490"><span class="linenos">2490</span></a><span class="s2">            &lt;DataItem</span>
</span><span id="checkpoint_xdmf-2491"><a href="#checkpoint_xdmf-2491"><span class="linenos">2491</span></a><span class="s2">               DataType=&quot;Float&quot; Precision=&quot;8&quot;</span>
</span><span id="checkpoint_xdmf-2492"><a href="#checkpoint_xdmf-2492"><span class="linenos">2492</span></a><span class="s2">               Dimensions=&quot;1 </span><span class="si">{</span><span class="n">numVertices</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">num_components</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="checkpoint_xdmf-2493"><a href="#checkpoint_xdmf-2493"><span class="linenos">2493</span></a><span class="s2">               Format=&quot;HDF&quot;&gt;</span>
</span><span id="checkpoint_xdmf-2494"><a href="#checkpoint_xdmf-2494"><span class="linenos">2494</span></a><span class="s2">              &amp;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="o">+</span><span class="s2">&quot;_Data&quot;</span><span class="si">}</span><span class="s2">;:/vertex_fields/</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">clean_name</span><span class="o">+</span><span class="s2">&quot;_P&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">_meshVar</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span><span class="si">}</span>
</span><span id="checkpoint_xdmf-2495"><a href="#checkpoint_xdmf-2495"><span class="linenos">2495</span></a><span class="s2">            &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2496"><a href="#checkpoint_xdmf-2496"><span class="linenos">2496</span></a><span class="s2">          &lt;/DataItem&gt;</span>
</span><span id="checkpoint_xdmf-2497"><a href="#checkpoint_xdmf-2497"><span class="linenos">2497</span></a><span class="s2">        &lt;/Attribute&gt;</span>
</span><span id="checkpoint_xdmf-2498"><a href="#checkpoint_xdmf-2498"><span class="linenos">2498</span></a><span class="s2">    &quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2499"><a href="#checkpoint_xdmf-2499"><span class="linenos">2499</span></a>        <span class="n">attributes</span> <span class="o">+=</span> <span class="n">var_attribute</span>
</span><span id="checkpoint_xdmf-2500"><a href="#checkpoint_xdmf-2500"><span class="linenos">2500</span></a>
</span><span id="checkpoint_xdmf-2501"><a href="#checkpoint_xdmf-2501"><span class="linenos">2501</span></a>    <span class="n">xdmf_end</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2502"><a href="#checkpoint_xdmf-2502"><span class="linenos">2502</span></a><span class="s2">    &lt;/Grid&gt;</span>
</span><span id="checkpoint_xdmf-2503"><a href="#checkpoint_xdmf-2503"><span class="linenos">2503</span></a><span class="s2">  &lt;/Domain&gt;</span>
</span><span id="checkpoint_xdmf-2504"><a href="#checkpoint_xdmf-2504"><span class="linenos">2504</span></a><span class="s2">&lt;/Xdmf&gt;</span>
</span><span id="checkpoint_xdmf-2505"><a href="#checkpoint_xdmf-2505"><span class="linenos">2505</span></a><span class="s2">    &quot;&quot;&quot;</span>
</span><span id="checkpoint_xdmf-2506"><a href="#checkpoint_xdmf-2506"><span class="linenos">2506</span></a>
</span><span id="checkpoint_xdmf-2507"><a href="#checkpoint_xdmf-2507"><span class="linenos">2507</span></a>    <span class="n">xdmf_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.mesh.</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">.xdmf&quot;</span>
</span><span id="checkpoint_xdmf-2508"><a href="#checkpoint_xdmf-2508"><span class="linenos">2508</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xdmf_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span><span id="checkpoint_xdmf-2509"><a href="#checkpoint_xdmf-2509"><span class="linenos">2509</span></a>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
</span><span id="checkpoint_xdmf-2510"><a href="#checkpoint_xdmf-2510"><span class="linenos">2510</span></a>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xdmf_start</span><span class="p">)</span>
</span><span id="checkpoint_xdmf-2511"><a href="#checkpoint_xdmf-2511"><span class="linenos">2511</span></a>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span id="checkpoint_xdmf-2512"><a href="#checkpoint_xdmf-2512"><span class="linenos">2512</span></a>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xdmf_end</span><span class="p">)</span>
</span><span id="checkpoint_xdmf-2513"><a href="#checkpoint_xdmf-2513"><span class="linenos">2513</span></a>
</span><span id="checkpoint_xdmf-2514"><a href="#checkpoint_xdmf-2514"><span class="linenos">2514</span></a>    <span class="k">return</span>
</span></pre></div>


    

                </section>
                <section id="meshVariable_lookup_by_symbol">
                            <input id="meshVariable_lookup_by_symbol-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">meshVariable_lookup_by_symbol</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mesh</span>, </span><span class="param"><span class="n">sympy_object</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="meshVariable_lookup_by_symbol-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#meshVariable_lookup_by_symbol"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="meshVariable_lookup_by_symbol-2517"><a href="#meshVariable_lookup_by_symbol-2517"><span class="linenos">2517</span></a><span class="k">def</span> <span class="nf">meshVariable_lookup_by_symbol</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">sympy_object</span><span class="p">):</span>
</span><span id="meshVariable_lookup_by_symbol-2518"><a href="#meshVariable_lookup_by_symbol-2518"><span class="linenos">2518</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a sympy object, scan the mesh variables in `mesh` to find the</span>
</span><span id="meshVariable_lookup_by_symbol-2519"><a href="#meshVariable_lookup_by_symbol-2519"><span class="linenos">2519</span></a><span class="sd">    location (meshvariable, component in the data array) corresponding to the symbol</span>
</span><span id="meshVariable_lookup_by_symbol-2520"><a href="#meshVariable_lookup_by_symbol-2520"><span class="linenos">2520</span></a><span class="sd">    or return None if not found</span>
</span><span id="meshVariable_lookup_by_symbol-2521"><a href="#meshVariable_lookup_by_symbol-2521"><span class="linenos">2521</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="meshVariable_lookup_by_symbol-2522"><a href="#meshVariable_lookup_by_symbol-2522"><span class="linenos">2522</span></a>
</span><span id="meshVariable_lookup_by_symbol-2523"><a href="#meshVariable_lookup_by_symbol-2523"><span class="linenos">2523</span></a>    <span class="k">for</span> <span class="n">meshvar</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="meshVariable_lookup_by_symbol-2524"><a href="#meshVariable_lookup_by_symbol-2524"><span class="linenos">2524</span></a>        <span class="k">if</span> <span class="n">meshvar</span><span class="o">.</span><span class="n">sym</span> <span class="o">==</span> <span class="n">sympy_object</span><span class="p">:</span>
</span><span id="meshVariable_lookup_by_symbol-2525"><a href="#meshVariable_lookup_by_symbol-2525"><span class="linenos">2525</span></a>            <span class="k">return</span> <span class="n">meshvar</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="meshVariable_lookup_by_symbol-2526"><a href="#meshVariable_lookup_by_symbol-2526"><span class="linenos">2526</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="meshVariable_lookup_by_symbol-2527"><a href="#meshVariable_lookup_by_symbol-2527"><span class="linenos">2527</span></a>            <span class="k">for</span> <span class="n">comp</span><span class="p">,</span> <span class="n">subvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">meshvar</span><span class="o">.</span><span class="n">sym_1d</span><span class="p">):</span>
</span><span id="meshVariable_lookup_by_symbol-2528"><a href="#meshVariable_lookup_by_symbol-2528"><span class="linenos">2528</span></a>                <span class="k">if</span> <span class="n">subvar</span> <span class="o">==</span> <span class="n">sympy_object</span><span class="p">:</span>
</span><span id="meshVariable_lookup_by_symbol-2529"><a href="#meshVariable_lookup_by_symbol-2529"><span class="linenos">2529</span></a>                    <span class="k">return</span> <span class="n">meshvar</span><span class="p">,</span> <span class="n">comp</span>
</span><span id="meshVariable_lookup_by_symbol-2530"><a href="#meshVariable_lookup_by_symbol-2530"><span class="linenos">2530</span></a>
</span><span id="meshVariable_lookup_by_symbol-2531"><a href="#meshVariable_lookup_by_symbol-2531"><span class="linenos">2531</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Given a sympy object, scan the mesh variables in <code>mesh</code> to find the
location (meshvariable, component in the data array) corresponding to the symbol
or return None if not found</p>
</div>


                </section>
                <section id="petsc_dm_find_labeled_points_local">
                            <input id="petsc_dm_find_labeled_points_local-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">petsc_dm_find_labeled_points_local</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">dm</span>, </span><span class="param"><span class="n">label_name</span>, </span><span class="param"><span class="n">label_value</span>, </span><span class="param"><span class="n">sectionIndex</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="petsc_dm_find_labeled_points_local-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#petsc_dm_find_labeled_points_local"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="petsc_dm_find_labeled_points_local-2534"><a href="#petsc_dm_find_labeled_points_local-2534"><span class="linenos">2534</span></a><span class="k">def</span> <span class="nf">petsc_dm_find_labeled_points_local</span><span class="p">(</span>
</span><span id="petsc_dm_find_labeled_points_local-2535"><a href="#petsc_dm_find_labeled_points_local-2535"><span class="linenos">2535</span></a>    <span class="n">dm</span><span class="p">,</span> <span class="n">label_name</span><span class="p">,</span> <span class="n">label_value</span><span class="p">,</span> <span class="n">sectionIndex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
</span><span id="petsc_dm_find_labeled_points_local-2536"><a href="#petsc_dm_find_labeled_points_local-2536"><span class="linenos">2536</span></a><span class="p">):</span>
</span><span id="petsc_dm_find_labeled_points_local-2537"><a href="#petsc_dm_find_labeled_points_local-2537"><span class="linenos">2537</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify local points associated with &quot;Label&quot;</span>
</span><span id="petsc_dm_find_labeled_points_local-2538"><a href="#petsc_dm_find_labeled_points_local-2538"><span class="linenos">2538</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2539"><a href="#petsc_dm_find_labeled_points_local-2539"><span class="linenos">2539</span></a><span class="sd">    dm -&gt; expects a petscDM object</span>
</span><span id="petsc_dm_find_labeled_points_local-2540"><a href="#petsc_dm_find_labeled_points_local-2540"><span class="linenos">2540</span></a><span class="sd">    label_name -&gt; &quot;String Name for Label&quot;</span>
</span><span id="petsc_dm_find_labeled_points_local-2541"><a href="#petsc_dm_find_labeled_points_local-2541"><span class="linenos">2541</span></a><span class="sd">    sectionIndex -&gt; False: leave points as indexed by the relevant section on the dm</span>
</span><span id="petsc_dm_find_labeled_points_local-2542"><a href="#petsc_dm_find_labeled_points_local-2542"><span class="linenos">2542</span></a><span class="sd">                    True: index into the local coordinate array</span>
</span><span id="petsc_dm_find_labeled_points_local-2543"><a href="#petsc_dm_find_labeled_points_local-2543"><span class="linenos">2543</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2544"><a href="#petsc_dm_find_labeled_points_local-2544"><span class="linenos">2544</span></a><span class="sd">    NOTE: Assumes uniform element types</span>
</span><span id="petsc_dm_find_labeled_points_local-2545"><a href="#petsc_dm_find_labeled_points_local-2545"><span class="linenos">2545</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="petsc_dm_find_labeled_points_local-2546"><a href="#petsc_dm_find_labeled_points_local-2546"><span class="linenos">2546</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2547"><a href="#petsc_dm_find_labeled_points_local-2547"><span class="linenos">2547</span></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="petsc_dm_find_labeled_points_local-2548"><a href="#petsc_dm_find_labeled_points_local-2548"><span class="linenos">2548</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2549"><a href="#petsc_dm_find_labeled_points_local-2549"><span class="linenos">2549</span></a>    <span class="n">pStart</span><span class="p">,</span> <span class="n">pEnd</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getDepthStratum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2550"><a href="#petsc_dm_find_labeled_points_local-2550"><span class="linenos">2550</span></a>    <span class="n">eStart</span><span class="p">,</span> <span class="n">eEnd</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getDepthStratum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2551"><a href="#petsc_dm_find_labeled_points_local-2551"><span class="linenos">2551</span></a>    <span class="n">fStart</span><span class="p">,</span> <span class="n">fEnd</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getDepthStratum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2552"><a href="#petsc_dm_find_labeled_points_local-2552"><span class="linenos">2552</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2553"><a href="#petsc_dm_find_labeled_points_local-2553"><span class="linenos">2553</span></a>    <span class="c1"># print(f&quot;Label: {label_name} / {label_value}&quot;)</span>
</span><span id="petsc_dm_find_labeled_points_local-2554"><a href="#petsc_dm_find_labeled_points_local-2554"><span class="linenos">2554</span></a>    <span class="c1"># print(f&quot;points: {pStart}: {pEnd}&quot;)</span>
</span><span id="petsc_dm_find_labeled_points_local-2555"><a href="#petsc_dm_find_labeled_points_local-2555"><span class="linenos">2555</span></a>    <span class="c1"># print(f&quot;edges : {eStart}: {eEnd}&quot;)</span>
</span><span id="petsc_dm_find_labeled_points_local-2556"><a href="#petsc_dm_find_labeled_points_local-2556"><span class="linenos">2556</span></a>    <span class="c1"># print(f&quot;faces : {fStart}: {fEnd}&quot;)</span>
</span><span id="petsc_dm_find_labeled_points_local-2557"><a href="#petsc_dm_find_labeled_points_local-2557"><span class="linenos">2557</span></a>    <span class="c1"># print(f&quot;&quot;, flush=True)</span>
</span><span id="petsc_dm_find_labeled_points_local-2558"><a href="#petsc_dm_find_labeled_points_local-2558"><span class="linenos">2558</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2559"><a href="#petsc_dm_find_labeled_points_local-2559"><span class="linenos">2559</span></a>    <span class="n">label</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">label_name</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2560"><a href="#petsc_dm_find_labeled_points_local-2560"><span class="linenos">2560</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
</span><span id="petsc_dm_find_labeled_points_local-2561"><a href="#petsc_dm_find_labeled_points_local-2561"><span class="linenos">2561</span></a>        <span class="k">if</span> <span class="n">uw</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="petsc_dm_find_labeled_points_local-2562"><a href="#petsc_dm_find_labeled_points_local-2562"><span class="linenos">2562</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label </span><span class="si">{</span><span class="n">label_name</span><span class="si">}</span><span class="s2"> is not present on the dm&quot;</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2563"><a href="#petsc_dm_find_labeled_points_local-2563"><span class="linenos">2563</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
</span><span id="petsc_dm_find_labeled_points_local-2564"><a href="#petsc_dm_find_labeled_points_local-2564"><span class="linenos">2564</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2565"><a href="#petsc_dm_find_labeled_points_local-2565"><span class="linenos">2565</span></a>    <span class="n">pointIS</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getStratumIS</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2566"><a href="#petsc_dm_find_labeled_points_local-2566"><span class="linenos">2566</span></a>    <span class="n">edgeIS</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getStratumIS</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2567"><a href="#petsc_dm_find_labeled_points_local-2567"><span class="linenos">2567</span></a>    <span class="n">faceIS</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getStratumIS</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2568"><a href="#petsc_dm_find_labeled_points_local-2568"><span class="linenos">2568</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2569"><a href="#petsc_dm_find_labeled_points_local-2569"><span class="linenos">2569</span></a>    <span class="n">point_indices</span> <span class="o">=</span> <span class="n">pointIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">()</span>
</span><span id="petsc_dm_find_labeled_points_local-2570"><a href="#petsc_dm_find_labeled_points_local-2570"><span class="linenos">2570</span></a>    <span class="n">edge_indices</span> <span class="o">=</span> <span class="n">edgeIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">()</span>
</span><span id="petsc_dm_find_labeled_points_local-2571"><a href="#petsc_dm_find_labeled_points_local-2571"><span class="linenos">2571</span></a>    <span class="n">face_indices</span> <span class="o">=</span> <span class="n">faceIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">()</span>
</span><span id="petsc_dm_find_labeled_points_local-2572"><a href="#petsc_dm_find_labeled_points_local-2572"><span class="linenos">2572</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2573"><a href="#petsc_dm_find_labeled_points_local-2573"><span class="linenos">2573</span></a>    <span class="c1"># _, iset_lab = label.convertToSection()</span>
</span><span id="petsc_dm_find_labeled_points_local-2574"><a href="#petsc_dm_find_labeled_points_local-2574"><span class="linenos">2574</span></a>    <span class="n">iset_lab</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">getStratumIS</span><span class="p">(</span><span class="n">label_value</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2575"><a href="#petsc_dm_find_labeled_points_local-2575"><span class="linenos">2575</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">iset_lab</span><span class="p">:</span>
</span><span id="petsc_dm_find_labeled_points_local-2576"><a href="#petsc_dm_find_labeled_points_local-2576"><span class="linenos">2576</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="petsc_dm_find_labeled_points_local-2577"><a href="#petsc_dm_find_labeled_points_local-2577"><span class="linenos">2577</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2578"><a href="#petsc_dm_find_labeled_points_local-2578"><span class="linenos">2578</span></a>    <span class="c1"># We need to associate edges and faces with their point indices to</span>
</span><span id="petsc_dm_find_labeled_points_local-2579"><a href="#petsc_dm_find_labeled_points_local-2579"><span class="linenos">2579</span></a>    <span class="c1"># build a field representation</span>
</span><span id="petsc_dm_find_labeled_points_local-2580"><a href="#petsc_dm_find_labeled_points_local-2580"><span class="linenos">2580</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2581"><a href="#petsc_dm_find_labeled_points_local-2581"><span class="linenos">2581</span></a>    <span class="n">IndicesP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">iset_lab</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(),</span> <span class="n">pointIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">())</span>
</span><span id="petsc_dm_find_labeled_points_local-2582"><a href="#petsc_dm_find_labeled_points_local-2582"><span class="linenos">2582</span></a>    <span class="n">IndicesE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">iset_lab</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(),</span> <span class="n">edgeIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">())</span>
</span><span id="petsc_dm_find_labeled_points_local-2583"><a href="#petsc_dm_find_labeled_points_local-2583"><span class="linenos">2583</span></a>    <span class="n">IndicesF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">iset_lab</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(),</span> <span class="n">faceIS</span><span class="o">.</span><span class="n">getIndices</span><span class="p">())</span>
</span><span id="petsc_dm_find_labeled_points_local-2584"><a href="#petsc_dm_find_labeled_points_local-2584"><span class="linenos">2584</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2585"><a href="#petsc_dm_find_labeled_points_local-2585"><span class="linenos">2585</span></a>    <span class="c1"># print(f&quot;Label {label_name}&quot;)</span>
</span><span id="petsc_dm_find_labeled_points_local-2586"><a href="#petsc_dm_find_labeled_points_local-2586"><span class="linenos">2586</span></a>    <span class="c1"># print(f&quot;P -&gt; {len(IndicesP)}, E-&gt;{len(IndicesE)}, F-&gt;{len(IndicesF)},&quot;)</span>
</span><span id="petsc_dm_find_labeled_points_local-2587"><a href="#petsc_dm_find_labeled_points_local-2587"><span class="linenos">2587</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2588"><a href="#petsc_dm_find_labeled_points_local-2588"><span class="linenos">2588</span></a>    <span class="n">IndicesFe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">IndicesF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dm</span><span class="o">.</span><span class="n">getConeSize</span><span class="p">(</span><span class="n">fStart</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2589"><a href="#petsc_dm_find_labeled_points_local-2589"><span class="linenos">2589</span></a>    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IndicesF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="petsc_dm_find_labeled_points_local-2590"><a href="#petsc_dm_find_labeled_points_local-2590"><span class="linenos">2590</span></a>        <span class="n">IndicesFe</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getCone</span><span class="p">(</span><span class="n">IndicesF</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
</span><span id="petsc_dm_find_labeled_points_local-2591"><a href="#petsc_dm_find_labeled_points_local-2591"><span class="linenos">2591</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2592"><a href="#petsc_dm_find_labeled_points_local-2592"><span class="linenos">2592</span></a>    <span class="n">IndicesFE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">IndicesE</span><span class="p">,</span> <span class="n">IndicesFe</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2593"><a href="#petsc_dm_find_labeled_points_local-2593"><span class="linenos">2593</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2594"><a href="#petsc_dm_find_labeled_points_local-2594"><span class="linenos">2594</span></a>    <span class="c1"># All faces are now recorded as edges</span>
</span><span id="petsc_dm_find_labeled_points_local-2595"><a href="#petsc_dm_find_labeled_points_local-2595"><span class="linenos">2595</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2596"><a href="#petsc_dm_find_labeled_points_local-2596"><span class="linenos">2596</span></a>    <span class="n">IndicesFEP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">IndicesFE</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dm</span><span class="o">.</span><span class="n">getConeSize</span><span class="p">(</span><span class="n">eStart</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2597"><a href="#petsc_dm_find_labeled_points_local-2597"><span class="linenos">2597</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2598"><a href="#petsc_dm_find_labeled_points_local-2598"><span class="linenos">2598</span></a>    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IndicesFE</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="petsc_dm_find_labeled_points_local-2599"><a href="#petsc_dm_find_labeled_points_local-2599"><span class="linenos">2599</span></a>        <span class="n">IndicesFEP</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">getCone</span><span class="p">(</span><span class="n">IndicesFE</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
</span><span id="petsc_dm_find_labeled_points_local-2600"><a href="#petsc_dm_find_labeled_points_local-2600"><span class="linenos">2600</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2601"><a href="#petsc_dm_find_labeled_points_local-2601"><span class="linenos">2601</span></a>    <span class="c1"># all faces / edges are now points</span>
</span><span id="petsc_dm_find_labeled_points_local-2602"><a href="#petsc_dm_find_labeled_points_local-2602"><span class="linenos">2602</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2603"><a href="#petsc_dm_find_labeled_points_local-2603"><span class="linenos">2603</span></a>    <span class="k">if</span> <span class="n">sectionIndex</span><span class="p">:</span>
</span><span id="petsc_dm_find_labeled_points_local-2604"><a href="#petsc_dm_find_labeled_points_local-2604"><span class="linenos">2604</span></a>        <span class="n">Indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">IndicesP</span><span class="p">,</span> <span class="n">IndicesFEP</span><span class="p">)</span>
</span><span id="petsc_dm_find_labeled_points_local-2605"><a href="#petsc_dm_find_labeled_points_local-2605"><span class="linenos">2605</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="petsc_dm_find_labeled_points_local-2606"><a href="#petsc_dm_find_labeled_points_local-2606"><span class="linenos">2606</span></a>        <span class="n">Indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">IndicesP</span><span class="p">,</span> <span class="n">IndicesFEP</span><span class="p">)</span> <span class="o">-</span> <span class="n">pStart</span>
</span><span id="petsc_dm_find_labeled_points_local-2607"><a href="#petsc_dm_find_labeled_points_local-2607"><span class="linenos">2607</span></a>
</span><span id="petsc_dm_find_labeled_points_local-2608"><a href="#petsc_dm_find_labeled_points_local-2608"><span class="linenos">2608</span></a>    <span class="k">return</span> <span class="n">Indices</span>
</span></pre></div>


            <div class="docstring"><p>Identify local points associated with "Label"</p>

<p>dm -> expects a petscDM object
label_name -> "String Name for Label"
sectionIndex -> False: leave points as indexed by the relevant section on the dm
                True: index into the local coordinate array</p>

<p>NOTE: Assumes uniform element types</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>